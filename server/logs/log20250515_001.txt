2025-05-15 14:04:47.202 +07:00 [INF] Executed DbCommand (27ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-15 14:04:47.351 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-15 14:04:47.392 +07:00 [WRN] The WebRootPath was not found: C:\Users\Thao\source\Flutter\Message_app\server\wwwroot. Static files may be unavailable.
2025-05-15 14:04:47.411 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-15 14:04:47.421 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-15 14:04:47.422 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-15 14:04:47.422 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-15 14:04:47.422 +07:00 [INF] Hosting environment: Development
2025-05-15 14:04:47.422 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-15 14:05:12.632 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:05:12.663 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:05:12.684 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:05:12.685 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-15 14:05:12.708 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:05:12.717 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:05:12.717 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:05:12.722 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:05:12.726 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:05:12.755 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:05:12.755 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:05:12.755 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:05:12.756 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:05:12.880 +07:00 [INF] Executed DbCommand (24ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:05:12.880 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:05:12.880 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:05:12.900 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:05:12.907 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:05:12.918 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:05:12.919 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:05:12.910 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:05:12.920 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:05:12.921 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:05:12.922 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:05:12.923 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:05:12.925 +07:00 [ERR] Connection id "0HNCJFRB3S97Q", Request id "0HNCJFRB3S97Q:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:05:12.925 +07:00 [ERR] Connection id "0HNCJFRB3S97O", Request id "0HNCJFRB3S97O:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:05:12.929 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 298.0859ms
2025-05-15 14:05:12.929 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 206.2315ms
2025-05-15 14:05:17.851 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:05:17.852 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:05:17.918 +07:00 [INF] Executed DbCommand (33ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:05:17.963 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:05:17.963 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:05:17.965 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:05:17.965 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:05:17.976 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:05:17.984 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:06:24.802 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 14:06:24.802 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:24.803 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 1.2166ms
2025-05-15 14:06:24.805 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 14:06:24.806 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:24.807 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:24.807 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:06:24.828 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:06:24.898 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:06:25.001 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:06:25.037 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 206.4848ms
2025-05-15 14:06:25.038 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:06:25.041 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 235.8247ms
2025-05-15 14:06:25.182 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:06:25.182 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.184 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.184 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:06:25.190 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:06:25.253 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:06:25.255 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:06:25.267 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 77.3043ms
2025-05-15 14:06:25.267 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:06:25.268 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 86.0168ms
2025-05-15 14:06:25.296 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:06:25.297 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.297 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.6742ms
2025-05-15 14:06:25.298 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:06:25.298 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.298 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.5641ms
2025-05-15 14:06:25.302 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:06:25.303 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.303 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.303 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:06:25.316 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:06:25.404 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:06:25.409 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:06:25.414 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 97.863ms
2025-05-15 14:06:25.414 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:06:25.415 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 113.3995ms
2025-05-15 14:06:25.415 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:06:25.416 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.417 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.417 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:06:25.417 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:06:25.420 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:06:25.421 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:06:25.421 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 4.0633ms
2025-05-15 14:06:25.421 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:06:25.422 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 6.2344ms
2025-05-15 14:06:25.500 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:06:25.500 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.501 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:25.501 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:06:25.615 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:06:25.616 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:06:25.619 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:06:25.620 +07:00 [ERR] Connection id "0HNCJFRB3S97T", Request id "0HNCJFRB3S97T:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:06:25.623 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 67660.5482ms
2025-05-15 14:06:25.630 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:06:25.648 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:06:30.389 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:06:30.390 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:06:30.400 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:06:30.447 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:06:30.458 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:06:30.459 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:06:30.459 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:06:30.459 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:06:30.459 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:06:30.460 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:06:30.460 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:06:30.461 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:06:30.461 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:06:30.461 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:06:30.461 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:06:30.461 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:06:30.462 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:06:30.462 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:06:30.463 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:06:30.463 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:06:30.464 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:06:30.464 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:06:30.464 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:06:30.464 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:06:30.465 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:06:30.465 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:06:30.466 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:06:30.466 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:06:30.467 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:06:30.467 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:06:30.468 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:06:30.468 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:06:30.468 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:06:30.469 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:06:30.469 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:06:30.470 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:06:30.470 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:06:30.470 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:06:30.471 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:06:30.471 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:06:30.471 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:06:30.471 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:06:30.471 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:06:30.471 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:06:30.472 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:06:30.472 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:06:30.472 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:06:30.473 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:06:30.473 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:06:30.474 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:06:30.474 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:06:30.475 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:06:30.475 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:06:30.475 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:06:30.476 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:06:30.478 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 2
2025-05-15 14:06:30.479 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:06:30.483 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 83.4567ms
2025-05-15 14:06:30.484 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:06:30.484 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 94.4391ms
2025-05-15 14:06:30.514 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:06:30.514 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:06:30.517 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:06:30.546 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:06:30.590 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:06:30.594 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 76.9008ms
2025-05-15 14:06:30.594 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:06:30.594 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 80.2206ms
2025-05-15 14:06:30.631 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:06:30.631 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:06:30.634 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:06:30.643 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:06:30.644 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:30.645 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:06:30.646 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:06:30.651 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:06:30.652 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:06:30.653 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:06:30.655 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 20.5252ms
2025-05-15 14:06:30.655 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:06:30.655 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 24.4074ms
2025-05-15 14:06:30.656 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:06:32.093 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:06:32.098 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:06:32.098 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:06:32.103 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:06:32.108 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:06:32.109 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 11.2106ms
2025-05-15 14:06:32.109 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:06:32.110 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 16.2033ms
2025-05-15 14:06:44.623 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:06:44.625 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:06:44.626 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:06:44.630 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:06:44.644 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:06:44.644 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:06:44.645 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:06:44.645 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:06:44.645 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:06:44.645 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:06:44.646 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:06:44.646 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:06:44.646 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:06:44.646 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:06:44.646 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:06:44.647 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:06:44.647 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:06:44.648 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:06:44.648 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:06:44.649 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:06:44.649 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:06:44.650 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:06:44.650 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:06:44.650 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:06:44.650 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:06:44.651 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:06:44.651 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:06:44.651 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:06:44.651 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:06:44.651 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:06:44.652 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:06:44.652 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:06:44.652 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:06:44.652 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:06:44.653 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:06:44.653 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:06:44.653 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:06:44.654 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:06:44.654 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:06:44.654 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:06:44.655 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:06:44.655 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:06:44.656 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:06:44.656 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:06:44.656 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:06:44.657 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:06:44.658 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:06:44.658 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:06:44.659 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:06:44.659 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:06:44.659 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:06:44.660 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:06:44.660 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:06:44.661 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:06:44.661 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:06:44.661 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 2
2025-05-15 14:06:44.661 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:06:44.661 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 35.6707ms
2025-05-15 14:06:44.662 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:06:44.662 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 38.5302ms
2025-05-15 14:06:44.693 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:06:44.696 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:06:44.696 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:06:44.715 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:06:44.716 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:06:44.716 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 19.8635ms
2025-05-15 14:06:44.716 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:06:44.717 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 23.5944ms
2025-05-15 14:06:44.747 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:06:44.747 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:06:44.747 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:06:44.751 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:06:44.752 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:06:44.752 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.8795ms
2025-05-15 14:06:44.752 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:06:44.752 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.5879ms
2025-05-15 14:06:47.546 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:06:47.547 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:06:47.547 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:06:47.551 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:06:47.551 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:06:47.551 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.8658ms
2025-05-15 14:06:47.551 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:06:47.552 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.5094ms
2025-05-15 14:06:52.938 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Message/uploadFile - multipart/form-data; boundary=--dio-boundary-0595214020 674701
2025-05-15 14:06:52.939 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.UploadFile (Message_app)'
2025-05-15 14:06:52.947 +07:00 [INF] Route matched with {action = "UploadFile", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UploadFile(Microsoft.AspNetCore.Http.IFormFile) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:06:58.123 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p0='?' (DbType = Single), @p1='?' (Size = 50), @p2='?' (Size = 255), @p3='?' (DbType = Boolean), @p4='?' (DbType = Int32), @p5='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Attachments] ([FileSize], [file_type], [file_url], [is_temporary], [message_id], [uploaded_at])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5);
2025-05-15 14:06:58.141 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`2[[System.Int32, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.String, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:06:58.145 +07:00 [INF] Executed action server.Controllers.MessageController.UploadFile (Message_app) in 5197.3566ms
2025-05-15 14:06:58.145 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.UploadFile (Message_app)'
2025-05-15 14:06:58.146 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Message/uploadFile - 200 null application/json; charset=utf-8 5207.0994ms
2025-05-15 14:07:27.433 +07:00 [INF] Request starting HTTP/1.1 PUT http://192.168.1.3:5053/api/Conversation/update_conversation_name/1 - application/json 9
2025-05-15 14:07:27.433 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.UpdateConversationName (Message_app)'
2025-05-15 14:07:27.436 +07:00 [INF] Route matched with {action = "UpdateConversationName", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateConversationName(Int32, System.String) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:07:27.448 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:07:27.467 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-15 14:07:27.474 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:07:27.480 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:07:27.481 +07:00 [INF] Executed action server.Controllers.ConversationController.UpdateConversationName (Message_app) in 44.3382ms
2025-05-15 14:07:27.481 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.UpdateConversationName (Message_app)'
2025-05-15 14:07:27.481 +07:00 [INF] Request finished HTTP/1.1 PUT http://192.168.1.3:5053/api/Conversation/update_conversation_name/1 - 200 null application/json; charset=utf-8 48.0078ms
2025-05-15 14:08:23.314 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:08:23.315 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:08:23.315 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:08:23.317 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:08:23.321 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:08:23.322 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:08:23.322 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:08:23.322 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:08:23.322 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:08:23.322 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:08:23.322 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:08:23.322 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:08:23.323 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:08:23.323 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:08:23.323 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:08:23.323 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:08:23.324 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:08:23.324 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:08:23.324 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:08:23.324 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:08:23.324 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:08:23.325 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:08:23.325 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:08:23.327 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:08:23.328 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:08:23.329 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:08:23.330 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:08:23.331 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:08:23.332 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:08:23.332 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:08:23.334 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:08:23.335 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:08:23.335 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:08:23.335 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:08:23.336 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:08:23.337 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:08:23.337 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:08:23.338 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:08:23.338 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:08:23.339 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:08:23.339 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:08:23.340 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:08:23.340 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:08:23.341 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:08:23.341 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:08:23.342 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:08:23.343 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:08:23.344 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:08:23.344 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:08:23.344 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:08:23.345 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:08:23.345 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:08:23.345 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:08:23.346 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:08:23.346 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:08:23.346 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 2
2025-05-15 14:08:23.346 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:08:23.346 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 31.8042ms
2025-05-15 14:08:23.347 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:08:23.347 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 32.3569ms
2025-05-15 14:08:23.372 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:08:23.373 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:08:23.373 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:08:23.387 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:08:23.388 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:08:23.388 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 15.0979ms
2025-05-15 14:08:23.388 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:08:23.389 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 16.4659ms
2025-05-15 14:08:23.409 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:08:23.410 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:08:23.411 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:08:23.416 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:08:23.416 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:08:23.417 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.8148ms
2025-05-15 14:08:23.417 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:08:23.417 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 7.6414ms
2025-05-15 14:08:24.664 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:08:24.665 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:08:24.665 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:08:24.668 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:08:24.669 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:08:24.669 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.7494ms
2025-05-15 14:08:24.669 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:08:24.669 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.9908ms
2025-05-15 14:08:31.479 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Message/uploadFile - multipart/form-data; boundary=--dio-boundary-1880726743 477235
2025-05-15 14:08:31.480 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.UploadFile (Message_app)'
2025-05-15 14:08:31.480 +07:00 [INF] Route matched with {action = "UploadFile", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UploadFile(Microsoft.AspNetCore.Http.IFormFile) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:08:46.407 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@p0='?' (DbType = Single), @p1='?' (Size = 50), @p2='?' (Size = 255), @p3='?' (DbType = Boolean), @p4='?' (DbType = Int32), @p5='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Attachments] ([FileSize], [file_type], [file_url], [is_temporary], [message_id], [uploaded_at])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5);
2025-05-15 14:08:46.407 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`2[[System.Int32, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.String, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:08:46.408 +07:00 [INF] Executed action server.Controllers.MessageController.UploadFile (Message_app) in 14927.8672ms
2025-05-15 14:08:46.408 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.UploadFile (Message_app)'
2025-05-15 14:08:46.409 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Message/uploadFile - 200 null application/json; charset=utf-8 14929.4903ms
2025-05-15 14:10:07.863 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 14:10:07.864 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:07.864 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.519ms
2025-05-15 14:10:07.866 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 14:10:07.866 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:07.867 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:07.867 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:10:07.867 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:10:07.875 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:10:07.876 +07:00 [INF] Executing BadRequestObjectResult, writing value of type 'System.String'.
2025-05-15 14:10:07.877 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 9.4702ms
2025-05-15 14:10:07.877 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:10:07.877 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 400 null application/json; charset=utf-8 11.1583ms
2025-05-15 14:10:13.975 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 14:10:13.975 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:13.975 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.4564ms
2025-05-15 14:10:13.976 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 14:10:13.976 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:13.977 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:13.977 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:10:13.977 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:10:13.984 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:10:13.985 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:10:13.985 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 8.2426ms
2025-05-15 14:10:13.985 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:10:13.985 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 9.2105ms
2025-05-15 14:10:14.115 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:10:14.115 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.118 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.118 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:10:14.118 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:10:14.126 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:10:14.127 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:10:14.127 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 8.9171ms
2025-05-15 14:10:14.127 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:10:14.127 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 12.4733ms
2025-05-15 14:10:14.268 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:10:14.268 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.268 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.3815ms
2025-05-15 14:10:14.271 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:10:14.271 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.271 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.2699ms
2025-05-15 14:10:14.271 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:10:14.271 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.271 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.272 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:10:14.272 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:10:14.288 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:10:14.288 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:10:14.288 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 16.7474ms
2025-05-15 14:10:14.288 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:10:14.289 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 17.3044ms
2025-05-15 14:10:14.290 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:10:14.290 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.290 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.290 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:10:14.290 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:10:14.294 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:10:14.295 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:10:14.296 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 5.6219ms
2025-05-15 14:10:14.296 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:10:14.297 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 6.7571ms
2025-05-15 14:10:14.588 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:10:14.588 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.588 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:10:14.588 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:10:14.658 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:10:14.667 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:10:18.337 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:10:18.337 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:10:18.337 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:10:18.341 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:10:18.342 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:10:18.342 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.1045ms
2025-05-15 14:10:18.342 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:10:18.343 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.8986ms
2025-05-15 14:10:30.781 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Message/uploadFile - multipart/form-data; boundary=--dio-boundary-3488005380 20085
2025-05-15 14:10:30.782 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.UploadFile (Message_app)'
2025-05-15 14:10:30.782 +07:00 [INF] Route matched with {action = "UploadFile", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UploadFile(Microsoft.AspNetCore.Http.IFormFile) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:10:33.473 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p0='?' (DbType = Single), @p1='?' (Size = 50), @p2='?' (Size = 255), @p3='?' (DbType = Boolean), @p4='?' (DbType = Int32), @p5='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Attachments] ([FileSize], [file_type], [file_url], [is_temporary], [message_id], [uploaded_at])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5);
2025-05-15 14:10:33.474 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`2[[System.Int32, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.String, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:10:33.474 +07:00 [INF] Executed action server.Controllers.MessageController.UploadFile (Message_app) in 2691.7539ms
2025-05-15 14:10:33.474 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.UploadFile (Message_app)'
2025-05-15 14:10:33.474 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Message/uploadFile - 200 null application/json; charset=utf-8 2692.8558ms
2025-05-15 14:10:33.525 +07:00 [INF] Request starting HTTP/1.1 PUT http://192.168.1.3:5053/api/Conversation/update_conversation_image/1 - application/json 133
2025-05-15 14:10:33.526 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.UpdateConversationImage (Message_app)'
2025-05-15 14:10:33.528 +07:00 [INF] Route matched with {action = "UpdateConversationImage", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateConversationImage(Int32, System.String) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:10:33.566 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-15 14:10:33.572 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-15 14:10:33.573 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:10:33.574 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:10:33.575 +07:00 [INF] Executed action server.Controllers.ConversationController.UpdateConversationImage (Message_app) in 46.6057ms
2025-05-15 14:10:33.575 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.UpdateConversationImage (Message_app)'
2025-05-15 14:10:33.575 +07:00 [INF] Request finished HTTP/1.1 PUT http://192.168.1.3:5053/api/Conversation/update_conversation_image/1 - 200 null application/json; charset=utf-8 49.6293ms
2025-05-15 14:14:34.723 +07:00 [INF] Request starting HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 14:14:34.724 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:14:34.742 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:14:34.871 +07:00 [INF] Executed DbCommand (32ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 14:14:34.886 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 14:14:34.892 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:14:34.895 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:14:34.895 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:14:34.897 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 155.5571ms
2025-05-15 14:14:34.897 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:14:34.898 +07:00 [INF] Request finished HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 174.5263ms
2025-05-15 14:19:25.407 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 57
2025-05-15 14:19:25.411 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:19:25.411 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:19:25.429 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:19:25.430 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:19:25.430 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 18.9729ms
2025-05-15 14:19:25.430 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:19:25.430 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 23.2953ms
2025-05-15 14:19:26.405 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 14:19:26.405 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:19:26.405 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:19:26.420 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:19:26.420 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:19:26.420 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 14.9034ms
2025-05-15 14:19:26.420 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:19:26.420 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 15.4579ms
2025-05-15 14:19:26.491 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:19:26.491 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:26.491 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:19:26.502 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:19:26.503 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:26.504 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:19:26.532 +07:00 [INF] Executed DbCommand (37ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:19:26.533 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:19:26.533 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 41.61ms
2025-05-15 14:19:26.533 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:26.533 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 42.3283ms
2025-05-15 14:19:26.541 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:19:26.542 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:19:26.542 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 38.0258ms
2025-05-15 14:19:26.542 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:26.542 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 39.7922ms
2025-05-15 14:19:26.879 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:19:26.879 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:19:26.922 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:19:26.922 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:19:26.923 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:19:26.924 +07:00 [ERR] Connection id "0HNCJFRB3S97S", Request id "0HNCJFRB3S97S:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:19:26.925 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 849073.2067ms
2025-05-15 14:19:26.925 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:19:31.940 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:19:31.940 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:19:31.972 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:19:39.974 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 14:19:39.974 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:39.975 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.3451ms
2025-05-15 14:19:39.975 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-15 14:19:39.976 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:39.976 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:39.976 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:19:39.976 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:19:39.989 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:19:39.990 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:19:39.990 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 14.02ms
2025-05-15 14:19:39.990 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:19:39.990 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 14.8624ms
2025-05-15 14:19:40.109 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 14:19:40.109 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.109 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.109 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:19:40.109 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:19:40.118 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:19:40.118 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:19:40.118 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 8.9258ms
2025-05-15 14:19:40.118 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:19:40.119 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 10.1087ms
2025-05-15 14:19:40.251 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:19:40.251 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.252 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.474ms
2025-05-15 14:19:40.253 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:19:40.253 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:19:40.253 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.253 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.3179ms
2025-05-15 14:19:40.253 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.254 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.254 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:40.254 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:19:40.274 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:19:40.274 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:19:40.274 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 20.6792ms
2025-05-15 14:19:40.275 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:40.275 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 21.2866ms
2025-05-15 14:19:40.276 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:19:40.276 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.276 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.276 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:40.276 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:19:40.278 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:19:40.278 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:19:40.279 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 2.594ms
2025-05-15 14:19:40.279 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:40.279 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 3.0886ms
2025-05-15 14:19:40.463 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 14:19:40.463 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.463 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:40.463 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:19:40.521 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:19:53.607 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 14:19:53.607 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.607 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.2073ms
2025-05-15 14:19:53.608 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 14:19:53.608 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.608 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.608 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:19:53.608 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:19:53.621 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:19:53.622 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:19:53.622 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 14.1885ms
2025-05-15 14:19:53.622 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:19:53.623 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 14.6176ms
2025-05-15 14:19:53.727 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:19:53.727 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.727 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.727 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:19:53.727 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:19:53.734 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:19:53.734 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:19:53.734 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 7.0491ms
2025-05-15 14:19:53.734 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:19:53.734 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 7.5149ms
2025-05-15 14:19:53.812 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:19:53.812 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.813 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.2481ms
2025-05-15 14:19:53.813 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:19:53.814 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.814 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.245ms
2025-05-15 14:19:53.814 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:19:53.814 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.814 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.815 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:53.815 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:19:53.828 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:19:53.828 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:19:53.829 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 13.8579ms
2025-05-15 14:19:53.829 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:53.829 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 14.602ms
2025-05-15 14:19:53.830 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:19:53.830 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.831 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.831 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:53.831 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:19:53.833 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:19:53.833 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:19:53.833 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 2.551ms
2025-05-15 14:19:53.833 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:19:53.833 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 3.1414ms
2025-05-15 14:19:53.854 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:19:53.854 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.855 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:53.855 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:19:53.934 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:19:53.948 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:19:55.175 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:19:55.175 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.175 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - 204 null null 0.1835ms
2025-05-15 14:19:55.176 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:19:55.176 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.176 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.177 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:19:55.177 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:19:55.179 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:19:55.184 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:19:55.184 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:19:55.184 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:19:55.184 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:19:55.184 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:19:55.185 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:19:55.185 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:19:55.185 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:19:55.186 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:19:55.186 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:19:55.186 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:19:55.186 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:19:55.186 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:19:55.187 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:19:55.187 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:19:55.187 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:19:55.187 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:19:55.188 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:19:55.188 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:19:55.189 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:19:55.189 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:19:55.189 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:19:55.190 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:19:55.190 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:19:55.190 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:19:55.190 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:19:55.190 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:19:55.191 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:19:55.191 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:19:55.191 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:19:55.191 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:19:55.191 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:19:55.192 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:19:55.192 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:19:55.192 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:19:55.192 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:19:55.193 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:19:55.193 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:19:55.193 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:19:55.193 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:19:55.194 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:19:55.194 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:19:55.194 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:19:55.194 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:19:55.195 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:19:55.195 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:19:55.195 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:19:55.196 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:19:55.196 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:19:55.196 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:19:55.196 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:19:55.196 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 3
2025-05-15 14:19:55.196 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:19:55.197 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 19.898ms
2025-05-15 14:19:55.197 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:19:55.197 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 20.7379ms
2025-05-15 14:19:55.207 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:19:55.207 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.207 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.2867ms
2025-05-15 14:19:55.208 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:19:55.208 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.209 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.209 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:19:55.209 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:19:55.216 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:19:55.217 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:19:55.217 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 8.4566ms
2025-05-15 14:19:55.217 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:19:55.217 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 9.025ms
2025-05-15 14:19:55.225 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:19:55.225 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.225 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.2271ms
2025-05-15 14:19:55.226 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:19:55.226 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.226 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:55.226 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:19:55.226 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:19:55.230 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:19:55.230 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:19:55.231 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.3577ms
2025-05-15 14:19:55.231 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:19:55.231 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.918ms
2025-05-15 14:19:58.084 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:19:58.085 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:58.085 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:19:58.085 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:19:58.085 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:19:58.090 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:19:58.091 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:19:58.091 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.8809ms
2025-05-15 14:19:58.091 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:19:58.091 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.4519ms
2025-05-15 14:20:00.848 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:20:00.848 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:00.848 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:00.849 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:20:00.849 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:20:00.857 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:20:00.858 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:20:00.858 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 9.2175ms
2025-05-15 14:20:00.858 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:20:00.858 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 10.0032ms
2025-05-15 14:20:03.712 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - null null
2025-05-15 14:20:03.712 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:03.713 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - 204 null null 0.3196ms
2025-05-15 14:20:03.714 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 14:20:03.714 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:03.714 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:03.714 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:20:03.718 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:20:03.742 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:20:03.753 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 14:20:03.762 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:20:03.771 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 14:20:03.774 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:20:03.775 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:20:03.776 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:20:03.776 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 58.1199ms
2025-05-15 14:20:03.776 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:20:03.777 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 62.7998ms
2025-05-15 14:20:04.004 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/2/1 - null null
2025-05-15 14:20:04.004 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:04.005 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/2/1 - 204 null null 0.2257ms
2025-05-15 14:20:04.006 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:20:04.006 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/1 - null null
2025-05-15 14:20:04.006 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:04.006 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:04.006 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.2326ms
2025-05-15 14:20:04.007 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:04.007 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 14:20:04.009 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:20:04.009 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:04.009 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:20:04.009 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:20:04.009 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:20:04.016 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:20:04.019 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:20:04.019 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:20:04.019 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 10.1349ms
2025-05-15 14:20:04.020 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:20:04.020 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 10.9789ms
2025-05-15 14:20:04.043 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__conversationId_0='?' (DbType = Int32), @__userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[name], [t].[is_group], [t].[created_at], [t].[lastMessage], [t].[lastMessageTime], [t].[img_url], [t0].[Id], [t0].[user_id], [t0].[ConversationId], [t0].[Name], [t0].[IsDeleted], [t0].[img_url]
FROM (
    SELECT TOP(1) [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversationId_0 AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_1)
) AS [t]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t0] ON [t].[id] = [t0].[ConversationId]
ORDER BY [t].[id]
2025-05-15 14:20:04.051 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-15 14:20:04.052 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 35.9136ms
2025-05-15 14:20:04.052 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 14:20:04.052 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/1 - 200 null application/json; charset=utf-8 45.7299ms
2025-05-15 14:24:33.839 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:33.839 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:33.839 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:33.839 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:24:33.839 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:24:33.839 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:24:33.843 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:24:33.843 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:24:33.842 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:24:33.843 +07:00 [ERR] Connection id "0HNCJFRB3S98T", Request id "0HNCJFRB3S98T:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:24:33.843 +07:00 [ERR] Connection id "0HNCJFRB3S97P", Request id "0HNCJFRB3S97P:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:24:33.843 +07:00 [ERR] Connection id "0HNCJFRB3S98S", Request id "0HNCJFRB3S98S:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:24:33.846 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 301905.9499ms
2025-05-15 14:24:33.846 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 1161138.1858ms
2025-05-15 14:24:33.847 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 306967.9148ms
2025-05-15 14:24:36.650 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:36.650 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:36.650 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:36.650 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:24:36.650 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:36.650 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:24:36.650 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:24:36.650 +07:00 [ERR] Connection id "0HNCJFRB3S980", Request id "0HNCJFRB3S980:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:24:36.650 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:24:36.651 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:36.651 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:24:36.650 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:24:36.651 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 1091150.7547ms
2025-05-15 14:24:36.651 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:24:36.651 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:24:36.651 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:24:36.652 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:24:36.652 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 296189.018ms
2025-05-15 14:24:36.651 +07:00 [ERR] Connection id "0HNCJFRB3S97R", Request id "0HNCJFRB3S97R:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:24:36.652 +07:00 [ERR] Connection id "0HNCJFRB3S991", Request id "0HNCJFRB3S991:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:24:36.653 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:24:36.653 +07:00 [ERR] Connection id "0HNCJFRB3S98J", Request id "0HNCJFRB3S98J:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:24:36.654 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 1163899.3678ms
2025-05-15 14:24:36.655 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 282800.7104ms
2025-05-15 14:24:36.655 +07:00 [ERR] Connection id "0HNCJFRB3S984", Request id "0HNCJFRB3S984:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:24:36.656 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 862067.7936ms
2025-05-15 14:24:36.657 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 1086013.2993ms
2025-05-15 14:26:28.124 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 14:26:28.127 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.132 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 8.2133ms
2025-05-15 14:26:28.134 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 14:26:28.137 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.144 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.148 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:26:28.187 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:26:28.463 +07:00 [INF] Executed DbCommand (33ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:26:28.478 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:26:28.495 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 308.1193ms
2025-05-15 14:26:28.495 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:26:28.496 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 362.6874ms
2025-05-15 14:26:28.667 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:26:28.667 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.670 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.670 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:26:28.676 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:26:28.697 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:26:28.698 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:26:28.702 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 26.2163ms
2025-05-15 14:26:28.703 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:26:28.703 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 36.1479ms
2025-05-15 14:26:28.910 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:26:28.910 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.910 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.3608ms
2025-05-15 14:26:28.912 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:26:28.912 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.912 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:26:28.912 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.2759ms
2025-05-15 14:26:28.912 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.913 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.914 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:26:28.918 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:26:28.947 +07:00 [INF] Executed DbCommand (25ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:26:28.948 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:26:28.950 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 31.8242ms
2025-05-15 14:26:28.951 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:26:28.951 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 38.3168ms
2025-05-15 14:26:28.952 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:26:28.952 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.953 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:28.953 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:26:28.953 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:26:28.958 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:26:28.958 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:26:28.958 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 5.1678ms
2025-05-15 14:26:28.958 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:26:28.959 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 6.9545ms
2025-05-15 14:26:29.091 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:26:29.091 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:29.091 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:26:29.091 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:26:29.158 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:26:29.187 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:26:43.441 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 57
2025-05-15 14:26:43.444 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:26:43.444 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:26:43.459 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:26:43.460 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:26:43.460 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 15.4427ms
2025-05-15 14:26:43.460 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:26:43.460 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 19.0319ms
2025-05-15 14:26:44.494 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 14:26:44.495 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:26:44.495 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:26:44.503 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:26:44.503 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:26:44.503 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 7.7344ms
2025-05-15 14:26:44.503 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:26:44.503 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 9.4192ms
2025-05-15 14:26:44.704 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:26:44.704 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:26:44.704 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:26:44.704 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:26:44.704 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:26:44.704 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:26:44.719 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:26:44.719 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:26:44.719 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 15.1834ms
2025-05-15 14:26:44.719 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:26:44.720 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 15.6869ms
2025-05-15 14:26:44.727 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:26:44.727 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:26:44.727 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 22.5934ms
2025-05-15 14:26:44.727 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:26:44.727 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 23.071ms
2025-05-15 14:26:45.072 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:26:45.073 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:26:45.138 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:26:47.702 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:26:47.703 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:26:47.706 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:26:47.713 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:26:47.718 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:26:47.718 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:26:47.718 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:26:47.718 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:26:47.719 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:26:47.719 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:26:47.719 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:26:47.719 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:26:47.719 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:26:47.719 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:26:47.719 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:26:47.720 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:26:47.720 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:26:47.720 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:26:47.720 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:26:47.721 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:26:47.721 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:26:47.721 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:26:47.722 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:26:47.722 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:26:47.723 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:26:47.723 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:26:47.723 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:26:47.723 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:26:47.724 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:26:47.724 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:26:47.724 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:26:47.724 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:26:47.724 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:26:47.725 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:26:47.725 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:26:47.725 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:26:47.725 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:26:47.726 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:26:47.726 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:26:47.726 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:26:47.726 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:26:47.726 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:26:47.726 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:26:47.727 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:26:47.727 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:26:47.727 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:26:47.727 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:26:47.727 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:26:47.727 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:26:47.727 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:26:47.727 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:26:47.728 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:26:47.728 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:26:47.728 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:26:47.728 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:26:47.728 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 2
2025-05-15 14:26:47.728 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:26:47.731 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 24.753ms
2025-05-15 14:26:47.731 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:26:47.731 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 28.8464ms
2025-05-15 14:26:47.788 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:26:47.788 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:26:47.791 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:26:47.799 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:26:47.801 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:26:47.803 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 11.4748ms
2025-05-15 14:26:47.803 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:26:47.803 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 14.9039ms
2025-05-15 14:26:47.840 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:26:47.841 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:26:47.844 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:26:47.847 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:26:47.847 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:26:47.849 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.9218ms
2025-05-15 14:26:47.849 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:26:47.849 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 8.7168ms
2025-05-15 14:26:50.505 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:26:50.506 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:26:50.506 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:26:50.511 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:26:50.511 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:26:50.512 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.1859ms
2025-05-15 14:26:50.512 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:26:50.512 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.9647ms
2025-05-15 14:26:55.240 +07:00 [INF] Request starting HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 14:26:55.240 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:26:55.260 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:26:55.268 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 14:26:55.290 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 14:26:55.295 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:26:55.299 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:26:55.299 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:26:55.300 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 40.5798ms
2025-05-15 14:26:55.300 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:26:55.300 +07:00 [INF] Request finished HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 60.9415ms
2025-05-15 14:27:35.496 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 57
2025-05-15 14:27:35.496 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:27:35.496 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:27:35.501 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:27:35.502 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:27:35.502 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 5.6119ms
2025-05-15 14:27:35.502 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:27:35.502 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 6.2184ms
2025-05-15 14:27:35.730 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 14:27:35.730 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:27:35.730 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:27:35.736 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:27:35.737 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:27:35.737 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 6.4795ms
2025-05-15 14:27:35.737 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:27:35.737 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 6.9199ms
2025-05-15 14:27:35.816 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:27:35.816 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:27:35.816 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:27:35.825 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:27:35.826 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:27:35.826 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:27:35.836 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:27:35.836 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:27:35.836 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 20.1409ms
2025-05-15 14:27:35.836 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:27:35.837 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 20.8225ms
2025-05-15 14:27:35.840 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:27:35.840 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:27:35.841 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 14.1249ms
2025-05-15 14:27:35.841 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:27:35.842 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 16.3139ms
2025-05-15 14:27:35.968 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:27:35.968 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:27:36.175 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:27:36.177 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:27:36.176 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:27:36.180 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:27:36.181 +07:00 [ERR] Connection id "0HNCJFRB3S999", Request id "0HNCJFRB3S999:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:27:36.183 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 51110.6328ms
2025-05-15 14:27:39.565 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:27:39.565 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.566 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - 204 null null 0.225ms
2025-05-15 14:27:39.568 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:27:39.569 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.571 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.571 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:27:39.571 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:27:39.580 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:27:39.598 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:27:39.598 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:27:39.598 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:27:39.599 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:27:39.599 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:27:39.599 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:27:39.600 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:27:39.600 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:27:39.600 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:27:39.600 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:27:39.601 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:27:39.601 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:27:39.601 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:27:39.601 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:27:39.601 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:27:39.601 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:27:39.602 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:27:39.602 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:27:39.602 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:27:39.602 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:27:39.602 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:27:39.603 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:27:39.603 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:27:39.603 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:27:39.603 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:27:39.603 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:27:39.604 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:27:39.604 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:27:39.604 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:27:39.604 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:27:39.604 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:27:39.605 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:27:39.605 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:27:39.605 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:27:39.605 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:27:39.606 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:27:39.606 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:27:39.606 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:27:39.607 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:27:39.607 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:27:39.607 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:27:39.607 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:27:39.608 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:27:39.608 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:27:39.608 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:27:39.608 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:27:39.609 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:27:39.609 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:27:39.609 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:27:39.609 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:27:39.609 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:27:39.609 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 3
2025-05-15 14:27:39.609 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:27:39.610 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 38.9548ms
2025-05-15 14:27:39.610 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:27:39.610 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 42.3257ms
2025-05-15 14:27:39.628 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:27:39.629 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.629 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.1773ms
2025-05-15 14:27:39.630 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:27:39.630 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.630 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.630 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:27:39.630 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:27:39.637 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:27:39.637 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:27:39.638 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.1662ms
2025-05-15 14:27:39.638 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:27:39.638 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 7.8243ms
2025-05-15 14:27:39.645 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:27:39.645 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.646 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.2266ms
2025-05-15 14:27:39.647 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:27:39.647 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.647 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:39.647 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:27:39.647 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:27:39.652 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:27:39.653 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:27:39.653 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.3429ms
2025-05-15 14:27:39.653 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:27:39.654 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.7756ms
2025-05-15 14:27:41.224 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:27:41.225 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:27:41.253 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:27:42.598 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:27:42.599 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:42.599 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:27:42.599 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:27:42.599 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:27:42.603 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:27:42.603 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:27:42.603 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.1801ms
2025-05-15 14:27:42.603 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:27:42.603 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.6522ms
2025-05-15 14:40:30.610 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:40:30.610 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:40:30.611 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:40:30.611 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:40:30.615 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:40:30.729 +07:00 [INF] Executed DbCommand (26ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:40:30.730 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:40:30.735 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 120.1236ms
2025-05-15 14:40:30.735 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:40:30.735 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 124.8732ms
2025-05-15 14:40:33.095 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - null null
2025-05-15 14:40:33.095 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:40:33.095 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - 204 null null 0.7652ms
2025-05-15 14:40:33.096 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 14:40:33.097 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:40:33.098 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:40:33.099 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:40:33.102 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:40:33.123 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:40:33.129 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 14:40:33.136 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:40:33.167 +07:00 [INF] Executed DbCommand (25ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 14:40:33.170 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:40:33.174 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:40:33.193 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 91.0142ms
2025-05-15 14:40:33.193 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:40:33.194 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 97.1295ms
2025-05-15 14:40:33.218 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:40:33.218 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:40:33.219 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.1779ms
2025-05-15 14:40:33.220 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:40:33.220 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:40:33.221 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:40:33.221 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:40:33.225 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:40:33.229 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:40:33.230 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:40:33.231 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.8745ms
2025-05-15 14:40:33.231 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:40:33.231 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 11.2126ms
2025-05-15 14:41:10.183 +07:00 [INF] Executed DbCommand (34ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-15 14:41:10.317 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-15 14:41:10.356 +07:00 [WRN] The WebRootPath was not found: C:\Users\Thao\source\Flutter\Message_app\server\wwwroot. Static files may be unavailable.
2025-05-15 14:41:10.375 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-15 14:41:10.389 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-15 14:41:10.389 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-15 14:41:10.389 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-15 14:41:10.389 +07:00 [INF] Hosting environment: Development
2025-05-15 14:41:10.389 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-15 14:41:14.862 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:41:14.884 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:41:14.901 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:41:14.902 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-15 14:41:14.923 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:41:15.030 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:41:15.058 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:41:18.681 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 57
2025-05-15 14:41:18.688 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:41:18.709 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:41:18.796 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:41:18.865 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:41:18.898 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 186.3969ms
2025-05-15 14:41:18.898 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:41:18.901 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 220.3246ms
2025-05-15 14:41:20.131 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 14:41:20.140 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:41:20.144 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:41:20.148 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:41:20.149 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:41:20.150 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:41:20.152 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:41:20.154 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:41:20.158 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:41:20.213 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:41:20.214 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:41:20.224 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 79.6366ms
2025-05-15 14:41:20.224 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:41:20.224 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 92.9396ms
2025-05-15 14:41:20.234 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:41:20.237 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:41:20.237 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:41:20.237 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:41:20.241 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 82.6317ms
2025-05-15 14:41:20.241 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 87.2181ms
2025-05-15 14:41:20.241 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:41:20.241 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:41:20.241 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 93.6274ms
2025-05-15 14:41:20.241 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 91.7893ms
2025-05-15 14:41:20.642 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:41:20.643 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:41:20.710 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:41:27.630 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:41:27.631 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:41:27.635 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:41:27.668 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:41:27.677 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:41:27.677 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:41:27.677 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:41:27.677 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:41:27.678 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:41:27.679 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:41:27.680 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:41:27.681 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:41:27.682 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:41:27.682 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:41:27.683 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:41:27.683 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:41:27.683 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:41:27.684 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:41:27.684 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:41:27.684 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:41:27.684 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:41:27.685 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:41:27.685 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:41:27.685 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:41:27.685 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:41:27.686 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:41:27.686 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:41:27.686 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:41:27.686 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:41:27.686 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:41:27.686 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:41:27.687 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:41:27.687 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:41:27.687 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:41:27.687 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:41:27.687 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:41:27.687 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:41:27.688 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:41:27.688 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:41:27.688 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:41:27.688 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:41:27.688 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:41:27.689 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:41:27.689 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:41:27.689 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:41:27.689 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:41:27.689 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:41:27.690 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:41:27.690 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:41:27.691 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:41:27.691 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:41:27.691 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:41:27.691 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:41:27.692 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:41:27.692 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:41:27.693 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 2
2025-05-15 14:41:27.694 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:41:27.699 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 63.8335ms
2025-05-15 14:41:27.700 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:41:27.700 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 69.5737ms
2025-05-15 14:41:27.748 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:41:27.749 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:41:27.756 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:41:27.789 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:41:27.816 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:41:27.818 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 61.6891ms
2025-05-15 14:41:27.818 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:41:27.818 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 70.2177ms
2025-05-15 14:41:27.880 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:41:27.881 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:41:27.884 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:41:27.895 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:41:27.898 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:41:27.900 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 16.5935ms
2025-05-15 14:41:27.901 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:41:27.901 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 20.8294ms
2025-05-15 14:41:29.267 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:41:29.269 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:41:29.269 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:41:29.271 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:41:29.272 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:41:29.272 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 2.9088ms
2025-05-15 14:41:29.272 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:41:29.272 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.0803ms
2025-05-15 14:41:37.163 +07:00 [INF] Request starting HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 14:41:37.164 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:41:37.167 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:41:37.179 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 14:41:37.241 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 14:41:37.254 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:41:37.259 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:41:37.260 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:41:37.260 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 93.4697ms
2025-05-15 14:41:37.260 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:41:37.261 +07:00 [INF] Request finished HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 97.2234ms
2025-05-15 14:42:24.239 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:42:24.240 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:42:24.240 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:42:24.242 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:42:24.249 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:42:24.250 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:42:24.250 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:42:24.251 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:42:24.252 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:42:24.253 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:42:24.254 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:42:24.254 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:42:24.255 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:42:24.256 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:42:24.256 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:42:24.257 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:42:24.257 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:42:24.258 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:42:24.259 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:42:24.260 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:42:24.261 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:42:24.263 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:42:24.264 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:42:24.265 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:42:24.265 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:42:24.265 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:42:24.266 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:42:24.267 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:42:24.268 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:42:24.269 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:42:24.269 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:42:24.270 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:42:24.271 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:42:24.272 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:42:24.273 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:42:24.273 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:42:24.274 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:42:24.274 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:42:24.275 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:42:24.275 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:42:24.276 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:42:24.276 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:42:24.277 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:42:24.277 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:42:24.277 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:42:24.277 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:42:24.277 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:42:24.278 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:42:24.278 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:42:24.278 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:42:24.278 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:42:24.279 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:42:24.279 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:42:24.279 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:42:24.279 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:42:24.280 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 2
2025-05-15 14:42:24.280 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:42:24.281 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 41.4175ms
2025-05-15 14:42:24.281 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:42:24.282 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 42.9825ms
2025-05-15 14:42:24.310 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:42:24.311 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:42:24.311 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:42:24.319 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:42:24.320 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:42:24.321 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 9.4833ms
2025-05-15 14:42:24.321 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:42:24.321 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 10.5279ms
2025-05-15 14:42:24.339 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:42:24.340 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:42:24.340 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:42:24.344 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:42:24.345 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:42:24.345 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.9545ms
2025-05-15 14:42:24.345 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:42:24.345 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.9061ms
2025-05-15 14:42:42.493 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 57
2025-05-15 14:42:42.494 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:42:42.494 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:42:42.505 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:42:42.506 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:42:42.507 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 12.8587ms
2025-05-15 14:42:42.507 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:42:42.507 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 14.4446ms
2025-05-15 14:42:42.738 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 14:42:42.739 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:42:42.739 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:42:42.746 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:42:42.747 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:42:42.747 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 7.5201ms
2025-05-15 14:42:42.747 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:42:42.747 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 9.1704ms
2025-05-15 14:42:42.801 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:42:42.801 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:42:42.801 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:42:42.805 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:42:42.805 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:42:42.805 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:42:42.821 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:42:42.821 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:42:42.821 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:42:42.821 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:42:42.821 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 16.3975ms
2025-05-15 14:42:42.821 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:42:42.821 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 20.1349ms
2025-05-15 14:42:42.821 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:42:42.822 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 16.8233ms
2025-05-15 14:42:42.822 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 20.6692ms
2025-05-15 14:42:42.955 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:42:42.955 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:42:42.975 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:43:19.217 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:43:19.217 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.219 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - 204 null null 2.0454ms
2025-05-15 14:43:19.221 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:43:19.221 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.221 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.221 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:43:19.221 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:43:19.223 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:43:19.229 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:43:19.229 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:43:19.229 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:43:19.229 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:43:19.229 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:43:19.229 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:43:19.230 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:43:19.230 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:43:19.230 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:43:19.230 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:43:19.230 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:43:19.231 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:43:19.232 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:43:19.232 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:43:19.232 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:43:19.232 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:43:19.233 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:43:19.233 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:43:19.233 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:43:19.233 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:43:19.233 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:43:19.234 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:43:19.234 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:43:19.234 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:43:19.234 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:43:19.234 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:43:19.235 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:43:19.235 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:43:19.235 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:43:19.235 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:43:19.235 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:43:19.235 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:43:19.235 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:43:19.235 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:43:19.236 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:43:19.236 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:43:19.236 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:43:19.236 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:43:19.236 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:43:19.236 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:43:19.236 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:43:19.237 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:43:19.238 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1
2025-05-15 14:43:19.238 +07:00 [INF] Retrieved 27 messages from Redis for conversation 1 and user 3
2025-05-15 14:43:19.238 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:43:19.238 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 16.9954ms
2025-05-15 14:43:19.238 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:43:19.238 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 17.5164ms
2025-05-15 14:43:19.248 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:43:19.248 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.248 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.365ms
2025-05-15 14:43:19.249 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:43:19.250 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.250 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.250 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:43:19.250 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:43:19.256 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:43:19.257 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:43:19.257 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.3971ms
2025-05-15 14:43:19.258 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:43:19.258 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 8.5704ms
2025-05-15 14:43:19.263 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:43:19.263 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.264 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.4284ms
2025-05-15 14:43:19.265 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:43:19.266 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.266 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:19.266 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:19.267 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:43:19.271 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:43:19.271 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:43:19.271 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.8549ms
2025-05-15 14:43:19.272 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:19.272 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.1597ms
2025-05-15 14:43:22.716 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:43:22.717 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:22.717 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:22.717 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:22.717 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:43:22.719 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:43:22.719 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:43:22.720 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 2.6901ms
2025-05-15 14:43:22.720 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:22.720 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.0151ms
2025-05-15 14:43:25.327 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:43:25.327 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:25.328 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:25.328 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:43:25.328 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:43:25.338 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:43:25.338 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:43:25.338 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 10.53ms
2025-05-15 14:43:25.338 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:43:25.339 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 11.889ms
2025-05-15 14:43:27.443 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - null null
2025-05-15 14:43:27.444 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:27.444 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - 204 null null 0.3362ms
2025-05-15 14:43:27.445 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 14:43:27.445 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:27.445 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:27.445 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:43:27.449 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:43:27.464 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:43:27.472 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 14:43:27.479 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:43:27.518 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 14:43:27.529 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:43:27.534 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:43:27.534 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 85.1555ms
2025-05-15 14:43:27.534 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:43:27.535 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 89.6375ms
2025-05-15 14:43:27.544 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:43:27.544 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:27.544 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.3107ms
2025-05-15 14:43:27.545 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:43:27.545 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:27.545 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:43:27.546 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:27.546 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:43:27.549 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:43:27.550 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:43:27.551 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.0124ms
2025-05-15 14:43:27.551 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:27.551 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.8704ms
2025-05-15 14:43:27.814 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversationDto/2/1 - null null
2025-05-15 14:43:27.814 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 14:43:27.818 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:43:27.846 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-15 14:43:27.846 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 27.9516ms
2025-05-15 14:43:27.846 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 14:43:27.846 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversationDto/2/1 - 200 null application/json; charset=utf-8 32.5677ms
2025-05-15 14:43:36.319 +07:00 [INF] Handling message from user 3: nn
2025-05-15 14:43:36.342 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-15 14:43:36.378 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-15 14:43:36.386 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 14:43:36.390 +07:00 [INF] Message saved to DB with ID: 272
2025-05-15 14:43:36.393 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-15 14:43:36.400 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-15 14:43:36.408 +07:00 [INF] Transaction committed for message: 272
2025-05-15 14:43:36.415 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:43:36.420 +07:00 [INF] Saved message 272 to Redis
2025-05-15 14:43:36.423 +07:00 [INF] Added message 272 to conversation 1
2025-05-15 14:43:36.423 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:43:40.854 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:43:40.855 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:43:40.855 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:43:40.857 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:43:40.862 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:43:40.862 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:43:40.863 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:43:40.863 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:43:40.864 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:43:40.864 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:43:40.864 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:43:40.864 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:43:40.864 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:43:40.864 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:43:40.865 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:43:40.865 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:43:40.866 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:43:40.866 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:43:40.867 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:43:40.867 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:43:40.867 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:43:40.867 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:43:40.868 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:43:40.868 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:43:40.868 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:43:40.869 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:43:40.869 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:43:40.869 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:43:40.870 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:43:40.871 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:43:40.871 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:43:40.871 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:43:40.872 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:43:40.872 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:43:40.873 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:43:40.873 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:43:40.873 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:43:40.873 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:43:40.873 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:43:40.874 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:43:40.874 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:43:40.874 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:43:40.874 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:43:40.874 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:43:40.874 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:43:40.875 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:43:40.875 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:43:40.875 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:43:40.875 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:43:40.875 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:43:40.876 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:43:40.876 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:43:40.876 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:43:40.876 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:43:40.876 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1
2025-05-15 14:43:40.876 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1 and user 2
2025-05-15 14:43:40.876 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:43:40.876 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 21.5627ms
2025-05-15 14:43:40.877 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:43:40.877 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 22.1573ms
2025-05-15 14:43:40.905 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:43:40.905 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:43:40.905 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:43:40.909 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:43:40.910 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:43:40.910 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 4.5989ms
2025-05-15 14:43:40.910 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:43:40.910 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 5.5305ms
2025-05-15 14:43:40.929 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:43:40.930 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:40.930 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:43:40.932 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:43:40.934 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:43:40.934 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.1558ms
2025-05-15 14:43:40.934 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:40.934 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.7223ms
2025-05-15 14:43:42.133 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:43:42.134 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:42.134 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:43:42.138 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:43:42.139 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:43:42.140 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.9065ms
2025-05-15 14:43:42.140 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:43:42.140 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 7.5094ms
2025-05-15 14:43:45.400 +07:00 [INF] Request starting HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 14:43:45.401 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:43:45.402 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:43:45.418 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 14:43:45.425 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 14:43:45.426 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:43:45.427 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:43:45.428 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:43:45.428 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 25.9268ms
2025-05-15 14:43:45.428 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:43:45.428 +07:00 [INF] Request finished HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 28.0666ms
2025-05-15 14:46:35.541 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 14:46:35.541 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.541 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.5732ms
2025-05-15 14:46:35.543 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 14:46:35.543 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.543 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.543 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:46:35.544 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:46:35.555 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:46:35.556 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:46:35.557 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 12.9699ms
2025-05-15 14:46:35.557 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:46:35.557 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 13.9343ms
2025-05-15 14:46:35.681 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:46:35.681 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.682 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.682 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:46:35.682 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:46:35.690 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:46:35.691 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:46:35.691 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 8.8905ms
2025-05-15 14:46:35.691 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:46:35.691 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 10.0311ms
2025-05-15 14:46:35.845 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:46:35.846 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.846 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.4567ms
2025-05-15 14:46:35.847 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:46:35.847 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.847 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.205ms
2025-05-15 14:46:35.848 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:46:35.848 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.848 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.848 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:46:35.848 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:46:35.865 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:46:35.866 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:46:35.866 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 17.5241ms
2025-05-15 14:46:35.866 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:46:35.866 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 18.4325ms
2025-05-15 14:46:35.867 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 14:46:35.867 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.867 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:35.868 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:46:35.868 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:46:35.870 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:46:35.871 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:46:35.871 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 3.0938ms
2025-05-15 14:46:35.871 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:46:35.871 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 3.6842ms
2025-05-15 14:46:36.043 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:46:36.043 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:36.043 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:36.043 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:46:36.102 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:46:36.105 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:46:36.111 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:46:36.103 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:46:36.129 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:46:36.130 +07:00 [ERR] Connection id "0HNCJGFFGI75R", Request id "0HNCJGFFGI75R:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:46:36.131 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 321270.4925ms
2025-05-15 14:46:41.137 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:46:41.137 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:41.138 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:41.138 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:46:41.142 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:46:41.143 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:46:41.143 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:46:41.143 +07:00 [ERR] Connection id "0HNCJGFFGI76N", Request id "0HNCJGFFGI76N:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:46:41.144 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 5101.4451ms
2025-05-15 14:46:41.154 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:46:41.161 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:46:46.158 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:46:46.159 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:46.159 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:46.159 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:46:46.163 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:46:46.170 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:46:50.858 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 57
2025-05-15 14:46:50.858 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:46:50.858 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:46:50.869 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:46:50.870 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:46:50.870 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 11.6223ms
2025-05-15 14:46:50.870 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:46:50.870 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 12.2866ms
2025-05-15 14:46:52.125 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 14:46:52.125 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:46:52.126 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:46:52.132 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:46:52.132 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:46:52.132 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:46:52.134 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:46:52.134 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:46:52.134 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 8.556ms
2025-05-15 14:46:52.134 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:46:52.134 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 9.6531ms
2025-05-15 14:46:52.135 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:46:52.135 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:46:52.135 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:46:52.150 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:46:52.151 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:46:52.151 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 18.7817ms
2025-05-15 14:46:52.151 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:46:52.151 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:46:52.151 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 19.5729ms
2025-05-15 14:46:52.152 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:46:52.152 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 16.8323ms
2025-05-15 14:46:52.152 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:46:52.152 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 17.4979ms
2025-05-15 14:46:52.545 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:46:52.546 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:46:52.864 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:46:55.355 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:46:55.356 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.356 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - 204 null null 0.3074ms
2025-05-15 14:46:55.357 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:46:55.357 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.357 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.357 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:46:55.357 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:46:55.359 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:46:55.363 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:46:55.363 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:46:55.364 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:46:55.364 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:46:55.364 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:46:55.365 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:46:55.365 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:46:55.366 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:46:55.366 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:46:55.366 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:46:55.367 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:46:55.367 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:46:55.367 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:46:55.368 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:46:55.368 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:46:55.368 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:46:55.369 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:46:55.369 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:46:55.370 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:46:55.370 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:46:55.371 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:46:55.371 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:46:55.371 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:46:55.372 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:46:55.372 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:46:55.372 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:46:55.373 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:46:55.373 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:46:55.373 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:46:55.374 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:46:55.374 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:46:55.374 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:46:55.375 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:46:55.375 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:46:55.375 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:46:55.375 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:46:55.376 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:46:55.376 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:46:55.376 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:46:55.376 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:46:55.377 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:46:55.377 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:46:55.377 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:46:55.377 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:46:55.377 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:46:55.377 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:46:55.378 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:46:55.378 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:46:55.378 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:46:55.378 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:46:55.378 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1
2025-05-15 14:46:55.378 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1 and user 3
2025-05-15 14:46:55.378 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:46:55.378 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 21.2202ms
2025-05-15 14:46:55.378 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:46:55.378 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 21.5805ms
2025-05-15 14:46:55.391 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:46:55.391 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.391 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.2198ms
2025-05-15 14:46:55.392 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:46:55.393 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.393 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.393 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:46:55.393 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:46:55.399 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:46:55.400 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:46:55.400 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.3232ms
2025-05-15 14:46:55.400 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:46:55.400 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 8.0044ms
2025-05-15 14:46:55.407 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:46:55.407 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.407 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.2553ms
2025-05-15 14:46:55.409 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:46:55.409 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.409 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:55.409 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:46:55.410 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:46:55.414 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:46:55.414 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:46:55.414 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.8217ms
2025-05-15 14:46:55.414 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:46:55.415 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.7793ms
2025-05-15 14:46:56.629 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:46:56.629 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:56.629 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:56.629 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:46:56.630 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:46:56.631 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:46:56.631 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:46:56.632 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 2.0516ms
2025-05-15 14:46:56.632 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:46:56.632 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 3.0837ms
2025-05-15 14:46:59.184 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:46:59.184 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:59.184 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:46:59.184 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:46:59.184 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:46:59.187 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:46:59.188 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:46:59.188 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 3.2626ms
2025-05-15 14:46:59.188 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:46:59.188 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 3.7944ms
2025-05-15 14:47:01.855 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - null null
2025-05-15 14:47:01.855 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:01.855 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - 204 null null 0.2529ms
2025-05-15 14:47:01.856 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 14:47:01.856 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:01.856 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:01.856 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:47:01.857 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:01.861 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:47:01.867 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 14:47:01.872 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:47:01.878 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 14:47:01.879 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:47:01.881 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:47:01.881 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 24.0626ms
2025-05-15 14:47:01.881 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:47:01.881 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 24.7392ms
2025-05-15 14:47:01.934 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:01.934 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:01.934 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.2621ms
2025-05-15 14:47:01.935 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:01.935 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:01.935 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:01.935 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:01.935 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:01.937 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:47:01.938 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:47:01.938 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 2.5634ms
2025-05-15 14:47:01.938 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:01.938 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 3.1705ms
2025-05-15 14:47:02.274 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversationDto/2/1 - null null
2025-05-15 14:47:02.274 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 14:47:02.275 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:47:02.276 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-15 14:47:02.277 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 1.7423ms
2025-05-15 14:47:02.277 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 14:47:02.277 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversationDto/2/1 - 200 null application/json; charset=utf-8 2.5733ms
2025-05-15 14:47:04.266 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:47:04.267 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:47:04.267 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:47:04.271 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:47:04.290 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:47:04.290 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:47:04.291 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:47:04.291 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:47:04.292 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:47:04.292 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:47:04.293 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:47:04.294 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:47:04.296 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:47:04.297 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:47:04.297 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:47:04.297 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:47:04.298 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:47:04.298 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:47:04.299 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:47:04.299 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:47:04.299 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:47:04.300 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:47:04.300 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:47:04.300 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:47:04.300 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:47:04.301 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:47:04.301 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:47:04.301 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:47:04.301 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:47:04.302 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:47:04.302 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:47:04.302 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:47:04.302 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:47:04.303 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:47:04.303 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:47:04.303 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:47:04.303 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:47:04.304 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:47:04.304 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:47:04.304 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:47:04.304 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:47:04.305 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:47:04.305 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:47:04.305 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:47:04.305 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:47:04.306 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:47:04.306 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:47:04.307 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:47:04.307 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:47:04.307 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:47:04.308 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:47:04.308 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:47:04.308 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:47:04.309 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:47:04.309 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1
2025-05-15 14:47:04.309 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1 and user 2
2025-05-15 14:47:04.309 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:47:04.309 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 42.116ms
2025-05-15 14:47:04.309 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:47:04.309 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 43.001ms
2025-05-15 14:47:04.367 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:47:04.367 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:47:04.367 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:47:04.370 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:47:04.371 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:47:04.372 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 4.294ms
2025-05-15 14:47:04.372 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:47:04.372 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 5.0728ms
2025-05-15 14:47:04.415 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:04.415 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:04.415 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:04.417 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:47:04.417 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:47:04.417 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 2.2193ms
2025-05-15 14:47:04.417 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:04.418 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 2.7918ms
2025-05-15 14:47:07.865 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:07.865 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:07.866 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:07.868 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:47:07.869 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:47:07.869 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.1024ms
2025-05-15 14:47:07.869 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:07.869 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 3.6264ms
2025-05-15 14:47:10.802 +07:00 [INF] Request starting HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 14:47:10.802 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:47:10.802 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:10.807 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 14:47:10.813 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 14:47:10.814 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:47:10.814 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:47:10.815 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:47:10.815 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 12.6853ms
2025-05-15 14:47:10.815 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:47:10.815 +07:00 [INF] Request finished HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 13.1902ms
2025-05-15 14:47:16.700 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:47:16.703 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:47:16.704 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:47:16.700 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:47:16.705 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:47:16.705 +07:00 [ERR] Connection id "0HNCJGFFGI76U", Request id "0HNCJGFFGI76U:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:47:16.704 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
 ---> Microsoft.AspNetCore.Connections.ConnectionResetException: An existing connection was forcibly closed by the remote host.
 ---> System.Net.Sockets.SocketException (10054): An existing connection was forcibly closed by the remote host.
   --- End of inner exception stack trace ---
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:47:16.704 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
 ---> Microsoft.AspNetCore.Connections.ConnectionResetException: An existing connection was forcibly closed by the remote host.
 ---> System.Net.Sockets.SocketException (10054): An existing connection was forcibly closed by the remote host.
   --- End of inner exception stack trace ---
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:47:16.707 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 24161.596ms
2025-05-15 14:47:16.707 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:47:16.710 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:47:16.710 +07:00 [ERR] Connection id "0HNCJGFFGI760", Request id "0HNCJGFFGI760:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
 ---> Microsoft.AspNetCore.Connections.ConnectionResetException: An existing connection was forcibly closed by the remote host.
 ---> System.Net.Sockets.SocketException (10054): An existing connection was forcibly closed by the remote host.
   --- End of inner exception stack trace ---
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:47:16.710 +07:00 [ERR] Connection id "0HNCJGFFGI76D", Request id "0HNCJGFFGI76D:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
 ---> Microsoft.AspNetCore.Connections.ConnectionResetException: An existing connection was forcibly closed by the remote host.
 ---> System.Net.Sockets.SocketException (10054): An existing connection was forcibly closed by the remote host.
   --- End of inner exception stack trace ---
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:47:16.712 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 356070.3012ms
2025-05-15 14:47:16.714 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 273758.943ms
2025-05-15 14:47:26.701 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:47:26.701 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.701 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - 204 null null 0.3005ms
2025-05-15 14:47:26.702 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-15 14:47:26.703 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.703 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.703 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:47:26.703 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:47:26.705 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:47:26.712 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:47:26.712 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:47:26.713 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:47:26.713 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:47:26.713 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:47:26.714 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:47:26.714 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:47:26.714 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:47:26.714 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:47:26.715 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:47:26.715 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:47:26.715 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:47:26.715 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:47:26.715 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:47:26.716 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:47:26.716 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:47:26.716 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:47:26.716 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:47:26.716 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:47:26.717 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:47:26.717 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:47:26.717 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:47:26.717 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:47:26.717 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:47:26.718 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:47:26.718 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:47:26.718 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:47:26.719 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:47:26.719 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:47:26.719 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:47:26.719 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:47:26.720 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:47:26.720 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:47:26.720 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:47:26.721 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:47:26.721 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:47:26.722 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:47:26.723 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:47:26.724 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:47:26.724 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:47:26.724 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:47:26.725 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:47:26.725 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:47:26.725 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:47:26.726 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:47:26.726 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:47:26.726 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:47:26.726 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:47:26.727 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:47:26.727 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:47:26.727 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1
2025-05-15 14:47:26.727 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1 and user 3
2025-05-15 14:47:26.727 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:47:26.727 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 24.3002ms
2025-05-15 14:47:26.727 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:47:26.727 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 25.0805ms
2025-05-15 14:47:26.744 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:47:26.744 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.744 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.2495ms
2025-05-15 14:47:26.746 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:47:26.746 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.746 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.746 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:47:26.746 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:47:26.758 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:47:26.759 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:47:26.759 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 12.4998ms
2025-05-15 14:47:26.759 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:47:26.759 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 13.5512ms
2025-05-15 14:47:26.767 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:26.767 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.767 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.4869ms
2025-05-15 14:47:26.769 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:26.769 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.769 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:26.769 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:26.769 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:26.775 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:47:26.775 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:47:26.776 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.4387ms
2025-05-15 14:47:26.776 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:26.776 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.9642ms
2025-05-15 14:47:28.183 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:28.183 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:28.183 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:28.183 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:28.183 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:28.188 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:47:28.189 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:47:28.189 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.7064ms
2025-05-15 14:47:28.189 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:28.189 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.7522ms
2025-05-15 14:47:35.271 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 14:47:35.271 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:35.272 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:35.272 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:47:35.272 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:47:35.287 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:47:35.288 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:47:35.288 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 16.2113ms
2025-05-15 14:47:35.288 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:47:35.289 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 17.2937ms
2025-05-15 14:47:37.951 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - null null
2025-05-15 14:47:37.951 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:37.952 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/add_member/1/2 - 204 null null 0.1952ms
2025-05-15 14:47:37.953 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 14:47:37.953 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:37.953 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:37.953 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:47:37.953 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:37.960 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:47:37.963 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 14:47:37.969 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 14:47:37.975 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 14:47:37.976 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:47:37.977 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:47:37.977 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 24.3762ms
2025-05-15 14:47:37.978 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 14:47:37.978 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 25.0827ms
2025-05-15 14:47:37.989 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:37.989 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:37.989 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.5332ms
2025-05-15 14:47:37.991 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:47:37.991 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:37.991 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:47:37.991 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:37.991 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:47:37.995 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:47:37.996 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:47:37.996 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.0135ms
2025-05-15 14:47:37.996 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:47:37.996 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.3818ms
2025-05-15 14:49:51.320 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 57
2025-05-15 14:49:51.321 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:49:51.321 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 14:49:51.349 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 14:49:51.350 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 14:49:51.350 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 28.9327ms
2025-05-15 14:49:51.350 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 14:49:51.351 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 30.3842ms
2025-05-15 14:49:52.567 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 14:49:52.567 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:49:52.567 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 14:49:52.578 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 14:49:52.578 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:49:52.578 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 10.8525ms
2025-05-15 14:49:52.578 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 14:49:52.578 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 11.3994ms
2025-05-15 14:49:52.803 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:49:52.803 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:49:52.803 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:49:52.807 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 14:49:52.808 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:49:52.808 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:49:52.830 +07:00 [INF] Executed DbCommand (25ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:49:52.830 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 14:49:52.831 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:49:52.831 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:49:52.831 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 27.8386ms
2025-05-15 14:49:52.831 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 22.7304ms
2025-05-15 14:49:52.831 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:49:52.831 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 14:49:52.831 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 23.6494ms
2025-05-15 14:49:52.831 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 28.354ms
2025-05-15 14:49:53.645 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 14:49:53.645 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:49:53.785 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:49:55.981 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:49:55.981 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:49:55.981 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:49:55.985 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:49:55.999 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:49:55.999 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:49:55.999 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:49:55.999 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:49:56.000 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:49:56.000 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:49:56.000 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:49:56.000 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:49:56.000 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:49:56.001 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:49:56.001 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:49:56.001 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:49:56.001 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:49:56.001 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:49:56.001 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:49:56.001 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:49:56.001 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:49:56.002 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:49:56.002 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:49:56.002 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:49:56.002 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:49:56.002 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:49:56.003 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:49:56.003 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:49:56.003 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:49:56.003 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:49:56.003 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:49:56.004 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:49:56.004 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:49:56.004 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:49:56.004 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:49:56.005 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:49:56.005 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:49:56.005 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:49:56.005 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:49:56.006 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:49:56.006 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:49:56.006 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:49:56.006 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:49:56.006 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:49:56.006 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:49:56.006 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:49:56.007 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:49:56.007 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:49:56.007 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:49:56.007 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:49:56.007 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:49:56.007 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:49:56.008 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:49:56.008 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:49:56.008 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1
2025-05-15 14:49:56.009 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1 and user 2
2025-05-15 14:49:56.010 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:49:56.010 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 29.1924ms
2025-05-15 14:49:56.011 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:49:56.011 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 30.0674ms
2025-05-15 14:49:56.065 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:49:56.066 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:49:56.066 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:49:56.071 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:49:56.072 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:49:56.073 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.0591ms
2025-05-15 14:49:56.073 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:49:56.073 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 7.5082ms
2025-05-15 14:49:56.112 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:49:56.112 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:49:56.113 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:49:56.118 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:49:56.119 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:49:56.119 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.0954ms
2025-05-15 14:49:56.119 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:49:56.119 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.9449ms
2025-05-15 14:49:58.451 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:49:58.451 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:49:58.451 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:49:58.456 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:49:58.457 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:49:58.457 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.2903ms
2025-05-15 14:49:58.457 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:49:58.457 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.6905ms
2025-05-15 14:50:08.819 +07:00 [INF] Request starting HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 14:50:08.819 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:50:08.819 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:50:08.824 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 14:50:08.833 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 14:50:08.834 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 14:50:08.834 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:50:08.834 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:50:08.834 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 15.0153ms
2025-05-15 14:50:08.834 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 14:50:08.835 +07:00 [INF] Request finished HTTP/1.1 DELETE http://192.168.1.3:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 15.7139ms
2025-05-15 14:51:26.426 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - null null
2025-05-15 14:51:26.426 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:51:26.427 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 14:51:26.431 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 14:51:26.456 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 14:51:26.456 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 14:51:26.457 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 14:51:26.457 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 14:51:26.458 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 14:51:26.458 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 14:51:26.459 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 14:51:26.459 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 14:51:26.459 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 14:51:26.459 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 14:51:26.459 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 14:51:26.459 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 14:51:26.459 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 14:51:26.460 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 14:51:26.460 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 14:51:26.460 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 14:51:26.460 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 14:51:26.460 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 14:51:26.461 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 14:51:26.462 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 14:51:26.462 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 14:51:26.463 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 14:51:26.463 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 14:51:26.463 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 14:51:26.464 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 14:51:26.464 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 14:51:26.464 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 14:51:26.465 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 14:51:26.465 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 14:51:26.465 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 14:51:26.466 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 14:51:26.466 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 14:51:26.466 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 14:51:26.467 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 14:51:26.467 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 14:51:26.467 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 14:51:26.467 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 14:51:26.468 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 14:51:26.468 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 14:51:26.468 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 14:51:26.468 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 14:51:26.469 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 14:51:26.469 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 14:51:26.469 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 14:51:26.469 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 14:51:26.469 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 14:51:26.470 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 14:51:26.470 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 14:51:26.470 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 14:51:26.470 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 14:51:26.470 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1
2025-05-15 14:51:26.470 +07:00 [INF] Retrieved 28 messages from Redis for conversation 1 and user 2
2025-05-15 14:51:26.470 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 14:51:26.470 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 43.2419ms
2025-05-15 14:51:26.470 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 14:51:26.470 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 44.3604ms
2025-05-15 14:51:26.505 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 14:51:26.506 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:51:26.506 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 14:51:26.520 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 14:51:26.520 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 14:51:26.520 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 13.3577ms
2025-05-15 14:51:26.520 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 14:51:26.521 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 16.0001ms
2025-05-15 14:51:26.588 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 14:51:26.588 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:51:26.588 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 14:51:26.595 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 14:51:26.595 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 14:51:26.596 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 7.1067ms
2025-05-15 14:51:26.596 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 14:51:26.596 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 7.6224ms
2025-05-15 14:51:31.673 +07:00 [INF] Handling message from user 3: d
2025-05-15 14:51:31.694 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-15 14:51:31.701 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-15 14:51:31.706 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 14:51:31.706 +07:00 [INF] Message saved to DB with ID: 273
2025-05-15 14:51:31.707 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-15 14:51:31.711 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-15 14:51:31.713 +07:00 [INF] Transaction committed for message: 273
2025-05-15 14:51:31.717 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:51:31.719 +07:00 [INF] Saved message 273 to Redis
2025-05-15 14:51:31.720 +07:00 [INF] Added message 273 to conversation 1
2025-05-15 14:51:31.720 +07:00 [INF] Published message to channel conversation:1
2025-05-15 14:56:44.776 +07:00 [INF] Application is shutting down...
2025-05-15 14:57:14.797 +07:00 [ERR] Error handling WebSocket connection from ::1
Microsoft.AspNetCore.Connections.ConnectionAbortedException: The connection was aborted because the server is shutting down and request processing didn't complete within the time specified by HostOptions.ShutdownTimeout.
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
2025-05-15 14:57:14.797 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
Microsoft.AspNetCore.Connections.ConnectionAbortedException: The connection was aborted because the server is shutting down and request processing didn't complete within the time specified by HostOptions.ShutdownTimeout.
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
2025-05-15 14:57:14.797 +07:00 [ERR] Error handling WebSocket connection from ::1
Microsoft.AspNetCore.Connections.ConnectionAbortedException: The connection was aborted because the server is shutting down and request processing didn't complete within the time specified by HostOptions.ShutdownTimeout.
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
2025-05-15 14:57:14.799 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:57:14.800 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:57:14.800 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:57:14.800 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:57:14.800 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:57:14.800 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:57:14.800 +07:00 [ERR] Connection id "0HNCJGFFGI76P", Request id "0HNCJGFFGI76P:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:57:14.800 +07:00 [ERR] Connection id "0HNCJGFFGI76O", Request id "0HNCJGFFGI76O:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:57:14.801 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 628642.909ms
2025-05-15 14:57:14.801 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 633664.195ms
2025-05-15 14:57:14.803 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:57:14.803 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:57:14.803 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:57:14.803 +07:00 [ERR] Connection id "0HNCJGFFGI779", Request id "0HNCJGFFGI779:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:57:14.803 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 441158.5447ms
2025-05-15 14:57:23.976 +07:00 [INF] Executed DbCommand (27ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-15 14:57:24.098 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-15 14:57:24.131 +07:00 [WRN] The WebRootPath was not found: C:\Users\Thao\source\Flutter\Message_app\server\wwwroot. Static files may be unavailable.
2025-05-15 14:57:24.145 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-15 14:57:24.153 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-15 14:57:24.153 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-15 14:57:24.154 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-15 14:57:24.154 +07:00 [INF] Hosting environment: Development
2025-05-15 14:57:24.154 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-15 14:57:24.230 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:57:24.250 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:24.267 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:24.267 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-15 14:57:24.290 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:57:24.299 +07:00 [INF] New WebSocket connection from 127.0.0.1. Waiting for bootup message.
2025-05-15 14:57:24.307 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 14:57:24.352 +07:00 [INF] Added client with UserId 3. Total clients: 1
2025-05-15 14:57:24.432 +07:00 [INF] Executed DbCommand (23ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 14:57:24.463 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 14:57:27.203 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:57:27.206 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:27.209 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:27.210 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:57:27.213 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 14:57:27.217 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 14:57:27.218 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 14:57:27.229 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 14:57:27.250 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:57:27.252 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:57:27.256 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:57:27.260 +07:00 [ERR] Connection id "0HNCJGOGD7K0M", Request id "0HNCJGOGD7K0M:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:57:27.262 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 59.0143ms
2025-05-15 14:57:32.279 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:57:32.280 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:32.280 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:32.282 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:57:32.282 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 14:57:32.289 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 14:57:32.289 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 14:57:32.290 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 14:57:32.291 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:57:32.291 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:57:32.293 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:57:32.293 +07:00 [ERR] Connection id "0HNCJGOGD7K0N", Request id "0HNCJGOGD7K0N:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:57:32.297 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 18.3211ms
2025-05-15 14:57:37.312 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:57:37.313 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:37.313 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:37.313 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:57:37.313 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 14:57:37.315 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 14:57:37.315 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 14:57:37.316 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 14:57:37.317 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:57:37.317 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:57:37.319 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:57:37.319 +07:00 [ERR] Connection id "0HNCJGOGD7K0O", Request id "0HNCJGOGD7K0O:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:57:37.321 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 8.6207ms
2025-05-15 14:57:42.331 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 14:57:42.333 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:42.333 +07:00 [INF] CORS policy execution successful.
2025-05-15 14:57:42.334 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 14:57:42.334 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 14:57:42.337 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 14:57:42.337 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 14:57:42.338 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 14:57:42.339 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:57:42.339 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:57:42.340 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:57:42.341 +07:00 [ERR] Connection id "0HNCJGOGD7K0P", Request id "0HNCJGOGD7K0P:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:57:42.342 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 10.6074ms
2025-05-15 14:57:45.404 +07:00 [ERR] Error handling WebSocket connection from 127.0.0.1
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 187
2025-05-15 14:57:45.406 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 14:57:45.406 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 14:57:45.407 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 14:57:45.408 +07:00 [ERR] Connection id "0HNCJGOGD7K0L", Request id "0HNCJGOGD7K0L:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 14:57:45.411 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 21182.0587ms
2025-05-15 15:01:58.690 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 15:01:58.699 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:58.715 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 24.6168ms
2025-05-15 15:01:58.721 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-15 15:01:58.725 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:58.739 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:58.743 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:01:58.824 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:01:59.117 +07:00 [INF] Executed DbCommand (47ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:01:59.221 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:01:59.257 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 430.7926ms
2025-05-15 15:01:59.257 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:01:59.262 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 540.552ms
2025-05-15 15:01:59.400 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 15:01:59.403 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.405 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.405 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:01:59.413 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:01:59.512 +07:00 [INF] Executed DbCommand (23ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:01:59.514 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:01:59.523 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 109.4607ms
2025-05-15 15:01:59.523 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:01:59.523 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 123.0835ms
2025-05-15 15:01:59.635 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:01:59.636 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.636 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.6568ms
2025-05-15 15:01:59.637 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:01:59.637 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:01:59.637 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.637 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.637 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.4ms
2025-05-15 15:01:59.638 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.638 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:01:59.641 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:01:59.782 +07:00 [INF] Executed DbCommand (40ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:01:59.786 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:01:59.791 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 149.9093ms
2025-05-15 15:01:59.792 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:01:59.792 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 154.6806ms
2025-05-15 15:01:59.793 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:01:59.793 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.795 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.796 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:01:59.796 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:01:59.805 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:01:59.805 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:01:59.806 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 9.7394ms
2025-05-15 15:01:59.806 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:01:59.806 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 13.1227ms
2025-05-15 15:01:59.968 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:01:59.970 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.970 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:01:59.970 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:01:59.973 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:02:00.027 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:02:00.030 +07:00 [INF] Added client with UserId 2. Total clients: 2
2025-05-15 15:02:00.036 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:02:24.711 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 60
2025-05-15 15:02:24.721 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:02:24.722 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:02:24.775 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:02:24.776 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:02:24.776 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 54.3093ms
2025-05-15 15:02:24.776 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:02:24.776 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 65.5969ms
2025-05-15 15:02:26.026 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:02:26.028 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:02:26.028 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:02:26.043 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:02:26.043 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:02:26.044 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 15.5197ms
2025-05-15 15:02:26.044 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:02:26.044 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 18.1862ms
2025-05-15 15:02:26.047 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:02:26.048 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:02:26.048 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:02:26.049 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:02:26.049 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:02:26.049 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:02:26.068 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:02:26.069 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:02:26.070 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 20.2481ms
2025-05-15 15:02:26.070 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:02:26.070 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 21.1641ms
2025-05-15 15:02:26.107 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:02:26.109 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:02:26.110 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 62.1167ms
2025-05-15 15:02:26.110 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:02:26.110 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 62.9988ms
2025-05-15 15:02:26.435 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:02:26.435 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:02:26.436 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:02:26.758 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 15:02:26.758 +07:00 [INF] Added client with UserId 3. Total clients: 3
2025-05-15 15:02:26.765 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:02:26.799 +07:00 [INF] Executed DbCommand (30ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:02:27.959 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/3 - null null
2025-05-15 15:02:27.959 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:02:27.965 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:02:28.009 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 15:02:28.024 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 15:02:28.025 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 15:02:28.025 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 15:02:28.025 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 15:02:28.026 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 15:02:28.026 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 15:02:28.026 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 15:02:28.026 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 15:02:28.027 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 15:02:28.029 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 15:02:28.031 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 15:02:28.032 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 15:02:28.033 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 15:02:28.034 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 15:02:28.035 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 15:02:28.036 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 15:02:28.037 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 15:02:28.037 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 15:02:28.038 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 15:02:28.039 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 15:02:28.040 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 15:02:28.041 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 15:02:28.041 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 15:02:28.042 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 15:02:28.043 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 15:02:28.043 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 15:02:28.044 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 15:02:28.045 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 15:02:28.046 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 15:02:28.047 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 15:02:28.047 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 15:02:28.050 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 15:02:28.051 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 15:02:28.051 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 15:02:28.052 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 15:02:28.053 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 15:02:28.054 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 15:02:28.055 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 15:02:28.055 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 15:02:28.056 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 15:02:28.056 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 15:02:28.056 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 15:02:28.057 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 15:02:28.057 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 15:02:28.058 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 15:02:28.058 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 15:02:28.059 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 15:02:28.059 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 15:02:28.060 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 15:02:28.060 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 15:02:28.060 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1
2025-05-15 15:02:28.065 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1 and user 3
2025-05-15 15:02:28.066 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:02:28.074 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 108.6538ms
2025-05-15 15:02:28.074 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:02:28.074 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 115.5656ms
2025-05-15 15:02:28.202 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:02:28.203 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:02:28.206 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:02:28.274 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:02:28.329 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:02:28.332 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 125.6685ms
2025-05-15 15:02:28.332 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:02:28.332 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 129.7624ms
2025-05-15 15:02:28.367 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:02:28.367 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:28.371 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:02:28.386 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:02:28.387 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:02:28.389 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 17.978ms
2025-05-15 15:02:28.389 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:28.389 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 22.657ms
2025-05-15 15:02:29.929 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:02:29.931 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:29.931 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:02:29.937 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:02:29.938 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:02:29.938 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.7702ms
2025-05-15 15:02:29.938 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:29.938 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 9.1602ms
2025-05-15 15:02:32.052 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:02:32.052 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:02:32.052 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:02:32.061 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:02:32.061 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:02:32.062 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 9.3384ms
2025-05-15 15:02:32.062 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:02:32.062 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 10.2164ms
2025-05-15 15:02:33.820 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 15:02:33.821 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 15:02:33.825 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:02:33.843 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 15:02:33.853 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 15:02:33.861 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 15:02:33.967 +07:00 [INF] Executed DbCommand (27ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 15:02:33.981 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-15 15:02:33.983 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 15:02:33.991 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:02:33.993 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 167.8112ms
2025-05-15 15:02:33.993 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 15:02:33.993 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 173.0699ms
2025-05-15 15:02:34.063 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:02:34.063 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:34.064 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:02:34.071 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:02:34.071 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:02:34.072 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 7.9429ms
2025-05-15 15:02:34.072 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:34.072 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 9.139ms
2025-05-15 15:02:34.131 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/2/1 - null null
2025-05-15 15:02:34.131 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:34.132 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/2/1 - 204 null null 0.6347ms
2025-05-15 15:02:34.133 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/1 - null null
2025-05-15 15:02:34.133 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:34.133 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:34.133 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 15:02:34.137 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:02:34.153 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-15 15:02:34.154 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 16.7557ms
2025-05-15 15:02:34.154 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 15:02:34.154 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/1 - 200 null application/json; charset=utf-8 20.862ms
2025-05-15 15:02:36.448 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/2 - null null
2025-05-15 15:02:36.448 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.448 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/2 - 204 null null 0.421ms
2025-05-15 15:02:36.450 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/2 - null null
2025-05-15 15:02:36.451 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.453 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.454 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:02:36.454 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:02:36.496 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 15:02:36.522 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 15:02:36.522 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 15:02:36.523 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 15:02:36.523 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 15:02:36.523 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 15:02:36.523 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 15:02:36.524 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 15:02:36.524 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 15:02:36.524 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 15:02:36.525 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 15:02:36.525 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 15:02:36.526 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 15:02:36.526 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 15:02:36.528 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 15:02:36.529 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 15:02:36.529 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 15:02:36.529 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 15:02:36.530 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 15:02:36.530 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 15:02:36.531 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 15:02:36.531 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 15:02:36.532 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 15:02:36.533 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 15:02:36.533 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 15:02:36.533 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 15:02:36.534 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 15:02:36.534 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 15:02:36.535 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 15:02:36.535 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 15:02:36.535 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 15:02:36.535 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 15:02:36.536 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 15:02:36.536 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 15:02:36.536 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 15:02:36.536 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 15:02:36.537 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 15:02:36.537 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 15:02:36.537 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 15:02:36.537 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 15:02:36.538 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 15:02:36.538 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 15:02:36.538 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 15:02:36.538 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 15:02:36.539 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 15:02:36.539 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 15:02:36.539 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 15:02:36.539 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 15:02:36.540 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 15:02:36.540 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 15:02:36.540 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 15:02:36.540 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1
2025-05-15 15:02:36.540 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1 and user 2
2025-05-15 15:02:36.540 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:02:36.541 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 86.9306ms
2025-05-15 15:02:36.541 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:02:36.541 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 90.6551ms
2025-05-15 15:02:36.551 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:02:36.551 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.551 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.4127ms
2025-05-15 15:02:36.553 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:02:36.553 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.553 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.554 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:02:36.554 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:02:36.559 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:02:36.560 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:02:36.560 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 6.5098ms
2025-05-15 15:02:36.560 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:02:36.560 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 7.3514ms
2025-05-15 15:02:36.568 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:02:36.568 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.569 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.4081ms
2025-05-15 15:02:36.570 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:02:36.570 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.571 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:36.571 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:36.571 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:02:36.575 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:02:36.575 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:02:36.576 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.7091ms
2025-05-15 15:02:36.576 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:36.576 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.6726ms
2025-05-15 15:02:43.288 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:02:43.288 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:43.288 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.3753ms
2025-05-15 15:02:43.289 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:02:43.289 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:43.290 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:43.290 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:43.290 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:02:43.296 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:02:43.297 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:02:43.297 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 7.3026ms
2025-05-15 15:02:43.297 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:02:43.298 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 8.3892ms
2025-05-15 15:02:52.327 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 15:02:52.327 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:52.327 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/leave_group/1/2 - 204 null null 0.4174ms
2025-05-15 15:02:52.328 +07:00 [INF] Request starting HTTP/1.1 DELETE http://localhost:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 15:02:52.328 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:52.329 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:02:52.331 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 15:02:52.334 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:02:52.366 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 15:02:52.391 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 15:02:52.396 +07:00 [INF] User 2 unsubscribed from channel conversation:1
2025-05-15 15:02:52.397 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 15:02:52.401 +07:00 [INF] Published message to channel conversation:1
2025-05-15 15:02:52.401 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:02:52.401 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 66.8434ms
2025-05-15 15:02:52.401 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 15:02:52.401 +07:00 [INF] Request finished HTTP/1.1 DELETE http://localhost:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 73.1566ms
2025-05-15 15:04:20.935 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:04:20.936 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:04:20.937 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:04:20.948 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:04:20.949 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:04:20.949 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 12.4176ms
2025-05-15 15:04:20.949 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:04:20.949 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 13.9341ms
2025-05-15 15:04:24.650 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:04:24.651 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:04:24.651 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:04:24.665 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:04:24.665 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:04:24.665 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 14.2855ms
2025-05-15 15:04:24.665 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:04:24.665 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 14.9358ms
2025-05-15 15:04:26.230 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 15:04:26.232 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 15:04:26.232 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:04:26.239 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 15:04:26.244 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 15:04:26.251 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 15:04:26.259 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 15:04:26.260 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-15 15:04:26.260 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 15:04:26.261 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:04:26.261 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 29.1476ms
2025-05-15 15:04:26.261 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 15:04:26.261 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 31.1187ms
2025-05-15 15:04:26.328 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:04:26.328 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:04:26.328 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:04:26.331 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:04:26.332 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:04:26.333 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.0739ms
2025-05-15 15:04:26.333 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:04:26.334 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 5.7913ms
2025-05-15 15:04:38.195 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 15:04:38.195 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.195 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.2232ms
2025-05-15 15:04:38.196 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-15 15:04:38.197 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.197 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.197 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:04:38.197 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:04:38.206 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:04:38.207 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:04:38.207 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 10.2587ms
2025-05-15 15:04:38.207 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:04:38.208 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 11.1565ms
2025-05-15 15:04:38.334 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 15:04:38.334 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.334 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.334 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:04:38.334 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:04:38.344 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:04:38.344 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:04:38.344 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 9.5964ms
2025-05-15 15:04:38.344 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:04:38.344 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 10.1255ms
2025-05-15 15:04:38.504 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:04:38.504 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.504 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.4525ms
2025-05-15 15:04:38.506 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:04:38.506 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.506 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.2752ms
2025-05-15 15:04:38.507 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:04:38.507 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.507 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.507 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:04:38.507 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:04:38.520 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:04:38.520 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:04:38.521 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 13.8564ms
2025-05-15 15:04:38.521 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:04:38.521 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 14.3207ms
2025-05-15 15:04:38.522 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:04:38.522 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.522 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.522 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:04:38.523 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:04:38.525 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:04:38.525 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:04:38.525 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 2.7713ms
2025-05-15 15:04:38.525 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:04:38.526 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 3.431ms
2025-05-15 15:04:38.645 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:04:38.645 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.645 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:38.645 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:04:38.645 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:04:38.774 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:04:38.774 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:04:38.776 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:04:38.780 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:04:38.781 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:04:38.784 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:04:38.784 +07:00 [ERR] Connection id "0HNCJGOGD7K1D", Request id "0HNCJGOGD7K1D:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:04:38.787 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 142.0845ms
2025-05-15 15:04:41.408 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/2 - null null
2025-05-15 15:04:41.409 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.409 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/2 - 204 null null 0.442ms
2025-05-15 15:04:41.410 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/2 - null null
2025-05-15 15:04:41.410 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.411 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.411 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:04:41.411 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:04:41.414 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 15:04:41.426 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 15:04:41.426 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 15:04:41.426 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 15:04:41.426 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 15:04:41.427 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 15:04:41.427 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 15:04:41.427 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 15:04:41.427 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 15:04:41.427 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 15:04:41.427 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 15:04:41.427 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 15:04:41.428 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 15:04:41.428 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 15:04:41.428 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 15:04:41.428 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 15:04:41.428 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 15:04:41.428 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 15:04:41.428 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 15:04:41.429 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 15:04:41.429 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 15:04:41.429 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 15:04:41.429 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 15:04:41.429 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 15:04:41.429 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 15:04:41.429 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 15:04:41.429 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 15:04:41.430 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 15:04:41.430 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 15:04:41.430 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 15:04:41.430 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 15:04:41.430 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 15:04:41.430 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 15:04:41.431 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 15:04:41.431 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 15:04:41.431 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 15:04:41.433 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 15:04:41.434 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 15:04:41.434 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 15:04:41.435 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 15:04:41.435 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 15:04:41.435 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 15:04:41.435 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 15:04:41.435 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 15:04:41.435 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 15:04:41.435 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 15:04:41.436 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 15:04:41.436 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 15:04:41.436 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 15:04:41.436 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 15:04:41.437 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 15:04:41.437 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1
2025-05-15 15:04:41.437 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1 and user 2
2025-05-15 15:04:41.437 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:04:41.437 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 25.9916ms
2025-05-15 15:04:41.437 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:04:41.437 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 27.031ms
2025-05-15 15:04:41.446 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:04:41.446 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.446 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.2339ms
2025-05-15 15:04:41.447 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:04:41.447 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.448 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.448 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:04:41.448 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:04:41.455 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:04:41.455 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:04:41.456 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.7768ms
2025-05-15 15:04:41.456 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:04:41.456 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 8.6405ms
2025-05-15 15:04:41.461 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:04:41.461 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.462 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.1925ms
2025-05-15 15:04:41.463 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:04:41.463 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.463 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:41.463 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:04:41.463 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:04:41.467 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:04:41.467 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:04:41.468 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.3785ms
2025-05-15 15:04:41.468 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:04:41.468 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.9919ms
2025-05-15 15:04:43.851 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:04:43.851 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:43.851 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:43.851 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:04:43.851 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:04:43.857 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:04:43.857 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:43.857 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:43.857 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:04:43.858 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:04:43.859 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:04:43.859 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:04:43.860 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:04:43.861 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:04:43.861 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:04:43.862 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:04:43.863 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:04:43.863 +07:00 [ERR] Connection id "0HNCJGOGD7K1F", Request id "0HNCJGOGD7K1F:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:04:43.864 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:04:43.866 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 15.5217ms
2025-05-15 15:04:43.866 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 8.8792ms
2025-05-15 15:04:43.867 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:04:43.867 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 9.6796ms
2025-05-15 15:04:48.149 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 15:04:48.149 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:48.150 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/leave_group/1/2 - 204 null null 0.4531ms
2025-05-15 15:04:48.151 +07:00 [INF] Request starting HTTP/1.1 DELETE http://localhost:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 15:04:48.151 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:48.151 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:48.151 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 15:04:48.152 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:04:48.158 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 15:04:48.163 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 15:04:48.163 +07:00 [INF] User 2 unsubscribed from channel conversation:1
2025-05-15 15:04:48.164 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 15:04:48.167 +07:00 [INF] Published message to channel conversation:1
2025-05-15 15:04:48.167 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:04:48.168 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 16.3048ms
2025-05-15 15:04:48.168 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 15:04:48.168 +07:00 [INF] Request finished HTTP/1.1 DELETE http://localhost:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 17.1957ms
2025-05-15 15:04:48.884 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:04:48.885 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:48.885 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:48.885 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:04:48.885 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:04:48.887 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:04:48.888 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:04:48.889 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:04:48.890 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:04:48.890 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:04:48.891 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:04:48.891 +07:00 [ERR] Connection id "0HNCJGOGD7K1G", Request id "0HNCJGOGD7K1G:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:04:48.894 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 9.815ms
2025-05-15 15:04:53.913 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:04:53.913 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:53.913 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:53.913 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:04:53.913 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:04:53.916 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:04:53.916 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:04:53.917 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:04:53.918 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:04:53.918 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:04:53.921 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:04:53.922 +07:00 [ERR] Connection id "0HNCJGOGD7K1H", Request id "0HNCJGOGD7K1H:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:04:53.923 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 10.0138ms
2025-05-15 15:04:58.934 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:04:58.934 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:58.934 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:04:58.934 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:04:58.935 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:04:58.936 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:04:58.936 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:04:58.937 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:04:58.937 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:04:58.937 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:04:58.938 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:04:58.938 +07:00 [ERR] Connection id "0HNCJGOGD7K1I", Request id "0HNCJGOGD7K1I:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:04:58.939 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5.0287ms
2025-05-15 15:05:03.949 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:03.950 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:03.950 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:03.950 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:03.950 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:03.953 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:03.953 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:03.955 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:03.956 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:03.958 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:03.959 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:03.960 +07:00 [ERR] Connection id "0HNCJGOGD7K1J", Request id "0HNCJGOGD7K1J:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:03.966 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 17.1509ms
2025-05-15 15:05:07.147 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:05:07.148 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.148 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - 204 null null 0.2569ms
2025-05-15 15:05:07.150 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:05:07.150 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.150 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.151 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:05:07.151 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:05:07.157 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19
2025-05-15 15:05:07.157 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19 and user 2
2025-05-15 15:05:07.157 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:05:07.158 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 6.4579ms
2025-05-15 15:05:07.158 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:05:07.158 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 7.5922ms
2025-05-15 15:05:07.169 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:05:07.169 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.169 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2095ms
2025-05-15 15:05:07.170 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:05:07.170 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.171 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.171 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:05:07.173 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:05:07.192 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:05:07.195 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:05:07.195 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 22.0915ms
2025-05-15 15:05:07.195 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:05:07.195 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 25.2145ms
2025-05-15 15:05:07.203 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:05:07.203 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.203 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.2466ms
2025-05-15 15:05:07.205 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:05:07.205 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.205 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:07.205 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:05:07.205 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:05:07.209 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:05:07.210 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:05:07.210 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.9814ms
2025-05-15 15:05:07.210 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:05:07.211 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 5.8579ms
2025-05-15 15:05:08.751 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:05:08.751 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:05:08.751 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:05:08.769 +07:00 [INF] Retrieved 64 messages from Redis for conversation 19
2025-05-15 15:05:08.769 +07:00 [INF] Retrieved 50 messages from Redis for conversation 19 and user 3
2025-05-15 15:05:08.769 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:05:08.770 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 18.4813ms
2025-05-15 15:05:08.770 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:05:08.770 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 19.1825ms
2025-05-15 15:05:08.864 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:05:08.864 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:05:08.864 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:05:08.897 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:05:08.897 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:05:08.897 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 32.8808ms
2025-05-15 15:05:08.897 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:05:08.897 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 33.3756ms
2025-05-15 15:05:08.943 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:05:08.943 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:05:08.943 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:05:08.947 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:05:08.947 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:05:08.947 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.3331ms
2025-05-15 15:05:08.948 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:05:08.948 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 4.7803ms
2025-05-15 15:05:08.975 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:08.975 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:08.975 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:08.975 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:08.975 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:08.977 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:08.977 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:08.978 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:08.978 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:08.979 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:08.979 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:08.979 +07:00 [ERR] Connection id "0HNCJGOGD7K1O", Request id "0HNCJGOGD7K1O:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:08.980 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 4.9613ms
2025-05-15 15:05:10.435 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:10.435 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:10.435 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:10.495 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:10.495 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:10.530 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:10.531 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:10.531 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:10.531 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:10.531 +07:00 [ERR] Connection id "0HNCJGOGD7K1P", Request id "0HNCJGOGD7K1P:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:10.534 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 99.6526ms
2025-05-15 15:05:13.986 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:13.986 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:13.986 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:13.986 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:13.987 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:13.996 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:13.996 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:13.997 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:13.998 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:14.000 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:14.003 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:14.004 +07:00 [ERR] Connection id "0HNCJGOGD7K1Q", Request id "0HNCJGOGD7K1Q:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:14.006 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 19.6868ms
2025-05-15 15:05:15.584 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:15.585 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:15.585 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:15.640 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:15.640 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:15.647 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:15.648 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:15.648 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:15.649 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:15.649 +07:00 [ERR] Connection id "0HNCJGOGD7K1R", Request id "0HNCJGOGD7K1R:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:15.655 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 70.1216ms
2025-05-15 15:05:18.329 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:18.329 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:18.329 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:18.330 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:18.330 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:18.342 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:18.342 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:18.342 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:18.343 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:18.343 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:18.344 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:18.344 +07:00 [ERR] Connection id "0HNCJGOGD7K1S", Request id "0HNCJGOGD7K1S:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:18.346 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 16.3318ms
2025-05-15 15:05:19.015 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:19.015 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:19.015 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:19.015 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:19.016 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:19.042 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:19.042 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:19.043 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:19.044 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:19.045 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:19.046 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:19.046 +07:00 [ERR] Connection id "0HNCJGOGD7K1T", Request id "0HNCJGOGD7K1T:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:19.048 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 33.0325ms
2025-05-15 15:05:20.672 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:20.673 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:20.673 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:20.693 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:20.693 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:20.702 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:20.705 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:20.705 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:20.706 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:20.706 +07:00 [ERR] Connection id "0HNCJGOGD7K1U", Request id "0HNCJGOGD7K1U:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:20.708 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 35.7649ms
2025-05-15 15:05:23.351 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:23.351 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:23.351 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:23.352 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:23.352 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:23.364 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:23.364 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:23.365 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:23.366 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:23.366 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:23.368 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:23.368 +07:00 [ERR] Connection id "0HNCJGOGD7K1V", Request id "0HNCJGOGD7K1V:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:23.369 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 17.9847ms
2025-05-15 15:05:24.199 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:24.199 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:24.199 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:24.199 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:24.200 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:24.208 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:24.209 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:24.209 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:24.210 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:24.210 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:24.211 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:24.211 +07:00 [ERR] Connection id "0HNCJGOGD7K20", Request id "0HNCJGOGD7K20:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:24.213 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 14.5426ms
2025-05-15 15:05:25.717 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:25.718 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:25.718 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:25.729 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:25.729 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:25.738 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:25.738 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:25.739 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:25.740 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:25.740 +07:00 [ERR] Connection id "0HNCJGOGD7K21", Request id "0HNCJGOGD7K21:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:25.741 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 23.5165ms
2025-05-15 15:05:25.988 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:25.988 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:25.989 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:26.029 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:26.030 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:26.041 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:26.041 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:26.042 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:26.042 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:26.043 +07:00 [ERR] Connection id "0HNCJGOGD7K22", Request id "0HNCJGOGD7K22:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:26.043 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 55.717ms
2025-05-15 15:05:28.384 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:28.385 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:28.385 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:28.385 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:28.385 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:28.386 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:28.387 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:28.387 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:28.388 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:28.388 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:28.389 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:28.389 +07:00 [ERR] Connection id "0HNCJGOGD7K23", Request id "0HNCJGOGD7K23:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:28.394 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 7.6785ms
2025-05-15 15:05:29.228 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:29.228 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:29.229 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:29.229 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:29.230 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:29.233 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:29.233 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:29.238 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:29.241 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:29.241 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:29.245 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:29.245 +07:00 [ERR] Connection id "0HNCJGOGD7K24", Request id "0HNCJGOGD7K24:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:29.251 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 22.7825ms
2025-05-15 15:05:30.776 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:30.777 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:30.777 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:30.791 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:30.791 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:30.796 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:30.796 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:30.799 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:30.802 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:30.803 +07:00 [ERR] Connection id "0HNCJGOGD7K25", Request id "0HNCJGOGD7K25:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:30.807 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 30.8514ms
2025-05-15 15:05:31.055 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:31.055 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:31.055 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:31.080 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:31.080 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:31.086 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:31.087 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:31.087 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:31.088 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:31.088 +07:00 [ERR] Connection id "0HNCJGOGD7K26", Request id "0HNCJGOGD7K26:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:31.088 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 33.8505ms
2025-05-15 15:05:33.407 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:33.408 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:33.408 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:33.408 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:33.408 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:33.409 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:33.409 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:33.410 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:33.410 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:33.410 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:33.411 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:33.411 +07:00 [ERR] Connection id "0HNCJGOGD7K27", Request id "0HNCJGOGD7K27:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:33.412 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 4.3018ms
2025-05-15 15:05:34.261 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:34.261 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:34.262 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:34.262 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:34.262 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:34.266 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:34.266 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:34.268 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:34.268 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:34.268 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:34.269 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:34.270 +07:00 [ERR] Connection id "0HNCJGOGD7K28", Request id "0HNCJGOGD7K28:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:34.274 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 12.9414ms
2025-05-15 15:05:35.816 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:35.817 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:35.818 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:35.838 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:35.839 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:35.848 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:35.848 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:35.848 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:35.850 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:35.850 +07:00 [ERR] Connection id "0HNCJGOGD7K29", Request id "0HNCJGOGD7K29:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:35.852 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 35.7235ms
2025-05-15 15:05:36.097 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:36.098 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:36.099 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:36.111 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:36.111 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:36.120 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:36.123 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:36.124 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:36.125 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:36.125 +07:00 [ERR] Connection id "0HNCJGOGD7K2A", Request id "0HNCJGOGD7K2A:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:36.126 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 28.7445ms
2025-05-15 15:05:36.275 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:05:36.276 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.276 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - 204 null null 0.3353ms
2025-05-15 15:05:36.277 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:05:36.277 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.277 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.277 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:05:36.277 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:05:36.282 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19
2025-05-15 15:05:36.282 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19 and user 2
2025-05-15 15:05:36.282 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:05:36.283 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 5.471ms
2025-05-15 15:05:36.283 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:05:36.283 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 5.951ms
2025-05-15 15:05:36.291 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:05:36.291 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.291 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.1931ms
2025-05-15 15:05:36.292 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:05:36.292 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.292 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.292 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:05:36.293 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:05:36.306 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:05:36.307 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:05:36.307 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 14.6301ms
2025-05-15 15:05:36.307 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:05:36.307 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 15.0986ms
2025-05-15 15:05:36.312 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:05:36.312 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.312 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.2088ms
2025-05-15 15:05:36.314 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:05:36.314 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.314 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:36.314 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:05:36.314 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:05:36.319 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:05:36.319 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:05:36.320 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.7089ms
2025-05-15 15:05:36.320 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:05:36.320 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 6.2069ms
2025-05-15 15:05:38.157 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:38.158 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:38.158 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:38.159 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:38.159 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:38.162 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:38.162 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:38.163 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:38.164 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:38.165 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:38.176 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:38.176 +07:00 [ERR] Connection id "0HNCJGOGD7K2B", Request id "0HNCJGOGD7K2B:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:38.189 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 31.6945ms
2025-05-15 15:05:38.417 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:38.417 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:38.417 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:38.417 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:38.417 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:38.429 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:38.429 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:38.430 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:38.430 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:38.430 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:38.431 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:38.431 +07:00 [ERR] Connection id "0HNCJGOGD7K2C", Request id "0HNCJGOGD7K2C:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:38.433 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 16.7646ms
2025-05-15 15:05:39.285 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:39.285 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:39.285 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:39.285 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:39.286 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:39.288 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:39.288 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:39.289 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:39.290 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:39.290 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:39.294 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:39.294 +07:00 [ERR] Connection id "0HNCJGOGD7K2D", Request id "0HNCJGOGD7K2D:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:39.297 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 11.7137ms
2025-05-15 15:05:40.868 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:40.869 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:40.869 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:40.883 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:40.884 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:40.903 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:40.903 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:40.904 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:40.906 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:40.906 +07:00 [ERR] Connection id "0HNCJGOGD7K2E", Request id "0HNCJGOGD7K2E:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:40.908 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 39.2342ms
2025-05-15 15:05:41.134 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:41.134 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:41.134 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:41.146 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:41.146 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:41.155 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:41.155 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:41.155 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:41.158 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:41.158 +07:00 [ERR] Connection id "0HNCJGOGD7K2F", Request id "0HNCJGOGD7K2F:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:41.159 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 25.7862ms
2025-05-15 15:05:43.196 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:43.196 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:43.196 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:43.196 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:43.196 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:43.198 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:43.198 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:43.198 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:43.198 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:43.199 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:43.199 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:43.200 +07:00 [ERR] Connection id "0HNCJGOGD7K2G", Request id "0HNCJGOGD7K2G:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:43.203 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 7.0526ms
2025-05-15 15:05:43.450 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:43.450 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:43.451 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:43.451 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:43.451 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:43.453 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:43.454 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:43.454 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:43.455 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:43.455 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:43.456 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:43.456 +07:00 [ERR] Connection id "0HNCJGOGD7K2H", Request id "0HNCJGOGD7K2H:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:43.459 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 8.9187ms
2025-05-15 15:05:44.308 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:44.308 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:44.308 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:44.308 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:44.309 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:44.310 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:44.311 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:44.314 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:44.315 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:44.316 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:44.317 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:44.317 +07:00 [ERR] Connection id "0HNCJGOGD7K2I", Request id "0HNCJGOGD7K2I:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:44.319 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 11.3297ms
2025-05-15 15:05:45.918 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:45.918 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:45.918 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:45.932 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:45.932 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:45.941 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:45.942 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:45.942 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:45.943 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:45.943 +07:00 [ERR] Connection id "0HNCJGOGD7K2J", Request id "0HNCJGOGD7K2J:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:45.945 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 26.6665ms
2025-05-15 15:05:46.174 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:46.175 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:46.175 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:46.189 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:46.189 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:46.197 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:46.197 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:46.197 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:46.198 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:46.198 +07:00 [ERR] Connection id "0HNCJGOGD7K2K", Request id "0HNCJGOGD7K2K:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:46.199 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 25.0419ms
2025-05-15 15:05:48.208 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:48.208 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:48.208 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:48.208 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:48.208 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:48.209 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:48.209 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:48.210 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:48.210 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:48.211 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:48.211 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:48.211 +07:00 [ERR] Connection id "0HNCJGOGD7K2L", Request id "0HNCJGOGD7K2L:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:48.213 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5.309ms
2025-05-15 15:05:48.474 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:48.474 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:48.474 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:48.474 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:48.475 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:48.476 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:48.477 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:48.477 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:48.477 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:48.477 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:48.478 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:48.478 +07:00 [ERR] Connection id "0HNCJGOGD7K2M", Request id "0HNCJGOGD7K2M:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:48.478 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 3.8086ms
2025-05-15 15:05:49.324 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:49.324 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:49.324 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:49.324 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:49.324 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:49.326 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:49.326 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:49.326 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:49.326 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:49.326 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:49.327 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:49.327 +07:00 [ERR] Connection id "0HNCJGOGD7K2N", Request id "0HNCJGOGD7K2N:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:49.327 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 3.4679ms
2025-05-15 15:05:51.987 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:51.987 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:51.987 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:52.003 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:52.004 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:52.011 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:52.013 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:52.013 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:52.014 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:52.014 +07:00 [ERR] Connection id "0HNCJGOGD7K2O", Request id "0HNCJGOGD7K2O:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:52.017 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 29.7432ms
2025-05-15 15:05:53.218 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:53.218 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:53.218 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:53.219 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:53.219 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:53.221 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:53.221 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:53.223 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:53.223 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:53.223 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:53.225 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:53.225 +07:00 [ERR] Connection id "0HNCJGOGD7K2P", Request id "0HNCJGOGD7K2P:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:53.227 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 9.5938ms
2025-05-15 15:05:53.483 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:53.483 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:53.483 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:53.483 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:53.483 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:53.485 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:53.485 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:53.485 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:53.486 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:53.486 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:53.486 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:53.486 +07:00 [ERR] Connection id "0HNCJGOGD7K2Q", Request id "0HNCJGOGD7K2Q:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:53.487 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 4.1664ms
2025-05-15 15:05:54.116 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:54.116 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:54.116 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:54.116 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:54.116 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:54.137 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:54.137 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:54.139 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:54.141 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:54.141 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:54.143 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:54.143 +07:00 [ERR] Connection id "0HNCJGOGD7K2R", Request id "0HNCJGOGD7K2R:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:54.145 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 28.759ms
2025-05-15 15:05:54.401 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:54.401 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:54.402 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:54.402 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:54.402 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:54.412 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:54.413 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:54.415 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:54.417 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:54.418 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:54.421 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:54.422 +07:00 [ERR] Connection id "0HNCJGOGD7K2S", Request id "0HNCJGOGD7K2S:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:54.427 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 26.4125ms
2025-05-15 15:05:57.039 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:05:57.039 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:57.039 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:05:57.063 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:05:57.063 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:05:57.071 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:57.072 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:57.073 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:57.074 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:57.074 +07:00 [ERR] Connection id "0HNCJGOGD7K2T", Request id "0HNCJGOGD7K2T:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:57.076 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 37.2431ms
2025-05-15 15:05:58.238 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:58.238 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:58.238 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:58.238 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:58.239 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:58.242 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:58.242 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:58.244 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:58.245 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:58.245 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:58.246 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:58.246 +07:00 [ERR] Connection id "0HNCJGOGD7K2U", Request id "0HNCJGOGD7K2U:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:58.250 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 12.066ms
2025-05-15 15:05:58.501 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:58.502 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:58.502 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:58.502 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:58.503 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:58.507 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:58.507 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:58.509 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:58.511 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:58.513 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:58.518 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:58.519 +07:00 [ERR] Connection id "0HNCJGOGD7K2V", Request id "0HNCJGOGD7K2V:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:58.526 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 24.3579ms
2025-05-15 15:05:59.152 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:59.153 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:59.153 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:59.153 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:59.153 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:59.156 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:05:59.156 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:59.157 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:59.159 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:59.159 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:59.163 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:59.163 +07:00 [ERR] Connection id "0HNCJGOGD7K30", Request id "0HNCJGOGD7K30:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:59.166 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 14.0636ms
2025-05-15 15:05:59.439 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:05:59.439 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:59.439 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:05:59.439 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:05:59.439 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:05:59.442 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:05:59.443 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:05:59.444 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:05:59.446 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:05:59.447 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:05:59.454 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:05:59.456 +07:00 [ERR] Connection id "0HNCJGOGD7K31", Request id "0HNCJGOGD7K31:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:05:59.459 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 20.5101ms
2025-05-15 15:06:00.541 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 212
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 184
2025-05-15 15:06:00.550 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:06:00.550 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:06:00.552 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:06:00.552 +07:00 [ERR] Connection id "0HNCJGOGD7K11", Request id "0HNCJGOGD7K11:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:06:00.553 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 214118.3219ms
2025-05-15 15:06:03.259 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:06:03.259 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:06:03.260 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:06:03.260 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:06:03.260 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:06:03.262 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:06:03.262 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:06:03.262 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:06:03.262 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:06:03.262 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:06:03.263 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:06:03.263 +07:00 [ERR] Connection id "0HNCJGOGD7K32", Request id "0HNCJGOGD7K32:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:06:03.264 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 4.6909ms
2025-05-15 15:06:03.538 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:06:03.539 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:06:03.539 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:06:03.539 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:06:03.539 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:06:03.541 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:06:03.541 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:06:03.542 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:06:03.543 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:06:03.543 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:06:03.545 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:06:03.545 +07:00 [ERR] Connection id "0HNCJGOGD7K33", Request id "0HNCJGOGD7K33:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:06:03.547 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 8.2548ms
2025-05-15 15:06:03.839 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:06:03.839 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 243870.7815ms
2025-05-15 15:07:44.978 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 15:07:44.979 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:44.982 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 3.6905ms
2025-05-15 15:07:44.983 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-15 15:07:44.984 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:44.984 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:44.984 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:07:44.986 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:07:45.114 +07:00 [INF] Executed DbCommand (94ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:07:45.134 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:07:45.137 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 150.0781ms
2025-05-15 15:07:45.137 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:07:45.138 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 154.4634ms
2025-05-15 15:07:45.290 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 15:07:45.290 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.290 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.290 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:07:45.290 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:07:45.321 +07:00 [INF] Executed DbCommand (25ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:07:45.321 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:07:45.322 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 31.9848ms
2025-05-15 15:07:45.322 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:07:45.323 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 32.7258ms
2025-05-15 15:07:45.539 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:07:45.539 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.540 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 1.6249ms
2025-05-15 15:07:45.542 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:07:45.542 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.543 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 1.0051ms
2025-05-15 15:07:45.543 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:07:45.544 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.544 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.544 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:07:45.544 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:07:45.593 +07:00 [INF] Executed DbCommand (42ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:07:45.594 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:07:45.595 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 49.8422ms
2025-05-15 15:07:45.595 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:07:45.595 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 51.737ms
2025-05-15 15:07:45.596 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:07:45.596 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.596 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.596 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:07:45.596 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:07:45.598 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:07:45.599 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:07:45.599 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 2.8028ms
2025-05-15 15:07:45.599 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:07:45.599 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 3.2274ms
2025-05-15 15:07:45.621 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:07:45.621 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.621 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:07:45.621 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:07:45.622 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:07:45.767 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:07:45.768 +07:00 [INF] Added client with UserId 2. Total clients: 3
2025-05-15 15:07:45.775 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:08:08.820 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 60
2025-05-15 15:08:08.825 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:08:08.825 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:08:08.842 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:08:08.843 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:08:08.844 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 18.3003ms
2025-05-15 15:08:08.844 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:08:08.844 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 23.3513ms
2025-05-15 15:08:09.968 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:08:09.968 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:08:09.968 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:08:09.978 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:08:09.979 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:09.979 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 10.4089ms
2025-05-15 15:08:09.979 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:08:09.979 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 10.8173ms
2025-05-15 15:08:10.162 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:08:10.162 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:08:10.163 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:08:10.164 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:08:10.164 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:08:10.164 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:08:10.177 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:08:10.177 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:08:10.177 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 14.8665ms
2025-05-15 15:08:10.178 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:08:10.178 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 15.5161ms
2025-05-15 15:08:10.209 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:08:10.210 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:08:10.210 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 45.325ms
2025-05-15 15:08:10.210 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:08:10.210 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 45.9948ms
2025-05-15 15:08:10.560 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:08:10.560 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:10.560 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:08:10.855 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 15:08:10.855 +07:00 [INF] Added client with UserId 3. Total clients: 4
2025-05-15 15:08:10.865 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:08:10.901 +07:00 [INF] Executed DbCommand (27ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:08:12.975 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/3 - null null
2025-05-15 15:08:12.975 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:08:12.980 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:08:12.994 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 15:08:13.017 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 15:08:13.017 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 15:08:13.018 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 15:08:13.019 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 15:08:13.020 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 15:08:13.020 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 15:08:13.020 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 15:08:13.021 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 15:08:13.021 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 15:08:13.021 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 15:08:13.021 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 15:08:13.022 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 15:08:13.022 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 15:08:13.022 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 15:08:13.023 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 15:08:13.024 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 15:08:13.024 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 15:08:13.024 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 15:08:13.024 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 15:08:13.025 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 15:08:13.025 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 15:08:13.025 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 15:08:13.026 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 15:08:13.026 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 15:08:13.026 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 15:08:13.026 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 15:08:13.026 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 15:08:13.027 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 15:08:13.027 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 15:08:13.027 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 15:08:13.027 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 15:08:13.028 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 15:08:13.028 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 15:08:13.028 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 15:08:13.028 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 15:08:13.028 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 15:08:13.029 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 15:08:13.029 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 15:08:13.029 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 15:08:13.029 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 15:08:13.029 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 15:08:13.030 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 15:08:13.030 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 15:08:13.030 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 15:08:13.030 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 15:08:13.031 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 15:08:13.031 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 15:08:13.031 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 15:08:13.031 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 15:08:13.032 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 15:08:13.032 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1
2025-05-15 15:08:13.034 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1 and user 3
2025-05-15 15:08:13.034 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:08:13.036 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 56.2359ms
2025-05-15 15:08:13.036 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:08:13.036 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 61.3915ms
2025-05-15 15:08:13.116 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:08:13.116 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:08:13.116 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:08:13.126 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:08:13.127 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:08:13.127 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 11.3238ms
2025-05-15 15:08:13.127 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:08:13.127 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 11.9378ms
2025-05-15 15:08:13.235 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:08:13.235 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:13.235 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:13.238 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:08:13.239 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:13.239 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.1691ms
2025-05-15 15:08:13.239 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:13.239 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.5626ms
2025-05-15 15:08:15.210 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:08:15.210 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:15.210 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:15.212 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:08:15.212 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:15.212 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 2.3748ms
2025-05-15 15:08:15.212 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:15.212 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 2.7ms
2025-05-15 15:08:17.959 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:08:17.959 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:08:17.959 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:08:17.969 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:08:17.969 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:17.969 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 9.8904ms
2025-05-15 15:08:17.969 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:08:17.969 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 10.4324ms
2025-05-15 15:08:19.970 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 15:08:19.970 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 15:08:20.002 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:20.017 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 15:08:20.026 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 15:08:20.031 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 15:08:20.063 +07:00 [INF] Executed DbCommand (26ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 15:08:20.065 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-15 15:08:20.065 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 15:08:20.067 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:08:20.068 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 65.0487ms
2025-05-15 15:08:20.068 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 15:08:20.068 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 98.0566ms
2025-05-15 15:08:20.107 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:08:20.107 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:20.107 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:20.114 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:08:20.114 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:20.115 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 7.1288ms
2025-05-15 15:08:20.115 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:20.115 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 7.7832ms
2025-05-15 15:08:20.195 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/2/1 - null null
2025-05-15 15:08:20.195 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:20.195 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/2/1 - 204 null null 0.2339ms
2025-05-15 15:08:20.196 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/1 - null null
2025-05-15 15:08:20.197 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:20.197 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:20.197 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 15:08:20.197 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:08:20.199 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-15 15:08:20.199 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 1.6529ms
2025-05-15 15:08:20.199 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-15 15:08:20.199 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/1 - 200 null application/json; charset=utf-8 2.4184ms
2025-05-15 15:08:22.406 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/2 - null null
2025-05-15 15:08:22.406 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.406 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/2 - 204 null null 0.2867ms
2025-05-15 15:08:22.407 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/2 - null null
2025-05-15 15:08:22.407 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.407 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.407 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:08:22.408 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:08:22.409 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 15:08:22.414 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 15:08:22.414 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 15:08:22.415 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 15:08:22.415 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 15:08:22.415 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 15:08:22.415 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 15:08:22.416 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 15:08:22.416 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 15:08:22.416 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 15:08:22.416 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 15:08:22.417 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 15:08:22.417 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 15:08:22.417 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 15:08:22.417 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 15:08:22.418 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 15:08:22.418 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 15:08:22.418 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 15:08:22.418 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 15:08:22.418 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 15:08:22.419 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 15:08:22.419 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 15:08:22.419 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 15:08:22.419 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 15:08:22.420 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 15:08:22.420 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 15:08:22.420 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 15:08:22.421 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 15:08:22.421 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 15:08:22.421 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 15:08:22.422 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 15:08:22.422 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 15:08:22.422 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 15:08:22.422 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 15:08:22.423 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 15:08:22.423 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 15:08:22.423 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 15:08:22.423 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 15:08:22.424 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 15:08:22.424 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 15:08:22.424 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 15:08:22.424 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 15:08:22.424 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 15:08:22.425 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 15:08:22.425 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 15:08:22.425 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 15:08:22.425 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 15:08:22.426 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 15:08:22.426 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 15:08:22.426 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 15:08:22.426 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 15:08:22.426 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1
2025-05-15 15:08:22.426 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1 and user 2
2025-05-15 15:08:22.426 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:08:22.427 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 19.0653ms
2025-05-15 15:08:22.427 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:08:22.427 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/2 - 200 null application/json; charset=utf-8 19.6648ms
2025-05-15 15:08:22.437 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:08:22.437 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.437 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.1938ms
2025-05-15 15:08:22.438 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:08:22.439 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.439 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.439 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:08:22.439 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:08:22.445 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:08:22.445 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:08:22.446 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 6.859ms
2025-05-15 15:08:22.446 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:08:22.446 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 7.2847ms
2025-05-15 15:08:22.452 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:08:22.452 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.452 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.2749ms
2025-05-15 15:08:22.453 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:08:22.453 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.454 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:22.454 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:22.454 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:22.458 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:08:22.459 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:22.459 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.4627ms
2025-05-15 15:08:22.459 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:22.460 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.2704ms
2025-05-15 15:08:23.955 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:08:23.955 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:23.955 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:23.955 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:23.956 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:23.961 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:08:23.962 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:23.962 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.9969ms
2025-05-15 15:08:23.962 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:23.962 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 6.9197ms
2025-05-15 15:08:27.370 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 15:08:27.371 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:27.372 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/leave_group/1/2 - 204 null null 2.0526ms
2025-05-15 15:08:27.374 +07:00 [INF] Request starting HTTP/1.1 DELETE http://localhost:5053/api/Participant/leave_group/1/2 - null null
2025-05-15 15:08:27.374 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:27.374 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:27.374 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 15:08:27.375 +07:00 [INF] Route matched with {action = "LeaveGroup", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] LeaveGroup(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:27.382 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1
2025-05-15 15:08:27.395 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [Participants]
OUTPUT 1
WHERE [id] = @p0;
2025-05-15 15:08:27.396 +07:00 [INF] User 2 unsubscribed from channel conversation:1
2025-05-15 15:08:27.397 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 15:08:27.397 +07:00 [INF] Published message to channel conversation:1
2025-05-15 15:08:27.397 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:08:27.397 +07:00 [INF] Executed action server.Controllers.ParticipantController.LeaveGroup (Message_app) in 22.409ms
2025-05-15 15:08:27.397 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.LeaveGroup (Message_app)'
2025-05-15 15:08:27.398 +07:00 [INF] Request finished HTTP/1.1 DELETE http://localhost:5053/api/Participant/leave_group/1/2 - 200 null application/json; charset=utf-8 23.4374ms
2025-05-15 15:08:33.945 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:08:33.945 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:08:33.945 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:08:33.960 +07:00 [INF] Retrieved 64 messages from Redis for conversation 19
2025-05-15 15:08:33.961 +07:00 [INF] Retrieved 50 messages from Redis for conversation 19 and user 3
2025-05-15 15:08:33.961 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:08:33.961 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 16.2242ms
2025-05-15 15:08:33.961 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:08:33.961 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 16.66ms
2025-05-15 15:08:33.995 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:08:33.995 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:08:33.995 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:08:34.002 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:08:34.003 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:08:34.003 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.892ms
2025-05-15 15:08:34.003 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:08:34.003 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 8.3525ms
2025-05-15 15:08:34.023 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:08:34.024 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:34.024 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:34.029 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:08:34.029 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:34.030 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.3422ms
2025-05-15 15:08:34.030 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:34.030 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 6.3597ms
2025-05-15 15:08:34.798 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:08:34.798 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.798 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - 204 null null 0.2178ms
2025-05-15 15:08:34.799 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:08:34.799 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.799 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.799 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:08:34.799 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:08:34.803 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19
2025-05-15 15:08:34.803 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19 and user 2
2025-05-15 15:08:34.803 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:08:34.803 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 3.5568ms
2025-05-15 15:08:34.803 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:08:34.803 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 4.0671ms
2025-05-15 15:08:34.810 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:08:34.811 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.811 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2226ms
2025-05-15 15:08:34.812 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:08:34.812 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.812 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.812 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:08:34.812 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:08:34.821 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:08:34.822 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:08:34.822 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 9.7553ms
2025-05-15 15:08:34.822 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:08:34.822 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 10.5512ms
2025-05-15 15:08:34.828 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:08:34.828 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.828 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.1878ms
2025-05-15 15:08:34.829 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:08:34.829 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.829 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:34.829 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:34.829 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:08:34.832 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:08:34.833 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:08:34.833 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.4345ms
2025-05-15 15:08:34.833 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:08:34.833 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 3.9179ms
2025-05-15 15:08:35.790 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:08:35.791 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:35.791 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:08:35.826 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:08:35.826 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:08:35.854 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:35.861 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:35.862 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:35.866 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:35.867 +07:00 [ERR] Connection id "0HNCJGOGD7K3L", Request id "0HNCJGOGD7K3L:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:35.869 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 78.727ms
2025-05-15 15:08:40.878 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:08:40.878 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:40.879 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:08:40.907 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:08:40.907 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:08:40.917 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:40.918 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:40.918 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:40.919 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:40.919 +07:00 [ERR] Connection id "0HNCJGOGD7K3M", Request id "0HNCJGOGD7K3M:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:40.920 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 42.2381ms
2025-05-15 15:08:44.260 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:08:44.260 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:44.260 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:44.262 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:44.262 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:08:44.279 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:08:44.279 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:08:44.280 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:44.281 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:44.282 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:44.284 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:44.285 +07:00 [ERR] Connection id "0HNCJGOGD7K3N", Request id "0HNCJGOGD7K3N:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:44.287 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 26.972ms
2025-05-15 15:08:45.937 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:08:45.938 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:45.938 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:08:45.954 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:08:45.954 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:08:45.962 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:45.963 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:45.964 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:45.966 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:45.966 +07:00 [ERR] Connection id "0HNCJGOGD7K3O", Request id "0HNCJGOGD7K3O:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:45.968 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 30.5662ms
2025-05-15 15:08:49.299 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:08:49.299 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:49.299 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:49.299 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:49.299 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:08:49.300 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:08:49.300 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:08:49.301 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:49.302 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:49.302 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:49.303 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:49.303 +07:00 [ERR] Connection id "0HNCJGOGD7K3P", Request id "0HNCJGOGD7K3P:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:49.304 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5.3911ms
2025-05-15 15:08:50.980 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:08:50.980 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:50.980 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:08:50.991 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:08:50.991 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:08:50.998 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:50.999 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:50.999 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:51.000 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:51.000 +07:00 [ERR] Connection id "0HNCJGOGD7K3Q", Request id "0HNCJGOGD7K3Q:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:51.005 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 25.6287ms
2025-05-15 15:08:54.333 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:08:54.334 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:54.334 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:54.334 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:54.334 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:08:54.337 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:08:54.337 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:08:54.338 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:54.339 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:54.339 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:54.341 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:54.342 +07:00 [ERR] Connection id "0HNCJGOGD7K3R", Request id "0HNCJGOGD7K3R:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:54.343 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 9.9162ms
2025-05-15 15:08:56.021 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:08:56.021 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:56.021 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:08:56.036 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:08:56.036 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:08:56.045 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:56.045 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:56.045 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:56.046 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:56.047 +07:00 [ERR] Connection id "0HNCJGOGD7K3S", Request id "0HNCJGOGD7K3S:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:56.048 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 27.013ms
2025-05-15 15:08:57.781 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:08:57.781 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:57.781 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:57.781 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:57.781 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:08:57.784 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:08:57.784 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:08:57.784 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:57.785 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:57.785 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:57.786 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:57.786 +07:00 [ERR] Connection id "0HNCJGOGD7K3T", Request id "0HNCJGOGD7K3T:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:57.787 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 6.8345ms
2025-05-15 15:08:59.357 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:08:59.357 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:59.358 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:08:59.358 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:08:59.358 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:08:59.359 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:08:59.360 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:08:59.360 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:08:59.360 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:08:59.361 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:08:59.361 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:08:59.361 +07:00 [ERR] Connection id "0HNCJGOGD7K3U", Request id "0HNCJGOGD7K3U:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:08:59.363 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 6.4578ms
2025-05-15 15:09:01.060 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:01.060 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:01.060 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:01.073 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:01.073 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:01.082 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:01.086 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:01.086 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:01.089 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:01.089 +07:00 [ERR] Connection id "0HNCJGOGD7K3V", Request id "0HNCJGOGD7K3V:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:01.093 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 32.4653ms
2025-05-15 15:09:02.815 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:02.816 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:02.816 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:02.816 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:02.816 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:02.819 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:02.819 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:02.820 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:02.821 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:02.822 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:02.828 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:02.828 +07:00 [ERR] Connection id "0HNCJGOGD7K40", Request id "0HNCJGOGD7K40:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:02.830 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 14.3825ms
2025-05-15 15:09:04.371 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:04.371 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:04.371 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:04.371 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:04.372 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:04.374 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:04.375 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:04.376 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:04.377 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:04.378 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:04.381 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:04.382 +07:00 [ERR] Connection id "0HNCJGOGD7K41", Request id "0HNCJGOGD7K41:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:04.385 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 13.7776ms
2025-05-15 15:09:06.105 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:06.105 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:06.105 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:06.118 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:06.118 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:06.127 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:06.128 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:06.128 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:06.129 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:06.129 +07:00 [ERR] Connection id "0HNCJGOGD7K42", Request id "0HNCJGOGD7K42:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:06.130 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 25.0507ms
2025-05-15 15:09:11.143 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:11.143 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:11.143 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:11.157 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:11.157 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:11.165 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:11.165 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:11.165 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:11.166 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:11.166 +07:00 [ERR] Connection id "0HNCJGOGD7K43", Request id "0HNCJGOGD7K43:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:11.166 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 23.6664ms
2025-05-15 15:09:16.199 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:16.200 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:16.200 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:16.214 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:16.214 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:16.222 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:16.223 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:16.223 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:16.225 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:16.225 +07:00 [ERR] Connection id "0HNCJGOGD7K44", Request id "0HNCJGOGD7K44:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:16.226 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 26.5941ms
2025-05-15 15:09:21.243 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:21.244 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:21.244 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:21.259 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:21.259 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:21.266 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:21.267 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:21.267 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:21.269 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:21.269 +07:00 [ERR] Connection id "0HNCJGOGD7K45", Request id "0HNCJGOGD7K45:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:21.269 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 25.8951ms
2025-05-15 15:09:24.069 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 15:09:24.070 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.070 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.2456ms
2025-05-15 15:09:24.071 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-15 15:09:24.071 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.071 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.071 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:09:24.071 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:09:24.088 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:09:24.091 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:09:24.091 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 19.7424ms
2025-05-15 15:09:24.091 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:09:24.091 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 20.189ms
2025-05-15 15:09:24.213 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 15:09:24.213 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.213 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.213 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:09:24.213 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:09:24.238 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:09:24.238 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:09:24.239 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 24.9707ms
2025-05-15 15:09:24.239 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:09:24.239 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 25.5878ms
2025-05-15 15:09:24.387 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:09:24.387 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.387 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.2646ms
2025-05-15 15:09:24.388 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:09:24.388 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.388 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.1494ms
2025-05-15 15:09:24.388 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:09:24.389 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.389 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.389 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:09:24.389 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:09:24.415 +07:00 [INF] Executed DbCommand (24ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:09:24.415 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:09:24.415 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 25.9221ms
2025-05-15 15:09:24.415 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:09:24.416 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 27.2334ms
2025-05-15 15:09:24.417 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:09:24.417 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.417 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.417 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:09:24.417 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:09:24.419 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:09:24.419 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:09:24.420 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 2.4147ms
2025-05-15 15:09:24.420 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:09:24.420 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 2.8214ms
2025-05-15 15:09:24.526 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:24.526 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.526 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:24.526 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:24.527 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:24.616 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:24.616 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:24.617 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:24.617 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:24.617 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:24.617 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:24.617 +07:00 [ERR] Connection id "0HNCJGOGD7K48", Request id "0HNCJGOGD7K48:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:24.618 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 91.7925ms
2025-05-15 15:09:26.287 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:26.289 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:26.289 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:26.305 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:26.305 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:26.313 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:26.313 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:26.313 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:26.314 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:26.314 +07:00 [ERR] Connection id "0HNCJGOGD7K49", Request id "0HNCJGOGD7K49:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:26.316 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 28.4954ms
2025-05-15 15:09:27.141 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:09:27.142 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.142 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - 204 null null 0.3447ms
2025-05-15 15:09:27.143 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:09:27.143 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.143 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.143 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:09:27.143 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:09:27.150 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19
2025-05-15 15:09:27.150 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19 and user 2
2025-05-15 15:09:27.150 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:09:27.150 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 6.8933ms
2025-05-15 15:09:27.150 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:09:27.151 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 7.537ms
2025-05-15 15:09:27.161 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:09:27.162 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.162 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2084ms
2025-05-15 15:09:27.163 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:09:27.163 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.163 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.163 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:09:27.163 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:09:27.178 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:09:27.179 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:09:27.179 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 15.4448ms
2025-05-15 15:09:27.179 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:09:27.179 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 16.0522ms
2025-05-15 15:09:27.184 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:09:27.185 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.185 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.1881ms
2025-05-15 15:09:27.186 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:09:27.186 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.186 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:27.186 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:09:27.186 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:09:27.191 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:09:27.192 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:09:27.192 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.0108ms
2025-05-15 15:09:27.192 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:09:27.192 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 6.3432ms
2025-05-15 15:09:28.332 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:09:28.332 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:09:28.332 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:09:28.350 +07:00 [INF] Retrieved 64 messages from Redis for conversation 19
2025-05-15 15:09:28.350 +07:00 [INF] Retrieved 50 messages from Redis for conversation 19 and user 3
2025-05-15 15:09:28.350 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:09:28.351 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 18.5041ms
2025-05-15 15:09:28.351 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:09:28.351 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 18.9704ms
2025-05-15 15:09:28.388 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:09:28.388 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:09:28.388 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:09:28.404 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:09:28.404 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:09:28.404 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 15.8027ms
2025-05-15 15:09:28.404 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:09:28.404 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 16.234ms
2025-05-15 15:09:28.424 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:09:28.424 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:09:28.424 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:09:28.427 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:09:28.428 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:09:28.429 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.3076ms
2025-05-15 15:09:28.429 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:09:28.430 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 6.111ms
2025-05-15 15:09:29.635 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:29.635 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:29.635 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:29.635 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:29.635 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:29.637 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:29.637 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:29.638 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:29.639 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:29.639 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:29.642 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:29.642 +07:00 [ERR] Connection id "0HNCJGOGD7K4D", Request id "0HNCJGOGD7K4D:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:29.647 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 11.8851ms
2025-05-15 15:09:29.921 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:29.921 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:29.921 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:29.921 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:29.921 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:29.934 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:29.934 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:29.935 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:29.935 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:29.935 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:29.936 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:29.936 +07:00 [ERR] Connection id "0HNCJGOGD7K4E", Request id "0HNCJGOGD7K4E:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:29.937 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 16.479ms
2025-05-15 15:09:31.332 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:31.333 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:31.333 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:31.344 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:31.344 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:31.352 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:31.353 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:31.353 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:31.353 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:31.353 +07:00 [ERR] Connection id "0HNCJGOGD7K4F", Request id "0HNCJGOGD7K4F:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:31.355 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 22.997ms
2025-05-15 15:09:32.522 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:32.522 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:32.522 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:32.550 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:32.550 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:32.596 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:32.597 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:32.597 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:32.598 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:32.598 +07:00 [ERR] Connection id "0HNCJGOGD7K4G", Request id "0HNCJGOGD7K4G:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:32.599 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 76.9617ms
2025-05-15 15:09:34.651 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:34.651 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:34.651 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:34.651 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:34.651 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:34.653 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:34.653 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:34.654 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:34.654 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:34.654 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:34.655 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:34.655 +07:00 [ERR] Connection id "0HNCJGOGD7K4H", Request id "0HNCJGOGD7K4H:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:34.657 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 6.0462ms
2025-05-15 15:09:34.943 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:34.943 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:34.943 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:34.944 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:34.944 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:34.947 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:34.947 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:34.948 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:34.949 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:34.949 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:34.956 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:34.956 +07:00 [ERR] Connection id "0HNCJGOGD7K4I", Request id "0HNCJGOGD7K4I:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:34.960 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 16.5903ms
2025-05-15 15:09:37.392 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:37.392 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:37.392 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:37.400 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:37.400 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:37.407 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:37.408 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:37.409 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:37.412 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:37.413 +07:00 [ERR] Connection id "0HNCJGOGD7K4J", Request id "0HNCJGOGD7K4J:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:37.416 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 24.7208ms
2025-05-15 15:09:37.612 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:37.612 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:37.612 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:37.623 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:37.623 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:37.631 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:37.632 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:37.632 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:37.633 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:37.634 +07:00 [ERR] Connection id "0HNCJGOGD7K4K", Request id "0HNCJGOGD7K4K:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:37.638 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 25.6833ms
2025-05-15 15:09:39.681 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:39.681 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:39.681 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:39.681 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:39.681 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:39.683 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:39.683 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:39.683 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:39.683 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:39.684 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:39.686 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:39.686 +07:00 [ERR] Connection id "0HNCJGOGD7K4L", Request id "0HNCJGOGD7K4L:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:39.690 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 8.3152ms
2025-05-15 15:09:39.974 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:39.974 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:39.974 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:39.974 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:39.974 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:39.977 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:39.977 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:39.978 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:39.979 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:39.979 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:39.983 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:39.984 +07:00 [ERR] Connection id "0HNCJGOGD7K4M", Request id "0HNCJGOGD7K4M:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:39.989 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 15.2023ms
2025-05-15 15:09:42.419 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:42.420 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:42.420 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:42.428 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:42.429 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:42.441 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:42.442 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:42.442 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:42.445 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:42.445 +07:00 [ERR] Connection id "0HNCJGOGD7K4N", Request id "0HNCJGOGD7K4N:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:42.448 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 28.6635ms
2025-05-15 15:09:42.643 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:42.644 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:42.644 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:42.651 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:42.652 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:42.659 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:42.659 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:42.659 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:42.660 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:42.660 +07:00 [ERR] Connection id "0HNCJGOGD7K4O", Request id "0HNCJGOGD7K4O:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:42.660 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 16.8429ms
2025-05-15 15:09:44.708 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:44.708 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:44.708 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:44.708 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:44.708 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:44.711 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:44.711 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:44.712 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:44.713 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:44.713 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:44.720 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:44.720 +07:00 [ERR] Connection id "0HNCJGOGD7K4P", Request id "0HNCJGOGD7K4P:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:44.723 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 15.2389ms
2025-05-15 15:09:45.005 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:45.006 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:45.006 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:45.006 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:45.007 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:45.008 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:45.009 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:45.009 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:45.010 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:45.011 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:45.012 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:45.013 +07:00 [ERR] Connection id "0HNCJGOGD7K4Q", Request id "0HNCJGOGD7K4Q:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:45.015 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 9.2919ms
2025-05-15 15:09:47.451 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:47.452 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:47.452 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:47.462 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:47.462 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:47.470 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:47.471 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:47.471 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:47.473 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:47.473 +07:00 [ERR] Connection id "0HNCJGOGD7K4R", Request id "0HNCJGOGD7K4R:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:47.475 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 23.772ms
2025-05-15 15:09:47.671 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:47.671 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:47.672 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:47.681 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:47.681 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:47.690 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:47.693 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:47.695 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:47.697 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:47.697 +07:00 [ERR] Connection id "0HNCJGOGD7K4S", Request id "0HNCJGOGD7K4S:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:47.702 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 31.002ms
2025-05-15 15:09:48.284 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:48.284 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:48.284 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:48.284 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:48.285 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:48.287 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:48.287 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:48.287 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:48.288 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:48.288 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:48.289 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:48.289 +07:00 [ERR] Connection id "0HNCJGOGD7K4T", Request id "0HNCJGOGD7K4T:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:48.290 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 6.029ms
2025-05-15 15:09:49.728 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:49.729 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:49.729 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:49.729 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:49.729 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:49.731 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:49.731 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:49.731 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:49.732 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:49.733 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:49.733 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:49.733 +07:00 [ERR] Connection id "0HNCJGOGD7K4U", Request id "0HNCJGOGD7K4U:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:49.734 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5.5077ms
2025-05-15 15:09:50.024 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:50.025 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:50.025 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:50.025 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:50.026 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:50.028 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:50.028 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:50.029 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:50.031 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:50.032 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:50.036 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:50.037 +07:00 [ERR] Connection id "0HNCJGOGD7K4V", Request id "0HNCJGOGD7K4V:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:50.042 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 17.6345ms
2025-05-15 15:09:52.489 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:52.489 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:52.489 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:52.499 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:52.500 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:52.507 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:52.508 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:52.508 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:52.509 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:52.509 +07:00 [ERR] Connection id "0HNCJGOGD7K50", Request id "0HNCJGOGD7K50:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:52.511 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 21.6176ms
2025-05-15 15:09:52.709 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:52.710 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:52.710 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:52.731 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:52.732 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:52.740 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:52.741 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:52.741 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:52.743 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:52.743 +07:00 [ERR] Connection id "0HNCJGOGD7K51", Request id "0HNCJGOGD7K51:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:52.745 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 36.1702ms
2025-05-15 15:09:53.313 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:53.313 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:53.313 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:53.313 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:53.313 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:53.315 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:53.315 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:53.316 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:53.316 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:53.316 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:53.318 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:53.318 +07:00 [ERR] Connection id "0HNCJGOGD7K52", Request id "0HNCJGOGD7K52:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:53.319 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5.9585ms
2025-05-15 15:09:54.740 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:54.741 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:54.741 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:54.741 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:54.741 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:54.742 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:54.743 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:54.743 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:54.744 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:54.745 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:54.746 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:54.746 +07:00 [ERR] Connection id "0HNCJGOGD7K53", Request id "0HNCJGOGD7K53:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:54.749 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 8.8201ms
2025-05-15 15:09:55.047 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:55.047 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:55.047 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:55.047 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:55.047 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:55.049 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:55.049 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:55.050 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:55.050 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:55.051 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:55.052 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:55.053 +07:00 [ERR] Connection id "0HNCJGOGD7K54", Request id "0HNCJGOGD7K54:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:55.054 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 7.4581ms
2025-05-15 15:09:57.549 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:57.549 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:57.549 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:57.559 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:57.560 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:57.566 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:57.567 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:57.567 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:57.567 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:57.567 +07:00 [ERR] Connection id "0HNCJGOGD7K55", Request id "0HNCJGOGD7K55:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:57.568 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 18.9348ms
2025-05-15 15:09:57.915 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:09:57.915 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:57.916 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:09:57.930 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:09:57.930 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:09:57.933 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/3 - null null
2025-05-15 15:09:57.934 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:09:57.934 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:09:57.935 +07:00 [WRN] Message 0 has invalid data: id=0, conversation_id=1, sender_id=0, created_at="2025-05-15T06:13:54.3970853Z"
2025-05-15 15:09:57.941 +07:00 [WRN] Message 114 not found in Redis
2025-05-15 15:09:57.942 +07:00 [WRN] Message 113 not found in Redis
2025-05-15 15:09:57.942 +07:00 [WRN] Message 112 not found in Redis
2025-05-15 15:09:57.942 +07:00 [WRN] Message 110 not found in Redis
2025-05-15 15:09:57.943 +07:00 [WRN] Message 109 not found in Redis
2025-05-15 15:09:57.943 +07:00 [WRN] Message 108 not found in Redis
2025-05-15 15:09:57.943 +07:00 [WRN] Message 107 not found in Redis
2025-05-15 15:09:57.944 +07:00 [WRN] Message 106 not found in Redis
2025-05-15 15:09:57.944 +07:00 [WRN] Message 105 not found in Redis
2025-05-15 15:09:57.945 +07:00 [WRN] Message 104 not found in Redis
2025-05-15 15:09:57.945 +07:00 [WRN] Message 103 not found in Redis
2025-05-15 15:09:57.945 +07:00 [WRN] Message 102 not found in Redis
2025-05-15 15:09:57.946 +07:00 [WRN] Message 101 not found in Redis
2025-05-15 15:09:57.946 +07:00 [WRN] Message 100 not found in Redis
2025-05-15 15:09:57.946 +07:00 [WRN] Message 99 not found in Redis
2025-05-15 15:09:57.946 +07:00 [WRN] Message 98 not found in Redis
2025-05-15 15:09:57.947 +07:00 [WRN] Message 95 not found in Redis
2025-05-15 15:09:57.947 +07:00 [WRN] Message 94 not found in Redis
2025-05-15 15:09:57.947 +07:00 [WRN] Message 93 not found in Redis
2025-05-15 15:09:57.948 +07:00 [WRN] Message 92 not found in Redis
2025-05-15 15:09:57.948 +07:00 [WRN] Message 91 not found in Redis
2025-05-15 15:09:57.948 +07:00 [WRN] Message 90 not found in Redis
2025-05-15 15:09:57.948 +07:00 [WRN] Message 87 not found in Redis
2025-05-15 15:09:57.949 +07:00 [WRN] Message 86 not found in Redis
2025-05-15 15:09:57.949 +07:00 [WRN] Message 85 not found in Redis
2025-05-15 15:09:57.949 +07:00 [WRN] Message 84 not found in Redis
2025-05-15 15:09:57.949 +07:00 [WRN] Message 83 not found in Redis
2025-05-15 15:09:57.949 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:57.950 +07:00 [WRN] Message 82 not found in Redis
2025-05-15 15:09:57.950 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:57.950 +07:00 [WRN] Message 81 not found in Redis
2025-05-15 15:09:57.950 +07:00 [WRN] Message 80 not found in Redis
2025-05-15 15:09:57.950 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:57.951 +07:00 [WRN] Message 79 not found in Redis
2025-05-15 15:09:57.951 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:57.951 +07:00 [WRN] Message 78 not found in Redis
2025-05-15 15:09:57.951 +07:00 [WRN] Message 77 not found in Redis
2025-05-15 15:09:57.951 +07:00 [ERR] Connection id "0HNCJGOGD7K56", Request id "0HNCJGOGD7K56:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:57.952 +07:00 [WRN] Message 76 not found in Redis
2025-05-15 15:09:57.952 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 36.4802ms
2025-05-15 15:09:57.952 +07:00 [WRN] Message 75 not found in Redis
2025-05-15 15:09:57.952 +07:00 [WRN] Message 74 not found in Redis
2025-05-15 15:09:57.952 +07:00 [WRN] Message 73 not found in Redis
2025-05-15 15:09:57.953 +07:00 [WRN] Message 72 not found in Redis
2025-05-15 15:09:57.953 +07:00 [WRN] Message 71 not found in Redis
2025-05-15 15:09:57.953 +07:00 [WRN] Message 68 not found in Redis
2025-05-15 15:09:57.953 +07:00 [WRN] Message 64 not found in Redis
2025-05-15 15:09:57.953 +07:00 [WRN] Message 62 not found in Redis
2025-05-15 15:09:57.954 +07:00 [WRN] Message 61 not found in Redis
2025-05-15 15:09:57.954 +07:00 [WRN] Message 60 not found in Redis
2025-05-15 15:09:57.954 +07:00 [WRN] Message 59 not found in Redis
2025-05-15 15:09:57.954 +07:00 [WRN] Message 57 not found in Redis
2025-05-15 15:09:57.954 +07:00 [WRN] Message 55 not found in Redis
2025-05-15 15:09:57.954 +07:00 [WRN] Message 54 not found in Redis
2025-05-15 15:09:57.955 +07:00 [WRN] Message 51 not found in Redis
2025-05-15 15:09:57.955 +07:00 [WRN] Message 49 not found in Redis
2025-05-15 15:09:57.955 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1
2025-05-15 15:09:57.955 +07:00 [INF] Retrieved 29 messages from Redis for conversation 1 and user 3
2025-05-15 15:09:57.955 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:09:57.955 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 21.5774ms
2025-05-15 15:09:57.955 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:09:57.955 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 22.0551ms
2025-05-15 15:09:57.983 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-15 15:09:57.983 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:09:57.983 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:09:58.002 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:09:58.002 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:09:58.003 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 19.338ms
2025-05-15 15:09:58.003 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:09:58.003 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 19.8305ms
2025-05-15 15:09:58.021 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:09:58.021 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:09:58.021 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:09:58.025 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:09:58.025 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:09:58.025 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.6273ms
2025-05-15 15:09:58.025 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:09:58.025 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.0155ms
2025-05-15 15:09:58.329 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:58.329 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:58.329 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:58.330 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:58.330 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:58.332 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:58.332 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:58.332 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:58.333 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:58.333 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:58.334 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:58.334 +07:00 [ERR] Connection id "0HNCJGOGD7K5A", Request id "0HNCJGOGD7K5A:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:58.335 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5.6929ms
2025-05-15 15:09:59.248 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:09:59.248 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:09:59.249 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:09:59.250 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:09:59.250 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:09:59.250 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 1.4871ms
2025-05-15 15:09:59.250 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:09:59.250 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 1.728ms
2025-05-15 15:09:59.754 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:09:59.754 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:59.755 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:09:59.755 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:09:59.755 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:09:59.756 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:09:59.756 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:09:59.757 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:09:59.758 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:09:59.758 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:09:59.758 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:09:59.758 +07:00 [ERR] Connection id "0HNCJGOGD7K5C", Request id "0HNCJGOGD7K5C:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:09:59.759 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 4.6594ms
2025-05-15 15:10:00.069 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:00.070 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:00.070 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:00.070 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:00.071 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:00.073 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:00.073 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:00.074 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:00.079 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:00.079 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:00.083 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:00.083 +07:00 [ERR] Connection id "0HNCJGOGD7K5D", Request id "0HNCJGOGD7K5D:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:00.084 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 14.2953ms
2025-05-15 15:10:00.777 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:10:00.777 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:10:00.777 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:10:00.800 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:10:00.801 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:10:00.801 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 23.825ms
2025-05-15 15:10:00.801 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:10:00.801 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 24.403ms
2025-05-15 15:10:02.598 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:10:02.598 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:02.599 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:10:02.602 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Participant/add_member/1/2 - null 0
2025-05-15 15:10:02.602 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 15:10:02.602 +07:00 [INF] Route matched with {action = "AddMember", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] AddMember(Int32, Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:10:02.608 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:10:02.608 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:10:02.610 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Conversations] AS [c]
        WHERE [c].[id] = @__conversation_id_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 15:10:02.616 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__user_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] = @__user_id_0
2025-05-15 15:10:02.619 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:02.620 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:02.620 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:02.625 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:02.628 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32), @__user_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[user_id] = @__user_id_1) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-05-15 15:10:02.628 +07:00 [ERR] Connection id "0HNCJGOGD7K5F", Request id "0HNCJGOGD7K5F:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:02.631 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 33.0764ms
2025-05-15 15:10:02.638 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Participants] ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-15 15:10:02.639 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-15 15:10:02.640 +07:00 [INF] Message 0 already exists in Redis
2025-05-15 15:10:02.643 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType18`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:10:02.644 +07:00 [INF] Executed action server.Controllers.ParticipantController.AddMember (Message_app) in 41.1753ms
2025-05-15 15:10:02.644 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.AddMember (Message_app)'
2025-05-15 15:10:02.644 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Participant/add_member/1/2 - 200 null application/json; charset=utf-8 42.056ms
2025-05-15 15:10:02.678 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - null null
2025-05-15 15:10:02.678 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:10:02.678 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:10:02.681 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:10:02.682 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:10:02.682 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.8089ms
2025-05-15 15:10:02.682 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:10:02.682 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 4.2299ms
2025-05-15 15:10:03.348 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:03.348 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:03.348 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:03.348 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:03.348 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:03.351 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:03.351 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:03.352 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:03.352 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:03.352 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:03.355 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:03.355 +07:00 [ERR] Connection id "0HNCJGOGD7K5H", Request id "0HNCJGOGD7K5H:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:03.359 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 11.7371ms
2025-05-15 15:10:03.985 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:10:03.986 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:03.986 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:10:03.997 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:10:03.998 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:10:04.006 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:04.008 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:04.011 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:04.014 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:04.014 +07:00 [ERR] Connection id "0HNCJGOGD7K5I", Request id "0HNCJGOGD7K5I:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:04.019 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 33.6482ms
2025-05-15 15:10:04.777 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:04.777 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:04.777 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:04.777 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:04.777 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:04.780 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:04.780 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:04.782 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:04.783 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:04.784 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:04.787 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:04.788 +07:00 [ERR] Connection id "0HNCJGOGD7K5J", Request id "0HNCJGOGD7K5J:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:04.793 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 16.1268ms
2025-05-15 15:10:05.090 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:05.090 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:05.090 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:05.090 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:05.091 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:05.093 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:05.093 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:05.095 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:05.096 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:05.096 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:05.105 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:05.105 +07:00 [ERR] Connection id "0HNCJGOGD7K5K", Request id "0HNCJGOGD7K5K:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:05.113 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 23.1918ms
2025-05-15 15:10:07.638 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:10:07.638 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:07.638 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:10:07.647 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:10:07.648 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:10:07.654 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:07.655 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:07.655 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:07.655 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:07.655 +07:00 [ERR] Connection id "0HNCJGOGD7K5L", Request id "0HNCJGOGD7K5L:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:07.660 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 22.1501ms
2025-05-15 15:10:08.375 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:08.375 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:08.375 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:08.375 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:08.376 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:08.379 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:08.379 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:08.380 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:08.380 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:08.380 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:08.381 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:08.384 +07:00 [ERR] Connection id "0HNCJGOGD7K5M", Request id "0HNCJGOGD7K5M:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:08.386 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 11.5559ms
2025-05-15 15:10:09.019 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:10:09.019 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:09.019 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:10:09.027 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:10:09.027 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:10:09.041 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:09.042 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:09.042 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:09.044 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:09.044 +07:00 [ERR] Connection id "0HNCJGOGD7K5N", Request id "0HNCJGOGD7K5N:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:09.046 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 26.9933ms
2025-05-15 15:10:09.804 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:09.804 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:09.804 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:09.805 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:09.805 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:09.807 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:09.808 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:09.809 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:09.812 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:09.813 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:09.815 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:09.815 +07:00 [ERR] Connection id "0HNCJGOGD7K5O", Request id "0HNCJGOGD7K5O:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:09.819 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 15.2093ms
2025-05-15 15:10:10.126 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:10.126 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:10.126 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:10.126 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:10.126 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:10.128 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:10.128 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:10.128 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:10.129 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:10.129 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:10.129 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:10.129 +07:00 [ERR] Connection id "0HNCJGOGD7K5P", Request id "0HNCJGOGD7K5P:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:10.130 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 4.2509ms
2025-05-15 15:10:12.700 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:10:12.701 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:12.701 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:10:12.715 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:10:12.716 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:10:12.725 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:12.726 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:12.726 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:12.728 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:12.728 +07:00 [ERR] Connection id "0HNCJGOGD7K5Q", Request id "0HNCJGOGD7K5Q:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:12.729 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 28.1223ms
2025-05-15 15:10:13.393 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:13.393 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:13.394 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:13.394 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:13.394 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:13.396 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:13.396 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:13.397 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:13.397 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:13.397 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:13.398 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:13.398 +07:00 [ERR] Connection id "0HNCJGOGD7K5R", Request id "0HNCJGOGD7K5R:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:13.398 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5.2321ms
2025-05-15 15:10:14.051 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:10:14.051 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:14.051 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:10:14.063 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:10:14.063 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:10:14.070 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:14.072 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:14.072 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:14.073 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:14.074 +07:00 [ERR] Connection id "0HNCJGOGD7K5S", Request id "0HNCJGOGD7K5S:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:14.079 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 27.4183ms
2025-05-15 15:10:14.827 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:14.827 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:14.827 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:14.827 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:14.827 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:14.828 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:14.828 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:14.828 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:14.828 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:14.828 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:14.829 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:14.829 +07:00 [ERR] Connection id "0HNCJGOGD7K5T", Request id "0HNCJGOGD7K5T:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:14.829 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 2.8769ms
2025-05-15 15:10:15.136 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:15.136 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:15.136 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:15.136 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:15.137 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:15.137 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:15.137 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:15.138 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:15.138 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:15.138 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:15.140 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:15.140 +07:00 [ERR] Connection id "0HNCJGOGD7K5U", Request id "0HNCJGOGD7K5U:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:15.142 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5.4818ms
2025-05-15 15:10:17.745 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:10:17.746 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:17.746 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:10:17.759 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:10:17.759 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:10:17.767 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:17.768 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:17.769 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:17.771 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:17.771 +07:00 [ERR] Connection id "0HNCJGOGD7K5V", Request id "0HNCJGOGD7K5V:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:17.775 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 29.3594ms
2025-05-15 15:10:18.411 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:10:18.411 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:18.411 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:10:18.411 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:18.411 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:10:18.412 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:10:18.412 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:10:18.412 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:18.412 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:18.412 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:18.413 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:18.413 +07:00 [ERR] Connection id "0HNCJGOGD7K60", Request id "0HNCJGOGD7K60:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:18.413 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 2.7828ms
2025-05-15 15:10:19.087 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:10:19.088 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:10:19.088 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:10:19.101 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:10:19.102 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:10:19.111 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:10:19.113 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:19.114 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:19.116 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:19.116 +07:00 [ERR] Connection id "0HNCJGOGD7K61", Request id "0HNCJGOGD7K61:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:19.119 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 31.8103ms
2025-05-15 15:10:19.173 +07:00 [INF] Application is shutting down...
2025-05-15 15:10:49.196 +07:00 [ERR] Error handling WebSocket connection from ::1
Microsoft.AspNetCore.Connections.ConnectionAbortedException: The connection was aborted because the server is shutting down and request processing didn't complete within the time specified by HostOptions.ShutdownTimeout.
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 212
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 184
2025-05-15 15:10:49.196 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
Microsoft.AspNetCore.Connections.ConnectionAbortedException: The connection was aborted because the server is shutting down and request processing didn't complete within the time specified by HostOptions.ShutdownTimeout.
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 212
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 184
2025-05-15 15:10:49.200 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:49.201 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:49.201 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:49.201 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:10:49.202 +07:00 [ERR] Connection id "0HNCJGOGD7K3B", Request id "0HNCJGOGD7K3B:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:49.202 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 158642.269ms
2025-05-15 15:10:49.202 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:10:49.202 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:10:49.202 +07:00 [ERR] Connection id "0HNCJGOGD7K36", Request id "0HNCJGOGD7K36:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 598
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:10:49.203 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 183582.6705ms
2025-05-15 15:11:18.719 +07:00 [INF] Executed DbCommand (32ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-15 15:11:18.860 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-15 15:11:18.894 +07:00 [WRN] The WebRootPath was not found: C:\Users\Thao\source\Flutter\Message_app\server\wwwroot. Static files may be unavailable.
2025-05-15 15:11:18.909 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-15 15:11:18.918 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-15 15:11:18.918 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-15 15:11:18.918 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-15 15:11:18.918 +07:00 [INF] Hosting environment: Development
2025-05-15 15:11:18.918 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-15 15:11:19.084 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:11:19.084 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:11:19.118 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:11:19.151 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:11:19.152 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-15 15:11:19.183 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:11:19.183 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:11:19.338 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:11:19.338 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:11:19.340 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - null null
2025-05-15 15:11:19.344 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:11:19.370 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:11:19.417 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:11:19.420 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:11:20.838 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:11:20.839 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:11:20.839 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:11:20.839 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:11:20.850 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:11:20.856 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:11:20.858 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Routing.EndpointRoutingMiddleware.<Invoke>g__AwaitMatcher|10_0(EndpointRoutingMiddleware middleware, HttpContext httpContext, Task`1 matcherTask)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:11:20.885 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:11:20.891 +07:00 [ERR] Connection id "0HNCJH096S640", Request id "0HNCJH096S640:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Routing.EndpointRoutingMiddleware.<Invoke>g__AwaitMatcher|10_0(EndpointRoutingMiddleware middleware, HttpContext httpContext, Task`1 matcherTask)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:11:20.895 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 1812.8382ms
2025-05-15 15:11:23.638 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:11:23.639 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:11:23.640 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:11:23.641 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:11:23.655 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:11:25.914 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:11:25.915 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:11:25.915 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:11:25.916 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:11:25.923 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:12:53.536 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:12:53.536 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:12:53.550 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
 ---> Microsoft.AspNetCore.Connections.ConnectionResetException: An existing connection was forcibly closed by the remote host.
 ---> System.Net.Sockets.SocketException (10054): An existing connection was forcibly closed by the remote host.
   --- End of inner exception stack trace ---
   at System.IO.Pipelines.Pipe.GetReadResult(ReadResult& result)
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at System.IO.Pipelines.Pipe.DefaultPipeReader.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:12:53.550 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
 ---> Microsoft.AspNetCore.Connections.ConnectionResetException: An existing connection was forcibly closed by the remote host.
 ---> System.Net.Sockets.SocketException (10054): An existing connection was forcibly closed by the remote host.
   --- End of inner exception stack trace ---
   at System.IO.Pipelines.Pipe.GetReadResult(ReadResult& result)
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at System.IO.Pipelines.Pipe.DefaultPipeReader.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:12:53.598 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:12:53.599 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:12:53.600 +07:00 [ERR] Connection id "0HNCJH096S641", Request id "0HNCJH096S641:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
 ---> Microsoft.AspNetCore.Connections.ConnectionResetException: An existing connection was forcibly closed by the remote host.
 ---> System.Net.Sockets.SocketException (10054): An existing connection was forcibly closed by the remote host.
   --- End of inner exception stack trace ---
   at System.IO.Pipelines.Pipe.GetReadResult(ReadResult& result)
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at System.IO.Pipelines.Pipe.DefaultPipeReader.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:12:53.600 +07:00 [ERR] Connection id "0HNCJH096S642", Request id "0HNCJH096S642:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
 ---> Microsoft.AspNetCore.Connections.ConnectionResetException: An existing connection was forcibly closed by the remote host.
 ---> System.Net.Sockets.SocketException (10054): An existing connection was forcibly closed by the remote host.
   --- End of inner exception stack trace ---
   at System.IO.Pipelines.Pipe.GetReadResult(ReadResult& result)
   at System.IO.Pipelines.Pipe.GetReadAsyncResult()
   at System.IO.Pipelines.Pipe.DefaultPipeReader.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.Http1UpgradeMessageBody.ReadAsyncInternalAwaited(ValueTask`1 readTask, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpRequestStream.ReadAsyncInternal(Memory`1 destination, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.IO.Stream.ReadAtLeastAsyncCore(Memory`1 buffer, Int32 minimumBytes, Boolean throwOnEndOfStream, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 177
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 160
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:12:53.612 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 94268.4957ms
2025-05-15 15:12:53.612 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=3 - 101 null null 94526.644ms
2025-05-15 15:13:34.570 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 15:13:34.578 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:34.592 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 21.0848ms
2025-05-15 15:13:34.595 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 15:13:34.598 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:34.608 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:34.611 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:13:34.713 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:13:35.049 +07:00 [INF] Executed DbCommand (112ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:13:35.191 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:13:35.235 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 518.8722ms
2025-05-15 15:13:35.235 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:13:35.240 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 645.2891ms
2025-05-15 15:13:35.430 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:13:35.433 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:35.436 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:35.436 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:13:35.445 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:13:35.599 +07:00 [INF] Executed DbCommand (48ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:13:35.601 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:13:35.618 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 173.013ms
2025-05-15 15:13:35.618 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:13:35.619 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 188.2474ms
2025-05-15 15:13:35.785 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:13:35.786 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:35.786 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.5045ms
2025-05-15 15:13:35.787 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:13:35.787 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:35.787 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:13:35.788 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.3839ms
2025-05-15 15:13:35.788 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:35.788 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:35.788 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:13:35.793 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:13:35.926 +07:00 [INF] Executed DbCommand (45ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:13:35.935 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:13:35.944 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 150.843ms
2025-05-15 15:13:35.944 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:13:35.944 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 156.6532ms
2025-05-15 15:13:35.945 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:13:35.946 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:35.949 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:35.949 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:13:35.949 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:13:35.954 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:13:35.955 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:13:35.955 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 6.0401ms
2025-05-15 15:13:35.955 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:13:35.956 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 10.1692ms
2025-05-15 15:13:36.012 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:13:36.013 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:36.014 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:36.014 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:13:36.228 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:13:36.259 +07:00 [INF] Executed DbCommand (24ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:13:49.972 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - application/json 57
2025-05-15 15:13:49.977 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:13:49.977 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:13:49.992 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:13:49.993 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:13:49.994 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 16.3054ms
2025-05-15 15:13:49.994 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:13:49.994 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.3:5053/api/Auth/login - 200 null application/json; charset=utf-8 21.904ms
2025-05-15 15:13:51.232 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:13:51.232 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:13:51.232 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:13:51.234 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - null null
2025-05-15 15:13:51.234 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:13:51.234 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:13:51.249 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:13:51.250 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:13:51.250 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 15.9882ms
2025-05-15 15:13:51.250 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:13:51.251 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 16.7261ms
2025-05-15 15:13:51.254 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:13:51.254 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:13:51.255 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 22.3391ms
2025-05-15 15:13:51.255 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:13:51.255 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 23.0891ms
2025-05-15 15:13:51.407 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:13:51.408 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:13:51.469 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:13:51.469 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:13:51.470 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:13:51.471 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:13:51.471 +07:00 [ERR] Connection id "0HNCJH096S645", Request id "0HNCJH096S645:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:13:51.472 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 145557.9729ms
2025-05-15 15:13:52.119 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - null null
2025-05-15 15:13:52.121 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:13:52.121 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:13:52.130 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:13:52.131 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:13:52.131 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 9.9178ms
2025-05-15 15:13:52.132 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:13:52.132 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 12.5407ms
2025-05-15 15:13:52.330 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:13:52.331 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.331 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.7221ms
2025-05-15 15:13:52.333 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:13:52.333 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.333 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.334 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:13:52.338 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:13:52.393 +07:00 [INF] Retrieved 64 messages from Redis for conversation 19
2025-05-15 15:13:52.394 +07:00 [INF] Retrieved 50 messages from Redis for conversation 19 and user 3
2025-05-15 15:13:52.394 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:13:52.400 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 62.5382ms
2025-05-15 15:13:52.400 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:13:52.400 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 67.8562ms
2025-05-15 15:13:52.413 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:13:52.414 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.414 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.4838ms
2025-05-15 15:13:52.415 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:13:52.416 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.416 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.416 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:13:52.419 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:13:52.460 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:13:52.492 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:13:52.496 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 76.5769ms
2025-05-15 15:13:52.496 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:13:52.496 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 80.6615ms
2025-05-15 15:13:52.505 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:13:52.505 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.506 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.663ms
2025-05-15 15:13:52.510 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:13:52.511 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.511 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:52.511 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:13:52.518 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:13:52.532 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:13:52.533 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:13:52.535 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 16.4497ms
2025-05-15 15:13:52.535 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:13:52.535 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 24.9549ms
2025-05-15 15:13:54.172 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/19/2 - null null
2025-05-15 15:13:54.174 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:13:54.174 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:13:54.180 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19
2025-05-15 15:13:54.180 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19 and user 2
2025-05-15 15:13:54.180 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:13:54.181 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 6.7939ms
2025-05-15 15:13:54.181 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:13:54.181 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 8.5876ms
2025-05-15 15:13:54.255 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:13:54.256 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:13:54.256 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:13:54.261 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:13:54.262 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:13:54.262 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 6.8247ms
2025-05-15 15:13:54.263 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:13:54.263 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 7.502ms
2025-05-15 15:13:54.356 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:13:54.357 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:13:54.357 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:13:54.364 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:13:54.364 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:13:54.364 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 7.3645ms
2025-05-15 15:13:54.364 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:13:54.365 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 9.0837ms
2025-05-15 15:13:56.495 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-15 15:13:56.496 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:56.496 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:13:56.496 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:13:56.620 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:13:56.620 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:13:56.622 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:13:56.622 +07:00 [ERR] Connection id "0HNCJH096S64C", Request id "0HNCJH096S64C:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:13:56.623 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 5215.7764ms
2025-05-15 15:13:56.626 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:14:01.635 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:14:01.636 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:14:01.668 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:14:06.954 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:14:06.954 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:06.955 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.4067ms
2025-05-15 15:14:06.960 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:14:06.961 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:06.962 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:06.962 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:14:06.965 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:14:07.001 +07:00 [INF] Retrieved 64 messages from Redis for conversation 19
2025-05-15 15:14:07.001 +07:00 [INF] Retrieved 50 messages from Redis for conversation 19 and user 3
2025-05-15 15:14:07.001 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:14:07.002 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 36.0324ms
2025-05-15 15:14:07.002 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:14:07.002 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 41.5396ms
2025-05-15 15:14:07.016 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:14:07.016 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:07.016 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.6368ms
2025-05-15 15:14:07.017 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:14:07.018 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:07.018 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:07.018 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:14:07.018 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:14:07.025 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:14:07.026 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:14:07.026 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.9118ms
2025-05-15 15:14:07.026 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:14:07.026 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 8.6228ms
2025-05-15 15:14:07.032 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:14:07.032 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:07.033 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.3499ms
2025-05-15 15:14:07.034 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:14:07.034 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:07.034 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:14:07.034 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:14:07.034 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:14:07.040 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:14:07.040 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:14:07.040 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.0188ms
2025-05-15 15:14:07.041 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:14:07.041 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 7.1228ms
2025-05-15 15:14:07.565 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:14:07.566 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:14:07.615 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:14:07.616 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:14:07.617 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:14:07.617 +07:00 [ERR] Connection id "0HNCJH096S64I", Request id "0HNCJH096S64I:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:14:07.619 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 5983.1209ms
2025-05-15 15:14:07.623 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:14:12.572 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:14:12.572 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:14:12.573 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:14:12.574 +07:00 [ERR] Connection id "0HNCJH096S648", Request id "0HNCJH096S648:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:14:12.575 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 36563.4603ms
2025-05-15 15:14:12.631 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:14:12.632 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:14:12.654 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:15:21.288 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 15:15:21.288 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.288 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.2905ms
2025-05-15 15:15:21.289 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 15:15:21.290 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.290 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.290 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:15:21.290 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:15:21.308 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:15:21.309 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:15:21.309 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 19.359ms
2025-05-15 15:15:21.309 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:15:21.310 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 20.212ms
2025-05-15 15:15:21.459 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:15:21.459 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.459 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.460 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:15:21.460 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:15:21.478 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:15:21.478 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:15:21.478 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 18.6458ms
2025-05-15 15:15:21.478 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:15:21.479 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 19.3477ms
2025-05-15 15:15:21.703 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:15:21.704 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.704 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.3294ms
2025-05-15 15:15:21.705 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:15:21.705 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.705 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.4308ms
2025-05-15 15:15:21.706 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:15:21.706 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.706 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.706 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:15:21.706 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:15:21.738 +07:00 [INF] Executed DbCommand (30ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:15:21.738 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:15:21.739 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 32.9588ms
2025-05-15 15:15:21.739 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:15:21.739 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 33.77ms
2025-05-15 15:15:21.741 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:15:21.741 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.741 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.742 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:15:21.742 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:15:21.754 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:15:21.755 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:15:21.755 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 13.4796ms
2025-05-15 15:15:21.755 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:15:21.756 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 14.5416ms
2025-05-15 15:15:21.956 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:15:21.956 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.956 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:21.957 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:15:22.069 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:15:22.076 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:15:35.922 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:15:35.923 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.923 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.548ms
2025-05-15 15:15:35.924 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:15:35.924 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.924 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.924 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:15:35.924 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:15:35.936 +07:00 [INF] Retrieved 64 messages from Redis for conversation 19
2025-05-15 15:15:35.936 +07:00 [INF] Retrieved 50 messages from Redis for conversation 19 and user 3
2025-05-15 15:15:35.936 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:15:35.937 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 12.4254ms
2025-05-15 15:15:35.937 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:15:35.937 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 12.897ms
2025-05-15 15:15:35.951 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:15:35.951 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.951 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2265ms
2025-05-15 15:15:35.953 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:15:35.953 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.954 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.954 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:15:35.954 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:15:35.970 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:15:35.971 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:15:35.971 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 17.2605ms
2025-05-15 15:15:35.971 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:15:35.971 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 18.2258ms
2025-05-15 15:15:35.978 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:15:35.978 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.978 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.2513ms
2025-05-15 15:15:35.980 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:15:35.980 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.980 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:15:35.980 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:15:35.980 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:15:35.986 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:15:35.987 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:15:35.987 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.9064ms
2025-05-15 15:15:35.987 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:15:35.987 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 7.4721ms
2025-05-15 15:15:48.214 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:15:48.214 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:15:48.215 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:15:48.216 +07:00 [ERR] Connection id "0HNCJH096S64N", Request id "0HNCJH096S64N:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:15:48.217 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 26261.4147ms
2025-05-15 15:15:59.047 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:15:59.048 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:15:59.048 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:15:59.048 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:15:59.048 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:15:59.048 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:15:59.048 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:15:59.048 +07:00 [ERR] Connection id "0HNCJH096S644", Request id "0HNCJH096S644:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:15:59.049 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:15:59.050 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 275411.8252ms
2025-05-15 15:15:59.049 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:15:59.051 +07:00 [ERR] Connection id "0HNCJH096S64H", Request id "0HNCJH096S64H:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:15:59.051 +07:00 [ERR] Connection id "0HNCJH096S643", Request id "0HNCJH096S643:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 552
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 162
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:15:59.053 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 122557.5365ms
2025-05-15 15:15:59.055 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 278217.1447ms
2025-05-15 15:17:08.451 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-15 15:17:08.451 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.452 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.7857ms
2025-05-15 15:17:08.453 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-15 15:17:08.454 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.454 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.454 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:17:08.454 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-15 15:17:08.470 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-15 15:17:08.471 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-15 15:17:08.471 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 17.3501ms
2025-05-15 15:17:08.471 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-15 15:17:08.472 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 18.0939ms
2025-05-15 15:17:08.618 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-15 15:17:08.618 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.619 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.619 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:17:08.619 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-15 15:17:08.637 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-15 15:17:08.637 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:17:08.638 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 19.3042ms
2025-05-15 15:17:08.638 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-15 15:17:08.638 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 20.2402ms
2025-05-15 15:17:08.858 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:17:08.858 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.858 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.2458ms
2025-05-15 15:17:08.859 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:17:08.859 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:17:08.859 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.859 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.859 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.859 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.1213ms
2025-05-15 15:17:08.859 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:17:08.860 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:17:08.878 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:17:08.878 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:17:08.879 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 19.142ms
2025-05-15 15:17:08.879 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:17:08.879 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 19.7677ms
2025-05-15 15:17:08.880 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-15 15:17:08.880 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.880 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:08.880 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:17:08.880 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:17:08.882 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-15 15:17:08.883 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:17:08.883 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 2.9129ms
2025-05-15 15:17:08.883 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-15 15:17:08.883 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 3.4367ms
2025-05-15 15:17:09.043 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:17:09.044 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:09.044 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:09.044 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:17:09.179 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:17:09.188 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:17:11.998 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:17:11.998 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:11.998 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.2865ms
2025-05-15 15:17:11.999 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-15 15:17:11.999 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:11.999 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:11.999 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:17:11.999 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-15 15:17:12.015 +07:00 [INF] Retrieved 64 messages from Redis for conversation 19
2025-05-15 15:17:12.015 +07:00 [INF] Retrieved 50 messages from Redis for conversation 19 and user 3
2025-05-15 15:17:12.015 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-15 15:17:12.015 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 15.572ms
2025-05-15 15:17:12.015 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-15 15:17:12.015 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 16.0966ms
2025-05-15 15:17:12.028 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:17:12.028 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:12.028 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.1877ms
2025-05-15 15:17:12.029 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-15 15:17:12.030 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:12.030 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:12.030 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:17:12.030 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-15 15:17:12.037 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-15 15:17:12.037 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-15 15:17:12.038 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 8.1254ms
2025-05-15 15:17:12.038 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-15 15:17:12.038 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 8.8388ms
2025-05-15 15:17:12.044 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:17:12.045 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:12.045 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.2123ms
2025-05-15 15:17:12.046 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-15 15:17:12.046 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:12.046 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:12.046 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:17:12.046 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-15 15:17:12.052 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-15 15:17:12.053 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-15 15:17:12.053 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.4628ms
2025-05-15 15:17:12.053 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-15 15:17:12.053 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 7.1839ms
2025-05-15 15:17:17.224 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:17:17.224 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:17.224 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:17:17.224 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:17:17.237 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:17:17.244 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:19:03.327 +07:00 [INF] Executed DbCommand (35ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-15 15:19:03.487 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-15 15:19:03.540 +07:00 [WRN] The WebRootPath was not found: C:\Users\Thao\source\Flutter\Message_app\server\wwwroot. Static files may be unavailable.
2025-05-15 15:19:03.564 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-15 15:19:03.581 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-15 15:19:03.581 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-15 15:19:03.581 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-15 15:19:03.581 +07:00 [INF] Hosting environment: Development
2025-05-15 15:19:03.581 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-15 15:19:04.201 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:19:04.202 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:19:04.249 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-15 15:19:04.271 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:04.271 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:04.282 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:19:04.282 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:19:04.307 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:19:04.310 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":1}
2025-05-15 15:19:04.379 +07:00 [INF] Added client with UserId 2. Total clients: 2
2025-05-15 15:19:04.379 +07:00 [INF] Added client with UserId 2. Total clients: 2
2025-05-15 15:19:04.457 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:19:04.457 +07:00 [INF] Executed DbCommand (26ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:19:04.477 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 597
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 187
2025-05-15 15:19:04.500 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:04.502 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 597
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Routing.EndpointRoutingMiddleware.<Invoke>g__AwaitMatcher|10_0(EndpointRoutingMiddleware middleware, HttpContext httpContext, Task`1 matcherTask)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:04.506 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:04.512 +07:00 [ERR] Connection id "0HNCJH4JQKAOE", Request id "0HNCJH4JQKAOE:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 597
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 197
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Routing.EndpointRoutingMiddleware.<Invoke>g__AwaitMatcher|10_0(EndpointRoutingMiddleware middleware, HttpContext httpContext, Task`1 matcherTask)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:04.515 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 315.3528ms
2025-05-15 15:19:06.435 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:19:06.438 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:06.440 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:06.442 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:06.444 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:19:06.445 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":19}
2025-05-15 15:19:06.445 +07:00 [INF] Added client with UserId 3. Total clients: 2
2025-05-15 15:19:06.490 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-15 15:19:06.509 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-15 15:19:08.479 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:19:08.480 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:08.480 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:08.480 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:08.481 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:19:08.484 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 15:19:08.484 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:19:08.513 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:08.514 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:08.515 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:08.516 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:08.516 +07:00 [ERR] Connection id "0HNCJH4JQKAOH", Request id "0HNCJH4JQKAOH:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:08.518 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 38.3687ms
2025-05-15 15:19:09.413 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:19:09.413 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:09.414 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:19:09.427 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:19:09.428 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:19:09.436 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:09.436 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:09.437 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:09.438 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:09.439 +07:00 [ERR] Connection id "0HNCJH4JQKAOI", Request id "0HNCJH4JQKAOI:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:09.443 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 30.3025ms
2025-05-15 15:19:13.532 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:19:13.532 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:13.532 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:13.532 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:13.533 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:19:13.534 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 15:19:13.535 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:19:13.535 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:13.550 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:13.551 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:13.552 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:13.552 +07:00 [ERR] Connection id "0HNCJH4JQKAOJ", Request id "0HNCJH4JQKAOJ:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:13.553 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 21.4928ms
2025-05-15 15:19:14.612 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:19:14.613 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:14.614 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:19:14.626 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:19:14.626 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:19:14.635 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:14.636 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:14.636 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:14.641 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:14.641 +07:00 [ERR] Connection id "0HNCJH4JQKAOK", Request id "0HNCJH4JQKAOK:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:14.643 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 30.5895ms
2025-05-15 15:19:18.572 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:19:18.572 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:18.572 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:18.572 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:18.573 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:19:18.574 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 15:19:18.575 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:19:18.575 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:18.576 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:18.576 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:18.576 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:18.577 +07:00 [ERR] Connection id "0HNCJH4JQKAOL", Request id "0HNCJH4JQKAOL:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:18.578 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 5.9501ms
2025-05-15 15:19:19.653 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:19:19.654 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:19.654 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:19:19.666 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:19:19.666 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:19:19.674 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:19.675 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:19.675 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:19.677 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:19.677 +07:00 [ERR] Connection id "0HNCJH4JQKAOM", Request id "0HNCJH4JQKAOM:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:19.681 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 27.0224ms
2025-05-15 15:19:23.585 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:19:23.585 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:23.585 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:23.585 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:23.586 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:19:23.587 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 15:19:23.587 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:19:23.588 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (997): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:23.589 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:23.589 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:23.589 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:23.589 +07:00 [ERR] Connection id "0HNCJH4JQKAON", Request id "0HNCJH4JQKAON:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:23.591 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 5.6269ms
2025-05-15 15:19:24.697 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:19:24.697 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:24.698 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:19:24.712 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:19:24.712 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:19:24.721 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:24.721 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:24.722 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:24.723 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:24.724 +07:00 [ERR] Connection id "0HNCJH4JQKAOO", Request id "0HNCJH4JQKAOO:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:24.726 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 28.6379ms
2025-05-15 15:19:28.610 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-15 15:19:28.610 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:28.610 +07:00 [INF] CORS policy execution successful.
2025-05-15 15:19:28.610 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:28.611 +07:00 [INF] New WebSocket connection from ::1. Waiting for bootup message.
2025-05-15 15:19:28.614 +07:00 [INF] Received message: {"type":"bootup","sender_id":3,"conversation_id":1}
2025-05-15 15:19:28.615 +07:00 [INF] Client with UserId 3 already exists. Closing new connection.
2025-05-15 15:19:28.616 +07:00 [ERR] Error handling WebSocket connection from ::1
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:28.616 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:28.617 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:28.622 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:28.624 +07:00 [ERR] Connection id "0HNCJH4JQKAOP", Request id "0HNCJH4JQKAOP:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:28.629 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 18.8846ms
2025-05-15 15:19:29.744 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - null null
2025-05-15 15:19:29.744 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-15 15:19:29.745 +07:00 [INF] New WebSocket connection from 192.168.1.2. Waiting for bootup message.
2025-05-15 15:19:29.759 +07:00 [INF] Received message: {"type":"bootup","sender_id":2,"conversation_id":19}
2025-05-15 15:19:29.759 +07:00 [INF] Client with UserId 2 already exists. Closing new connection.
2025-05-15 15:19:29.768 +07:00 [ERR] Error handling WebSocket connection from 192.168.1.2
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 192
2025-05-15 15:19:29.769 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-15 15:19:29.770 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-15 15:19:29.770 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-15 15:19:29.771 +07:00 [ERR] Connection id "0HNCJH4JQKAOQ", Request id "0HNCJH4JQKAOQ:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The WebSocket is in an invalid state ('Closed') for this operation. Valid states are: 'Open, CloseReceived, CloseSent'
   at System.Net.WebSockets.WebSocketValidate.ThrowIfInvalidState(WebSocketState currentState, Boolean isDisposed, WebSocketState[] validStates)
   at System.Net.WebSockets.ManagedWebSocket.CloseAsync(WebSocketCloseStatus closeStatus, String statusDescription, CancellationToken cancellationToken)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 199
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 92
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-15 15:19:29.773 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.3:5053/ws/chat?userId=2 - 101 null null 28.224ms
