2025-05-08 10:57:00.502 +07:00 [INF] Executed DbCommand (49ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-08 10:57:00.723 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-08 10:57:00.842 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-08 10:57:00.853 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-08 10:57:00.855 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-08 10:57:00.855 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-08 10:57:00.855 +07:00 [INF] Hosting environment: Development
2025-05-08 10:57:00.855 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-08 10:57:21.407 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-08 10:57:21.407 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-08 10:57:21.450 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:57:21.450 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:57:21.504 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:57:21.505 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:57:21.506 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-08 10:57:21.589 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 10:57:21.589 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 10:57:21.833 +07:00 [INF] Executed DbCommand (33ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 10:57:21.833 +07:00 [INF] Executed DbCommand (29ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 10:57:21.910 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 10:57:26.631 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 10:57:26.636 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 5229.2612ms
2025-05-08 10:57:28.790 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 10:57:28.791 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 7385.5843ms
2025-05-08 10:59:09.768 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 10:59:09.777 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:09.782 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 14.6757ms
2025-05-08 10:59:09.807 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-08 10:59:09.809 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:09.813 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:09.819 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 10:59:09.898 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 10:59:10.224 +07:00 [INF] Executed DbCommand (25ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 10:59:10.500 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 10:59:10.604 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 698.5523ms
2025-05-08 10:59:10.605 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 10:59:10.612 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 804.8772ms
2025-05-08 10:59:10.733 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-08 10:59:10.734 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:10.737 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:10.739 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 10:59:10.750 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 10:59:10.857 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 10:59:10.857 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:10.858 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 1.0774ms
2025-05-08 10:59:10.860 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 10:59:10.860 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:10.861 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:10.861 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 10:59:10.867 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 10:59:10.892 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 10:59:10.898 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 10:59:10.924 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 10:59:10.925 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 175.1354ms
2025-05-08 10:59:10.925 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 10:59:10.926 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 193.1929ms
2025-05-08 10:59:10.933 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 65.6208ms
2025-05-08 10:59:10.933 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 10:59:10.933 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 73.6353ms
2025-05-08 10:59:10.945 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-08 10:59:10.945 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:10.946 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:10.947 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 10:59:11.135 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 10:59:38.328 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 10:59:38.329 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.330 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 1.0017ms
2025-05-08 10:59:38.332 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-08 10:59:38.333 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.334 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.334 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 10:59:38.335 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 10:59:38.343 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 10:59:38.345 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 10:59:38.345 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 10.1237ms
2025-05-08 10:59:38.345 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 10:59:38.346 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 13.131ms
2025-05-08 10:59:38.519 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-08 10:59:38.519 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.522 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.524 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 10:59:38.524 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 10:59:38.533 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 10:59:38.534 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 10:59:38.534 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 10.2047ms
2025-05-08 10:59:38.534 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 10:59:38.535 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 15.8389ms
2025-05-08 10:59:38.626 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-08 10:59:38.626 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.626 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.3857ms
2025-05-08 10:59:38.630 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-08 10:59:38.631 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.637 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.637 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 10:59:38.638 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 10:59:38.647 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 10:59:38.647 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 8.8209ms
2025-05-08 10:59:38.647 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 10:59:38.648 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 17.1864ms
2025-05-08 10:59:38.714 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-08 10:59:38.714 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.715 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:38.715 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 10:59:38.848 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 10:59:38.859 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 10:59:51.414 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/18/3 - null null
2025-05-08 10:59:51.415 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.417 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/18/3 - 204 null null 2.5608ms
2025-05-08 10:59:51.418 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/18/3 - null null
2025-05-08 10:59:51.418 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.419 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.419 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 10:59:51.426 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 10:59:51.463 +07:00 [INF] Retrieved 11 messages from Redis for conversation 18
2025-05-08 10:59:51.465 +07:00 [INF] Retrieved 11 messages from Redis for conversation 18 and user 3
2025-05-08 10:59:51.465 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 10:59:51.468 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 42.3546ms
2025-05-08 10:59:51.468 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 10:59:51.468 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/18/3 - 200 null application/json; charset=utf-8 50.0528ms
2025-05-08 10:59:51.477 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/18 - null null
2025-05-08 10:59:51.478 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.478 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/18 - 204 null null 0.4157ms
2025-05-08 10:59:51.480 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/18 - null null
2025-05-08 10:59:51.480 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.480 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.480 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 10:59:51.484 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 10:59:51.578 +07:00 [INF] Executed DbCommand (32ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 10:59:51.614 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 10:59:51.617 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 132.4281ms
2025-05-08 10:59:51.617 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 10:59:51.617 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/18 - 200 null application/json; charset=utf-8 137.4383ms
2025-05-08 10:59:51.624 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/18 - null null
2025-05-08 10:59:51.624 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.624 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/18 - 204 null null 0.2339ms
2025-05-08 10:59:51.626 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/18 - null null
2025-05-08 10:59:51.626 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.626 +07:00 [INF] CORS policy execution successful.
2025-05-08 10:59:51.626 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 10:59:51.630 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 10:59:51.652 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 10:59:51.653 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 10:59:51.657 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 26.8573ms
2025-05-08 10:59:51.657 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 10:59:51.657 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/18 - 200 null application/json; charset=utf-8 31.4866ms
2025-05-08 11:00:00.077 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/18/2 - null null
2025-05-08 11:00:00.078 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.079 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/18/2 - 204 null null 1.3134ms
2025-05-08 11:00:00.080 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/18/2 - null null
2025-05-08 11:00:00.080 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.082 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.082 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 11:00:00.082 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 11:00:00.088 +07:00 [INF] Retrieved 11 messages from Redis for conversation 18
2025-05-08 11:00:00.089 +07:00 [INF] Retrieved 11 messages from Redis for conversation 18 and user 2
2025-05-08 11:00:00.089 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 11:00:00.089 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 7.1623ms
2025-05-08 11:00:00.090 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 11:00:00.090 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/18/2 - 200 null application/json; charset=utf-8 9.7935ms
2025-05-08 11:00:00.099 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/18 - null null
2025-05-08 11:00:00.099 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.099 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/18 - 204 null null 0.2859ms
2025-05-08 11:00:00.101 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/18 - null null
2025-05-08 11:00:00.101 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.101 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.101 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 11:00:00.101 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 11:00:00.111 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 11:00:00.112 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 11:00:00.112 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 10.8966ms
2025-05-08 11:00:00.112 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 11:00:00.113 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/18 - 200 null application/json; charset=utf-8 11.9628ms
2025-05-08 11:00:00.122 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/18 - null null
2025-05-08 11:00:00.122 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.122 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/18 - 204 null null 0.3362ms
2025-05-08 11:00:00.124 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/18 - null null
2025-05-08 11:00:00.124 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.125 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:00:00.125 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 11:00:00.125 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 11:00:00.129 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 11:00:00.130 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 11:00:00.130 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.7201ms
2025-05-08 11:00:00.130 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 11:00:00.131 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/18 - 200 null application/json; charset=utf-8 7.0005ms
2025-05-08 11:00:04.519 +07:00 [INF] Handling message from user 3: asjd
2025-05-08 11:00:04.552 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 11:00:04.772 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:00:04.784 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 11:00:04.802 +07:00 [INF] Message saved to DB with ID: 172
2025-05-08 11:00:04.805 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:00:04.812 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 11:00:04.819 +07:00 [INF] Transaction committed for message: 172
2025-05-08 11:00:15.654 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 11:01:45.414 +07:00 [INF] Executed DbCommand (45ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-08 11:01:45.658 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-08 11:01:45.776 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-08 11:01:45.799 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-08 11:01:45.801 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-08 11:01:45.804 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-08 11:01:45.806 +07:00 [INF] Hosting environment: Development
2025-05-08 11:01:45.807 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-08 11:01:45.982 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-08 11:01:46.022 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:01:46.060 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:01:46.064 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-08 11:01:46.103 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 11:01:46.289 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 11:01:47.455 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-08 11:01:47.460 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:01:47.464 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:01:47.467 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 11:01:47.554 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 11:01:47.586 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 11:04:58.898 +07:00 [INF] Handling message from user 3: asdas
2025-05-08 11:04:59.094 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 11:04:59.587 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:04:59.619 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 11:04:59.689 +07:00 [INF] Message saved to DB with ID: 173
2025-05-08 11:04:59.700 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:04:59.712 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 11:04:59.743 +07:00 [INF] Transaction committed for message: 173
2025-05-08 11:04:59.771 +07:00 [INF] Saved message 173 to Redis
2025-05-08 11:04:59.779 +07:00 [INF] Added message 173 to conversation 18
2025-05-08 11:04:59.872 +07:00 [INF] Published message to channel conversation:18
2025-05-08 11:05:05.235 +07:00 [INF] Handling message from user 2: kasjfds
2025-05-08 11:05:05.244 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 11:05:05.271 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:05:05.275 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 11:05:05.279 +07:00 [INF] Message saved to DB with ID: 174
2025-05-08 11:05:05.286 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:05:05.290 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 11:05:05.298 +07:00 [INF] Transaction committed for message: 174
2025-05-08 11:05:05.310 +07:00 [INF] Saved message 174 to Redis
2025-05-08 11:05:05.313 +07:00 [INF] Added message 174 to conversation 18
2025-05-08 11:05:05.319 +07:00 [INF] Published message to channel conversation:18
2025-05-08 11:05:13.057 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/18/3 - null null
2025-05-08 11:05:13.070 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.089 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/18/3 - 204 null null 30.7709ms
2025-05-08 11:05:13.103 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/18/3 - null null
2025-05-08 11:05:13.108 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.110 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.116 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 11:05:13.171 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 11:05:13.271 +07:00 [INF] Retrieved 13 messages from Redis for conversation 18
2025-05-08 11:05:13.280 +07:00 [INF] Retrieved 13 messages from Redis for conversation 18 and user 3
2025-05-08 11:05:13.298 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 11:05:13.338 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 155.5526ms
2025-05-08 11:05:13.343 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 11:05:13.353 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/18/3 - 200 null application/json; charset=utf-8 250.019ms
2025-05-08 11:05:13.371 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/18 - null null
2025-05-08 11:05:13.376 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.378 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/18 - 204 null null 7.4227ms
2025-05-08 11:05:13.405 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/18 - null null
2025-05-08 11:05:13.413 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.423 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.430 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 11:05:13.446 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 11:05:13.652 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 11:05:13.709 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 11:05:13.759 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 307.4293ms
2025-05-08 11:05:13.763 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 11:05:13.777 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/18 - 200 null application/json; charset=utf-8 370.8189ms
2025-05-08 11:05:13.788 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/18 - null null
2025-05-08 11:05:13.796 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.800 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/18 - 204 null null 11.3691ms
2025-05-08 11:05:13.810 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/18 - null null
2025-05-08 11:05:13.818 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.820 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:05:13.823 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 11:05:13.837 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 11:05:13.863 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 11:05:13.871 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 11:05:13.895 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 52.4712ms
2025-05-08 11:05:13.899 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 11:05:13.907 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/18 - 200 null application/json; charset=utf-8 96.7874ms
2025-05-08 11:05:18.386 +07:00 [INF] Handling message from user 3: asda
2025-05-08 11:05:18.413 +07:00 [INF] Executed DbCommand (21ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 11:05:18.441 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:05:18.458 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 11:05:18.463 +07:00 [INF] Message saved to DB with ID: 175
2025-05-08 11:05:18.468 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:05:18.477 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 11:05:18.488 +07:00 [INF] Transaction committed for message: 175
2025-05-08 11:05:18.491 +07:00 [INF] Saved message 175 to Redis
2025-05-08 11:05:18.494 +07:00 [INF] Added message 175 to conversation 18
2025-05-08 11:05:18.496 +07:00 [INF] Published message to channel conversation:18
2025-05-08 11:07:16.017 +07:00 [INF] Application is shutting down...
2025-05-08 11:07:46.038 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 11:07:46.038 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 11:07:46.043 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 360062.9518ms
2025-05-08 11:07:46.043 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 358587.5998ms
2025-05-08 11:08:55.056 +07:00 [INF] Executed DbCommand (33ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-08 11:08:55.235 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-08 11:08:55.297 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-08 11:08:55.312 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-08 11:08:55.314 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-08 11:08:55.315 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-08 11:08:55.317 +07:00 [INF] Hosting environment: Development
2025-05-08 11:08:55.318 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-08 11:08:57.613 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-08 11:08:57.647 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:08:57.677 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:08:57.679 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-08 11:08:57.712 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 11:08:57.742 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-08 11:08:57.747 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:08:57.750 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:08:57.752 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 11:08:57.936 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 11:08:57.936 +07:00 [INF] Executed DbCommand (20ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 11:08:57.979 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 11:09:04.432 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/18/2 - null null
2025-05-08 11:09:04.440 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:04.447 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/18/2 - 204 null null 14.0008ms
2025-05-08 11:09:04.465 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/18/2 - null null
2025-05-08 11:09:04.471 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:04.475 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:04.481 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 11:09:04.533 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 11:09:04.634 +07:00 [INF] Retrieved 14 messages from Redis for conversation 18
2025-05-08 11:09:04.645 +07:00 [INF] Retrieved 14 messages from Redis for conversation 18 and user 2
2025-05-08 11:09:04.664 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 11:09:04.753 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 209.522ms
2025-05-08 11:09:04.757 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 11:09:04.764 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/18/2 - 200 null application/json; charset=utf-8 298.545ms
2025-05-08 11:09:04.781 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/18 - null null
2025-05-08 11:09:04.790 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:04.793 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/18 - 204 null null 11.6547ms
2025-05-08 11:09:04.803 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/18 - null null
2025-05-08 11:09:04.814 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:04.819 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:04.825 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 11:09:04.847 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 11:09:05.266 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 11:09:05.469 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 11:09:05.583 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 731.6558ms
2025-05-08 11:09:05.591 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 11:09:05.622 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/18 - 200 null application/json; charset=utf-8 818.0191ms
2025-05-08 11:09:05.650 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/18 - null null
2025-05-08 11:09:05.658 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:05.661 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/18 - 204 null null 11.5024ms
2025-05-08 11:09:05.674 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/18 - null null
2025-05-08 11:09:05.679 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:05.682 +07:00 [INF] CORS policy execution successful.
2025-05-08 11:09:05.685 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 11:09:05.700 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 11:09:05.745 +07:00 [INF] Executed DbCommand (21ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 11:09:05.765 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 11:09:05.788 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 81.5237ms
2025-05-08 11:09:05.792 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 11:09:05.794 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/18 - 200 null application/json; charset=utf-8 120.1596ms
2025-05-08 11:09:09.602 +07:00 [INF] Handling message from user 3: sdfdf
2025-05-08 11:09:09.646 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 11:09:09.987 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:09:10.013 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 11:09:10.065 +07:00 [INF] Message saved to DB with ID: 176
2025-05-08 11:09:10.080 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 11:09:10.096 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 11:09:10.134 +07:00 [INF] Transaction committed for message: 176
2025-05-08 11:09:10.148 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 12:20:46.960 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 13:29:30.673 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 112
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 95
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 89
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-08 13:29:30.720 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-08 13:29:30.723 +07:00 [ERR] Connection id "0HNCDSO71DG02", Request id "0HNCDSO71DG02:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 112
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 95
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 89
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-08 13:29:30.732 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 8432989.5851ms
2025-05-08 13:36:29.084 +07:00 [INF] Application is shutting down...
2025-05-08 16:58:48.833 +07:00 [INF] Executed DbCommand (59ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-08 16:58:48.981 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-08 16:58:49.070 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-08 16:58:49.079 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-08 16:58:49.080 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-08 16:58:49.080 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-08 16:58:49.080 +07:00 [INF] Hosting environment: Development
2025-05-08 16:58:49.080 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-08 17:06:37.292 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 17:06:37.340 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:37.355 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 68.7055ms
2025-05-08 17:06:37.362 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-08 17:06:37.364 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:37.413 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:37.415 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-08 17:06:37.473 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 17:06:37.521 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 17:06:37.949 +07:00 [INF] Executed DbCommand (62ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 17:06:38.162 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 17:06:38.261 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 734.9803ms
2025-05-08 17:06:38.262 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 17:06:38.268 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 906.5485ms
2025-05-08 17:06:38.407 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-08 17:06:38.413 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:38.418 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:38.419 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 17:06:38.430 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 17:06:38.506 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 17:06:38.506 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:38.506 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.6015ms
2025-05-08 17:06:38.508 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 17:06:38.509 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:38.509 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:38.513 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 17:06:38.522 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:06:38.571 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 17:06:38.578 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 55.6792ms
2025-05-08 17:06:38.579 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 17:06:38.579 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 71.2337ms
2025-05-08 17:06:38.590 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-08 17:06:38.593 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:38.593 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:38.593 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 17:06:38.687 +07:00 [INF] Executed DbCommand (21ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 17:06:38.689 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:06:38.706 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 275.1986ms
2025-05-08 17:06:38.706 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 17:06:38.707 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 299.9572ms
2025-05-08 17:06:38.756 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 17:06:54.969 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 17:06:54.970 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:54.973 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 3.0585ms
2025-05-08 17:06:54.973 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 53
2025-05-08 17:06:54.974 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:54.975 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:54.975 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 17:06:54.976 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 17:06:54.999 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 17:06:55.003 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 17:06:55.006 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 30.3568ms
2025-05-08 17:06:55.006 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 17:06:55.007 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 33.3861ms
2025-05-08 17:06:55.148 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/5 - null null
2025-05-08 17:06:55.148 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:55.150 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:55.150 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 17:06:55.151 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 17:06:55.160 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 17:06:55.161 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:06:55.162 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 10.9157ms
2025-05-08 17:06:55.163 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 17:06:55.163 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/5 - 200 null application/json; charset=utf-8 15.8353ms
2025-05-08 17:06:55.232 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/5 - null null
2025-05-08 17:06:55.232 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:55.232 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/5 - 204 null null 0.45ms
2025-05-08 17:06:55.234 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/5 - null null
2025-05-08 17:06:55.234 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:55.236 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:55.236 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 17:06:55.237 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:06:55.377 +07:00 [INF] Executed DbCommand (34ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-08 17:06:55.397 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 17:06:55.398 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 161.4294ms
2025-05-08 17:06:55.399 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 17:06:55.399 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/5 - 200 null application/json; charset=utf-8 165.4772ms
2025-05-08 17:06:55.409 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=5 - null null
2025-05-08 17:06:55.410 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:55.411 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:55.411 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 17:06:55.514 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 17:06:55.758 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 17:06:55.762 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 17:06:59.326 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/5 - null null
2025-05-08 17:06:59.326 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.327 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/5 - 204 null null 1.4036ms
2025-05-08 17:06:59.328 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/5 - null null
2025-05-08 17:06:59.328 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.329 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.329 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:06:59.336 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:06:59.444 +07:00 [INF] Retrieved 50 messages from Redis for conversation 4
2025-05-08 17:06:59.448 +07:00 [INF] Retrieved 50 messages from Redis for conversation 4 and user 5
2025-05-08 17:06:59.448 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 17:06:59.455 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 119.1729ms
2025-05-08 17:06:59.455 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:06:59.456 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/5 - 200 null application/json; charset=utf-8 127.7225ms
2025-05-08 17:06:59.471 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:06:59.471 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.472 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - 204 null null 0.532ms
2025-05-08 17:06:59.473 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:06:59.473 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.474 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.474 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:06:59.479 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:06:59.645 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 17:06:59.720 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 17:06:59.726 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 246.3124ms
2025-05-08 17:06:59.726 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:06:59.726 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - 200 null application/json; charset=utf-8 253.0446ms
2025-05-08 17:06:59.733 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:06:59.733 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.733 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - 204 null null 0.554ms
2025-05-08 17:06:59.735 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:06:59.735 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.735 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:06:59.736 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:06:59.742 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:06:59.757 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:06:59.759 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:06:59.762 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 19.3917ms
2025-05-08 17:06:59.762 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:06:59.762 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 27.2808ms
2025-05-08 17:07:05.714 +07:00 [INF] Handling message from user 5: sdfas
2025-05-08 17:07:05.750 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 17:07:05.981 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 17:07:06.020 +07:00 [INF] Executed DbCommand (33ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 17:07:06.057 +07:00 [INF] Message saved to DB with ID: 177
2025-05-08 17:07:06.063 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 17:07:06.076 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 17:07:06.094 +07:00 [INF] Transaction committed for message: 177
2025-05-08 17:07:06.107 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 17:07:06.117 +07:00 [INF] Saved message 177 to Redis
2025-05-08 17:07:06.120 +07:00 [INF] Added message 177 to conversation 4
2025-05-08 17:07:06.131 +07:00 [INF] Published message to channel conversation:4
2025-05-08 17:07:12.417 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:07:12.417 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:12.417 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - 204 null null 0.3734ms
2025-05-08 17:07:12.418 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:07:12.419 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:12.421 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:12.421 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:12.422 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:07:12.441 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:07:12.442 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:07:12.443 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 20.9258ms
2025-05-08 17:07:12.443 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:12.443 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 24.4227ms
2025-05-08 17:07:16.681 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:07:16.681 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:16.681 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:16.681 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:16.682 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:07:16.686 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:07:16.694 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:07:16.694 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 12.6419ms
2025-05-08 17:07:16.694 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:16.695 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 13.4928ms
2025-05-08 17:07:21.150 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/DeleteMessageForMe/4/5 - null null
2025-05-08 17:07:21.151 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:21.151 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/DeleteMessageForMe/4/5 - 204 null null 0.4851ms
2025-05-08 17:07:21.152 +07:00 [INF] Request starting HTTP/1.1 DELETE http://localhost:5053/api/Message/DeleteMessageForMe/4/5 - null null
2025-05-08 17:07:21.152 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:21.154 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:21.154 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.DeleteMessageConversationForMe (Message_app)'
2025-05-08 17:07:21.163 +07:00 [INF] Route matched with {action = "DeleteMessageConversationForMe", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] DeleteMessageConversationForMe(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:07:21.199 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 17:07:21.215 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-08 17:07:21.241 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__user_id_0='?' (DbType = Int32), @__conversation_id_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [m].[id], [m].[cleared_at], [m].[conversation_id], [m].[user_id]
FROM [messageDeletions] AS [m]
WHERE [m].[user_id] = @__user_id_0 AND [m].[conversation_id] = @__conversation_id_1
2025-05-08 17:07:21.284 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p0='?' (DbType = DateTime2), @p1='?' (DbType = Int32), @p2='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [messageDeletions] ([cleared_at], [conversation_id], [user_id])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2);
2025-05-08 17:07:21.300 +07:00 [INF] Deleted message 31 from Redis
2025-05-08 17:07:21.301 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.301 +07:00 [INF] Deleted message 32 from Redis
2025-05-08 17:07:21.302 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.302 +07:00 [INF] Deleted message 33 from Redis
2025-05-08 17:07:21.303 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.303 +07:00 [INF] Deleted message 34 from Redis
2025-05-08 17:07:21.304 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.309 +07:00 [INF] Deleted message 35 from Redis
2025-05-08 17:07:21.310 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.310 +07:00 [INF] Deleted message 36 from Redis
2025-05-08 17:07:21.311 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.312 +07:00 [INF] Deleted message 37 from Redis
2025-05-08 17:07:21.312 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.313 +07:00 [INF] Deleted message 38 from Redis
2025-05-08 17:07:21.314 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.314 +07:00 [INF] Deleted message 39 from Redis
2025-05-08 17:07:21.314 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.315 +07:00 [INF] Deleted message 40 from Redis
2025-05-08 17:07:21.315 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.315 +07:00 [INF] Deleted message 41 from Redis
2025-05-08 17:07:21.316 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.316 +07:00 [INF] Deleted message 42 from Redis
2025-05-08 17:07:21.317 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.317 +07:00 [INF] Deleted message 43 from Redis
2025-05-08 17:07:21.318 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.318 +07:00 [INF] Deleted message 44 from Redis
2025-05-08 17:07:21.318 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.319 +07:00 [INF] Deleted message 45 from Redis
2025-05-08 17:07:21.319 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.320 +07:00 [INF] Deleted message 46 from Redis
2025-05-08 17:07:21.320 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.320 +07:00 [INF] Deleted message 47 from Redis
2025-05-08 17:07:21.321 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.322 +07:00 [INF] Deleted message 50 from Redis
2025-05-08 17:07:21.323 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.324 +07:00 [INF] Deleted message 52 from Redis
2025-05-08 17:07:21.324 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.325 +07:00 [INF] Deleted message 53 from Redis
2025-05-08 17:07:21.325 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.325 +07:00 [INF] Deleted message 56 from Redis
2025-05-08 17:07:21.326 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.326 +07:00 [INF] Deleted message 58 from Redis
2025-05-08 17:07:21.327 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.327 +07:00 [INF] Deleted message 63 from Redis
2025-05-08 17:07:21.328 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.328 +07:00 [INF] Deleted message 66 from Redis
2025-05-08 17:07:21.329 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.329 +07:00 [INF] Deleted message 67 from Redis
2025-05-08 17:07:21.329 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.330 +07:00 [INF] Deleted message 69 from Redis
2025-05-08 17:07:21.330 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.330 +07:00 [INF] Deleted message 89 from Redis
2025-05-08 17:07:21.331 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.331 +07:00 [INF] Deleted message 96 from Redis
2025-05-08 17:07:21.332 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.332 +07:00 [INF] Deleted message 97 from Redis
2025-05-08 17:07:21.332 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.333 +07:00 [INF] Deleted message 111 from Redis
2025-05-08 17:07:21.333 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.334 +07:00 [INF] Deleted message 118 from Redis
2025-05-08 17:07:21.334 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.335 +07:00 [INF] Deleted message 119 from Redis
2025-05-08 17:07:21.335 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.335 +07:00 [INF] Deleted message 120 from Redis
2025-05-08 17:07:21.336 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.336 +07:00 [INF] Deleted message 121 from Redis
2025-05-08 17:07:21.336 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.337 +07:00 [INF] Deleted message 122 from Redis
2025-05-08 17:07:21.337 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.337 +07:00 [INF] Deleted message 123 from Redis
2025-05-08 17:07:21.337 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.338 +07:00 [INF] Deleted message 124 from Redis
2025-05-08 17:07:21.339 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.340 +07:00 [INF] Deleted message 125 from Redis
2025-05-08 17:07:21.340 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.341 +07:00 [INF] Deleted message 126 from Redis
2025-05-08 17:07:21.341 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.341 +07:00 [INF] Deleted message 127 from Redis
2025-05-08 17:07:21.342 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.342 +07:00 [INF] Deleted message 128 from Redis
2025-05-08 17:07:21.342 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.342 +07:00 [INF] Deleted message 129 from Redis
2025-05-08 17:07:21.343 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.343 +07:00 [INF] Deleted message 130 from Redis
2025-05-08 17:07:21.343 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.344 +07:00 [INF] Deleted message 131 from Redis
2025-05-08 17:07:21.344 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.344 +07:00 [INF] Deleted message 132 from Redis
2025-05-08 17:07:21.345 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.345 +07:00 [INF] Deleted message 133 from Redis
2025-05-08 17:07:21.345 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.345 +07:00 [INF] Deleted message 135 from Redis
2025-05-08 17:07:21.346 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.346 +07:00 [INF] Deleted message 159 from Redis
2025-05-08 17:07:21.346 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.347 +07:00 [INF] Deleted message 160 from Redis
2025-05-08 17:07:21.347 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.347 +07:00 [INF] Deleted message 161 from Redis
2025-05-08 17:07:21.348 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.348 +07:00 [INF] Deleted message 177 from Redis
2025-05-08 17:07:21.348 +07:00 [INF] Deleted all messages for conversation 4 from Redis
2025-05-08 17:07:21.349 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType12`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.String, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:07:21.351 +07:00 [INF] Executed action server.Controllers.MessageController.DeleteMessageConversationForMe (Message_app) in 187.3192ms
2025-05-08 17:07:21.351 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.DeleteMessageConversationForMe (Message_app)'
2025-05-08 17:07:21.351 +07:00 [INF] Request finished HTTP/1.1 DELETE http://localhost:5053/api/Message/DeleteMessageForMe/4/5 - 200 null application/json; charset=utf-8 199.1831ms
2025-05-08 17:07:23.179 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/5 - null null
2025-05-08 17:07:23.179 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.180 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/5 - 204 null null 0.2876ms
2025-05-08 17:07:23.181 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/5 - null null
2025-05-08 17:07:23.181 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.181 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.182 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:07:23.182 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:07:23.197 +07:00 [INF] Retrieved 0 messages from Redis for conversation 4
2025-05-08 17:07:23.220 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__user_id_0='?' (DbType = Int32), @__conversationId_1='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [m].[cleared_at]
FROM [messageDeletions] AS [m]
WHERE [m].[user_id] = @__user_id_0 AND CAST([m].[conversation_id] AS bigint) = @__conversationId_1
2025-05-08 17:07:23.256 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__p_2='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int64), @__clearedAt_1='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[content], [t].[conversation_id], [t].[created_at], [t].[isFile], [t].[isRecalled], [t].[is_read], [t].[sender_id], [t].[type], [a].[id], [a].[FileSize], [a].[file_type], [a].[file_url], [a].[is_temporary], [a].[message_id], [a].[uploaded_at]
FROM (
    SELECT TOP(@__p_2) [m].[id], [m].[content], [m].[conversation_id], [m].[created_at], [m].[isFile], [m].[isRecalled], [m].[is_read], [m].[sender_id], [m].[type]
    FROM [Messages] AS [m]
    WHERE CAST([m].[conversation_id] AS bigint) = @__conversationId_0 AND [m].[created_at] > @__clearedAt_1
    ORDER BY [m].[created_at] DESC
) AS [t]
LEFT JOIN [Attachments] AS [a] ON [t].[id] = [a].[message_id]
ORDER BY [t].[created_at] DESC, [t].[id]
2025-05-08 17:07:23.259 +07:00 [INF] Executing NotFoundObjectResult, writing value of type 'System.String'.
2025-05-08 17:07:23.259 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 77.1581ms
2025-05-08 17:07:23.260 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:07:23.260 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/5 - 404 null text/plain; charset=utf-8 78.8079ms
2025-05-08 17:07:23.399 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:07:23.399 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.399 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - 204 null null 0.2257ms
2025-05-08 17:07:23.401 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:07:23.401 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.401 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.401 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:07:23.401 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:07:23.424 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 17:07:23.424 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 17:07:23.425 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 23.1982ms
2025-05-08 17:07:23.425 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:07:23.425 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - 200 null application/json; charset=utf-8 24.4756ms
2025-05-08 17:07:23.432 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:07:23.432 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.433 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - 204 null null 0.4842ms
2025-05-08 17:07:23.434 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:07:23.434 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.435 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:23.435 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:23.435 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:07:23.437 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:07:23.439 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:07:23.439 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.8362ms
2025-05-08 17:07:23.439 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:23.439 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 5.1769ms
2025-05-08 17:07:27.661 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/5 - null null
2025-05-08 17:07:27.661 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:27.661 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:27.662 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:07:27.662 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:07:27.664 +07:00 [INF] Retrieved 0 messages from Redis for conversation 4
2025-05-08 17:07:27.666 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__user_id_0='?' (DbType = Int32), @__conversationId_1='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [m].[cleared_at]
FROM [messageDeletions] AS [m]
WHERE [m].[user_id] = @__user_id_0 AND CAST([m].[conversation_id] AS bigint) = @__conversationId_1
2025-05-08 17:07:27.669 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__p_2='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int64), @__clearedAt_1='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[content], [t].[conversation_id], [t].[created_at], [t].[isFile], [t].[isRecalled], [t].[is_read], [t].[sender_id], [t].[type], [a].[id], [a].[FileSize], [a].[file_type], [a].[file_url], [a].[is_temporary], [a].[message_id], [a].[uploaded_at]
FROM (
    SELECT TOP(@__p_2) [m].[id], [m].[content], [m].[conversation_id], [m].[created_at], [m].[isFile], [m].[isRecalled], [m].[is_read], [m].[sender_id], [m].[type]
    FROM [Messages] AS [m]
    WHERE CAST([m].[conversation_id] AS bigint) = @__conversationId_0 AND [m].[created_at] > @__clearedAt_1
    ORDER BY [m].[created_at] DESC
) AS [t]
LEFT JOIN [Attachments] AS [a] ON [t].[id] = [a].[message_id]
ORDER BY [t].[created_at] DESC, [t].[id]
2025-05-08 17:07:27.671 +07:00 [INF] Executing NotFoundObjectResult, writing value of type 'System.String'.
2025-05-08 17:07:27.675 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 12.8916ms
2025-05-08 17:07:27.675 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:07:27.676 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/5 - 404 null text/plain; charset=utf-8 14.9599ms
2025-05-08 17:07:27.684 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:07:27.685 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:27.685 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:27.685 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:07:27.685 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:07:27.690 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 17:07:27.694 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 17:07:27.695 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 8.9214ms
2025-05-08 17:07:27.695 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:07:27.695 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - 200 null application/json; charset=utf-8 10.5378ms
2025-05-08 17:07:27.700 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:07:27.700 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:27.702 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:27.702 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:27.702 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:07:27.706 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:07:27.707 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:07:27.709 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.4261ms
2025-05-08 17:07:27.709 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:27.709 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 8.757ms
2025-05-08 17:07:32.181 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/2 - null null
2025-05-08 17:07:32.181 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.181 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/2 - 204 null null 0.5146ms
2025-05-08 17:07:32.183 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/2 - null null
2025-05-08 17:07:32.183 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.183 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.184 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:07:32.184 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:07:32.186 +07:00 [INF] Retrieved 0 messages from Redis for conversation 4
2025-05-08 17:07:32.189 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__user_id_0='?' (DbType = Int32), @__conversationId_1='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [m].[cleared_at]
FROM [messageDeletions] AS [m]
WHERE [m].[user_id] = @__user_id_0 AND CAST([m].[conversation_id] AS bigint) = @__conversationId_1
2025-05-08 17:07:32.269 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[content], [t].[conversation_id], [t].[created_at], [t].[isFile], [t].[isRecalled], [t].[is_read], [t].[sender_id], [t].[type], [a].[id], [a].[FileSize], [a].[file_type], [a].[file_url], [a].[is_temporary], [a].[message_id], [a].[uploaded_at]
FROM (
    SELECT TOP(@__p_1) [m].[id], [m].[content], [m].[conversation_id], [m].[created_at], [m].[isFile], [m].[isRecalled], [m].[is_read], [m].[sender_id], [m].[type]
    FROM [Messages] AS [m]
    WHERE CAST([m].[conversation_id] AS bigint) = @__conversationId_0
    ORDER BY [m].[created_at] DESC
) AS [t]
LEFT JOIN [Attachments] AS [a] ON [t].[id] = [a].[message_id]
ORDER BY [t].[created_at] DESC, [t].[id]
2025-05-08 17:07:32.302 +07:00 [INF] Saved message 177 to Redis
2025-05-08 17:07:32.303 +07:00 [INF] Added message 177 to conversation 4
2025-05-08 17:07:32.305 +07:00 [INF] Saved message 161 to Redis
2025-05-08 17:07:32.305 +07:00 [INF] Added message 161 to conversation 4
2025-05-08 17:07:32.307 +07:00 [INF] Saved message 160 to Redis
2025-05-08 17:07:32.307 +07:00 [INF] Added message 160 to conversation 4
2025-05-08 17:07:32.309 +07:00 [INF] Saved message 159 to Redis
2025-05-08 17:07:32.309 +07:00 [INF] Added message 159 to conversation 4
2025-05-08 17:07:32.312 +07:00 [INF] Saved message 135 to Redis
2025-05-08 17:07:32.312 +07:00 [INF] Added message 135 to conversation 4
2025-05-08 17:07:32.314 +07:00 [INF] Saved message 133 to Redis
2025-05-08 17:07:32.315 +07:00 [INF] Added message 133 to conversation 4
2025-05-08 17:07:32.317 +07:00 [INF] Saved message 132 to Redis
2025-05-08 17:07:32.317 +07:00 [INF] Added message 132 to conversation 4
2025-05-08 17:07:32.319 +07:00 [INF] Saved message 131 to Redis
2025-05-08 17:07:32.320 +07:00 [INF] Added message 131 to conversation 4
2025-05-08 17:07:32.322 +07:00 [INF] Saved message 130 to Redis
2025-05-08 17:07:32.322 +07:00 [INF] Added message 130 to conversation 4
2025-05-08 17:07:32.324 +07:00 [INF] Saved message 129 to Redis
2025-05-08 17:07:32.325 +07:00 [INF] Added message 129 to conversation 4
2025-05-08 17:07:32.327 +07:00 [INF] Saved message 128 to Redis
2025-05-08 17:07:32.328 +07:00 [INF] Added message 128 to conversation 4
2025-05-08 17:07:32.329 +07:00 [INF] Saved message 127 to Redis
2025-05-08 17:07:32.330 +07:00 [INF] Added message 127 to conversation 4
2025-05-08 17:07:32.332 +07:00 [INF] Saved message 126 to Redis
2025-05-08 17:07:32.333 +07:00 [INF] Added message 126 to conversation 4
2025-05-08 17:07:32.335 +07:00 [INF] Saved message 125 to Redis
2025-05-08 17:07:32.336 +07:00 [INF] Added message 125 to conversation 4
2025-05-08 17:07:32.338 +07:00 [INF] Saved message 124 to Redis
2025-05-08 17:07:32.338 +07:00 [INF] Added message 124 to conversation 4
2025-05-08 17:07:32.340 +07:00 [INF] Saved message 123 to Redis
2025-05-08 17:07:32.341 +07:00 [INF] Added message 123 to conversation 4
2025-05-08 17:07:32.342 +07:00 [INF] Saved message 122 to Redis
2025-05-08 17:07:32.343 +07:00 [INF] Added message 122 to conversation 4
2025-05-08 17:07:32.345 +07:00 [INF] Saved message 121 to Redis
2025-05-08 17:07:32.346 +07:00 [INF] Added message 121 to conversation 4
2025-05-08 17:07:32.348 +07:00 [INF] Saved message 120 to Redis
2025-05-08 17:07:32.348 +07:00 [INF] Added message 120 to conversation 4
2025-05-08 17:07:32.350 +07:00 [INF] Saved message 119 to Redis
2025-05-08 17:07:32.351 +07:00 [INF] Added message 119 to conversation 4
2025-05-08 17:07:32.353 +07:00 [INF] Saved message 118 to Redis
2025-05-08 17:07:32.353 +07:00 [INF] Added message 118 to conversation 4
2025-05-08 17:07:32.359 +07:00 [INF] Saved message 111 to Redis
2025-05-08 17:07:32.360 +07:00 [INF] Added message 111 to conversation 4
2025-05-08 17:07:32.362 +07:00 [INF] Saved message 97 to Redis
2025-05-08 17:07:32.362 +07:00 [INF] Added message 97 to conversation 4
2025-05-08 17:07:32.365 +07:00 [INF] Saved message 96 to Redis
2025-05-08 17:07:32.365 +07:00 [INF] Added message 96 to conversation 4
2025-05-08 17:07:32.367 +07:00 [INF] Saved message 89 to Redis
2025-05-08 17:07:32.367 +07:00 [INF] Added message 89 to conversation 4
2025-05-08 17:07:32.370 +07:00 [INF] Saved message 69 to Redis
2025-05-08 17:07:32.371 +07:00 [INF] Added message 69 to conversation 4
2025-05-08 17:07:32.372 +07:00 [INF] Saved message 67 to Redis
2025-05-08 17:07:32.373 +07:00 [INF] Added message 67 to conversation 4
2025-05-08 17:07:32.374 +07:00 [INF] Saved message 66 to Redis
2025-05-08 17:07:32.375 +07:00 [INF] Added message 66 to conversation 4
2025-05-08 17:07:32.376 +07:00 [INF] Saved message 63 to Redis
2025-05-08 17:07:32.378 +07:00 [INF] Added message 63 to conversation 4
2025-05-08 17:07:32.379 +07:00 [INF] Saved message 58 to Redis
2025-05-08 17:07:32.380 +07:00 [INF] Added message 58 to conversation 4
2025-05-08 17:07:32.380 +07:00 [INF] Saved message 56 to Redis
2025-05-08 17:07:32.381 +07:00 [INF] Added message 56 to conversation 4
2025-05-08 17:07:32.383 +07:00 [INF] Saved message 53 to Redis
2025-05-08 17:07:32.384 +07:00 [INF] Added message 53 to conversation 4
2025-05-08 17:07:32.386 +07:00 [INF] Saved message 52 to Redis
2025-05-08 17:07:32.387 +07:00 [INF] Added message 52 to conversation 4
2025-05-08 17:07:32.389 +07:00 [INF] Saved message 50 to Redis
2025-05-08 17:07:32.389 +07:00 [INF] Added message 50 to conversation 4
2025-05-08 17:07:32.391 +07:00 [INF] Saved message 47 to Redis
2025-05-08 17:07:32.391 +07:00 [INF] Added message 47 to conversation 4
2025-05-08 17:07:32.393 +07:00 [INF] Saved message 46 to Redis
2025-05-08 17:07:32.393 +07:00 [INF] Added message 46 to conversation 4
2025-05-08 17:07:32.395 +07:00 [INF] Saved message 45 to Redis
2025-05-08 17:07:32.396 +07:00 [INF] Added message 45 to conversation 4
2025-05-08 17:07:32.397 +07:00 [INF] Saved message 44 to Redis
2025-05-08 17:07:32.398 +07:00 [INF] Added message 44 to conversation 4
2025-05-08 17:07:32.399 +07:00 [INF] Saved message 43 to Redis
2025-05-08 17:07:32.400 +07:00 [INF] Added message 43 to conversation 4
2025-05-08 17:07:32.402 +07:00 [INF] Saved message 42 to Redis
2025-05-08 17:07:32.403 +07:00 [INF] Added message 42 to conversation 4
2025-05-08 17:07:32.405 +07:00 [INF] Saved message 41 to Redis
2025-05-08 17:07:32.405 +07:00 [INF] Added message 41 to conversation 4
2025-05-08 17:07:32.407 +07:00 [INF] Saved message 40 to Redis
2025-05-08 17:07:32.407 +07:00 [INF] Added message 40 to conversation 4
2025-05-08 17:07:32.408 +07:00 [INF] Saved message 39 to Redis
2025-05-08 17:07:32.408 +07:00 [INF] Added message 39 to conversation 4
2025-05-08 17:07:32.410 +07:00 [INF] Saved message 38 to Redis
2025-05-08 17:07:32.411 +07:00 [INF] Added message 38 to conversation 4
2025-05-08 17:07:32.413 +07:00 [INF] Saved message 37 to Redis
2025-05-08 17:07:32.414 +07:00 [INF] Added message 37 to conversation 4
2025-05-08 17:07:32.415 +07:00 [INF] Saved message 36 to Redis
2025-05-08 17:07:32.415 +07:00 [INF] Added message 36 to conversation 4
2025-05-08 17:07:32.417 +07:00 [INF] Saved message 35 to Redis
2025-05-08 17:07:32.418 +07:00 [INF] Added message 35 to conversation 4
2025-05-08 17:07:32.421 +07:00 [INF] Saved message 34 to Redis
2025-05-08 17:07:32.421 +07:00 [INF] Added message 34 to conversation 4
2025-05-08 17:07:32.422 +07:00 [INF] Saved message 33 to Redis
2025-05-08 17:07:32.423 +07:00 [INF] Added message 33 to conversation 4
2025-05-08 17:07:32.424 +07:00 [INF] Saved message 32 to Redis
2025-05-08 17:07:32.424 +07:00 [INF] Added message 32 to conversation 4
2025-05-08 17:07:32.424 +07:00 [INF] Cached 50 messages to Redis for conversation 4
2025-05-08 17:07:32.424 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 17:07:32.432 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 247.9787ms
2025-05-08 17:07:32.432 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:07:32.432 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/2 - 200 null application/json; charset=utf-8 249.7346ms
2025-05-08 17:07:32.448 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:07:32.448 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.448 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - 204 null null 0.3112ms
2025-05-08 17:07:32.449 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:07:32.449 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.450 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.450 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:07:32.450 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:07:32.452 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 17:07:32.452 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 17:07:32.453 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 2.8809ms
2025-05-08 17:07:32.453 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:07:32.453 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - 200 null application/json; charset=utf-8 3.8438ms
2025-05-08 17:07:32.461 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:07:32.461 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.461 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - 204 null null 0.3247ms
2025-05-08 17:07:32.464 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:07:32.464 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.464 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:32.464 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:32.465 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:07:32.467 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:07:32.467 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:07:32.467 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 2.8945ms
2025-05-08 17:07:32.468 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:07:32.469 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 4.3791ms
2025-05-08 17:07:36.137 +07:00 [INF] Handling message from user 5: sdv
2025-05-08 17:07:36.144 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 17:07:36.162 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 17:07:36.174 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 17:07:36.175 +07:00 [INF] Message saved to DB with ID: 178
2025-05-08 17:07:36.176 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 17:07:36.183 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 17:07:36.186 +07:00 [INF] Transaction committed for message: 178
2025-05-08 17:07:36.197 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 17:07:36.198 +07:00 [INF] Saved message 178 to Redis
2025-05-08 17:07:36.198 +07:00 [INF] Added message 178 to conversation 4
2025-05-08 17:07:36.200 +07:00 [INF] Published message to channel conversation:4
2025-05-08 17:07:42.133 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/recall_message/178 - null null
2025-05-08 17:07:42.133 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:42.134 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/recall_message/178 - 204 null null 0.4004ms
2025-05-08 17:07:42.135 +07:00 [INF] Request starting HTTP/1.1 PUT http://localhost:5053/api/Message/recall_message/178 - null 0
2025-05-08 17:07:42.135 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:42.135 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:07:42.135 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.recall_message (Message_app)'
2025-05-08 17:07:42.142 +07:00 [INF] Route matched with {action = "recall_message", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] recall_message(Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:07:42.186 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__message_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [m].[id], [m].[content], [m].[conversation_id], [m].[created_at], [m].[isFile], [m].[isRecalled], [m].[is_read], [m].[sender_id], [m].[type]
FROM [Messages] AS [m]
WHERE [m].[id] = @__message_id_0 AND [m].[isRecalled] = CAST(0 AS bit)
2025-05-08 17:07:42.210 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@p8='?' (DbType = Int32), @p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Messages] SET [content] = @p0, [conversation_id] = @p1, [created_at] = @p2, [isFile] = @p3, [isRecalled] = @p4, [is_read] = @p5, [sender_id] = @p6, [type] = @p7
OUTPUT 1
WHERE [id] = @p8;
2025-05-08 17:07:42.210 +07:00 [INF] Message 178 marked as recalled in database
2025-05-08 17:07:42.225 +07:00 [INF] Updated message 178 to recalled with content 'tin nhn  c thu hi' in Redis
2025-05-08 17:07:42.227 +07:00 [INF] Published message to channel conversation:4
2025-05-08 17:07:42.227 +07:00 [INF] Message 178 recall status updated in Redis
2025-05-08 17:07:42.227 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType2`1[[System.String, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:07:42.229 +07:00 [INF] Executed action server.Controllers.MessageController.recall_message (Message_app) in 87.001ms
2025-05-08 17:07:42.229 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.recall_message (Message_app)'
2025-05-08 17:07:42.229 +07:00 [INF] Request finished HTTP/1.1 PUT http://localhost:5053/api/Message/recall_message/178 - 200 null application/json; charset=utf-8 94.442ms
2025-05-08 17:09:46.289 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/open_conversation/2/5 - null null
2025-05-08 17:09:46.289 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.289 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/open_conversation/2/5 - 204 null null 0.4467ms
2025-05-08 17:09:46.291 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/open_conversation/2/5 - null null
2025-05-08 17:09:46.291 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.291 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.291 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.OpenConversation (Message_app)'
2025-05-08 17:09:46.297 +07:00 [INF] Route matched with {action = "OpenConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] OpenConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:09:46.348 +07:00 [INF] Executed DbCommand (26ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-08 17:09:46.351 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-08 17:09:46.461 +07:00 [INF] Executed DbCommand (73ms) [Parameters=[@__user1_0='?' (DbType = Int32), @__user2_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[name], [t].[is_group], [t].[created_at], [t].[lastMessage], [t].[lastMessageTime], [t].[img_url], [t0].[Id], [t0].[user_id], [t0].[ConversationId], [t0].[Name], [t0].[IsDeleted], [t0].[img_url]
FROM (
    SELECT TOP(1) [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url]
    FROM [Conversations] AS [c]
    WHERE [c].[is_group] = CAST(0 AS bit) AND (
        SELECT COUNT(*)
        FROM [Participants] AS [p]
        WHERE [c].[id] = [p].[conversation_id]) = 2 AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p0]
        WHERE [c].[id] = [p0].[conversation_id] AND [p0].[user_id] = @__user1_0) AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p1]
        WHERE [c].[id] = [p1].[conversation_id] AND [p1].[user_id] = @__user2_1)
) AS [t]
LEFT JOIN (
    SELECT [p2].[id] AS [Id], [p2].[user_id], [p2].[conversation_id] AS [ConversationId], [p2].[name] AS [Name], [p2].[is_deleted] AS [IsDeleted], [p2].[img_url]
    FROM [Participants] AS [p2]
    WHERE [p2].[is_deleted] = CAST(0 AS bit)
) AS [t0] ON [t].[id] = [t0].[ConversationId]
ORDER BY [t].[id]
2025-05-08 17:09:46.461 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-08 17:09:46.462 +07:00 [INF] Executed action server.Controllers.ConversationController.OpenConversation (Message_app) in 164.1917ms
2025-05-08 17:09:46.462 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.OpenConversation (Message_app)'
2025-05-08 17:09:46.462 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/open_conversation/2/5 - 200 null application/json; charset=utf-8 171.3621ms
2025-05-08 17:09:46.550 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/2 - null null
2025-05-08 17:09:46.551 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.551 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/2 - 204 null null 0.4483ms
2025-05-08 17:09:46.552 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/2 - null null
2025-05-08 17:09:46.553 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.553 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.553 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:09:46.554 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:09:46.596 +07:00 [INF] Retrieved 51 messages from Redis for conversation 4
2025-05-08 17:09:46.596 +07:00 [INF] Retrieved 50 messages from Redis for conversation 4 and user 2
2025-05-08 17:09:46.596 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 17:09:46.597 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 43.1402ms
2025-05-08 17:09:46.597 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:09:46.597 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/2 - 200 null application/json; charset=utf-8 44.9513ms
2025-05-08 17:09:46.609 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:09:46.609 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.609 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - 204 null null 0.259ms
2025-05-08 17:09:46.610 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:09:46.611 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.611 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.611 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:09:46.611 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:09:46.617 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 17:09:46.619 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 17:09:46.619 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.4702ms
2025-05-08 17:09:46.619 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:09:46.619 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - 200 null application/json; charset=utf-8 8.9118ms
2025-05-08 17:09:46.624 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:09:46.624 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.625 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - 204 null null 0.7502ms
2025-05-08 17:09:46.638 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:09:46.638 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.638 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:46.638 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:09:46.638 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:09:46.642 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:09:46.643 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:09:46.643 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.1628ms
2025-05-08 17:09:46.644 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:09:46.645 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 7.2472ms
2025-05-08 17:09:53.856 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/open_conversation/2/4 - null null
2025-05-08 17:09:53.856 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:53.856 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/open_conversation/2/4 - 204 null null 0.7466ms
2025-05-08 17:09:53.858 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/open_conversation/2/4 - null null
2025-05-08 17:09:53.858 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:53.858 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:53.858 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.OpenConversation (Message_app)'
2025-05-08 17:09:53.858 +07:00 [INF] Route matched with {action = "OpenConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] OpenConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:09:53.879 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-08 17:09:53.886 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-08 17:09:53.889 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__user1_0='?' (DbType = Int32), @__user2_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[name], [t].[is_group], [t].[created_at], [t].[lastMessage], [t].[lastMessageTime], [t].[img_url], [t0].[Id], [t0].[user_id], [t0].[ConversationId], [t0].[Name], [t0].[IsDeleted], [t0].[img_url]
FROM (
    SELECT TOP(1) [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url]
    FROM [Conversations] AS [c]
    WHERE [c].[is_group] = CAST(0 AS bit) AND (
        SELECT COUNT(*)
        FROM [Participants] AS [p]
        WHERE [c].[id] = [p].[conversation_id]) = 2 AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p0]
        WHERE [c].[id] = [p0].[conversation_id] AND [p0].[user_id] = @__user1_0) AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p1]
        WHERE [c].[id] = [p1].[conversation_id] AND [p1].[user_id] = @__user2_1)
) AS [t]
LEFT JOIN (
    SELECT [p2].[id] AS [Id], [p2].[user_id], [p2].[conversation_id] AS [ConversationId], [p2].[name] AS [Name], [p2].[is_deleted] AS [IsDeleted], [p2].[img_url]
    FROM [Participants] AS [p2]
    WHERE [p2].[is_deleted] = CAST(0 AS bit)
) AS [t0] ON [t].[id] = [t0].[ConversationId]
ORDER BY [t].[id]
2025-05-08 17:09:53.890 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-08 17:09:53.896 +07:00 [INF] Executed action server.Controllers.ConversationController.OpenConversation (Message_app) in 38.3465ms
2025-05-08 17:09:53.897 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.OpenConversation (Message_app)'
2025-05-08 17:09:53.897 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/open_conversation/2/4 - 200 null application/json; charset=utf-8 38.9494ms
2025-05-08 17:09:53.985 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/3/2 - null null
2025-05-08 17:09:53.985 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:53.985 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/3/2 - 204 null null 0.3831ms
2025-05-08 17:09:53.986 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/3/2 - null null
2025-05-08 17:09:53.987 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:53.987 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:53.987 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:09:53.987 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:09:53.995 +07:00 [INF] Retrieved 7 messages from Redis for conversation 3
2025-05-08 17:09:53.995 +07:00 [INF] Retrieved 7 messages from Redis for conversation 3 and user 2
2025-05-08 17:09:53.995 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 17:09:53.995 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 8.1457ms
2025-05-08 17:09:53.996 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:09:53.996 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/3/2 - 200 null application/json; charset=utf-8 9.7047ms
2025-05-08 17:09:54.003 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/3 - null null
2025-05-08 17:09:54.003 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:54.003 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/3 - 204 null null 0.3498ms
2025-05-08 17:09:54.007 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/3 - null null
2025-05-08 17:09:54.008 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:54.008 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:54.008 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:09:54.008 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:09:54.016 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 17:09:54.016 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 17:09:54.017 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 8.8163ms
2025-05-08 17:09:54.017 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:09:54.017 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/3 - 200 null application/json; charset=utf-8 10.4664ms
2025-05-08 17:09:54.023 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/3 - null null
2025-05-08 17:09:54.023 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:54.023 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/3 - 204 null null 0.2688ms
2025-05-08 17:09:54.024 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/3 - null null
2025-05-08 17:09:54.025 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:54.025 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:09:54.025 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:09:54.027 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:09:54.030 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:09:54.030 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:09:54.030 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.4559ms
2025-05-08 17:09:54.030 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:09:54.031 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/3 - 200 null application/json; charset=utf-8 6.2756ms
2025-05-08 17:09:59.978 +07:00 [INF] Handling message from user 2: fsdf
2025-05-08 17:09:59.981 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 17:10:00.001 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 17:10:00.016 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 17:10:00.016 +07:00 [INF] Message saved to DB with ID: 179
2025-05-08 17:10:00.018 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 17:10:00.032 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 17:10:00.035 +07:00 [INF] Transaction committed for message: 179
2025-05-08 17:10:00.038 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 17:10:00.040 +07:00 [INF] Saved message 179 to Redis
2025-05-08 17:10:00.041 +07:00 [INF] Added message 179 to conversation 3
2025-05-08 17:10:00.041 +07:00 [INF] Published message to channel conversation:3
2025-05-08 17:11:37.952 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/5 - null null
2025-05-08 17:11:37.952 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:37.952 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/5 - 204 null null 0.7117ms
2025-05-08 17:11:37.954 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/5 - null null
2025-05-08 17:11:37.954 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:37.954 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:37.955 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:11:37.955 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 17:11:37.970 +07:00 [INF] Retrieved 1 messages from Redis for conversation 4
2025-05-08 17:11:37.971 +07:00 [INF] Retrieved 1 messages from Redis for conversation 4 and user 5
2025-05-08 17:11:37.971 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 17:11:37.972 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 16.7302ms
2025-05-08 17:11:37.972 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 17:11:37.972 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/5 - 200 null application/json; charset=utf-8 17.7959ms
2025-05-08 17:11:37.980 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:11:37.980 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:37.980 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - 204 null null 0.1955ms
2025-05-08 17:11:37.982 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 17:11:37.982 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:37.982 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:37.983 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:11:37.983 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 17:11:38.009 +07:00 [INF] Executed DbCommand (25ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 17:11:38.010 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 17:11:38.010 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 27.5743ms
2025-05-08 17:11:38.011 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 17:11:38.011 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - 200 null application/json; charset=utf-8 28.5387ms
2025-05-08 17:11:38.017 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:11:38.017 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:38.017 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - 204 null null 0.184ms
2025-05-08 17:11:38.018 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 17:11:38.019 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:38.019 +07:00 [INF] CORS policy execution successful.
2025-05-08 17:11:38.019 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:11:38.019 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 17:11:38.023 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 17:11:38.024 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 17:11:38.025 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.2612ms
2025-05-08 17:11:38.025 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 17:11:38.025 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 6.4312ms
2025-05-08 17:47:10.411 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 17:47:10.411 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=5 - 101 null null 2415002.1883ms
2025-05-08 17:47:21.754 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 17:47:21.754 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 2443164.7119ms
2025-05-08 19:47:45.454 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 19:47:45.461 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:45.465 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 11.8321ms
2025-05-08 19:47:45.466 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-08 19:47:45.467 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:45.481 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:45.497 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 19:47:45.508 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 19:47:45.939 +07:00 [INF] Executed DbCommand (73ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 19:47:45.964 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 19:47:45.967 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 457.2977ms
2025-05-08 19:47:45.967 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 19:47:45.967 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 500.7852ms
2025-05-08 19:47:46.097 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-08 19:47:46.100 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:46.100 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:46.100 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 19:47:46.101 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 19:47:46.141 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 19:47:46.142 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 19:47:46.143 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 42.3066ms
2025-05-08 19:47:46.143 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 19:47:46.143 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 46.2085ms
2025-05-08 19:47:46.189 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 19:47:46.189 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:46.190 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 1.3544ms
2025-05-08 19:47:46.191 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 19:47:46.192 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:46.192 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:46.192 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 19:47:46.193 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 19:47:46.200 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 19:47:46.200 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 7.1782ms
2025-05-08 19:47:46.200 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 19:47:46.200 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 8.7461ms
2025-05-08 19:47:46.259 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-08 19:47:46.261 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:46.261 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:46.262 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 19:47:46.391 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 19:47:50.309 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/2 - null null
2025-05-08 19:47:50.309 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.309 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/2 - 204 null null 0.2527ms
2025-05-08 19:47:50.310 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/2 - null null
2025-05-08 19:47:50.311 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.311 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.311 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 19:47:50.312 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 19:47:50.338 +07:00 [INF] Retrieved 51 messages from Redis for conversation 4
2025-05-08 19:47:50.340 +07:00 [INF] Retrieved 50 messages from Redis for conversation 4 and user 2
2025-05-08 19:47:50.341 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 19:47:50.345 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 33.2393ms
2025-05-08 19:47:50.345 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 19:47:50.345 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/2 - 200 null application/json; charset=utf-8 34.7617ms
2025-05-08 19:47:50.366 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 19:47:50.366 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.366 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - 204 null null 0.3003ms
2025-05-08 19:47:50.368 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 19:47:50.368 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.369 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.370 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 19:47:50.370 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 19:47:50.390 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 19:47:50.394 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 19:47:50.394 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 24.269ms
2025-05-08 19:47:50.394 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 19:47:50.394 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - 200 null application/json; charset=utf-8 26.6175ms
2025-05-08 19:47:50.402 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 19:47:50.402 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.402 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - 204 null null 0.2535ms
2025-05-08 19:47:50.404 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 19:47:50.404 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.404 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:47:50.404 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 19:47:50.405 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 19:47:50.411 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 19:47:50.413 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 19:47:50.413 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 8.3368ms
2025-05-08 19:47:50.413 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 19:47:50.413 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 9.0818ms
2025-05-08 19:47:54.234 +07:00 [INF] Handling message from user 2: gdfg
2025-05-08 19:47:54.268 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 19:47:54.289 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 19:47:54.376 +07:00 [INF] Executed DbCommand (87ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 19:47:54.382 +07:00 [INF] Message saved to DB with ID: 180
2025-05-08 19:47:54.389 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 19:47:54.397 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 19:47:54.399 +07:00 [INF] Transaction committed for message: 180
2025-05-08 19:47:54.405 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 19:47:54.407 +07:00 [INF] Saved message 180 to Redis
2025-05-08 19:47:54.407 +07:00 [INF] Added message 180 to conversation 4
2025-05-08 19:47:54.409 +07:00 [INF] Published message to channel conversation:4
2025-05-08 19:48:00.732 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/2 - null null
2025-05-08 19:48:00.732 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.733 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/4/2 - 204 null null 0.3375ms
2025-05-08 19:48:00.734 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/2 - null null
2025-05-08 19:48:00.734 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.734 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.734 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 19:48:00.734 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 19:48:00.765 +07:00 [INF] Retrieved 52 messages from Redis for conversation 4
2025-05-08 19:48:00.766 +07:00 [INF] Retrieved 50 messages from Redis for conversation 4 and user 2
2025-05-08 19:48:00.766 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 19:48:00.767 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 32.263ms
2025-05-08 19:48:00.767 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 19:48:00.767 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/4/2 - 200 null application/json; charset=utf-8 33.0159ms
2025-05-08 19:48:00.779 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 19:48:00.779 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.780 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/4 - 204 null null 0.2338ms
2025-05-08 19:48:00.781 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - null null
2025-05-08 19:48:00.781 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.781 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.781 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 19:48:00.781 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 19:48:00.812 +07:00 [INF] Executed DbCommand (29ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 19:48:00.812 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 19:48:00.812 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 31.0264ms
2025-05-08 19:48:00.812 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 19:48:00.812 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/4 - 200 null application/json; charset=utf-8 31.563ms
2025-05-08 19:48:00.819 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 19:48:00.819 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.819 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/4 - 204 null null 0.1629ms
2025-05-08 19:48:00.822 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - null null
2025-05-08 19:48:00.822 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.822 +07:00 [INF] CORS policy execution successful.
2025-05-08 19:48:00.822 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 19:48:00.823 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 19:48:00.834 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 19:48:00.836 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 19:48:00.836 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 13.8943ms
2025-05-08 19:48:00.837 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 19:48:00.837 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/4 - 200 null application/json; charset=utf-8 14.5064ms
2025-05-08 21:06:47.798 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 21:06:47.807 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 112
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 95
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 89
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-08 21:06:48.021 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-08 21:06:48.027 +07:00 [ERR] Connection id "0HNCE302HBKGS", Request id "0HNCE302HBKGS:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 112
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 95
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 89
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-08 21:06:48.075 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 4741816.0813ms
2025-05-08 21:36:01.851 +07:00 [INF] Application is shutting down...
2025-05-08 21:36:20.370 +07:00 [INF] Executed DbCommand (28ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-08 21:36:20.609 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-08 21:36:20.719 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-08 21:36:20.731 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-08 21:36:20.731 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-08 21:36:20.732 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-08 21:36:20.732 +07:00 [INF] Hosting environment: Development
2025-05-08 21:36:20.732 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-08 21:37:13.184 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 21:37:13.246 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:13.262 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 81.4965ms
2025-05-08 21:37:13.271 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-08 21:37:13.275 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:13.328 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:13.329 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-08 21:37:13.397 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 21:37:13.449 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 21:37:13.929 +07:00 [INF] Executed DbCommand (34ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 21:37:14.268 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 21:37:14.504 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 1047.6577ms
2025-05-08 21:37:14.506 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 21:37:14.518 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 1247.1415ms
2025-05-08 21:37:14.931 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-08 21:37:14.942 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:14.956 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:14.965 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 21:37:14.997 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 21:37:15.156 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 21:37:15.183 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:15.184 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 28.3405ms
2025-05-08 21:37:15.189 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 21:37:15.190 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:15.194 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:15.202 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 21:37:15.215 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:37:15.524 +07:00 [INF] Executed DbCommand (21ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 21:37:15.541 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:37:15.629 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 631.6486ms
2025-05-08 21:37:15.630 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 21:37:15.630 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 699.3309ms
2025-05-08 21:37:15.634 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-08 21:37:15.660 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 21:37:15.700 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 484.6577ms
2025-05-08 21:37:15.701 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 21:37:15.705 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 516.0305ms
2025-05-08 21:37:15.805 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-08 21:37:15.808 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:15.808 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:15.809 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 21:37:16.119 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 21:37:31.538 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 21:37:31.539 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:31.539 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 1.0059ms
2025-05-08 21:37:31.541 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-08 21:37:31.541 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:31.543 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:31.545 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 21:37:31.545 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 21:37:31.566 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 21:37:31.575 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 21:37:31.576 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 30.4697ms
2025-05-08 21:37:31.576 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 21:37:31.577 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 35.3679ms
2025-05-08 21:37:31.791 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-08 21:37:31.791 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:31.798 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:31.799 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 21:37:31.799 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 21:37:31.849 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 21:37:31.850 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:37:31.851 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 51.7253ms
2025-05-08 21:37:31.853 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 21:37:31.853 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 62.8372ms
2025-05-08 21:37:31.934 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-08 21:37:31.936 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:31.937 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 2.3879ms
2025-05-08 21:37:31.939 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-08 21:37:31.939 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:31.941 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:31.941 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 21:37:31.942 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:37:31.963 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-08 21:37:31.964 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 21:37:31.965 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 23.3232ms
2025-05-08 21:37:31.966 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 21:37:31.966 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 27.628ms
2025-05-08 21:37:32.058 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-08 21:37:32.059 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:32.060 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:32.060 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 21:37:32.293 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 21:37:32.330 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 21:37:35.558 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/open_conversation/2/3 - null null
2025-05-08 21:37:35.559 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:35.559 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/open_conversation/2/3 - 204 null null 0.7962ms
2025-05-08 21:37:35.563 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/open_conversation/2/3 - null null
2025-05-08 21:37:35.563 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:35.564 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:35.564 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.OpenConversation (Message_app)'
2025-05-08 21:37:35.573 +07:00 [INF] Route matched with {action = "OpenConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] OpenConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:37:35.642 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-08 21:37:35.647 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-08 21:37:35.758 +07:00 [INF] Executed DbCommand (58ms) [Parameters=[@__user1_0='?' (DbType = Int32), @__user2_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[name], [t].[is_group], [t].[created_at], [t].[lastMessage], [t].[lastMessageTime], [t].[img_url], [t0].[Id], [t0].[user_id], [t0].[ConversationId], [t0].[Name], [t0].[IsDeleted], [t0].[img_url]
FROM (
    SELECT TOP(1) [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url]
    FROM [Conversations] AS [c]
    WHERE [c].[is_group] = CAST(0 AS bit) AND (
        SELECT COUNT(*)
        FROM [Participants] AS [p]
        WHERE [c].[id] = [p].[conversation_id]) = 2 AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p0]
        WHERE [c].[id] = [p0].[conversation_id] AND [p0].[user_id] = @__user1_0) AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p1]
        WHERE [c].[id] = [p1].[conversation_id] AND [p1].[user_id] = @__user2_1)
) AS [t]
LEFT JOIN (
    SELECT [p2].[id] AS [Id], [p2].[user_id], [p2].[conversation_id] AS [ConversationId], [p2].[name] AS [Name], [p2].[is_deleted] AS [IsDeleted], [p2].[img_url]
    FROM [Participants] AS [p2]
    WHERE [p2].[is_deleted] = CAST(0 AS bit)
) AS [t0] ON [t].[id] = [t0].[ConversationId]
ORDER BY [t].[id]
2025-05-08 21:37:36.065 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Conversations] ([created_at], [img_url], [is_group], [lastMessage], [lastMessageSender], [lastMessageTime], [name])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6);
2025-05-08 21:37:36.201 +07:00 [INF] Executed DbCommand (21ms) [Parameters=[@__user_id_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
WHERE [u].[id] IN (
    SELECT [u0].[value]
    FROM OPENJSON(@__user_id_0) WITH ([value] int '$') AS [u0]
)
2025-05-08 21:37:36.334 +07:00 [INF] Executed DbCommand (37ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = Int32), @p2='?' (Size = 4000), @p3='?' (DbType = Boolean), @p4='?' (DbType = DateTime2), @p5='?' (Size = 4000), @p6='?' (Size = 4000), @p7='?' (DbType = Int32), @p8='?' (Size = 4000), @p9='?' (DbType = Int32), @p10='?' (Size = 4000), @p11='?' (DbType = Boolean), @p12='?' (DbType = DateTime2), @p13='?' (Size = 4000), @p14='?' (Size = 4000), @p15='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
MERGE [Participants] USING (
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7, 0),
(@p8, @p9, @p10, @p11, @p12, @p13, @p14, @p15, 1)) AS i ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id], _Position) ON 1=0
WHEN NOT MATCHED THEN
INSERT ([adder], [conversation_id], [img_url], [is_deleted], [joined_at], [name], [role], [user_id])
VALUES (i.[adder], i.[conversation_id], i.[img_url], i.[is_deleted], i.[joined_at], i.[name], i.[role], i.[user_id])
OUTPUT INSERTED.[id], i._Position;
2025-05-08 21:37:36.372 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[name], [t].[is_group], [t].[created_at], [t].[lastMessage], [t].[lastMessageTime], [t].[img_url], [t0].[Id], [t0].[user_id], [t0].[ConversationId], [t0].[Name], [t0].[IsDeleted], [t0].[img_url]
FROM (
    SELECT TOP(1) [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN (
    SELECT [p].[id] AS [Id], [p].[user_id], [p].[conversation_id] AS [ConversationId], [p].[name] AS [Name], [p].[is_deleted] AS [IsDeleted], [p].[img_url]
    FROM [Participants] AS [p]
    WHERE [p].[is_deleted] = CAST(0 AS bit)
) AS [t0] ON [t].[id] = [t0].[ConversationId]
ORDER BY [t].[id]
2025-05-08 21:37:36.433 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-08 21:37:36.433 +07:00 [INF] Executed action server.Controllers.ConversationController.OpenConversation (Message_app) in 859.7975ms
2025-05-08 21:37:36.434 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.OpenConversation (Message_app)'
2025-05-08 21:37:36.434 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/open_conversation/2/3 - 200 null application/json; charset=utf-8 870.9973ms
2025-05-08 21:37:36.669 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-08 21:37:36.669 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:36.669 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - 204 null null 0.3514ms
2025-05-08 21:37:36.672 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-08 21:37:36.672 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:36.672 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:36.672 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 21:37:36.680 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 21:37:36.710 +07:00 [INF] Retrieved 0 messages from Redis for conversation 19
2025-05-08 21:37:36.740 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__user_id_0='?' (DbType = Int32), @__conversationId_1='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [m].[cleared_at]
FROM [messageDeletions] AS [m]
WHERE [m].[user_id] = @__user_id_0 AND CAST([m].[conversation_id] AS bigint) = @__conversationId_1
2025-05-08 21:37:36.795 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int64)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[content], [t].[conversation_id], [t].[created_at], [t].[isFile], [t].[isRecalled], [t].[is_read], [t].[sender_id], [t].[type], [a].[id], [a].[FileSize], [a].[file_type], [a].[file_url], [a].[is_temporary], [a].[message_id], [a].[uploaded_at]
FROM (
    SELECT TOP(@__p_1) [m].[id], [m].[content], [m].[conversation_id], [m].[created_at], [m].[isFile], [m].[isRecalled], [m].[is_read], [m].[sender_id], [m].[type]
    FROM [Messages] AS [m]
    WHERE CAST([m].[conversation_id] AS bigint) = @__conversationId_0
    ORDER BY [m].[created_at] DESC
) AS [t]
LEFT JOIN [Attachments] AS [a] ON [t].[id] = [a].[message_id]
ORDER BY [t].[created_at] DESC, [t].[id]
2025-05-08 21:37:36.798 +07:00 [INF] Executing NotFoundObjectResult, writing value of type 'System.String'.
2025-05-08 21:37:36.799 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 118.5473ms
2025-05-08 21:37:36.799 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 21:37:36.800 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - 404 null text/plain; charset=utf-8 127.8623ms
2025-05-08 21:37:37.072 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-08 21:37:37.072 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:37.072 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.7348ms
2025-05-08 21:37:37.074 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-08 21:37:37.075 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:37.075 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:37.075 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 21:37:37.083 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:37:37.125 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 21:37:37.134 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 21:37:37.145 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 61.6303ms
2025-05-08 21:37:37.145 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 21:37:37.145 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 70.8771ms
2025-05-08 21:37:37.162 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-08 21:37:37.162 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:37.162 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.3524ms
2025-05-08 21:37:37.164 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-08 21:37:37.165 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:37.165 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:37.165 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:37:37.173 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 21:37:37.194 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 21:37:37.196 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:37:37.200 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 27.165ms
2025-05-08 21:37:37.200 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:37:37.201 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 36.2818ms
2025-05-08 21:37:51.331 +07:00 [INF] Handling message from user 2: sgf
2025-05-08 21:37:51.358 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 21:37:51.417 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/2/19 - null null
2025-05-08 21:37:51.417 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:51.417 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/2/19 - 204 null null 0.3964ms
2025-05-08 21:37:51.418 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 21:37:51.421 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/19 - null null
2025-05-08 21:37:51.421 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:51.421 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:51.422 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-08 21:37:51.427 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:37:51.429 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 21:37:51.432 +07:00 [INF] Message saved to DB with ID: 181
2025-05-08 21:37:51.443 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 21:37:51.451 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 21:37:51.473 +07:00 [INF] Transaction committed for message: 181
2025-05-08 21:37:51.482 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 21:37:51.482 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__conversationId_0='?' (DbType = Int32), @__userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[name], [t].[is_group], [t].[created_at], [t].[lastMessage], [t].[lastMessageTime], [t].[img_url], [t0].[Id], [t0].[user_id], [t0].[ConversationId], [t0].[Name], [t0].[IsDeleted], [t0].[img_url]
FROM (
    SELECT TOP(1) [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversationId_0 AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_1)
) AS [t]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t0] ON [t].[id] = [t0].[ConversationId]
ORDER BY [t].[id]
2025-05-08 21:37:51.484 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-08 21:37:51.484 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 56.8983ms
2025-05-08 21:37:51.484 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-08 21:37:51.485 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/19 - 200 null application/json; charset=utf-8 64.065ms
2025-05-08 21:37:51.493 +07:00 [INF] Saved message 181 to Redis
2025-05-08 21:37:51.495 +07:00 [INF] Added message 181 to conversation 19
2025-05-08 21:37:51.505 +07:00 [INF] Published message to channel conversation:19
2025-05-08 21:37:51.533 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/19 - null null
2025-05-08 21:37:51.533 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/3/19 - null null
2025-05-08 21:37:51.533 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:51.533 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:51.533 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:51.533 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversationDto/3/19 - 204 null null 0.4263ms
2025-05-08 21:37:51.534 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-08 21:37:51.534 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:37:51.535 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-08 21:37:51.535 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/3/19 - null null
2025-05-08 21:37:51.536 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:51.536 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 1.9017ms
2025-05-08 21:37:51.536 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:51.536 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-08 21:37:51.536 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-08 21:37:51.536 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:37:51.537 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/2/19 - 200 null application/json; charset=utf-8 3.7081ms
2025-05-08 21:37:51.562 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@__conversationId_0='?' (DbType = Int32), @__userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[name], [t].[is_group], [t].[created_at], [t].[lastMessage], [t].[lastMessageTime], [t].[img_url], [t0].[Id], [t0].[user_id], [t0].[ConversationId], [t0].[Name], [t0].[IsDeleted], [t0].[img_url]
FROM (
    SELECT TOP(1) [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversationId_0 AND EXISTS (
        SELECT 1
        FROM [Participants] AS [p]
        WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_1)
) AS [t]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t0] ON [t].[id] = [t0].[ConversationId]
ORDER BY [t].[id]
2025-05-08 21:37:51.564 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-08 21:37:51.564 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 28.1106ms
2025-05-08 21:37:51.564 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-08 21:37:51.565 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/3/19 - 200 null application/json; charset=utf-8 29.1841ms
2025-05-08 21:37:52.158 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/3/19 - null null
2025-05-08 21:37:52.158 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:52.158 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:37:52.159 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-08 21:37:52.159 +07:00 [INF] Route matched with {action = "GetConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversation(Int32, Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:37:52.161 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.ConversationDto'.
2025-05-08 21:37:52.161 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversation (Message_app) in 2.4678ms
2025-05-08 21:37:52.162 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversation (Message_app)'
2025-05-08 21:37:52.162 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversationDto/3/19 - 200 null application/json; charset=utf-8 4.071ms
2025-05-08 21:38:01.257 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-08 21:38:01.258 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.258 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.9289ms
2025-05-08 21:38:01.261 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-08 21:38:01.262 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.264 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.265 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 21:38:01.265 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 21:38:01.303 +07:00 [INF] Retrieved 1 messages from Redis for conversation 19
2025-05-08 21:38:01.306 +07:00 [INF] Retrieved 1 messages from Redis for conversation 19 and user 3
2025-05-08 21:38:01.307 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 21:38:01.312 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 46.5282ms
2025-05-08 21:38:01.312 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 21:38:01.312 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 51.0469ms
2025-05-08 21:38:01.326 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-08 21:38:01.326 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.326 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.5441ms
2025-05-08 21:38:01.328 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-08 21:38:01.328 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.328 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.329 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 21:38:01.329 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:38:01.344 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 21:38:01.346 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 21:38:01.346 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 17.6108ms
2025-05-08 21:38:01.347 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 21:38:01.347 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 19.0323ms
2025-05-08 21:38:01.361 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-08 21:38:01.361 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.362 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.5685ms
2025-05-08 21:38:01.364 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-08 21:38:01.364 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.366 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:38:01.366 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:38:01.366 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 21:38:01.379 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 21:38:01.380 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:38:01.380 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 13.6633ms
2025-05-08 21:38:01.380 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:38:01.381 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 16.9236ms
2025-05-08 21:38:04.119 +07:00 [INF] Handling message from user 3: dgh
2025-05-08 21:38:04.132 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 21:38:04.150 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 21:38:04.172 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 21:38:04.173 +07:00 [INF] Message saved to DB with ID: 182
2025-05-08 21:38:04.175 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 21:38:04.182 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 21:38:04.185 +07:00 [INF] Transaction committed for message: 182
2025-05-08 21:38:04.194 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 21:38:04.197 +07:00 [INF] Saved message 182 to Redis
2025-05-08 21:38:04.198 +07:00 [INF] Added message 182 to conversation 19
2025-05-08 21:38:04.199 +07:00 [INF] Published message to channel conversation:19
2025-05-08 21:42:35.282 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-08 21:42:35.282 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:35.283 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:35.283 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 21:42:35.311 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 21:42:35.324 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 21:42:54.455 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-08 21:42:54.456 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.456 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - 204 null null 0.4811ms
2025-05-08 21:42:54.459 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-08 21:42:54.459 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.459 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.460 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 21:42:54.460 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 21:42:54.470 +07:00 [INF] Retrieved 2 messages from Redis for conversation 19
2025-05-08 21:42:54.472 +07:00 [INF] Retrieved 2 messages from Redis for conversation 19 and user 2
2025-05-08 21:42:54.473 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 21:42:54.473 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 12.9429ms
2025-05-08 21:42:54.474 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 21:42:54.474 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 14.8958ms
2025-05-08 21:42:54.485 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-08 21:42:54.485 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.486 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.31ms
2025-05-08 21:42:54.487 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-08 21:42:54.487 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.488 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.488 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 21:42:54.488 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:42:54.500 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 21:42:54.501 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 21:42:54.501 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 13.2845ms
2025-05-08 21:42:54.501 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 21:42:54.502 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 14.4277ms
2025-05-08 21:42:54.509 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-08 21:42:54.509 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.509 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.384ms
2025-05-08 21:42:54.511 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-08 21:42:54.512 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.512 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:42:54.512 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:42:54.513 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 21:42:54.520 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 21:42:54.521 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:42:54.522 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 9.0558ms
2025-05-08 21:42:54.522 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:42:54.528 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 17.3755ms
2025-05-08 21:42:58.265 +07:00 [INF] Handling message from user 2: oj
2025-05-08 21:42:58.274 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-08 21:42:58.299 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 21:42:58.305 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-08 21:42:58.305 +07:00 [INF] Message saved to DB with ID: 183
2025-05-08 21:42:58.306 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-08 21:42:58.312 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-08 21:42:58.314 +07:00 [INF] Transaction committed for message: 183
2025-05-08 21:42:58.319 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 21:42:58.324 +07:00 [INF] Saved message 183 to Redis
2025-05-08 21:42:58.325 +07:00 [INF] Added message 183 to conversation 19
2025-05-08 21:42:58.325 +07:00 [INF] Published message to channel conversation:19
2025-05-08 21:58:26.806 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 21:58:26.806 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 21:58:26.807 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 1254748.3274ms
2025-05-08 21:58:26.807 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 951524.5248ms
2025-05-08 21:58:29.824 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 21:58:29.824 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 1274019.4946ms
2025-05-08 21:58:55.196 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 21:58:55.197 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.197 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.5829ms
2025-05-08 21:58:55.198 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 57
2025-05-08 21:58:55.199 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.199 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.199 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 21:58:55.200 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 21:58:55.251 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 21:58:55.255 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 21:58:55.256 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 55.0825ms
2025-05-08 21:58:55.256 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 21:58:55.257 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 58.0944ms
2025-05-08 21:58:55.479 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-08 21:58:55.480 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.480 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.480 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 21:58:55.480 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 21:58:55.528 +07:00 [INF] Executed DbCommand (28ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 21:58:55.528 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:58:55.529 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 47.9481ms
2025-05-08 21:58:55.529 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 21:58:55.529 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 49.3896ms
2025-05-08 21:58:55.608 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 21:58:55.609 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.609 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.5603ms
2025-05-08 21:58:55.611 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-08 21:58:55.612 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.612 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.613 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 21:58:55.615 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:58:55.652 +07:00 [INF] Executed DbCommand (29ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-08 21:58:55.658 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 21:58:55.659 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 44.3051ms
2025-05-08 21:58:55.659 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 21:58:55.660 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 48.2337ms
2025-05-08 21:58:55.799 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-08 21:58:55.799 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.799 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:58:55.800 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 21:58:56.057 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 21:59:19.185 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-08 21:59:19.185 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.186 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.7739ms
2025-05-08 21:59:19.198 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-08 21:59:19.200 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.200 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.201 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 21:59:19.201 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-08 21:59:19.214 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__email_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-08 21:59:19.215 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-08 21:59:19.215 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 14.1025ms
2025-05-08 21:59:19.215 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-08 21:59:19.216 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 17.8328ms
2025-05-08 21:59:19.355 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-08 21:59:19.355 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.356 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.356 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 21:59:19.356 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-08 21:59:19.374 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-08 21:59:19.375 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType5`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:59:19.375 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 18.4121ms
2025-05-08 21:59:19.375 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-08 21:59:19.375 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 20.4726ms
2025-05-08 21:59:19.421 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-08 21:59:19.421 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.422 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 1.6606ms
2025-05-08 21:59:19.426 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-08 21:59:19.426 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.427 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.427 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 21:59:19.427 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:59:19.451 +07:00 [INF] Executed DbCommand (20ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [t].[Id], [t].[user_id], [t].[ConversationId], [t].[Name], [t].[IsDeleted], [t].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN (
    SELECT [p0].[id] AS [Id], [p0].[user_id], [p0].[conversation_id] AS [ConversationId], [p0].[name] AS [Name], [p0].[is_deleted] AS [IsDeleted], [p0].[img_url]
    FROM [Participants] AS [p0]
    WHERE [p0].[is_deleted] = CAST(0 AS bit)
) AS [t] ON [c].[id] = [t].[ConversationId]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-08 21:59:19.451 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 21:59:19.452 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 24.3836ms
2025-05-08 21:59:19.452 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-08 21:59:19.452 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 25.9621ms
2025-05-08 21:59:19.506 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-08 21:59:19.507 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.507 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:19.507 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-08 21:59:19.624 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-08 21:59:19.685 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__p_1='?' (DbType = Int32), @__conversationId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(@__p_1) [m].[id], [m].[conversation_id], [m].[sender_id], [m].[content], [m].[created_at], [m].[isFile], [m].[type], [m].[isRecalled]
FROM [Messages] AS [m]
WHERE [m].[conversation_id] = @__conversationId_0
ORDER BY [m].[created_at] DESC
2025-05-08 21:59:22.386 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-08 21:59:22.386 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.386 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/1/3 - 204 null null 0.4725ms
2025-05-08 21:59:22.389 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - null null
2025-05-08 21:59:22.390 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.391 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.392 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 21:59:22.393 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-08 21:59:22.433 +07:00 [INF] Retrieved 50 messages from Redis for conversation 1
2025-05-08 21:59:22.434 +07:00 [INF] Retrieved 50 messages from Redis for conversation 1 and user 3
2025-05-08 21:59:22.434 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-08 21:59:22.435 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 42.0427ms
2025-05-08 21:59:22.435 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-08 21:59:22.435 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/1/3 - 200 null application/json; charset=utf-8 46.0457ms
2025-05-08 21:59:22.465 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-08 21:59:22.465 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.466 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/1 - 204 null null 0.3524ms
2025-05-08 21:59:22.467 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - null null
2025-05-08 21:59:22.467 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.467 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.468 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 21:59:22.468 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-08 21:59:22.515 +07:00 [INF] Executed DbCommand (45ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-08 21:59:22.516 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-08 21:59:22.517 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 49.1906ms
2025-05-08 21:59:22.517 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-08 21:59:22.517 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/1 - 200 null application/json; charset=utf-8 50.4378ms
2025-05-08 21:59:22.530 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-08 21:59:22.530 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.530 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/1 - 204 null null 0.3137ms
2025-05-08 21:59:22.531 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-08 21:59:22.531 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.531 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:22.531 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:59:22.531 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 21:59:22.541 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 21:59:22.542 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:59:22.543 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 11.6249ms
2025-05-08 21:59:22.543 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:59:22.543 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 12.3261ms
2025-05-08 21:59:26.439 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - null null
2025-05-08 21:59:26.440 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:26.441 +07:00 [INF] CORS policy execution successful.
2025-05-08 21:59:26.441 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:59:26.442 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-08 21:59:26.450 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-08 21:59:26.451 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType17`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-08 21:59:26.451 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 9.388ms
2025-05-08 21:59:26.451 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-08 21:59:26.452 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/1 - 200 null application/json; charset=utf-8 12.6798ms
2025-05-08 23:22:38.720 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 23:22:38.720 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-08 23:22:38.741 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 144
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 127
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 89
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-08 23:22:38.721 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 144
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 127
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 89
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-08 23:22:40.326 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-08 23:22:40.551 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-08 23:22:40.563 +07:00 [ERR] Connection id "0HNCE7N970HO7", Request id "0HNCE7N970HO7:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 144
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 127
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 89
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-08 23:22:40.562 +07:00 [ERR] Connection id "0HNCE7N970HO6", Request id "0HNCE7N970HO6:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 144
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 127
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 89
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-08 23:22:40.701 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 5001194.4741ms
2025-05-08 23:22:40.727 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 5024928.1377ms
