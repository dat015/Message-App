2025-05-22 20:06:07.310 +07:00 [INF] Executed DbCommand (57ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-22 20:06:07.686 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-22 20:06:07.863 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-22 20:06:07.904 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-22 20:06:07.905 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-22 20:06:07.906 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-22 20:06:07.906 +07:00 [INF] Hosting environment: Development
2025-05-22 20:06:07.907 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-22 20:06:18.626 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 20:06:18.749 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 20:06:18.760 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:06:18.760 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:06:18.858 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 235.6048ms
2025-05-22 20:06:18.870 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 20:06:18.872 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:06:18.974 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:06:18.975 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:06:18.978 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-22 20:06:19.162 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 20:06:19.162 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:06:19.240 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 20:06:19.776 +07:00 [INF] Executed DbCommand (241ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 20:06:20.128 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 20:06:20.247 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 1000.1266ms
2025-05-22 20:06:20.248 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:06:20.257 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 1386.4631ms
2025-05-22 20:06:20.430 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:06:20.452 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 20:06:20.453 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 20:06:20.454 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 20:06:20.455 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 20:06:20.456 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 20:06:20.466 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 20:06:20.470 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 20:06:20.475 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 20:06:20.483 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 20:06:20.488 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 20:06:20.492 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 20:06:20.493 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 20:06:20.494 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 20:06:20.495 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 20:06:20.496 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 20:06:20.497 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 20:06:20.498 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 20:06:20.498 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 20:06:20.499 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 20:06:20.500 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 20:06:20.501 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 20:08:00.635 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 58
2025-05-22 20:08:00.643 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:08:00.643 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 20:08:00.654 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 20:08:00.657 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 20:08:00.657 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 14.0739ms
2025-05-22 20:08:00.658 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:08:00.658 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 200 null application/json; charset=utf-8 23.0868ms
2025-05-22 20:08:01.408 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - null null
2025-05-22 20:08:01.410 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 20:08:01.592 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:08:01.594 +07:00 [INF] User 2 subscribed to channel conversation:3
2025-05-22 20:08:01.595 +07:00 [INF] User 2 subscribed to channel conversation:4
2025-05-22 20:08:01.598 +07:00 [INF] User 2 subscribed to channel conversation:19
2025-05-22 20:08:01.598 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-22 20:08:01.599 +07:00 [INF] User 2 subscribed to channel conversation:25
2025-05-22 20:08:01.599 +07:00 [INF] User 2 subscribed to channel conversation:26
2025-05-22 20:08:01.599 +07:00 [INF] User 2 subscribed to channel conversation:27
2025-05-22 20:08:01.600 +07:00 [INF] User 2 subscribed to channel conversation:28
2025-05-22 20:08:01.604 +07:00 [INF] User 2 subscribed to channel conversation:29
2025-05-22 20:08:01.605 +07:00 [INF] User 2 subscribed to channel conversation:32
2025-05-22 20:08:01.621 +07:00 [INF] User 2 subscribed to channel conversation:33
2025-05-22 20:08:01.622 +07:00 [INF] User 2 subscribed to channel conversation:34
2025-05-22 20:08:01.623 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - application/json 168
2025-05-22 20:08:01.623 +07:00 [INF] User 2 subscribed to channel conversation:35
2025-05-22 20:08:01.624 +07:00 [INF] User 2 subscribed to channel conversation:36
2025-05-22 20:08:01.624 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 20:08:01.625 +07:00 [INF] User 2 subscribed to channel conversation:37
2025-05-22 20:08:01.625 +07:00 [INF] User 2 subscribed to channel conversation:38
2025-05-22 20:08:01.626 +07:00 [INF] User 2 subscribed to channel conversation:39
2025-05-22 20:08:01.634 +07:00 [INF] User 2 subscribed to channel conversation:41
2025-05-22 20:08:01.634 +07:00 [INF] User 2 subscribed to channel conversation:40
2025-05-22 20:08:01.634 +07:00 [INF] User 2 subscribed to channel conversation:42
2025-05-22 20:08:01.634 +07:00 [INF] User 2 subscribed to channel conversation:44
2025-05-22 20:08:01.635 +07:00 [INF] User 2 subscribed to channel conversation:43
2025-05-22 20:08:01.635 +07:00 [INF] User 2 subscribed to channel conversation:45
2025-05-22 20:08:01.646 +07:00 [INF] Route matched with {action = "UpdateFcmToken", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateFcmToken(FcmBackend.Controllers.UpdateFcmTokenRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 20:08:07.315 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-22 20:08:07.340 +07:00 [INF] FCM token updated for userId: 2
2025-05-22 20:08:07.340 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.String'.
2025-05-22 20:08:07.341 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app) in 5694.6025ms
2025-05-22 20:08:07.341 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 20:08:07.341 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - 200 null text/plain; charset=utf-8 5718.5692ms
2025-05-22 20:08:07.991 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - null null
2025-05-22 20:08:07.991 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 20:08:07.996 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 20:08:08.013 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 20:08:08.014 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 20:08:08.018 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 20:08:08.058 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 20:08:08.063 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 20:08:08.076 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 79.5988ms
2025-05-22 20:08:08.076 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 20:08:08.076 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 85.3372ms
2025-05-22 20:08:08.091 +07:00 [INF] Executed DbCommand (24ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 20:08:08.102 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 20:08:08.107 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 88.5907ms
2025-05-22 20:08:08.107 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 20:08:08.107 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 93.9255ms
2025-05-22 20:08:10.833 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/42/2 - null null
2025-05-22 20:08:10.834 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 20:08:10.839 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 20:08:10.876 +07:00 [INF] Retrieved 3 messages from Redis for conversation 42
2025-05-22 20:08:10.878 +07:00 [INF] Retrieved 3 messages from Redis for conversation 42 and user 2
2025-05-22 20:08:10.878 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 20:08:10.880 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 41.1006ms
2025-05-22 20:08:10.880 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 20:08:10.880 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/42/2 - 200 null application/json; charset=utf-8 47.1867ms
2025-05-22 20:08:10.940 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/42 - null null
2025-05-22 20:08:10.941 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 20:08:10.943 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 20:08:10.975 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 20:08:11.008 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 20:08:11.011 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 67.7293ms
2025-05-22 20:08:11.011 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 20:08:11.011 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/42 - 200 null application/json; charset=utf-8 71.7397ms
2025-05-22 20:08:11.049 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/42 - null null
2025-05-22 20:08:11.050 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 20:08:11.052 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 20:08:11.060 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 20:08:11.061 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 20:08:11.062 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 10.2637ms
2025-05-22 20:08:11.062 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 20:08:11.063 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/42 - 200 null application/json; charset=utf-8 13.1969ms
2025-05-22 20:08:14.855 +07:00 [INF] Handling message from user 2: xd
2025-05-22 20:08:14.863 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 20:08:14.956 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 20:08:14.982 +07:00 [INF] Executed DbCommand (23ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 20:08:14.996 +07:00 [INF] Message saved to DB with ID: 379
2025-05-22 20:08:15.000 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 20:08:15.011 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 20:08:15.027 +07:00 [INF] Transaction committed for message: 379
2025-05-22 20:08:15.033 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:08:15.042 +07:00 [INF] Saved message 379 to Redis
2025-05-22 20:08:15.044 +07:00 [INF] Added message 379 to conversation 42
2025-05-22 20:08:15.044 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 20:08:15.045 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:08:15.048 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 20:08:15.048 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:08:15.049 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 20:08:15.052 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 20:08:15.052 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:08:15.053 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 20:08:15.053 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 20:08:15.054 +07:00 [INF] Sending notification to userId: 5, title: Tin nhắn mới trong nhóm, body: xd
2025-05-22 20:08:15.054 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: xd
2025-05-22 20:08:15.055 +07:00 [INF] Published message to channel conversation:42
2025-05-22 20:08:15.054 +07:00 [INF] Sending notification to userId: 4, title: Tin nhắn mới trong nhóm, body: xd
2025-05-22 20:08:15.064 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 20:08:15.071 +07:00 [ERR] FCM token not found for userId: 3
2025-05-22 20:08:15.077 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 20:08:15.078 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 25.153ms
2025-05-22 20:08:15.078 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:08:15.079 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 26.5349ms
2025-05-22 20:08:15.087 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 20:08:15.087 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 20:08:15.087 +07:00 [ERR] FCM token not found for userId: 5
2025-05-22 20:08:15.087 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 20:08:15.088 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 38.5525ms
2025-05-22 20:08:15.088 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:08:15.088 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 43.7661ms
2025-05-22 20:08:16.716 +07:00 [ERR] Error sending notification to userId: 4 : SenderId mismatch
2025-05-22 20:08:16.716 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 20:08:16.717 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 1663.2695ms
2025-05-22 20:08:16.717 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:08:16.717 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 1668.5432ms
2025-05-22 20:09:01.346 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 20:09:01.347 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:09:01.348 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 1.7766ms
2025-05-22 20:09:01.353 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 20:09:01.353 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:09:01.353 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:09:01.354 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:09:01.354 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 20:09:01.400 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 20:09:01.405 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 20:09:01.406 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 50.9874ms
2025-05-22 20:09:01.406 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:09:01.407 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 53.8148ms
2025-05-22 20:09:01.473 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:09:01.474 +07:00 [INF] User 3 already subscribed to channel conversation:1
2025-05-22 20:09:01.475 +07:00 [INF] User 3 already subscribed to channel conversation:2
2025-05-22 20:09:01.476 +07:00 [INF] User 3 already subscribed to channel conversation:9
2025-05-22 20:09:01.476 +07:00 [INF] User 3 already subscribed to channel conversation:19
2025-05-22 20:09:01.476 +07:00 [INF] User 3 already subscribed to channel conversation:25
2025-05-22 20:09:01.476 +07:00 [INF] User 3 already subscribed to channel conversation:26
2025-05-22 20:09:01.476 +07:00 [INF] User 3 already subscribed to channel conversation:27
2025-05-22 20:09:01.476 +07:00 [INF] User 3 already subscribed to channel conversation:28
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:29
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:32
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:34
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:35
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:36
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:37
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:38
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:39
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:40
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:42
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:43
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:44
2025-05-22 20:09:01.477 +07:00 [INF] User 3 already subscribed to channel conversation:45
2025-05-22 20:09:04.587 +07:00 [INF] Handling message from user 2: m
2025-05-22 20:09:04.597 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 20:09:04.620 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 20:09:04.631 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 20:09:04.633 +07:00 [INF] Message saved to DB with ID: 380
2025-05-22 20:09:04.635 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 20:09:04.644 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 20:09:04.648 +07:00 [INF] Transaction committed for message: 380
2025-05-22 20:09:04.656 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:09:04.665 +07:00 [INF] Saved message 380 to Redis
2025-05-22 20:09:04.666 +07:00 [INF] Added message 380 to conversation 42
2025-05-22 20:09:04.668 +07:00 [INF] Published message to channel conversation:42
2025-05-22 20:09:04.873 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 64
2025-05-22 20:09:04.874 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:09:04.874 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 20:09:04.875 +07:00 [INF] Sending notification to userId: 5, title: Tin nhắn mới trong nhóm, body: m
2025-05-22 20:09:04.877 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 64
2025-05-22 20:09:04.878 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:09:04.878 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 20:09:04.882 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 64
2025-05-22 20:09:04.884 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:09:04.884 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 20:09:04.901 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 20:09:04.901 +07:00 [ERR] FCM token not found for userId: 5
2025-05-22 20:09:04.901 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: m
2025-05-22 20:09:04.901 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 20:09:04.902 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 27.4681ms
2025-05-22 20:09:04.902 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:09:04.902 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 28.8201ms
2025-05-22 20:09:04.903 +07:00 [INF] Sending notification to userId: 4, title: Tin nhắn mới trong nhóm, body: m
2025-05-22 20:09:04.919 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 20:09:04.920 +07:00 [ERR] FCM token not found for userId: 3
2025-05-22 20:09:04.920 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 20:09:04.920 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 27.7591ms
2025-05-22 20:09:04.931 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:09:04.931 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 49.4212ms
2025-05-22 20:09:04.935 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 20:09:05.162 +07:00 [ERR] Error sending notification to userId: 4 : SenderId mismatch
2025-05-22 20:09:05.163 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 20:09:05.163 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 284.4232ms
2025-05-22 20:09:05.163 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 20:09:05.163 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 286.7454ms
2025-05-22 20:09:21.533 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 20:09:21.533 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:09:21.533 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.3631ms
2025-05-22 20:09:21.575 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 20:09:21.575 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:09:21.576 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:09:21.576 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:09:21.576 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 20:09:21.589 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 20:09:21.590 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 20:09:21.590 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 14.0856ms
2025-05-22 20:09:21.590 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:09:21.591 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 15.7121ms
2025-05-22 20:09:21.654 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:09:21.655 +07:00 [INF] User 3 already subscribed to channel conversation:1
2025-05-22 20:09:21.655 +07:00 [INF] User 3 already subscribed to channel conversation:2
2025-05-22 20:09:21.655 +07:00 [INF] User 3 already subscribed to channel conversation:9
2025-05-22 20:09:21.655 +07:00 [INF] User 3 already subscribed to channel conversation:19
2025-05-22 20:09:21.655 +07:00 [INF] User 3 already subscribed to channel conversation:25
2025-05-22 20:09:21.655 +07:00 [INF] User 3 already subscribed to channel conversation:26
2025-05-22 20:09:21.655 +07:00 [INF] User 3 already subscribed to channel conversation:27
2025-05-22 20:09:21.655 +07:00 [INF] User 3 already subscribed to channel conversation:28
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:29
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:32
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:34
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:35
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:36
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:37
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:38
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:39
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:40
2025-05-22 20:09:21.656 +07:00 [INF] User 3 already subscribed to channel conversation:42
2025-05-22 20:09:21.657 +07:00 [INF] User 3 already subscribed to channel conversation:43
2025-05-22 20:09:21.657 +07:00 [INF] User 3 already subscribed to channel conversation:44
2025-05-22 20:09:21.658 +07:00 [INF] User 3 already subscribed to channel conversation:45
2025-05-22 20:09:26.647 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 20:09:26.660 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 20:09:26.751 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 20:09:26.755 +07:00 [ERR] Connection id "0HNCP65OFONU3", Request id "0HNCP65OFONU3:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 20:09:26.759 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 188009.9919ms
2025-05-22 20:13:15.326 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 20:13:15.326 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:13:15.327 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 6.6029ms
2025-05-22 20:13:15.335 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 20:13:15.335 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:13:15.340 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:13:15.340 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:13:15.340 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 20:13:15.354 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 20:13:15.354 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 20:13:15.355 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 13.8488ms
2025-05-22 20:13:15.355 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:13:15.355 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 20.4949ms
2025-05-22 20:13:15.396 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 20:13:15.403 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:13:15.403 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:13:15.403 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 20:13:15.437 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:13:15.439 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 20:13:15.440 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 20:13:15.440 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 20:13:15.440 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 20:13:15.440 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 20:13:15.440 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 20:13:15.441 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 20:13:15.441 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 20:13:15.441 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 20:13:15.441 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 20:13:15.443 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 20:13:15.444 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 20:13:15.444 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 20:13:15.444 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 20:13:15.444 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 20:13:15.444 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 20:13:15.444 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 20:13:15.444 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 20:13:15.447 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 20:13:15.449 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 20:13:15.449 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 20:19:15.946 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 20:19:15.946 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:19:15.947 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.6586ms
2025-05-22 20:19:15.951 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 20:19:15.951 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:19:15.951 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:19:15.951 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:19:15.952 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 20:19:16.002 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 20:19:16.004 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 20:19:16.009 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 56.5419ms
2025-05-22 20:19:16.009 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:19:16.009 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 58.7039ms
2025-05-22 20:19:16.046 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:1
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:2
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:9
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:19
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:25
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:26
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:27
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:28
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:29
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:32
2025-05-22 20:19:16.047 +07:00 [INF] User 3 already subscribed to channel conversation:34
2025-05-22 20:19:16.048 +07:00 [INF] User 3 already subscribed to channel conversation:35
2025-05-22 20:19:16.048 +07:00 [INF] User 3 already subscribed to channel conversation:36
2025-05-22 20:19:16.048 +07:00 [INF] User 3 already subscribed to channel conversation:37
2025-05-22 20:19:16.048 +07:00 [INF] User 3 already subscribed to channel conversation:38
2025-05-22 20:19:16.049 +07:00 [INF] User 3 already subscribed to channel conversation:39
2025-05-22 20:19:16.049 +07:00 [INF] User 3 already subscribed to channel conversation:40
2025-05-22 20:19:16.049 +07:00 [INF] User 3 already subscribed to channel conversation:42
2025-05-22 20:19:16.049 +07:00 [INF] User 3 already subscribed to channel conversation:43
2025-05-22 20:19:16.049 +07:00 [INF] User 3 already subscribed to channel conversation:44
2025-05-22 20:19:16.049 +07:00 [INF] User 3 already subscribed to channel conversation:45
2025-05-22 20:21:54.013 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 20:21:54.014 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 20:21:54.017 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 20:21:54.017 +07:00 [ERR] Connection id "0HNCP65OFONUL", Request id "0HNCP65OFONUL:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 20:21:54.018 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 518622.5527ms
2025-05-22 20:24:02.876 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 20:24:02.885 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:24:02.889 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 13.1718ms
2025-05-22 20:24:02.893 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 20:24:02.895 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:24:02.898 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:24:02.904 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:24:02.912 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 20:24:03.073 +07:00 [INF] Executed DbCommand (120ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 20:24:03.095 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 20:24:03.099 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 185.9827ms
2025-05-22 20:24:03.099 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 20:24:03.099 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 205.5967ms
2025-05-22 20:24:03.128 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 20:24:03.137 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:24:03.137 +07:00 [INF] CORS policy execution successful.
2025-05-22 20:24:03.138 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 20:24:03.177 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 20:24:03.180 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 20:24:03.181 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 20:24:03.181 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 20:24:03.181 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 20:24:03.181 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 20:24:03.181 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 20:24:03.182 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 20:24:03.182 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 20:24:03.182 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 20:24:03.183 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 20:24:03.184 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 20:24:03.186 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 20:24:03.186 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 20:24:03.186 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 20:24:03.186 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 20:24:03.186 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 20:24:03.187 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 20:24:03.187 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 20:24:03.188 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 20:24:03.189 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 20:24:03.189 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:00:11.942 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:00:11.944 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:00:11.946 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 4.4287ms
2025-05-22 21:00:11.947 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 21:00:11.948 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:00:11.950 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:00:11.951 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:00:11.952 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:00:12.044 +07:00 [INF] Executed DbCommand (29ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:00:12.047 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:00:12.048 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 95.7446ms
2025-05-22 21:00:12.048 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:00:12.049 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 101.1501ms
2025-05-22 21:00:12.060 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:00:12.061 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:00:12.061 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:00:12.062 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:00:12.081 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:00:12.082 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:00:12.082 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:00:12.082 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:00:12.082 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:00:12.082 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:00:12.082 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:00:12.083 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:00:12.083 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:00:12.084 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:00:12.084 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:00:12.084 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:00:12.084 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:00:12.085 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:00:23.288 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:00:23.301 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:00:23.302 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:00:23.302 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:00:23.314 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:00:23.314 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:00:23.315 +07:00 [ERR] Connection id "0HNCP65OFONUO", Request id "0HNCP65OFONUO:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:00:23.315 +07:00 [ERR] Connection id "0HNCP65OFONUQ", Request id "0HNCP65OFONUQ:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:00:23.318 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 2180190.2398ms
2025-05-22 21:00:23.319 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 11259.4155ms
2025-05-22 21:01:56.703 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:01:56.703 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:01:56.703 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.7223ms
2025-05-22 21:01:56.707 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 21:01:56.708 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:01:56.708 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:01:56.708 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:01:56.709 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:01:56.749 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:01:56.751 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:01:56.752 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 42.9559ms
2025-05-22 21:01:56.752 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:01:56.752 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 44.3452ms
2025-05-22 21:01:56.777 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:01:56.777 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:01:56.777 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:01:56.778 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:01:56.801 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:01:56.802 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:01:56.802 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:01:56.802 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:01:56.802 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:01:56.802 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:01:56.803 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:01:56.803 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:01:56.803 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:01:56.803 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:01:56.803 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:01:56.803 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:01:56.804 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:01:56.804 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:01:56.804 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:01:56.804 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:01:56.805 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:01:56.805 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:01:56.805 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:01:56.805 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:01:56.806 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:01:56.806 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:03:47.132 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:03:47.132 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:03:47.132 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.3853ms
2025-05-22 21:03:47.134 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 58
2025-05-22 21:03:47.134 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:03:47.134 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:03:47.134 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:03:47.134 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:03:47.150 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:03:47.150 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:03:47.151 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 16.3754ms
2025-05-22 21:03:47.151 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:03:47.151 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 17.6407ms
2025-05-22 21:03:47.173 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-22 21:03:47.173 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:03:47.174 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:03:47.174 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:03:47.194 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:03:47.194 +07:00 [INF] User 2 subscribed to channel conversation:3
2025-05-22 21:03:47.194 +07:00 [INF] User 2 subscribed to channel conversation:4
2025-05-22 21:03:47.194 +07:00 [INF] User 2 subscribed to channel conversation:19
2025-05-22 21:03:47.194 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-22 21:03:47.194 +07:00 [INF] User 2 subscribed to channel conversation:25
2025-05-22 21:03:47.195 +07:00 [INF] User 2 subscribed to channel conversation:26
2025-05-22 21:03:47.195 +07:00 [INF] User 2 subscribed to channel conversation:27
2025-05-22 21:03:47.195 +07:00 [INF] User 2 subscribed to channel conversation:28
2025-05-22 21:03:47.196 +07:00 [INF] User 2 subscribed to channel conversation:29
2025-05-22 21:03:47.196 +07:00 [INF] User 2 subscribed to channel conversation:32
2025-05-22 21:03:47.196 +07:00 [INF] User 2 subscribed to channel conversation:33
2025-05-22 21:03:47.196 +07:00 [INF] User 2 subscribed to channel conversation:34
2025-05-22 21:03:47.196 +07:00 [INF] User 2 subscribed to channel conversation:35
2025-05-22 21:03:47.196 +07:00 [INF] User 2 subscribed to channel conversation:36
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:37
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:38
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:39
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:41
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:40
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:42
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:44
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:43
2025-05-22 21:03:47.197 +07:00 [INF] User 2 subscribed to channel conversation:45
2025-05-22 21:05:35.307 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-22 21:05:35.307 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:35.316 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:35.317 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:05:35.317 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:05:35.411 +07:00 [INF] Executed DbCommand (49ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:05:35.430 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:05:35.433 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 115.6479ms
2025-05-22 21:05:35.433 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:05:35.433 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 126.6683ms
2025-05-22 21:05:35.610 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:05:35.610 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:35.611 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.3513ms
2025-05-22 21:05:35.613 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:05:35.614 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:35.615 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:35.615 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:05:35.616 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:05:35.733 +07:00 [INF] Executed DbCommand (51ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:05:35.768 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:05:35.778 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 162.3694ms
2025-05-22 21:05:35.778 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:05:35.778 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 165.282ms
2025-05-22 21:05:38.141 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/42/2 - null null
2025-05-22 21:05:38.141 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.142 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/42/2 - 204 null null 0.312ms
2025-05-22 21:05:38.143 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/42/2 - null null
2025-05-22 21:05:38.143 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.153 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.153 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:05:38.154 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:05:38.255 +07:00 [INF] Retrieved 5 messages from Redis for conversation 42
2025-05-22 21:05:38.259 +07:00 [INF] Retrieved 5 messages from Redis for conversation 42 and user 2
2025-05-22 21:05:38.259 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:05:38.260 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 105.5199ms
2025-05-22 21:05:38.260 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:05:38.260 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/42/2 - 200 null application/json; charset=utf-8 116.7588ms
2025-05-22 21:05:38.272 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/42 - null null
2025-05-22 21:05:38.272 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.273 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/42 - 204 null null 0.2819ms
2025-05-22 21:05:38.275 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/42 - null null
2025-05-22 21:05:38.280 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.281 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.283 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:05:38.285 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:05:38.335 +07:00 [INF] Executed DbCommand (29ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:05:38.367 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:05:38.373 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 87.1131ms
2025-05-22 21:05:38.373 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:05:38.373 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/42 - 200 null application/json; charset=utf-8 98.3218ms
2025-05-22 21:05:38.381 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/42 - null null
2025-05-22 21:05:38.382 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.382 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/42 - 204 null null 0.3156ms
2025-05-22 21:05:38.385 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/42 - null null
2025-05-22 21:05:38.386 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.401 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:05:38.401 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:05:38.402 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:05:38.421 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:05:38.427 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:05:38.432 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 30.515ms
2025-05-22 21:05:38.433 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:05:38.437 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/42 - 200 null application/json; charset=utf-8 51.5267ms
2025-05-22 21:06:29.987 +07:00 [INF] Handling message from user 2: ag
2025-05-22 21:06:30.031 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:06:30.136 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:06:30.199 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:06:30.207 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:06:30.209 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.210 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 2.6756ms
2025-05-22 21:06:30.210 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:06:30.210 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.211 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 1.0884ms
2025-05-22 21:06:30.217 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.217 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 18.3538ms
2025-05-22 21:06:30.225 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 65
2025-05-22 21:06:30.225 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 65
2025-05-22 21:06:30.226 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.226 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.229 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 65
2025-05-22 21:06:30.229 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.231 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.231 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.231 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:06:30.232 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:06:30.232 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:06:30.232 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:06:30.232 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:06:30.232 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:06:30.232 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:06:30.241 +07:00 [INF] Sending notification to userId: 5, title: Tin nhắn mới trong nhóm, body: ag
2025-05-22 21:06:30.241 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: ag
2025-05-22 21:06:30.241 +07:00 [INF] Sending notification to userId: 4, title: Tin nhắn mới trong nhóm, body: ag
2025-05-22 21:06:30.321 +07:00 [INF] Executed DbCommand (183ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:06:30.325 +07:00 [INF] Message saved to DB with ID: 381
2025-05-22 21:06:30.375 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:06:30.400 +07:00 [INF] Executed DbCommand (24ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:06:30.402 +07:00 [INF] Transaction committed for message: 381
2025-05-22 21:06:30.414 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:06:30.421 +07:00 [INF] Saved message 381 to Redis
2025-05-22 21:06:30.423 +07:00 [INF] Added message 381 to conversation 42
2025-05-22 21:06:30.425 +07:00 [INF] Published message to channel conversation:42
2025-05-22 21:06:30.454 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:06:30.455 +07:00 [ERR] FCM token not found for userId: 3
2025-05-22 21:06:30.456 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:06:30.459 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 227.2447ms
2025-05-22 21:06:30.460 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:06:30.460 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 231.1458ms
2025-05-22 21:06:30.471 +07:00 [INF] Executed DbCommand (32ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:06:30.472 +07:00 [ERR] FCM token not found for userId: 5
2025-05-22 21:06:30.472 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:06:30.472 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 239.8765ms
2025-05-22 21:06:30.472 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:06:30.473 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 247.1905ms
2025-05-22 21:06:30.527 +07:00 [INF] Executed DbCommand (36ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:06:31.140 +07:00 [ERR] Error sending notification to userId: 4 : SenderId mismatch
2025-05-22 21:06:31.141 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:06:31.141 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 908.2206ms
2025-05-22 21:06:31.141 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:06:31.141 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 915.5139ms
2025-05-22 21:07:02.087 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:07:02.093 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:07:02.141 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:07:02.143 +07:00 [ERR] Connection id "0HNCP65OFONU5", Request id "0HNCP65OFONU5:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:07:02.156 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - 101 null null 3540747.8467ms
2025-05-22 21:07:52.777 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 60
2025-05-22 21:07:52.782 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:07:52.785 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:07:52.810 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:07:52.818 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:07:52.819 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 34.1387ms
2025-05-22 21:07:52.819 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:07:52.819 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 200 null application/json; charset=utf-8 42.6007ms
2025-05-22 21:07:53.660 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=3 - null null
2025-05-22 21:07:53.663 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:07:53.827 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - application/json 168
2025-05-22 21:07:53.827 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:07:53.832 +07:00 [INF] Route matched with {action = "UpdateFcmToken", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateFcmToken(FcmBackend.Controllers.UpdateFcmTokenRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:07:53.881 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:07:53.883 +07:00 [INF] Executed DbCommand (49ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:07:53.883 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:07:53.884 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:07:53.888 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:07:53.888 +07:00 [ERR] Connection id "0HNCP65OFONUS", Request id "0HNCP65OFONUS:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:07:53.889 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:07:53.890 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:07:53.890 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:07:53.890 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:07:53.890 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 357112.816ms
2025-05-22 21:07:53.898 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-22 21:07:53.918 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p1='?' (DbType = Int32), @p0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Users] SET [fcmToken] = @p0
OUTPUT 1
WHERE [id] = @p1;
2025-05-22 21:07:53.920 +07:00 [INF] FCM token updated for userId: 3
2025-05-22 21:07:53.921 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.String'.
2025-05-22 21:07:53.921 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app) in 88.2813ms
2025-05-22 21:07:53.921 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:07:53.921 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - 200 null text/plain; charset=utf-8 94.2014ms
2025-05-22 21:07:54.591 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 21:07:54.595 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:07:54.595 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:07:54.602 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:07:54.604 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:07:54.605 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:07:54.619 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:07:54.619 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:07:54.620 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 24.3823ms
2025-05-22 21:07:54.620 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:07:54.620 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 29.1562ms
2025-05-22 21:07:54.631 +07:00 [INF] Executed DbCommand (24ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:07:54.638 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:07:54.651 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 46.1694ms
2025-05-22 21:07:54.651 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:07:54.651 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 48.7207ms
2025-05-22 21:07:57.769 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/42/3 - null null
2025-05-22 21:07:57.770 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:07:57.770 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:07:57.784 +07:00 [INF] Retrieved 6 messages from Redis for conversation 42
2025-05-22 21:07:57.784 +07:00 [INF] Retrieved 6 messages from Redis for conversation 42 and user 3
2025-05-22 21:07:57.785 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:07:57.785 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 15.1465ms
2025-05-22 21:07:57.785 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:07:57.785 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/42/3 - 200 null application/json; charset=utf-8 15.6683ms
2025-05-22 21:07:57.819 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/42 - null null
2025-05-22 21:07:57.820 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:07:57.820 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:07:57.835 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:07:57.837 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:07:57.837 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 17.6833ms
2025-05-22 21:07:57.838 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:07:57.838 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/42 - 200 null application/json; charset=utf-8 18.3849ms
2025-05-22 21:07:57.885 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/42 - null null
2025-05-22 21:07:57.885 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:07:57.885 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:07:57.892 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:07:57.893 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:07:57.893 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 7.5811ms
2025-05-22 21:07:57.893 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:07:57.893 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/42 - 200 null application/json; charset=utf-8 8.1092ms
2025-05-22 21:07:58.952 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:07:58.952 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:07:58.953 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:07:58.953 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:08:03.214 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:08:03.215 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:08:03.215 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:08:03.217 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:08:03.217 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:08:03.217 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:08:03.218 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:08:03.218 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:08:03.218 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:08:03.218 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:08:03.218 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:08:03.218 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:08:03.219 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:08:03.219 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:08:03.219 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:08:03.219 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:08:03.220 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:08:03.220 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:08:03.220 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:08:03.220 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:08:03.221 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:08:03.222 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:08:03.222 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:08:03.223 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:08:03.223 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:08:03.223 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:08:03.223 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:08:03.224 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:08:03.224 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:08:03.224 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:08:03.224 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:08:03.224 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:08:03.225 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:08:03.225 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:08:03.225 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:08:03.225 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:08:03.225 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:08:03.226 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:08:03.226 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:08:03.226 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:08:03.227 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:08:03.227 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:08:03.227 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:08:03.228 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:08:03.228 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:08:03.228 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:08:03.228 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:08:03.229 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:08:03.229 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:08:03.229 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:08:03.229 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:08:03.230 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:08:03.230 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:08:03.230 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:08:03.230 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:08:03.230 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:08:03.230 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:08:03.231 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:08:03.231 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:08:03.231 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:08:03.231 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:08:03.232 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:08:03.232 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:08:03.232 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:08:03.233 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:08:03.233 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:08:03.233 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:08:03.233 +07:00 [INF] Retrieved 2 messages from Redis for conversation 19
2025-05-22 21:08:03.233 +07:00 [INF] Retrieved 2 messages from Redis for conversation 19 and user 3
2025-05-22 21:08:03.234 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:08:03.234 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 19.0058ms
2025-05-22 21:08:03.234 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:08:03.234 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 19.9816ms
2025-05-22 21:08:03.256 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:08:03.256 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:08:03.256 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:08:03.259 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:08:03.260 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:08:03.260 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 4.05ms
2025-05-22 21:08:03.260 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:08:03.260 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 4.4175ms
2025-05-22 21:08:03.279 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:08:03.279 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:08:03.279 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:08:03.282 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:08:03.283 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:08:03.283 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.5841ms
2025-05-22 21:08:03.283 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:08:03.283 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 4.2602ms
2025-05-22 21:08:07.291 +07:00 [INF] Handling message from user 3: vv
2025-05-22 21:08:07.296 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:08:07.298 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:08:07.307 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:08:07.307 +07:00 [INF] Message saved to DB with ID: 382
2025-05-22 21:08:07.307 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:08:07.314 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:08:07.315 +07:00 [INF] Transaction committed for message: 382
2025-05-22 21:08:07.319 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:08:07.324 +07:00 [INF] Saved message 382 to Redis
2025-05-22 21:08:07.325 +07:00 [INF] Added message 382 to conversation 19
2025-05-22 21:08:07.326 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:08:07.588 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 21:08:07.589 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:08:07.589 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:08:07.590 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: vv
2025-05-22 21:08:07.599 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:08:08.909 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:08:08.909 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:08:08.909 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 1320.6768ms
2025-05-22 21:08:08.909 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:08:08.909 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 1321.2359ms
2025-05-22 21:08:11.152 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-22 21:08:11.152 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.154 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - 204 null null 1.5878ms
2025-05-22 21:08:11.157 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-22 21:08:11.157 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.157 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.157 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:08:11.157 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:08:11.162 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:08:11.162 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:08:11.162 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:08:11.163 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:08:11.163 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:08:11.164 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:08:11.164 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:08:11.165 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:08:11.165 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:08:11.165 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:08:11.165 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:08:11.166 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:08:11.167 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:08:11.167 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:08:11.167 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:08:11.168 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:08:11.168 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:08:11.169 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:08:11.169 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:08:11.169 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:08:11.170 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:08:11.170 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:08:11.171 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:08:11.172 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:08:11.173 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:08:11.174 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:08:11.174 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:08:11.174 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:08:11.175 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:08:11.175 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:08:11.176 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:08:11.176 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:08:11.176 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:08:11.176 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:08:11.177 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:08:11.177 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:08:11.177 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:08:11.177 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:08:11.178 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:08:11.178 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:08:11.178 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:08:11.179 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:08:11.179 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:08:11.179 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:08:11.179 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:08:11.180 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:08:11.180 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:08:11.181 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:08:11.182 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:08:11.183 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:08:11.183 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:08:11.184 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:08:11.184 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:08:11.185 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:08:11.185 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:08:11.185 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:08:11.185 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:08:11.186 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:08:11.186 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:08:11.186 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:08:11.186 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:08:11.186 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:08:11.187 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:08:11.187 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:08:11.187 +07:00 [INF] Retrieved 3 messages from Redis for conversation 19
2025-05-22 21:08:11.187 +07:00 [INF] Retrieved 3 messages from Redis for conversation 19 and user 2
2025-05-22 21:08:11.187 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:08:11.188 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 30.4079ms
2025-05-22 21:08:11.188 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:08:11.188 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 31.3286ms
2025-05-22 21:08:11.196 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:08:11.197 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.197 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2686ms
2025-05-22 21:08:11.198 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:08:11.198 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.198 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.199 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:08:11.199 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:08:11.202 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:08:11.205 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:08:11.206 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 7.0153ms
2025-05-22 21:08:11.206 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:08:11.206 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 7.6655ms
2025-05-22 21:08:11.213 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:08:11.213 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.213 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.6988ms
2025-05-22 21:08:11.215 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:08:11.215 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.216 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:11.216 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:08:11.216 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:08:11.219 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:08:11.220 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:08:11.220 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.2747ms
2025-05-22 21:08:11.220 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:08:11.220 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 5.0329ms
2025-05-22 21:08:15.108 +07:00 [INF] Handling message from user 2: mn
2025-05-22 21:08:15.115 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:08:15.122 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:08:15.125 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:08:15.126 +07:00 [INF] Message saved to DB with ID: 383
2025-05-22 21:08:15.127 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:08:15.128 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:08:15.129 +07:00 [INF] Transaction committed for message: 383
2025-05-22 21:08:15.132 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:08:15.134 +07:00 [INF] Saved message 383 to Redis
2025-05-22 21:08:15.134 +07:00 [INF] Added message 383 to conversation 19
2025-05-22 21:08:15.135 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:08:15.268 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:08:15.268 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:15.268 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 0.2456ms
2025-05-22 21:08:15.269 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 65
2025-05-22 21:08:15.269 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:15.270 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:08:15.270 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:08:15.270 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:08:15.270 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: mn
2025-05-22 21:08:15.274 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:08:15.426 +07:00 [ERR] Error sending notification to userId: 3 : SenderId mismatch
2025-05-22 21:08:15.426 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:08:15.426 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 156.0932ms
2025-05-22 21:08:15.426 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:08:15.426 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 157.0121ms
2025-05-22 21:10:27.005 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:10:27.005 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:27.005 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 0.2067ms
2025-05-22 21:10:27.010 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 58
2025-05-22 21:10:27.010 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:27.011 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:27.011 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:10:27.011 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:10:27.034 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:10:27.035 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:10:27.035 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 24.1237ms
2025-05-22 21:10:27.035 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:10:27.035 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 24.7218ms
2025-05-22 21:10:27.070 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-22 21:10:27.071 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:27.071 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:27.072 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:10:27.102 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:10:27.120 +07:00 [INF] User 2 subscribed to channel conversation:3
2025-05-22 21:10:27.132 +07:00 [INF] User 2 subscribed to channel conversation:4
2025-05-22 21:10:27.150 +07:00 [INF] User 2 subscribed to channel conversation:19
2025-05-22 21:10:27.167 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-22 21:10:27.167 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:10:27.167 +07:00 [INF] User 2 subscribed to channel conversation:25
2025-05-22 21:10:27.167 +07:00 [INF] User 2 subscribed to channel conversation:26
2025-05-22 21:10:27.168 +07:00 [INF] User 2 subscribed to channel conversation:27
2025-05-22 21:10:27.168 +07:00 [INF] User 2 subscribed to channel conversation:28
2025-05-22 21:10:27.168 +07:00 [INF] User 2 subscribed to channel conversation:29
2025-05-22 21:10:27.168 +07:00 [INF] User 2 subscribed to channel conversation:32
2025-05-22 21:10:27.168 +07:00 [INF] User 2 subscribed to channel conversation:33
2025-05-22 21:10:27.168 +07:00 [INF] User 2 subscribed to channel conversation:34
2025-05-22 21:10:27.169 +07:00 [INF] User 2 subscribed to channel conversation:35
2025-05-22 21:10:27.169 +07:00 [INF] User 2 subscribed to channel conversation:36
2025-05-22 21:10:27.169 +07:00 [INF] User 2 subscribed to channel conversation:37
2025-05-22 21:10:27.169 +07:00 [INF] User 2 subscribed to channel conversation:38
2025-05-22 21:10:27.169 +07:00 [INF] User 2 subscribed to channel conversation:39
2025-05-22 21:10:27.169 +07:00 [INF] User 2 subscribed to channel conversation:41
2025-05-22 21:10:27.169 +07:00 [INF] User 2 subscribed to channel conversation:40
2025-05-22 21:10:27.170 +07:00 [INF] User 2 subscribed to channel conversation:42
2025-05-22 21:10:27.170 +07:00 [INF] User 2 subscribed to channel conversation:44
2025-05-22 21:10:27.170 +07:00 [INF] User 2 subscribed to channel conversation:43
2025-05-22 21:10:27.170 +07:00 [INF] User 2 subscribed to channel conversation:45
2025-05-22 21:10:27.169 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:10:27.171 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:10:27.171 +07:00 [ERR] Connection id "0HNCP65OFONUT", Request id "0HNCP65OFONUT:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:10:27.172 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 399999.3035ms
2025-05-22 21:10:28.410 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - null null
2025-05-22 21:10:28.411 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:28.411 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:28.411 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:10:28.411 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:10:28.421 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:10:28.423 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:10:28.424 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 13.161ms
2025-05-22 21:10:28.424 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:10:28.424 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 13.8983ms
2025-05-22 21:10:28.622 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:10:28.622 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:28.622 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/2 - 204 null null 0.2597ms
2025-05-22 21:10:28.624 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:10:28.624 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:28.624 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:28.624 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:10:28.624 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:10:28.646 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:10:28.658 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:10:28.663 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 38.981ms
2025-05-22 21:10:28.663 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:10:28.664 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 39.9156ms
2025-05-22 21:10:31.954 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-22 21:10:31.954 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:31.954 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/2 - 204 null null 0.1775ms
2025-05-22 21:10:31.955 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - null null
2025-05-22 21:10:31.955 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:31.955 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:31.955 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:10:31.955 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:10:31.958 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:10:31.959 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:10:31.959 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:10:31.960 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:10:31.960 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:10:31.960 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:10:31.961 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:10:31.961 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:10:31.961 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:10:31.961 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:10:31.962 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:10:31.962 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:10:31.962 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:10:31.962 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:10:31.962 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:10:31.963 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:10:31.963 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:10:31.963 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:10:31.963 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:10:31.964 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:10:31.964 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:10:31.964 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:10:31.964 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:10:31.965 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:10:31.965 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:10:31.965 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:10:31.965 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:10:31.966 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:10:31.966 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:10:31.966 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:10:31.967 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:10:31.967 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:10:31.967 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:10:31.968 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:10:31.968 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:10:31.969 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:10:31.969 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:10:31.969 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:10:31.970 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:10:31.970 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:10:31.970 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:10:31.970 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:10:31.971 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:10:31.971 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:10:31.971 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:10:31.972 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:10:31.973 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:10:31.973 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:10:31.974 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:10:31.974 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:10:31.974 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:10:31.974 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:10:31.975 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:10:31.976 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:10:31.976 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:10:31.976 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:10:31.976 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:10:31.977 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:10:31.977 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:10:31.977 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:10:31.977 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:10:31.977 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:10:31.978 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:10:31.978 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:10:31.978 +07:00 [INF] Retrieved 4 messages from Redis for conversation 19
2025-05-22 21:10:31.978 +07:00 [INF] Retrieved 4 messages from Redis for conversation 19 and user 2
2025-05-22 21:10:31.979 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:10:31.979 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 23.6427ms
2025-05-22 21:10:31.979 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:10:31.979 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 24.4329ms
2025-05-22 21:10:31.984 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:10:31.984 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:31.984 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2387ms
2025-05-22 21:10:31.985 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:10:31.985 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:31.985 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:31.985 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:10:31.985 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:10:31.995 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:10:31.996 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:10:31.996 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 11.0283ms
2025-05-22 21:10:31.996 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:10:31.997 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 11.6812ms
2025-05-22 21:10:32.002 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:10:32.002 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:32.002 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.2022ms
2025-05-22 21:10:32.003 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:10:32.004 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:32.004 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:32.004 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:10:32.004 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:10:32.008 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:10:32.008 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:10:32.008 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.3904ms
2025-05-22 21:10:32.009 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:10:32.009 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 5.7136ms
2025-05-22 21:10:32.178 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - null null
2025-05-22 21:10:32.178 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:32.178 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:32.178 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:10:35.460 +07:00 [INF] Handling message from user 2: hnn
2025-05-22 21:10:35.469 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:10:35.473 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:10:35.481 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:10:35.481 +07:00 [INF] Message saved to DB with ID: 384
2025-05-22 21:10:35.482 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:10:35.489 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:10:35.490 +07:00 [INF] Transaction committed for message: 384
2025-05-22 21:10:35.493 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:10:35.494 +07:00 [INF] Saved message 384 to Redis
2025-05-22 21:10:35.495 +07:00 [INF] Added message 384 to conversation 19
2025-05-22 21:10:35.495 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:10:35.621 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:10:35.621 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:35.621 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 0.1634ms
2025-05-22 21:10:35.622 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 66
2025-05-22 21:10:35.622 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:35.622 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:10:35.622 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:10:35.623 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:10:35.626 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: hnn
2025-05-22 21:10:35.632 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:10:35.894 +07:00 [ERR] Error sending notification to userId: 3 : SenderId mismatch
2025-05-22 21:10:35.895 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:10:35.895 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 271.9787ms
2025-05-22 21:10:35.895 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:10:35.895 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 272.7161ms
2025-05-22 21:10:39.541 +07:00 [INF] Handling message from user 3: ff
2025-05-22 21:10:39.546 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:10:39.549 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:10:39.552 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:10:39.553 +07:00 [INF] Message saved to DB with ID: 385
2025-05-22 21:10:39.554 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:10:39.555 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:10:39.558 +07:00 [INF] Transaction committed for message: 385
2025-05-22 21:10:39.559 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:10:39.562 +07:00 [INF] Saved message 385 to Redis
2025-05-22 21:10:39.563 +07:00 [INF] Added message 385 to conversation 19
2025-05-22 21:10:39.563 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:10:40.035 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 21:10:40.035 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:10:40.035 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:10:40.035 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: ff
2025-05-22 21:10:40.040 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:10:40.159 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:10:40.159 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:10:40.159 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 124.322ms
2025-05-22 21:10:40.159 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:10:40.160 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 124.8543ms
2025-05-22 21:10:46.388 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:10:46.389 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:10:46.389 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:10:46.410 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:10:46.410 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:10:46.411 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:10:46.411 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:10:46.411 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:10:46.412 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:10:46.412 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:10:46.412 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:10:46.413 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:10:46.413 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:10:46.413 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:10:46.413 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:10:46.414 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:10:46.414 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:10:46.414 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:10:46.414 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:10:46.415 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:10:46.415 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:10:46.415 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:10:46.416 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:10:46.416 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:10:46.416 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:10:46.416 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:10:46.417 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:10:46.417 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:10:46.417 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:10:46.418 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:10:46.418 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:10:46.418 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:10:46.419 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:10:46.419 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:10:46.420 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:10:46.420 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:10:46.420 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:10:46.421 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:10:46.421 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:10:46.421 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:10:46.422 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:10:46.422 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:10:46.422 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:10:46.423 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:10:46.423 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:10:46.423 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:10:46.423 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:10:46.424 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:10:46.424 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:10:46.424 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:10:46.425 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:10:46.426 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:10:46.426 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:10:46.427 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:10:46.427 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:10:46.428 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:10:46.428 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:10:46.428 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:10:46.429 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:10:46.429 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:10:46.429 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:10:46.430 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:10:46.430 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:10:46.430 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:10:46.431 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:10:46.431 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:10:46.431 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:10:46.431 +07:00 [INF] Retrieved 6 messages from Redis for conversation 19
2025-05-22 21:10:46.432 +07:00 [INF] Retrieved 6 messages from Redis for conversation 19 and user 3
2025-05-22 21:10:46.432 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:10:46.432 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 42.4716ms
2025-05-22 21:10:46.432 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:10:46.432 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 43.5892ms
2025-05-22 21:10:46.534 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:10:46.534 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:10:46.534 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:10:46.540 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:10:46.540 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:10:46.540 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 6.3261ms
2025-05-22 21:10:46.540 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:10:46.540 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 6.7995ms
2025-05-22 21:10:46.569 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:10:46.569 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:10:46.569 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:10:46.573 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:10:46.573 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:10:46.573 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.2738ms
2025-05-22 21:10:46.573 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:10:46.573 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 4.6999ms
2025-05-22 21:10:49.266 +07:00 [INF] Handling message from user 3: â
2025-05-22 21:10:49.271 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:10:49.275 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:10:49.280 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:10:49.281 +07:00 [INF] Message saved to DB with ID: 386
2025-05-22 21:10:49.281 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:10:49.284 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:10:49.285 +07:00 [INF] Transaction committed for message: 386
2025-05-22 21:10:49.289 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:10:49.291 +07:00 [INF] Saved message 386 to Redis
2025-05-22 21:10:49.291 +07:00 [INF] Added message 386 to conversation 19
2025-05-22 21:10:49.298 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:10:49.458 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 21:10:49.458 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:10:49.458 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:10:49.459 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: â
2025-05-22 21:10:49.467 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:10:49.572 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:10:49.572 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:10:49.572 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 113.7545ms
2025-05-22 21:10:49.572 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:10:49.572 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 114.1889ms
2025-05-22 21:11:15.437 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 60
2025-05-22 21:11:15.437 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:11:15.437 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:11:15.441 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:11:15.442 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:11:15.442 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 5.2348ms
2025-05-22 21:11:15.443 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:11:15.443 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 200 null application/json; charset=utf-8 5.9671ms
2025-05-22 21:11:15.525 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:11:15.526 +07:00 [INF] User 3 already subscribed to channel conversation:1
2025-05-22 21:11:15.526 +07:00 [INF] User 3 already subscribed to channel conversation:2
2025-05-22 21:11:15.526 +07:00 [INF] User 3 already subscribed to channel conversation:9
2025-05-22 21:11:15.526 +07:00 [INF] User 3 already subscribed to channel conversation:19
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:25
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:26
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:27
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:28
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:29
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:32
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:34
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:35
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:36
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:37
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:38
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:39
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:40
2025-05-22 21:11:15.527 +07:00 [INF] User 3 already subscribed to channel conversation:42
2025-05-22 21:11:15.528 +07:00 [INF] User 3 already subscribed to channel conversation:43
2025-05-22 21:11:15.528 +07:00 [INF] User 3 already subscribed to channel conversation:44
2025-05-22 21:11:15.528 +07:00 [INF] User 3 already subscribed to channel conversation:45
2025-05-22 21:11:15.573 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - application/json 168
2025-05-22 21:11:15.573 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:11:15.573 +07:00 [INF] Route matched with {action = "UpdateFcmToken", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateFcmToken(FcmBackend.Controllers.UpdateFcmTokenRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:11:15.577 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-22 21:11:15.577 +07:00 [INF] FCM token updated for userId: 3
2025-05-22 21:11:15.577 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.String'.
2025-05-22 21:11:15.578 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app) in 4.1574ms
2025-05-22 21:11:15.578 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:11:15.578 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - 200 null text/plain; charset=utf-8 4.6203ms
2025-05-22 21:11:15.758 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 21:11:15.758 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:11:15.758 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:11:15.766 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:11:15.767 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:11:15.767 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 8.5418ms
2025-05-22 21:11:15.767 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:11:15.767 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 8.9349ms
2025-05-22 21:11:15.807 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:11:15.807 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:11:15.807 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:11:15.824 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:11:15.839 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:11:15.841 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 33.7567ms
2025-05-22 21:11:15.841 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:11:15.842 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 34.6828ms
2025-05-22 21:11:17.389 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:11:17.389 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:11:17.389 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:11:17.393 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:11:17.393 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:11:17.394 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:11:17.394 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:11:17.395 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:11:17.395 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:11:17.396 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:11:17.396 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:11:17.397 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:11:17.397 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:11:17.397 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:11:17.398 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:11:17.398 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:11:17.398 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:11:17.399 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:11:17.399 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:11:17.399 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:11:17.400 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:11:17.400 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:11:17.400 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:11:17.401 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:11:17.401 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:11:17.402 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:11:17.402 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:11:17.402 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:11:17.403 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:11:17.403 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:11:17.403 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:11:17.403 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:11:17.404 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:11:17.404 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:11:17.404 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:11:17.404 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:11:17.405 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:11:17.405 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:11:17.405 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:11:17.406 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:11:17.406 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:11:17.406 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:11:17.406 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:11:17.406 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:11:17.407 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:11:17.407 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:11:17.408 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:11:17.408 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:11:17.408 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:11:17.408 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:11:17.408 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:11:17.409 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:11:17.409 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:11:17.409 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:11:17.410 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:11:17.410 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:11:17.411 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:11:17.411 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:11:17.411 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:11:17.412 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:11:17.412 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:11:17.412 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:11:17.413 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:11:17.413 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:11:17.413 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:11:17.414 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:11:17.414 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:11:17.414 +07:00 [INF] Retrieved 7 messages from Redis for conversation 19
2025-05-22 21:11:17.414 +07:00 [INF] Retrieved 7 messages from Redis for conversation 19 and user 3
2025-05-22 21:11:17.414 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:11:17.414 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 25.3089ms
2025-05-22 21:11:17.414 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:11:17.415 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 25.9044ms
2025-05-22 21:11:17.439 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:11:17.440 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:11:17.440 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:11:17.446 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:11:17.447 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:11:17.447 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 6.8404ms
2025-05-22 21:11:17.447 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:11:17.447 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 7.4863ms
2025-05-22 21:11:17.466 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:11:17.466 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:11:17.467 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:11:17.471 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:11:17.472 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:11:17.472 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.1299ms
2025-05-22 21:11:17.472 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:11:17.472 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 5.5772ms
2025-05-22 21:11:22.354 +07:00 [INF] Handling message from user 3: bh
2025-05-22 21:11:22.362 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:11:22.363 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:11:22.368 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:11:22.368 +07:00 [INF] Message saved to DB with ID: 387
2025-05-22 21:11:22.369 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:11:22.374 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:11:22.375 +07:00 [INF] Transaction committed for message: 387
2025-05-22 21:11:22.381 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:11:22.384 +07:00 [INF] Saved message 387 to Redis
2025-05-22 21:11:22.385 +07:00 [INF] Added message 387 to conversation 19
2025-05-22 21:11:22.386 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:11:22.535 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 21:11:22.535 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:11:22.535 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:11:22.537 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: bh
2025-05-22 21:11:22.540 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:11:22.649 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:11:22.650 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:11:22.650 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 115.0312ms
2025-05-22 21:11:22.650 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:11:22.650 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 115.5242ms
2025-05-22 21:11:25.861 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:11:25.862 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:11:25.864 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:11:25.865 +07:00 [ERR] Connection id "0HNCP65OFONV3", Request id "0HNCP65OFONV3:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:11:25.867 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=3 - 101 null null 212206.544ms
2025-05-22 21:17:33.401 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:17:33.401 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:17:33.453 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 574451.3185ms
2025-05-22 21:17:33.453 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 421225.0423ms
2025-05-22 21:17:33.523 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:17:33.527 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:17:33.551 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:17:33.553 +07:00 [ERR] Connection id "0HNCP65OFONVH", Request id "0HNCP65OFONVH:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:17:33.556 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=2 - 101 null null 426486.2533ms
2025-05-22 21:21:12.231 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:21:12.237 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:12.243 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 12.6007ms
2025-05-22 21:21:12.248 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 21:21:12.253 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:12.281 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:12.286 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:21:12.291 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:21:12.488 +07:00 [INF] Executed DbCommand (47ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:21:12.509 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:21:12.511 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 217.8842ms
2025-05-22 21:21:12.511 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:21:12.511 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 263.1774ms
2025-05-22 21:21:12.547 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:21:12.547 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:12.548 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:12.548 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:21:12.588 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:21:12.592 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:21:12.592 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:21:12.592 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:21:12.594 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:21:12.594 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:21:12.594 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:21:12.595 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:21:12.595 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:21:12.595 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:21:12.595 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:21:12.595 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:21:12.596 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:21:12.596 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:21:12.596 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:21:12.597 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:21:12.597 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:21:12.597 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:21:12.597 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:21:12.597 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:21:12.598 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:21:12.598 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:21:18.386 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 21:21:18.387 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:18.387 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:18.388 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:21:18.388 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:21:18.414 +07:00 [INF] Executed DbCommand (17ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:21:18.415 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:21:18.416 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 27.3586ms
2025-05-22 21:21:18.416 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:21:18.416 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 29.2855ms
2025-05-22 21:21:18.658 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:21:18.658 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:18.658 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.4092ms
2025-05-22 21:21:18.661 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:21:18.661 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:18.661 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:18.661 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:21:18.662 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:21:18.704 +07:00 [INF] Executed DbCommand (33ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:21:18.716 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:21:18.721 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 59.0524ms
2025-05-22 21:21:18.721 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:21:18.721 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 60.0324ms
2025-05-22 21:21:34.404 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 57
2025-05-22 21:21:34.404 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:21:34.405 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:21:34.417 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:21:34.420 +07:00 [INF] Executing BadRequestObjectResult, writing value of type 'System.String'.
2025-05-22 21:21:34.423 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 18.3128ms
2025-05-22 21:21:34.423 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:21:34.423 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 400 null application/json; charset=utf-8 19.0858ms
2025-05-22 21:21:38.142 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 58
2025-05-22 21:21:38.142 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:21:38.142 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:21:38.148 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:21:38.150 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:21:38.150 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 8.293ms
2025-05-22 21:21:38.150 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:21:38.151 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 200 null application/json; charset=utf-8 8.9412ms
2025-05-22 21:21:38.743 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - null null
2025-05-22 21:21:38.744 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:21:39.035 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:21:39.036 +07:00 [INF] User 2 subscribed to channel conversation:3
2025-05-22 21:21:39.037 +07:00 [INF] User 2 subscribed to channel conversation:4
2025-05-22 21:21:39.037 +07:00 [INF] User 2 subscribed to channel conversation:19
2025-05-22 21:21:39.037 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-22 21:21:39.037 +07:00 [INF] User 2 subscribed to channel conversation:25
2025-05-22 21:21:39.039 +07:00 [INF] User 2 subscribed to channel conversation:26
2025-05-22 21:21:39.039 +07:00 [INF] User 2 subscribed to channel conversation:27
2025-05-22 21:21:39.039 +07:00 [INF] User 2 subscribed to channel conversation:28
2025-05-22 21:21:39.039 +07:00 [INF] User 2 subscribed to channel conversation:29
2025-05-22 21:21:39.039 +07:00 [INF] User 2 subscribed to channel conversation:32
2025-05-22 21:21:39.040 +07:00 [INF] User 2 subscribed to channel conversation:33
2025-05-22 21:21:39.040 +07:00 [INF] User 2 subscribed to channel conversation:34
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:35
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:36
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:37
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:38
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:39
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:41
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:40
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:42
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:44
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:43
2025-05-22 21:21:39.041 +07:00 [INF] User 2 subscribed to channel conversation:45
2025-05-22 21:21:39.079 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - application/json 168
2025-05-22 21:21:39.080 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:21:39.080 +07:00 [INF] Route matched with {action = "UpdateFcmToken", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateFcmToken(FcmBackend.Controllers.UpdateFcmTokenRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:21:39.089 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-22 21:21:39.092 +07:00 [INF] FCM token updated for userId: 2
2025-05-22 21:21:39.093 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.String'.
2025-05-22 21:21:39.093 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app) in 12.6638ms
2025-05-22 21:21:39.093 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:21:39.094 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - 200 null text/plain; charset=utf-8 14.4644ms
2025-05-22 21:21:39.702 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:21:39.702 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:21:39.702 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:21:39.706 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:21:39.706 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - null null
2025-05-22 21:21:39.706 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:21:39.706 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:21:39.727 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:21:39.730 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 27.8675ms
2025-05-22 21:21:39.730 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:21:39.730 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 28.7231ms
2025-05-22 21:21:39.733 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:21:39.735 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:21:39.735 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 27.4843ms
2025-05-22 21:21:39.735 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:21:39.735 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 29.426ms
2025-05-22 21:21:40.629 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:21:40.629 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.630 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 1.4821ms
2025-05-22 21:21:40.631 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:21:40.631 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.632 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.632 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:21:40.632 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:21:40.638 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:21:40.638 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:21:40.638 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:21:40.639 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:21:40.639 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:21:40.639 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:21:40.639 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:21:40.639 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:21:40.640 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:21:40.641 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:21:40.641 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:21:40.641 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:21:40.641 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:21:40.641 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:21:40.642 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:21:40.642 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:21:40.642 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:21:40.642 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:21:40.643 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:21:40.643 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:21:40.643 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:21:40.643 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:21:40.644 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:21:40.644 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:21:40.644 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:21:40.644 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:21:40.644 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:21:40.645 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:21:40.645 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:21:40.645 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:21:40.645 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:21:40.645 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:21:40.646 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:21:40.646 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:21:40.646 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:21:40.646 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:21:40.646 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:21:40.647 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:21:40.647 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:21:40.647 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:21:40.647 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:21:40.647 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:21:40.648 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:21:40.648 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:21:40.648 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:21:40.648 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:21:40.648 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:21:40.649 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:21:40.649 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:21:40.650 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:21:40.650 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:21:40.650 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:21:40.651 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:21:40.651 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:21:40.651 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:21:40.652 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:21:40.652 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:21:40.652 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:21:40.653 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:21:40.653 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:21:40.653 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:21:40.654 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:21:40.654 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:21:40.654 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:21:40.654 +07:00 [INF] Retrieved 8 messages from Redis for conversation 19
2025-05-22 21:21:40.656 +07:00 [INF] Retrieved 8 messages from Redis for conversation 19 and user 3
2025-05-22 21:21:40.656 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:21:40.656 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 24.2793ms
2025-05-22 21:21:40.656 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:21:40.656 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 24.8154ms
2025-05-22 21:21:40.665 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:21:40.665 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.665 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2318ms
2025-05-22 21:21:40.667 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:21:40.667 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.667 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.667 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:21:40.667 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:21:40.675 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:21:40.676 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:21:40.677 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 9.9359ms
2025-05-22 21:21:40.678 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:21:40.678 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 11.1494ms
2025-05-22 21:21:40.684 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:21:40.684 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.684 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.2701ms
2025-05-22 21:21:40.685 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:21:40.685 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.685 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:40.686 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:21:40.686 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:21:40.691 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:21:40.691 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:21:40.691 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.4814ms
2025-05-22 21:21:40.691 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:21:40.691 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 6.3135ms
2025-05-22 21:21:46.065 +07:00 [INF] Handling message from user 3: bmnb
2025-05-22 21:21:46.074 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:21:46.087 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:21:46.110 +07:00 [INF] Executed DbCommand (23ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:21:46.111 +07:00 [INF] Message saved to DB with ID: 388
2025-05-22 21:21:46.112 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:21:46.121 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:21:46.123 +07:00 [INF] Transaction committed for message: 388
2025-05-22 21:21:46.137 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:21:46.140 +07:00 [INF] Saved message 388 to Redis
2025-05-22 21:21:46.141 +07:00 [INF] Added message 388 to conversation 19
2025-05-22 21:21:46.144 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:21:46.277 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:21:46.277 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:46.277 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 0.268ms
2025-05-22 21:21:46.279 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 67
2025-05-22 21:21:46.279 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:46.279 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:21:46.279 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:21:46.279 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:21:46.282 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: bmnb
2025-05-22 21:21:46.287 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:21:46.569 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:21:46.569 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:21:46.569 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 289.6521ms
2025-05-22 21:21:46.570 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:21:46.570 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 290.4362ms
2025-05-22 21:22:06.356 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/2 - null null
2025-05-22 21:22:06.357 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:22:06.357 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:22:06.364 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:22:06.364 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:22:06.365 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:22:06.365 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:22:06.365 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:22:06.365 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:22:06.365 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:22:06.366 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:22:06.367 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:22:06.370 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:22:06.372 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:22:06.372 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:22:06.373 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:22:06.373 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:22:06.373 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:22:06.373 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:22:06.373 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:22:06.374 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:22:06.374 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:22:06.374 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:22:06.374 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:22:06.374 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:22:06.374 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:22:06.375 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:22:06.375 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:22:06.375 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:22:06.375 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:22:06.375 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:22:06.375 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:22:06.376 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:22:06.376 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:22:06.376 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:22:06.376 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:22:06.377 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:22:06.377 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:22:06.377 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:22:06.377 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:22:06.377 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:22:06.377 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:22:06.378 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:22:06.378 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:22:06.378 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:22:06.378 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:22:06.378 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:22:06.379 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:22:06.379 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:22:06.379 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:22:06.379 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:22:06.379 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:22:06.379 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:22:06.380 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:22:06.380 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:22:06.380 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:22:06.380 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:22:06.380 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:22:06.381 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:22:06.381 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:22:06.381 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:22:06.381 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:22:06.381 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:22:06.381 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:22:06.382 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:22:06.382 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:22:06.382 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:22:06.382 +07:00 [INF] Retrieved 9 messages from Redis for conversation 19
2025-05-22 21:22:06.382 +07:00 [INF] Retrieved 9 messages from Redis for conversation 19 and user 2
2025-05-22 21:22:06.382 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:22:06.382 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 25.6809ms
2025-05-22 21:22:06.382 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:22:06.383 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 26.2045ms
2025-05-22 21:22:06.453 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:22:06.453 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:22:06.453 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:22:06.462 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:22:06.463 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:22:06.464 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 10.3361ms
2025-05-22 21:22:06.464 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:22:06.464 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 10.81ms
2025-05-22 21:22:06.500 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:22:06.500 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:22:06.500 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:22:06.503 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:22:06.503 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:22:06.503 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 3.181ms
2025-05-22 21:22:06.503 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:22:06.503 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 3.5534ms
2025-05-22 21:22:08.772 +07:00 [INF] Handling message from user 2: đ
2025-05-22 21:22:08.780 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:22:08.782 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:22:08.787 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:22:08.787 +07:00 [INF] Message saved to DB with ID: 389
2025-05-22 21:22:08.787 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:22:08.791 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:22:08.792 +07:00 [INF] Transaction committed for message: 389
2025-05-22 21:22:08.797 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:22:08.798 +07:00 [INF] Saved message 389 to Redis
2025-05-22 21:22:08.799 +07:00 [INF] Added message 389 to conversation 19
2025-05-22 21:22:08.801 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:22:09.233 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 21:22:09.235 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:22:09.235 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:22:09.235 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: đ
2025-05-22 21:22:09.241 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:22:09.377 +07:00 [ERR] Error sending notification to userId: 3 : SenderId mismatch
2025-05-22 21:22:09.377 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:22:09.377 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 142.4437ms
2025-05-22 21:22:09.377 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:22:09.377 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 144.7862ms
2025-05-22 21:25:05.614 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:25:05.619 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:25:05.643 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:25:05.644 +07:00 [ERR] Connection id "0HNCP65OFOO04", Request id "0HNCP65OFOO04:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:25:05.649 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - 101 null null 206905.1802ms
2025-05-22 21:25:09.032 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:25:09.033 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:25:09.034 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:25:09.035 +07:00 [ERR] Connection id "0HNCP65OFOO01", Request id "0HNCP65OFOO01:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:25:09.035 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 236488.7299ms
2025-05-22 21:27:14.488 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:27:14.497 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:14.504 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 17.5341ms
2025-05-22 21:27:14.509 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 21:27:14.510 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:14.513 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:14.569 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:27:14.574 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:27:14.808 +07:00 [INF] Executed DbCommand (70ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:27:14.837 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:27:14.839 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 263.4317ms
2025-05-22 21:27:14.840 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:27:14.840 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 331.846ms
2025-05-22 21:27:14.865 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:27:14.868 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:14.868 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:14.869 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:27:14.926 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:27:14.932 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:27:14.932 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:27:14.932 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:27:14.932 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:27:14.933 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:27:14.933 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:27:14.933 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:27:14.933 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:27:14.933 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:27:14.934 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:27:14.934 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:27:14.934 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:27:14.934 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:27:14.935 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:27:14.935 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:27:14.935 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:27:14.935 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:27:14.936 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:27:14.936 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:27:14.936 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:27:14.936 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:27:18.517 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 21:27:18.518 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:18.521 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:18.521 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:27:18.522 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:27:18.555 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:27:18.556 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:27:18.559 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 37.2853ms
2025-05-22 21:27:18.559 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:27:18.559 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 41.985ms
2025-05-22 21:27:18.739 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:27:18.739 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:18.739 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.2166ms
2025-05-22 21:27:18.741 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:27:18.742 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:18.742 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:18.742 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:27:18.742 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:27:18.800 +07:00 [INF] Executed DbCommand (34ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:27:18.811 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:27:18.816 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 73.9967ms
2025-05-22 21:27:18.816 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:27:18.816 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 75.043ms
2025-05-22 21:27:32.365 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 58
2025-05-22 21:27:32.365 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:27:32.365 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:27:32.433 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:27:32.434 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:27:32.434 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 69.0363ms
2025-05-22 21:27:32.434 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:27:32.434 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 200 null application/json; charset=utf-8 69.435ms
2025-05-22 21:27:33.270 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - null null
2025-05-22 21:27:33.273 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:27:33.370 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - application/json 168
2025-05-22 21:27:33.371 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:27:33.371 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:27:33.371 +07:00 [INF] Route matched with {action = "UpdateFcmToken", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateFcmToken(FcmBackend.Controllers.UpdateFcmTokenRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:27:33.371 +07:00 [INF] User 2 subscribed to channel conversation:3
2025-05-22 21:27:33.371 +07:00 [INF] User 2 subscribed to channel conversation:4
2025-05-22 21:27:33.372 +07:00 [INF] User 2 subscribed to channel conversation:19
2025-05-22 21:27:33.372 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-22 21:27:33.373 +07:00 [INF] User 2 subscribed to channel conversation:25
2025-05-22 21:27:33.373 +07:00 [INF] User 2 subscribed to channel conversation:26
2025-05-22 21:27:33.373 +07:00 [INF] User 2 subscribed to channel conversation:27
2025-05-22 21:27:33.373 +07:00 [INF] User 2 subscribed to channel conversation:28
2025-05-22 21:27:33.373 +07:00 [INF] User 2 subscribed to channel conversation:29
2025-05-22 21:27:33.375 +07:00 [INF] User 2 subscribed to channel conversation:32
2025-05-22 21:27:33.375 +07:00 [INF] User 2 subscribed to channel conversation:33
2025-05-22 21:27:33.375 +07:00 [INF] User 2 subscribed to channel conversation:34
2025-05-22 21:27:33.375 +07:00 [INF] User 2 subscribed to channel conversation:35
2025-05-22 21:27:33.376 +07:00 [INF] User 2 subscribed to channel conversation:36
2025-05-22 21:27:33.376 +07:00 [INF] User 2 subscribed to channel conversation:37
2025-05-22 21:27:33.376 +07:00 [INF] User 2 subscribed to channel conversation:38
2025-05-22 21:27:33.376 +07:00 [INF] User 2 subscribed to channel conversation:39
2025-05-22 21:27:33.376 +07:00 [INF] User 2 subscribed to channel conversation:41
2025-05-22 21:27:33.376 +07:00 [INF] User 2 subscribed to channel conversation:40
2025-05-22 21:27:33.377 +07:00 [INF] User 2 subscribed to channel conversation:42
2025-05-22 21:27:33.378 +07:00 [INF] User 2 subscribed to channel conversation:44
2025-05-22 21:27:33.378 +07:00 [INF] User 2 subscribed to channel conversation:43
2025-05-22 21:27:33.378 +07:00 [INF] User 2 subscribed to channel conversation:45
2025-05-22 21:27:33.473 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-22 21:27:33.476 +07:00 [INF] FCM token updated for userId: 2
2025-05-22 21:27:33.476 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.String'.
2025-05-22 21:27:33.477 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app) in 106.3488ms
2025-05-22 21:27:33.477 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:27:33.477 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - 200 null text/plain; charset=utf-8 107.1789ms
2025-05-22 21:27:33.905 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - null null
2025-05-22 21:27:33.905 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:27:33.905 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:27:33.924 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:27:33.929 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:27:33.930 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 24.8339ms
2025-05-22 21:27:33.930 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:27:33.930 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 25.2849ms
2025-05-22 21:27:34.091 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:27:34.091 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:27:34.091 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:27:34.107 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:27:34.118 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:27:34.119 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 28.357ms
2025-05-22 21:27:34.120 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:27:34.120 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 28.9539ms
2025-05-22 21:27:38.110 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:27:38.110 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.110 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.3328ms
2025-05-22 21:27:38.111 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:27:38.111 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.112 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.112 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:27:38.113 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:27:38.125 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:27:38.125 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:27:38.125 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:27:38.126 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:27:38.126 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:27:38.126 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:27:38.127 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:27:38.127 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:27:38.127 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:27:38.128 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:27:38.128 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:27:38.129 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:27:38.129 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:27:38.130 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:27:38.130 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:27:38.131 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:27:38.131 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:27:38.131 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:27:38.131 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:27:38.132 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:27:38.132 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:27:38.133 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:27:38.133 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:27:38.133 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:27:38.134 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:27:38.134 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:27:38.134 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:27:38.134 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:27:38.135 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:27:38.135 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:27:38.135 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:27:38.136 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:27:38.137 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:27:38.137 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:27:38.137 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:27:38.137 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:27:38.138 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:27:38.139 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:27:38.139 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:27:38.139 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:27:38.139 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:27:38.140 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:27:38.140 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:27:38.140 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:27:38.141 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:27:38.141 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:27:38.142 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:27:38.142 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:27:38.142 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:27:38.143 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:27:38.143 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:27:38.144 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:27:38.144 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:27:38.145 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:27:38.145 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:27:38.146 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:27:38.147 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:27:38.147 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:27:38.148 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:27:38.148 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:27:38.148 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:27:38.149 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:27:38.149 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:27:38.150 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:27:38.150 +07:00 [INF] Retrieved 10 messages from Redis for conversation 19
2025-05-22 21:27:38.152 +07:00 [INF] Retrieved 10 messages from Redis for conversation 19 and user 3
2025-05-22 21:27:38.152 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:27:38.152 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 39.2106ms
2025-05-22 21:27:38.152 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:27:38.152 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 41.2451ms
2025-05-22 21:27:38.160 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:27:38.160 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.160 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.1597ms
2025-05-22 21:27:38.161 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:27:38.161 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.161 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.161 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:27:38.162 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:27:38.171 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:27:38.173 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:27:38.173 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 11.5631ms
2025-05-22 21:27:38.173 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:27:38.173 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 12.3463ms
2025-05-22 21:27:38.180 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:27:38.180 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.181 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.1942ms
2025-05-22 21:27:38.182 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:27:38.182 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.182 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:38.182 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:27:38.183 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:27:38.189 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:27:38.189 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:27:38.190 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 6.9253ms
2025-05-22 21:27:38.190 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:27:38.190 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 8.0779ms
2025-05-22 21:27:41.498 +07:00 [INF] Handling message from user 3: nnn
2025-05-22 21:27:41.505 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:27:41.515 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:27:41.551 +07:00 [INF] Executed DbCommand (36ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:27:41.553 +07:00 [INF] Message saved to DB with ID: 390
2025-05-22 21:27:41.554 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:27:41.565 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:27:41.567 +07:00 [INF] Transaction committed for message: 390
2025-05-22 21:27:41.572 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:27:41.575 +07:00 [INF] Saved message 390 to Redis
2025-05-22 21:27:41.576 +07:00 [INF] Added message 390 to conversation 19
2025-05-22 21:27:41.578 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:27:41.661 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:27:41.661 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:41.661 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 0.2502ms
2025-05-22 21:27:41.662 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 66
2025-05-22 21:27:41.663 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:41.663 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:27:41.663 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:27:41.663 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:27:41.665 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: nnn
2025-05-22 21:27:41.670 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:27:43.221 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:27:43.221 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:27:43.221 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 1558.5033ms
2025-05-22 21:27:43.221 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:27:43.222 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 1559.0702ms
2025-05-22 21:27:51.162 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/2 - null null
2025-05-22 21:27:51.163 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:27:51.163 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:27:51.177 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:27:51.178 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:27:51.178 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:27:51.179 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:27:51.180 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:27:51.181 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:27:51.182 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:27:51.183 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:27:51.184 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:27:51.185 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:27:51.185 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:27:51.186 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:27:51.188 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:27:51.189 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:27:51.190 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:27:51.191 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:27:51.191 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:27:51.192 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:27:51.194 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:27:51.195 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:27:51.195 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:27:51.196 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:27:51.197 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:27:51.198 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:27:51.198 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:27:51.200 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:27:51.201 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:27:51.202 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:27:51.203 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:27:51.204 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:27:51.206 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:27:51.206 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:27:51.208 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:27:51.209 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:27:51.210 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:27:51.211 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:27:51.211 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:27:51.212 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:27:51.214 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:27:51.215 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:27:51.215 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:27:51.215 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:27:51.216 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:27:51.217 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:27:51.217 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:27:51.218 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:27:51.218 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:27:51.219 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:27:51.220 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:27:51.221 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:27:51.222 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:27:51.223 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:27:51.224 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:27:51.225 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:27:51.225 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:27:51.226 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:27:51.226 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:27:51.226 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:27:51.227 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:27:51.227 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:27:51.227 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:27:51.228 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:27:51.229 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:27:51.229 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:27:51.229 +07:00 [INF] Retrieved 11 messages from Redis for conversation 19
2025-05-22 21:27:51.229 +07:00 [INF] Retrieved 11 messages from Redis for conversation 19 and user 2
2025-05-22 21:27:51.229 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:27:51.230 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 66.8088ms
2025-05-22 21:27:51.230 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:27:51.230 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 67.2043ms
2025-05-22 21:27:51.282 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:27:51.282 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:27:51.282 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:27:51.290 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:27:51.291 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:27:51.291 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 9.0028ms
2025-05-22 21:27:51.291 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:27:51.291 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 9.3371ms
2025-05-22 21:27:51.414 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:27:51.414 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:27:51.414 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:27:51.419 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:27:51.419 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:27:51.419 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 4.5508ms
2025-05-22 21:27:51.419 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:27:51.419 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 4.8179ms
2025-05-22 21:27:53.725 +07:00 [INF] Handling message from user 2: ccf
2025-05-22 21:27:53.731 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:27:53.733 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:27:53.738 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:27:53.738 +07:00 [INF] Message saved to DB with ID: 391
2025-05-22 21:27:53.739 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:27:53.743 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:27:53.744 +07:00 [INF] Transaction committed for message: 391
2025-05-22 21:27:53.749 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:27:53.752 +07:00 [INF] Saved message 391 to Redis
2025-05-22 21:27:53.753 +07:00 [INF] Added message 391 to conversation 19
2025-05-22 21:27:53.754 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:27:54.086 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 66
2025-05-22 21:27:54.087 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:27:54.087 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:27:54.087 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: ccf
2025-05-22 21:27:54.089 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:27:54.216 +07:00 [ERR] Error sending notification to userId: 3 : SenderId mismatch
2025-05-22 21:27:54.216 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:27:54.216 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 129.4692ms
2025-05-22 21:27:54.216 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:27:54.216 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 129.8068ms
2025-05-22 21:28:16.070 +07:00 [INF] Handling message from user 2: ff
2025-05-22 21:28:16.079 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:28:16.082 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:28:16.088 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:28:16.088 +07:00 [INF] Message saved to DB with ID: 392
2025-05-22 21:28:16.089 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:28:16.096 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:28:16.098 +07:00 [INF] Transaction committed for message: 392
2025-05-22 21:28:16.105 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:28:16.109 +07:00 [INF] Saved message 392 to Redis
2025-05-22 21:28:16.110 +07:00 [INF] Added message 392 to conversation 19
2025-05-22 21:28:16.111 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:28:16.384 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 65
2025-05-22 21:28:16.385 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:28:16.385 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:28:16.385 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: ff
2025-05-22 21:28:16.392 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:28:16.530 +07:00 [ERR] Error sending notification to userId: 3 : SenderId mismatch
2025-05-22 21:28:16.530 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:28:16.530 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 145.0502ms
2025-05-22 21:28:16.530 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:28:16.530 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 145.8683ms
2025-05-22 21:29:45.404 +07:00 [INF] Executed DbCommand (42ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-22 21:29:45.593 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-22 21:29:45.708 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-22 21:29:45.718 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-22 21:29:45.719 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-22 21:29:45.719 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-22 21:29:45.719 +07:00 [INF] Hosting environment: Development
2025-05-22 21:29:45.719 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-22 21:29:45.775 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:29:45.800 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:29:45.826 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:29:45.826 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-22 21:29:45.861 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:29:49.729 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - null null
2025-05-22 21:29:49.733 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:30:02.193 +07:00 [INF] Handling message from user 3: sad
2025-05-22 21:30:02.263 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:30:02.264 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:30:02.267 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 3.1341ms
2025-05-22 21:30:02.308 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 66
2025-05-22 21:30:02.309 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:30:02.310 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:30:02.313 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:30:02.343 +07:00 [INF] Executed DbCommand (60ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:30:02.351 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:30:02.376 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: sad
2025-05-22 21:30:02.441 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:30:02.505 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:30:02.514 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:30:02.529 +07:00 [INF] Message saved to DB with ID: 393
2025-05-22 21:30:02.532 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:30:02.536 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:30:02.543 +07:00 [INF] Transaction committed for message: 393
2025-05-22 21:30:02.558 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:30:02.568 +07:00 [INF] Saved message 393 to Redis
2025-05-22 21:30:02.569 +07:00 [INF] Added message 393 to conversation 19
2025-05-22 21:30:02.585 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:30:02.962 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:30:02.966 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:30:02.969 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 615.6675ms
2025-05-22 21:30:02.969 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:30:02.973 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 664.9983ms
2025-05-22 21:30:10.810 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:30:10.812 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:30:10.852 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:30:10.862 +07:00 [ERR] Connection id "0HNCP7KCP1SIL", Request id "0HNCP7KCP1SIL:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:30:10.879 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - 101 null null 21150.6754ms
2025-05-22 21:30:15.525 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:30:15.525 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 29752.9975ms
2025-05-22 21:32:21.114 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:32:21.118 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:21.120 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 6.6064ms
2025-05-22 21:32:21.121 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 21:32:21.121 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:21.128 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:21.132 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:32:21.170 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:32:21.299 +07:00 [INF] Executed DbCommand (44ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:32:21.380 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:32:21.430 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 259.8184ms
2025-05-22 21:32:21.430 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:32:21.431 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 309.6998ms
2025-05-22 21:32:21.461 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:32:21.464 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:21.464 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:21.464 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:32:21.503 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:32:21.522 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:32:21.522 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:32:21.523 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:32:21.524 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:32:21.524 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:32:21.526 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:32:21.527 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:32:21.527 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:32:21.528 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:32:21.528 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:32:21.529 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:32:21.530 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:32:21.530 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:32:21.531 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:32:21.531 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:32:21.532 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:32:21.532 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:32:21.533 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:32:21.533 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:32:21.534 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:32:21.535 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:32:25.450 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 21:32:25.450 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:25.452 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:25.453 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:32:25.461 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:32:25.563 +07:00 [INF] Executed DbCommand (24ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:32:25.566 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:32:25.580 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 119.2695ms
2025-05-22 21:32:25.580 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:32:25.581 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 131.0917ms
2025-05-22 21:32:25.785 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:32:25.785 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:25.786 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.4709ms
2025-05-22 21:32:25.787 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:32:25.788 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:25.788 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:25.788 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:32:25.792 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:32:25.937 +07:00 [INF] Executed DbCommand (32ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:32:25.949 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:32:25.958 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 166.2082ms
2025-05-22 21:32:25.958 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:32:25.959 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 171.1391ms
2025-05-22 21:32:39.995 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 58
2025-05-22 21:32:40.005 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:32:40.006 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:32:40.028 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:32:40.030 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:32:40.030 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 23.5703ms
2025-05-22 21:32:40.030 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:32:40.030 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 200 null application/json; charset=utf-8 34.8676ms
2025-05-22 21:32:40.829 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - null null
2025-05-22 21:32:40.829 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:32:41.035 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:32:41.036 +07:00 [INF] User 2 subscribed to channel conversation:3
2025-05-22 21:32:41.036 +07:00 [INF] User 2 subscribed to channel conversation:4
2025-05-22 21:32:41.039 +07:00 [INF] User 2 subscribed to channel conversation:19
2025-05-22 21:32:41.039 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-22 21:32:41.039 +07:00 [INF] User 2 subscribed to channel conversation:25
2025-05-22 21:32:41.039 +07:00 [INF] User 2 subscribed to channel conversation:26
2025-05-22 21:32:41.039 +07:00 [INF] User 2 subscribed to channel conversation:27
2025-05-22 21:32:41.039 +07:00 [INF] User 2 subscribed to channel conversation:28
2025-05-22 21:32:41.039 +07:00 [INF] User 2 subscribed to channel conversation:29
2025-05-22 21:32:41.040 +07:00 [INF] User 2 subscribed to channel conversation:32
2025-05-22 21:32:41.042 +07:00 [INF] User 2 subscribed to channel conversation:33
2025-05-22 21:32:41.042 +07:00 [INF] User 2 subscribed to channel conversation:34
2025-05-22 21:32:41.042 +07:00 [INF] User 2 subscribed to channel conversation:35
2025-05-22 21:32:41.042 +07:00 [INF] User 2 subscribed to channel conversation:36
2025-05-22 21:32:41.042 +07:00 [INF] User 2 subscribed to channel conversation:37
2025-05-22 21:32:41.043 +07:00 [INF] User 2 subscribed to channel conversation:38
2025-05-22 21:32:41.044 +07:00 [INF] User 2 subscribed to channel conversation:39
2025-05-22 21:32:41.046 +07:00 [INF] User 2 subscribed to channel conversation:41
2025-05-22 21:32:41.046 +07:00 [INF] User 2 subscribed to channel conversation:40
2025-05-22 21:32:41.046 +07:00 [INF] User 2 subscribed to channel conversation:42
2025-05-22 21:32:41.046 +07:00 [INF] User 2 subscribed to channel conversation:44
2025-05-22 21:32:41.046 +07:00 [INF] User 2 subscribed to channel conversation:43
2025-05-22 21:32:41.046 +07:00 [INF] User 2 subscribed to channel conversation:45
2025-05-22 21:32:41.064 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - application/json 168
2025-05-22 21:32:41.065 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:32:41.072 +07:00 [INF] Route matched with {action = "UpdateFcmToken", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateFcmToken(FcmBackend.Controllers.UpdateFcmTokenRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:32:41.094 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-22 21:32:41.108 +07:00 [INF] FCM token updated for userId: 2
2025-05-22 21:32:41.108 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.String'.
2025-05-22 21:32:41.108 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app) in 35.4252ms
2025-05-22 21:32:41.108 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:32:41.108 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - 200 null text/plain; charset=utf-8 44.6128ms
2025-05-22 21:32:41.596 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - null null
2025-05-22 21:32:41.600 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:32:41.600 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:32:41.600 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:32:41.604 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:32:41.605 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:32:41.638 +07:00 [INF] Executed DbCommand (30ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:32:41.638 +07:00 [INF] Executed DbCommand (31ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:32:41.642 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:32:41.643 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 42.0861ms
2025-05-22 21:32:41.643 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:32:41.643 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 47.0566ms
2025-05-22 21:32:41.652 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:32:41.659 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 54.2595ms
2025-05-22 21:32:41.659 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:32:41.659 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 58.8169ms
2025-05-22 21:32:49.341 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:32:49.341 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.341 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.6433ms
2025-05-22 21:32:49.346 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:32:49.347 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.347 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.347 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:32:49.353 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:32:49.422 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:32:49.422 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:32:49.423 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:32:49.423 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:32:49.424 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:32:49.424 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:32:49.424 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:32:49.425 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:32:49.425 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:32:49.425 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:32:49.426 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:32:49.426 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:32:49.427 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:32:49.427 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:32:49.428 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:32:49.428 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:32:49.428 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:32:49.429 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:32:49.429 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:32:49.430 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:32:49.430 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:32:49.430 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:32:49.431 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:32:49.431 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:32:49.431 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:32:49.432 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:32:49.432 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:32:49.432 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:32:49.432 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:32:49.433 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:32:49.433 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:32:49.434 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:32:49.434 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:32:49.434 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:32:49.435 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:32:49.435 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:32:49.435 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:32:49.436 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:32:49.436 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:32:49.436 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:32:49.437 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:32:49.437 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:32:49.438 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:32:49.438 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:32:49.438 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:32:49.439 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:32:49.439 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:32:49.440 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:32:49.440 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:32:49.440 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:32:49.441 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:32:49.441 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:32:49.441 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:32:49.442 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:32:49.442 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:32:49.442 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:32:49.442 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:32:49.443 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:32:49.443 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:32:49.443 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:32:49.443 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:32:49.444 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:32:49.444 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:32:49.445 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:32:49.445 +07:00 [INF] Retrieved 14 messages from Redis for conversation 19
2025-05-22 21:32:49.447 +07:00 [INF] Retrieved 14 messages from Redis for conversation 19 and user 3
2025-05-22 21:32:49.447 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:32:49.450 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 96.9259ms
2025-05-22 21:32:49.450 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:32:49.450 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 103.4455ms
2025-05-22 21:32:49.459 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:32:49.460 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.460 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.3214ms
2025-05-22 21:32:49.462 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:32:49.462 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.462 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.462 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:32:49.466 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:32:49.511 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:32:49.522 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:32:49.525 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 59.7322ms
2025-05-22 21:32:49.525 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:32:49.526 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 63.9551ms
2025-05-22 21:32:49.535 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:32:49.535 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.535 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.4495ms
2025-05-22 21:32:49.537 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:32:49.537 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.537 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:49.537 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:32:49.541 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:32:49.555 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:32:49.556 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:32:49.558 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 16.734ms
2025-05-22 21:32:49.558 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:32:49.559 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 21.9372ms
2025-05-22 21:32:53.207 +07:00 [INF] Handling message from user 3: sdg
2025-05-22 21:32:53.214 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:32:53.234 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:32:53.257 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:32:53.258 +07:00 [INF] Message saved to DB with ID: 394
2025-05-22 21:32:53.258 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:32:53.265 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:32:53.266 +07:00 [INF] Transaction committed for message: 394
2025-05-22 21:32:53.270 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:32:53.272 +07:00 [INF] Saved message 394 to Redis
2025-05-22 21:32:53.273 +07:00 [INF] Added message 394 to conversation 19
2025-05-22 21:32:53.274 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:32:53.391 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:32:53.391 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:53.392 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 1.583ms
2025-05-22 21:32:53.394 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 66
2025-05-22 21:32:53.395 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:53.398 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:32:53.398 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:32:53.399 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:32:53.405 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: sdg
2025-05-22 21:32:53.418 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:32:53.704 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:32:53.704 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:32:53.704 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 304.9988ms
2025-05-22 21:32:53.704 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:32:53.704 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 310.1484ms
2025-05-22 21:33:27.946 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:33:27.947 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:27.947 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.6659ms
2025-05-22 21:33:27.948 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:33:27.948 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:27.949 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:27.949 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:33:27.949 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:33:27.954 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:33:27.954 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:33:27.954 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:33:27.954 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:33:27.955 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:33:27.955 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:33:27.955 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:33:27.956 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:33:27.956 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:33:27.956 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:33:27.956 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:33:27.956 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:33:27.957 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:33:27.957 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:33:27.957 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:33:27.958 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:33:27.958 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:33:27.959 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:33:27.959 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:33:27.959 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:33:27.960 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:33:27.960 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:33:27.961 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:33:27.962 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:33:27.962 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:33:27.962 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:33:27.963 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:33:27.963 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:33:27.963 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:33:27.964 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:33:27.964 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:33:27.964 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:33:27.965 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:33:27.965 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:33:27.965 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:33:27.965 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:33:27.966 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:33:27.966 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:33:27.966 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:33:27.967 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:33:27.967 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:33:27.967 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:33:27.968 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:33:27.968 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:33:27.968 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:33:27.968 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:33:27.969 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:33:27.969 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:33:27.969 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:33:27.969 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:33:27.970 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:33:27.970 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:33:27.970 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:33:27.970 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:33:27.971 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:33:27.971 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:33:27.971 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:33:27.971 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:33:27.971 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:33:27.972 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:33:27.972 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:33:27.972 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:33:27.972 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:33:27.973 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:33:27.973 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19
2025-05-22 21:33:27.973 +07:00 [INF] Retrieved 15 messages from Redis for conversation 19 and user 3
2025-05-22 21:33:27.973 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:33:27.973 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 23.8528ms
2025-05-22 21:33:27.973 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:33:27.973 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 25.269ms
2025-05-22 21:33:27.983 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:33:27.983 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:27.984 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 1.1217ms
2025-05-22 21:33:27.988 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:33:27.988 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:27.988 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:27.989 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:33:27.989 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:33:28.025 +07:00 [INF] Executed DbCommand (34ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:33:28.025 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:33:28.026 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 37.0921ms
2025-05-22 21:33:28.026 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:33:28.026 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 37.9248ms
2025-05-22 21:33:28.042 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:33:28.042 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:28.042 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.3464ms
2025-05-22 21:33:28.043 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:33:28.043 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:28.045 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:28.045 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:33:28.045 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:33:28.050 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:33:28.051 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:33:28.051 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.7087ms
2025-05-22 21:33:28.051 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:33:28.051 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 7.9668ms
2025-05-22 21:33:30.754 +07:00 [INF] Handling message from user 3: a
2025-05-22 21:33:30.757 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:33:30.771 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:33:30.779 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:33:30.780 +07:00 [INF] Message saved to DB with ID: 395
2025-05-22 21:33:30.781 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:33:30.786 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:33:30.787 +07:00 [INF] Transaction committed for message: 395
2025-05-22 21:33:30.791 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:33:30.792 +07:00 [INF] Saved message 395 to Redis
2025-05-22 21:33:30.792 +07:00 [INF] Added message 395 to conversation 19
2025-05-22 21:33:30.793 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:33:30.987 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:33:30.987 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:30.988 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 0.2674ms
2025-05-22 21:33:30.990 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 64
2025-05-22 21:33:30.991 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:30.991 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:33:30.991 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:33:30.991 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:33:30.992 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: a
2025-05-22 21:33:31.001 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:33:31.111 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:33:31.111 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:33:31.111 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 119.634ms
2025-05-22 21:33:31.111 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:33:31.112 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 121.3544ms
2025-05-22 21:40:15.045 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:40:15.046 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:40:15.056 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:40:15.057 +07:00 [ERR] Connection id "0HNCP7KCP1SIQ", Request id "0HNCP7KCP1SIQ:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:40:15.060 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - 101 null null 454231.3266ms
2025-05-22 21:40:38.436 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:40:38.443 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:38.446 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 9.0211ms
2025-05-22 21:40:38.448 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 21:40:38.450 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:38.453 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:38.458 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:40:38.468 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:40:38.616 +07:00 [INF] Executed DbCommand (49ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:40:38.633 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:40:38.636 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 166.7208ms
2025-05-22 21:40:38.636 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:40:38.637 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 188.5508ms
2025-05-22 21:40:38.718 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:40:38.722 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:38.722 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:38.723 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:40:38.797 +07:00 [INF] Executed DbCommand (31ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:40:38.799 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:40:38.799 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:40:38.799 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:40:38.799 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:40:38.799 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:40:38.799 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:40:38.800 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:40:38.801 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:40:39.017 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 21:40:39.017 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:39.018 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:39.018 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:40:39.019 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:40:39.050 +07:00 [INF] Executed DbCommand (25ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:40:39.051 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:40:39.052 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 33.0383ms
2025-05-22 21:40:39.052 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:40:39.052 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 35.3799ms
2025-05-22 21:40:39.214 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:40:39.214 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:39.215 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.6984ms
2025-05-22 21:40:39.216 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:40:39.216 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:39.217 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:40:39.217 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:40:39.218 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:40:39.263 +07:00 [INF] Executed DbCommand (42ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:40:39.277 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:40:39.283 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 65.5806ms
2025-05-22 21:40:39.283 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:40:39.284 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 67.3259ms
2025-05-22 21:40:55.997 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:40:56.000 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:40:56.000 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:40:56.005 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:40:55.998 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:40:56.006 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:40:56.006 +07:00 [ERR] Connection id "0HNCP7KCP1SIV", Request id "0HNCP7KCP1SIV:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:40:56.007 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 17289.53ms
2025-05-22 21:40:56.007 +07:00 [ERR] Connection id "0HNCP7KCP1SIO", Request id "0HNCP7KCP1SIO:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:40:56.009 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 514548.5164ms
2025-05-22 21:41:22.427 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 58
2025-05-22 21:41:22.430 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:41:22.431 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:41:22.454 +07:00 [INF] Executed DbCommand (16ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:41:22.455 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:41:22.456 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 25.1161ms
2025-05-22 21:41:22.456 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:41:22.456 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 200 null application/json; charset=utf-8 28.9754ms
2025-05-22 21:41:23.298 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - application/json 168
2025-05-22 21:41:23.299 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:41:23.299 +07:00 [INF] Route matched with {action = "UpdateFcmToken", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateFcmToken(FcmBackend.Controllers.UpdateFcmTokenRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:41:23.315 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-22 21:41:23.370 +07:00 [INF] Executed DbCommand (31ms) [Parameters=[@p1='?' (DbType = Int32), @p0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Users] SET [fcmToken] = @p0
OUTPUT 1
WHERE [id] = @p1;
2025-05-22 21:41:23.372 +07:00 [INF] FCM token updated for userId: 2
2025-05-22 21:41:23.373 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.String'.
2025-05-22 21:41:23.373 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app) in 73.9007ms
2025-05-22 21:41:23.373 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:41:23.373 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - 200 null text/plain; charset=utf-8 75.3902ms
2025-05-22 21:41:23.808 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - null null
2025-05-22 21:41:23.809 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:41:23.809 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:41:23.821 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:41:23.827 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:41:23.828 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 18.7542ms
2025-05-22 21:41:23.828 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:41:23.828 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 19.9539ms
2025-05-22 21:41:23.966 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:41:23.966 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:41:23.966 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:41:23.995 +07:00 [INF] Executed DbCommand (26ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:41:24.010 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:41:24.013 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 46.3437ms
2025-05-22 21:41:24.013 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:41:24.013 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 47.274ms
2025-05-22 21:41:24.468 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - null null
2025-05-22 21:41:24.468 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:41:24.544 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:41:24.545 +07:00 [INF] User 2 subscribed to channel conversation:3
2025-05-22 21:41:24.545 +07:00 [INF] User 2 subscribed to channel conversation:4
2025-05-22 21:41:24.545 +07:00 [INF] User 2 subscribed to channel conversation:19
2025-05-22 21:41:24.546 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-22 21:41:24.546 +07:00 [INF] User 2 subscribed to channel conversation:25
2025-05-22 21:41:24.546 +07:00 [INF] User 2 subscribed to channel conversation:26
2025-05-22 21:41:24.546 +07:00 [INF] User 2 subscribed to channel conversation:27
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:28
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:29
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:32
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:33
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:34
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:35
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:36
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:37
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:38
2025-05-22 21:41:24.547 +07:00 [INF] User 2 subscribed to channel conversation:39
2025-05-22 21:41:24.548 +07:00 [INF] User 2 subscribed to channel conversation:41
2025-05-22 21:41:24.548 +07:00 [INF] User 2 subscribed to channel conversation:40
2025-05-22 21:41:24.548 +07:00 [INF] User 2 subscribed to channel conversation:42
2025-05-22 21:41:24.548 +07:00 [INF] User 2 subscribed to channel conversation:44
2025-05-22 21:41:24.548 +07:00 [INF] User 2 subscribed to channel conversation:43
2025-05-22 21:41:24.548 +07:00 [INF] User 2 subscribed to channel conversation:45
2025-05-22 21:42:18.801 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:42:18.803 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:18.805 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 3.7333ms
2025-05-22 21:42:18.808 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 21:42:18.808 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:18.808 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:18.808 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:42:18.809 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:42:18.824 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:42:18.825 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:42:18.830 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 21.7825ms
2025-05-22 21:42:18.831 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:42:18.831 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 22.8888ms
2025-05-22 21:42:18.863 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:42:18.864 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:18.864 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:18.865 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:42:18.888 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:42:18.891 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:42:18.891 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:42:18.891 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:42:18.891 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:42:18.891 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:42:18.891 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:42:18.895 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:42:18.895 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:42:18.895 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:42:18.895 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:42:18.896 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:42:18.897 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:42:18.898 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:42:22.074 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 21:42:22.075 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:22.076 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:22.077 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:42:22.077 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:42:22.087 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:42:22.088 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:42:22.088 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 11.2844ms
2025-05-22 21:42:22.088 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:42:22.088 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 14.0015ms
2025-05-22 21:42:22.293 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:42:22.293 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:22.295 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 2.2924ms
2025-05-22 21:42:22.297 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:42:22.297 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:22.297 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:22.298 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:42:22.298 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:42:22.310 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:42:22.318 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:42:22.319 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 21.2181ms
2025-05-22 21:42:22.320 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:42:22.320 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 23.1603ms
2025-05-22 21:42:24.406 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:42:24.406 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.407 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.9097ms
2025-05-22 21:42:24.408 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:42:24.409 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.409 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.409 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:42:24.410 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:42:24.458 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:42:24.459 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:42:24.460 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:42:24.461 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:42:24.462 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:42:24.463 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:42:24.464 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:42:24.465 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:42:24.466 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:42:24.466 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:42:24.467 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:42:24.467 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:42:24.468 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:42:24.469 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:42:24.469 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:42:24.469 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:42:24.470 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:42:24.472 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:42:24.473 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:42:24.473 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:42:24.474 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:42:24.474 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:42:24.474 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:42:24.475 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:42:24.475 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:42:24.478 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:42:24.479 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:42:24.481 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:42:24.482 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:42:24.483 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:42:24.484 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:42:24.484 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:42:24.484 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:42:24.484 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:42:24.485 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:42:24.485 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:42:24.485 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:42:24.485 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:42:24.485 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:42:24.486 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:42:24.486 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:42:24.488 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:42:24.489 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:42:24.489 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:42:24.489 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:42:24.489 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:42:24.490 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:42:24.490 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:42:24.490 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:42:24.491 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:42:24.491 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:42:24.492 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:42:24.492 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:42:24.493 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:42:24.494 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:42:24.495 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:42:24.496 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:42:24.496 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:42:24.496 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:42:24.496 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:42:24.496 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:42:24.497 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:42:24.497 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:42:24.497 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:42:24.497 +07:00 [INF] Retrieved 16 messages from Redis for conversation 19
2025-05-22 21:42:24.499 +07:00 [INF] Retrieved 16 messages from Redis for conversation 19 and user 3
2025-05-22 21:42:24.499 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:42:24.500 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 89.7876ms
2025-05-22 21:42:24.500 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:42:24.500 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 91.5307ms
2025-05-22 21:42:24.508 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:42:24.508 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.508 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2044ms
2025-05-22 21:42:24.509 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:42:24.510 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.510 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.510 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:42:24.510 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:42:24.529 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:42:24.536 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:42:24.538 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 27.291ms
2025-05-22 21:42:24.538 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:42:24.538 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 28.5761ms
2025-05-22 21:42:24.545 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:42:24.545 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.546 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.4206ms
2025-05-22 21:42:24.548 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:42:24.548 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.549 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:24.549 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:42:24.549 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:42:24.555 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:42:24.556 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:42:24.556 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 7.5836ms
2025-05-22 21:42:24.556 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:42:24.557 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 8.4103ms
2025-05-22 21:42:37.482 +07:00 [INF] Handling message from user 3: ss
2025-05-22 21:42:37.498 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:42:37.536 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:42:37.560 +07:00 [INF] Executed DbCommand (23ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:42:37.565 +07:00 [INF] Message saved to DB with ID: 396
2025-05-22 21:42:37.566 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:42:37.572 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:42:37.573 +07:00 [INF] Transaction committed for message: 396
2025-05-22 21:42:37.577 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:42:37.582 +07:00 [INF] Saved message 396 to Redis
2025-05-22 21:42:37.584 +07:00 [INF] Added message 396 to conversation 19
2025-05-22 21:42:37.586 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:42:37.673 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:42:37.673 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:37.673 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 0.2997ms
2025-05-22 21:42:37.675 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 65
2025-05-22 21:42:37.675 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:37.675 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:42:37.676 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:42:37.676 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:42:37.680 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: ss
2025-05-22 21:42:37.690 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:42:38.973 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:42:38.974 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:42:38.974 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 1297.4113ms
2025-05-22 21:42:38.974 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:42:38.974 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 1298.8889ms
2025-05-22 21:43:18.981 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/2 - null null
2025-05-22 21:43:18.982 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:43:18.982 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:43:19.233 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:43:19.234 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:43:19.244 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:43:19.252 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:43:19.253 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:43:19.255 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:43:19.285 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:43:19.288 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:43:19.292 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:43:19.305 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:43:19.321 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:43:19.322 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:43:19.330 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:43:19.332 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:43:19.333 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:43:19.334 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:43:19.365 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:43:19.373 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:43:19.375 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:43:19.379 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:43:19.398 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:43:19.398 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:43:19.400 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:43:19.401 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:43:19.402 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:43:19.403 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:43:19.403 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:43:19.405 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:43:19.405 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:43:19.406 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:43:19.406 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:43:19.408 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:43:19.410 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:43:19.411 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:43:19.412 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:43:19.424 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:43:19.427 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:43:19.441 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:43:19.449 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:43:19.451 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:43:19.454 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:43:19.455 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:43:19.459 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:43:19.518 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:43:19.522 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:43:19.525 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:43:19.529 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:43:19.530 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:43:19.531 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:43:19.534 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:43:19.571 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:43:19.579 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:43:19.584 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:43:19.585 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:43:19.586 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:43:19.587 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:43:19.588 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:43:19.589 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:43:19.589 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:43:19.590 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:43:19.606 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:43:19.607 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:43:19.608 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:43:19.609 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:43:19.609 +07:00 [INF] Retrieved 17 messages from Redis for conversation 19
2025-05-22 21:43:19.609 +07:00 [INF] Retrieved 17 messages from Redis for conversation 19 and user 2
2025-05-22 21:43:19.609 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:43:19.610 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 627.4867ms
2025-05-22 21:43:19.610 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:43:19.611 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 629.467ms
2025-05-22 21:43:19.730 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:43:19.731 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:43:19.731 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:43:19.758 +07:00 [INF] Executed DbCommand (22ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:43:19.759 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:43:19.759 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 28.0754ms
2025-05-22 21:43:19.759 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:43:19.760 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 29.1839ms
2025-05-22 21:43:19.797 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:43:19.797 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:43:19.797 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:43:19.802 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:43:19.803 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:43:19.803 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 5.5009ms
2025-05-22 21:43:19.803 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:43:19.803 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 6.2458ms
2025-05-22 21:43:23.885 +07:00 [INF] Handling message from user 2: xxxhh
2025-05-22 21:43:23.891 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:43:23.894 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:43:23.905 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:43:23.906 +07:00 [INF] Message saved to DB with ID: 397
2025-05-22 21:43:23.906 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:43:23.911 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:43:23.913 +07:00 [INF] Transaction committed for message: 397
2025-05-22 21:43:23.918 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:43:23.921 +07:00 [INF] Saved message 397 to Redis
2025-05-22 21:43:23.921 +07:00 [INF] Added message 397 to conversation 19
2025-05-22 21:43:23.922 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:43:24.282 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 68
2025-05-22 21:43:24.282 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:43:24.282 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:43:24.285 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: xxxhh
2025-05-22 21:43:24.288 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:43:24.289 +07:00 [ERR] FCM token not found for userId: 3
2025-05-22 21:43:24.289 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:43:24.290 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 7.9217ms
2025-05-22 21:43:24.290 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:43:24.290 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 8.4025ms
2025-05-22 21:53:34.664 +07:00 [INF] Application is shutting down...
2025-05-22 21:53:54.489 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:53:54.490 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:53:54.498 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:53:54.498 +07:00 [ERR] Connection id "0HNCP7KCP1SJ4", Request id "0HNCP7KCP1SJ4:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:53:54.501 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - 101 null null 750032.6508ms
2025-05-22 21:54:01.614 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 21:54:01.614 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 21:54:01.615 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 21:54:01.615 +07:00 [ERR] Connection id "0HNCP7KCP1SJ6", Request id "0HNCP7KCP1SJ6:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client)
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context)
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext()
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 21:54:01.616 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 702753.346ms
2025-05-22 21:54:22.208 +07:00 [INF] Executed DbCommand (65ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[id], [u].[username], [u].[avatar_url]
FROM [Users] AS [u]
2025-05-22 21:54:22.685 +07:00 [INF] User profile is available. Using 'C:\Users\Thao\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-22 21:54:22.871 +07:00 [WRN] Overriding address(es) 'http://localhost:5053'. Binding to endpoints defined via IConfiguration and/or UseKestrel() instead.
2025-05-22 21:54:22.898 +07:00 [INF] Now listening on: http://[::]:5053
2025-05-22 21:54:22.900 +07:00 [INF] Now listening on: http://0.0.0.0:5053
2025-05-22 21:54:22.901 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-05-22 21:54:22.901 +07:00 [INF] Hosting environment: Development
2025-05-22 21:54:22.901 +07:00 [INF] Content root path: C:\Users\Thao\source\Flutter\Message_app\server
2025-05-22 21:55:42.447 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 21:55:42.508 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:42.519 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 76.1118ms
2025-05-22 21:55:42.523 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 21:55:42.524 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:42.560 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:42.561 +07:00 [WRN] Failed to determine the https port for redirect.
2025-05-22 21:55:42.594 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:55:42.621 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:55:42.908 +07:00 [INF] Executed DbCommand (89ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:55:43.014 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:55:43.055 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 431.5421ms
2025-05-22 21:55:43.055 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:55:43.059 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 536.2016ms
2025-05-22 21:55:43.079 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 21:55:43.085 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:43.086 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:43.087 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:55:43.246 +07:00 [INF] Executed DbCommand (25ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:55:43.266 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 21:55:43.267 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 21:55:43.268 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 21:55:43.269 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 21:55:43.270 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 21:55:43.270 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 21:55:43.271 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 21:55:43.272 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 21:55:43.272 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 21:55:43.273 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 21:55:43.273 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 21:55:43.274 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 21:55:43.275 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 21:55:43.275 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 21:55:43.275 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 21:55:43.276 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 21:55:43.276 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 21:55:43.277 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 21:55:43.277 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 21:55:43.278 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 21:55:43.279 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 21:55:46.769 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 21:55:46.771 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:46.773 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:46.775 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:55:46.784 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:55:46.860 +07:00 [INF] Executed DbCommand (23ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:55:46.862 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:55:46.872 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 87.6002ms
2025-05-22 21:55:46.872 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:55:46.873 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 103.4747ms
2025-05-22 21:55:46.993 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:55:46.993 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:46.994 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.9911ms
2025-05-22 21:55:46.996 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 21:55:46.996 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:46.996 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:55:46.997 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:55:47.002 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:55:47.115 +07:00 [INF] Executed DbCommand (33ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:55:47.135 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:55:47.159 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 156.7669ms
2025-05-22 21:55:47.159 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:55:47.160 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 163.9275ms
2025-05-22 21:56:23.215 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - application/json 58
2025-05-22 21:56:23.219 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:56:23.220 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 21:56:23.258 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 21:56:23.261 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 21:56:23.261 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 41.705ms
2025-05-22 21:56:23.262 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 21:56:23.262 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Auth/login - 200 null application/json; charset=utf-8 46.7613ms
2025-05-22 21:56:24.129 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - null null
2025-05-22 21:56:24.130 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 21:56:24.241 +07:00 [INF] Executed DbCommand (21ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:56:24.243 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - application/json 168
2025-05-22 21:56:24.244 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:56:24.245 +07:00 [INF] User 2 subscribed to channel conversation:3
2025-05-22 21:56:24.247 +07:00 [INF] User 2 subscribed to channel conversation:4
2025-05-22 21:56:24.258 +07:00 [INF] User 2 subscribed to channel conversation:19
2025-05-22 21:56:24.260 +07:00 [INF] User 2 subscribed to channel conversation:1
2025-05-22 21:56:24.265 +07:00 [INF] User 2 subscribed to channel conversation:25
2025-05-22 21:56:24.266 +07:00 [INF] User 2 subscribed to channel conversation:26
2025-05-22 21:56:24.266 +07:00 [INF] User 2 subscribed to channel conversation:27
2025-05-22 21:56:24.267 +07:00 [INF] User 2 subscribed to channel conversation:28
2025-05-22 21:56:24.267 +07:00 [INF] User 2 subscribed to channel conversation:29
2025-05-22 21:56:24.267 +07:00 [INF] User 2 subscribed to channel conversation:32
2025-05-22 21:56:24.268 +07:00 [INF] User 2 subscribed to channel conversation:33
2025-05-22 21:56:24.269 +07:00 [INF] User 2 subscribed to channel conversation:34
2025-05-22 21:56:24.269 +07:00 [INF] User 2 subscribed to channel conversation:35
2025-05-22 21:56:24.269 +07:00 [INF] User 2 subscribed to channel conversation:36
2025-05-22 21:56:24.269 +07:00 [INF] User 2 subscribed to channel conversation:37
2025-05-22 21:56:24.269 +07:00 [INF] User 2 subscribed to channel conversation:38
2025-05-22 21:56:24.269 +07:00 [INF] User 2 subscribed to channel conversation:39
2025-05-22 21:56:24.279 +07:00 [INF] Route matched with {action = "UpdateFcmToken", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateFcmToken(FcmBackend.Controllers.UpdateFcmTokenRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:56:24.280 +07:00 [INF] User 2 subscribed to channel conversation:41
2025-05-22 21:56:24.280 +07:00 [INF] User 2 subscribed to channel conversation:40
2025-05-22 21:56:24.280 +07:00 [INF] User 2 subscribed to channel conversation:42
2025-05-22 21:56:24.280 +07:00 [INF] User 2 subscribed to channel conversation:44
2025-05-22 21:56:24.280 +07:00 [INF] User 2 subscribed to channel conversation:43
2025-05-22 21:56:24.280 +07:00 [INF] User 2 subscribed to channel conversation:45
2025-05-22 21:56:24.339 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__p_0
2025-05-22 21:56:24.550 +07:00 [INF] Executed DbCommand (44ms) [Parameters=[@p1='?' (DbType = Int32), @p0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Users] SET [fcmToken] = @p0
OUTPUT 1
WHERE [id] = @p1;
2025-05-22 21:56:24.567 +07:00 [INF] FCM token updated for userId: 2
2025-05-22 21:56:24.567 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.String'.
2025-05-22 21:56:24.569 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app) in 290.4135ms
2025-05-22 21:56:24.569 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.UpdateFcmToken (Message_app)'
2025-05-22 21:56:24.569 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/token - 200 null text/plain; charset=utf-8 326.1046ms
2025-05-22 21:56:25.057 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - null null
2025-05-22 21:56:25.060 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:56:25.060 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:25.080 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:25.094 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:25.094 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 34.3505ms
2025-05-22 21:56:25.094 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 21:56:25.095 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/friends/GetAllFriends/2 - 200 null application/json; charset=utf-8 38.0836ms
2025-05-22 21:56:25.249 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - null null
2025-05-22 21:56:25.252 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:56:25.252 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:56:25.279 +07:00 [INF] Executed DbCommand (19ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 21:56:25.302 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:56:25.305 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 52.9764ms
2025-05-22 21:56:25.305 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 21:56:25.306 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_conversations/2 - 200 null application/json; charset=utf-8 56.7929ms
2025-05-22 21:56:35.149 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/requests/received/3 - null null
2025-05-22 21:56:35.150 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.151 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.151 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app)'
2025-05-22 21:56:35.158 +07:00 [INF] Route matched with {action = "GetReceivedFriendRequests", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetReceivedFriendRequests(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.228 +07:00 [INF] Executed DbCommand (30ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[Id], [f].[SenderId], [f].[ReceiverId], [u].[username] AS [Username], [u].[avatar_url] AS [AvatarUrl], [f].[Status], [f].[CreatedAt], 0 AS [MutualFriendsCount]
FROM [FriendRequests] AS [f]
INNER JOIN [Users] AS [u] ON [f].[SenderId] = [u].[id]
WHERE [f].[ReceiverId] = @__userId_0 AND [f].[Status] = N'Pending'
2025-05-22 21:56:35.231 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendRequestDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.235 +07:00 [INF] Executed action server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app) in 77.4439ms
2025-05-22 21:56:35.236 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app)'
2025-05-22 21:56:35.236 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/requests/received/3 - 200 null application/json; charset=utf-8 86.2728ms
2025-05-22 21:56:35.237 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/requests/received/3 - null null
2025-05-22 21:56:35.237 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.237 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.237 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app)'
2025-05-22 21:56:35.237 +07:00 [INF] Route matched with {action = "GetReceivedFriendRequests", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetReceivedFriendRequests(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.242 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[Id], [f].[SenderId], [f].[ReceiverId], [u].[username] AS [Username], [u].[avatar_url] AS [AvatarUrl], [f].[Status], [f].[CreatedAt], 0 AS [MutualFriendsCount]
FROM [FriendRequests] AS [f]
INNER JOIN [Users] AS [u] ON [f].[SenderId] = [u].[id]
WHERE [f].[ReceiverId] = @__userId_0 AND [f].[Status] = N'Pending'
2025-05-22 21:56:35.242 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendRequestDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.242 +07:00 [INF] Executed action server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app) in 4.8756ms
2025-05-22 21:56:35.242 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app)'
2025-05-22 21:56:35.243 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/requests/received/3 - 200 null application/json; charset=utf-8 5.6994ms
2025-05-22 21:56:35.244 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/requests/received/3 - null null
2025-05-22 21:56:35.245 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.245 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.245 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app)'
2025-05-22 21:56:35.246 +07:00 [INF] Route matched with {action = "GetReceivedFriendRequests", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetReceivedFriendRequests(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.250 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[Id], [f].[SenderId], [f].[ReceiverId], [u].[username] AS [Username], [u].[avatar_url] AS [AvatarUrl], [f].[Status], [f].[CreatedAt], 0 AS [MutualFriendsCount]
FROM [FriendRequests] AS [f]
INNER JOIN [Users] AS [u] ON [f].[SenderId] = [u].[id]
WHERE [f].[ReceiverId] = @__userId_0 AND [f].[Status] = N'Pending'
2025-05-22 21:56:35.252 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendRequestDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.253 +07:00 [INF] Executed action server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app) in 6.6901ms
2025-05-22 21:56:35.253 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetReceivedFriendRequests (Message_app)'
2025-05-22 21:56:35.253 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/requests/received/3 - 200 null application/json; charset=utf-8 9.0398ms
2025-05-22 21:56:35.278 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/get-sent-requests/3 - null null
2025-05-22 21:56:35.278 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.278 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.279 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetSentFriendRequests (Message_app)'
2025-05-22 21:56:35.292 +07:00 [INF] Route matched with {action = "GetSentFriendRequests", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetSentFriendRequests(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.323 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[Id], [f].[SenderId], [f].[ReceiverId], [u].[username] AS [Username], [u].[avatar_url] AS [AvatarUrl], [f].[Status], [f].[CreatedAt], 0 AS [MutualFriendsCount]
FROM [FriendRequests] AS [f]
INNER JOIN [Users] AS [u] ON [f].[ReceiverId] = [u].[id]
WHERE [f].[SenderId] = @__userId_0 AND [f].[Status] = N'Pending'
2025-05-22 21:56:35.324 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType13`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendRequestDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.326 +07:00 [INF] Executed action server.Controllers.FriendsController.GetSentFriendRequests (Message_app) in 33.1528ms
2025-05-22 21:56:35.326 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetSentFriendRequests (Message_app)'
2025-05-22 21:56:35.326 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/get-sent-requests/3 - 200 null application/json; charset=utf-8 48.1409ms
2025-05-22 21:56:35.327 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/get-sent-requests/3 - null null
2025-05-22 21:56:35.327 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.328 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.328 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetSentFriendRequests (Message_app)'
2025-05-22 21:56:35.328 +07:00 [INF] Route matched with {action = "GetSentFriendRequests", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetSentFriendRequests(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.330 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[Id], [f].[SenderId], [f].[ReceiverId], [u].[username] AS [Username], [u].[avatar_url] AS [AvatarUrl], [f].[Status], [f].[CreatedAt], 0 AS [MutualFriendsCount]
FROM [FriendRequests] AS [f]
INNER JOIN [Users] AS [u] ON [f].[ReceiverId] = [u].[id]
WHERE [f].[SenderId] = @__userId_0 AND [f].[Status] = N'Pending'
2025-05-22 21:56:35.330 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType13`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendRequestDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.331 +07:00 [INF] Executed action server.Controllers.FriendsController.GetSentFriendRequests (Message_app) in 2.7002ms
2025-05-22 21:56:35.331 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetSentFriendRequests (Message_app)'
2025-05-22 21:56:35.331 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/get-sent-requests/3 - 200 null application/json; charset=utf-8 3.722ms
2025-05-22 21:56:35.333 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/suggestions/3 - null null
2025-05-22 21:56:35.333 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.334 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.334 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetFriendSuggestions (Message_app)'
2025-05-22 21:56:35.334 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/get-sent-requests/3 - null null
2025-05-22 21:56:35.334 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.334 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.334 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetSentFriendRequests (Message_app)'
2025-05-22 21:56:35.335 +07:00 [INF] Route matched with {action = "GetSentFriendRequests", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetSentFriendRequests(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.337 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[Id], [f].[SenderId], [f].[ReceiverId], [u].[username] AS [Username], [u].[avatar_url] AS [AvatarUrl], [f].[Status], [f].[CreatedAt], 0 AS [MutualFriendsCount]
FROM [FriendRequests] AS [f]
INNER JOIN [Users] AS [u] ON [f].[ReceiverId] = [u].[id]
WHERE [f].[SenderId] = @__userId_0 AND [f].[Status] = N'Pending'
2025-05-22 21:56:35.338 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType13`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendRequestDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.338 +07:00 [INF] Executed action server.Controllers.FriendsController.GetSentFriendRequests (Message_app) in 3.3347ms
2025-05-22 21:56:35.338 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetSentFriendRequests (Message_app)'
2025-05-22 21:56:35.339 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/get-sent-requests/3 - 200 null application/json; charset=utf-8 4.8976ms
2025-05-22 21:56:35.340 +07:00 [INF] Route matched with {action = "GetFriendSuggestions", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFriendSuggestions(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.359 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__userId_0
2025-05-22 21:56:35.369 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.385 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.390 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.393 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.405 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[ReceiverId]
FROM [FriendRequests] AS [f]
WHERE [f].[SenderId] = @__userId_0
2025-05-22 21:56:35.412 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[SenderId]
FROM [FriendRequests] AS [f]
WHERE [f].[ReceiverId] = @__userId_0
2025-05-22 21:56:35.433 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__fof_Key_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__fof_Key_0
2025-05-22 21:56:35.448 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType12`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendSuggestionDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.461 +07:00 [INF] Executed action server.Controllers.FriendsController.GetFriendSuggestions (Message_app) in 120.6157ms
2025-05-22 21:56:35.461 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetFriendSuggestions (Message_app)'
2025-05-22 21:56:35.461 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/suggestions/3 - null null
2025-05-22 21:56:35.461 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/suggestions/3 - 200 null application/json; charset=utf-8 128.0774ms
2025-05-22 21:56:35.461 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.462 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.462 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetFriendSuggestions (Message_app)'
2025-05-22 21:56:35.462 +07:00 [INF] Route matched with {action = "GetFriendSuggestions", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFriendSuggestions(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.466 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/list/3 - null null
2025-05-22 21:56:35.466 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.468 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.468 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetFriendsAsync (Message_app)'
2025-05-22 21:56:35.473 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__userId_0
2025-05-22 21:56:35.476 +07:00 [INF] Route matched with {action = "GetFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFriendsAsync(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.479 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.487 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.494 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.495 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.502 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[ReceiverId]
FROM [FriendRequests] AS [f]
WHERE [f].[SenderId] = @__userId_0
2025-05-22 21:56:35.507 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[SenderId]
FROM [FriendRequests] AS [f]
WHERE [f].[ReceiverId] = @__userId_0
2025-05-22 21:56:35.519 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END, [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username], [u0].[id], [u0].[avatar_url], [u0].[bio], [u0].[birthday], [u0].[created_at], [u0].[email], [u0].[fcmToken], [u0].[gender], [u0].[interests], [u0].[location], [u0].[password], [u0].[passwordSalt], [u0].[username]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.528 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.539 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.544 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.546 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.546 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.Models.User, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.552 +07:00 [INF] Executed action server.Controllers.FriendsController.GetFriendsAsync (Message_app) in 75.1263ms
2025-05-22 21:56:35.552 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetFriendsAsync (Message_app)'
2025-05-22 21:56:35.552 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/list/3 - 200 null application/json; charset=utf-8 86.2657ms
2025-05-22 21:56:35.567 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__fof_Key_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__fof_Key_0
2025-05-22 21:56:35.572 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType12`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendSuggestionDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.573 +07:00 [INF] Executed action server.Controllers.FriendsController.GetFriendSuggestions (Message_app) in 110.566ms
2025-05-22 21:56:35.573 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetFriendSuggestions (Message_app)'
2025-05-22 21:56:35.573 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/suggestions/3 - 200 null application/json; charset=utf-8 111.8207ms
2025-05-22 21:56:35.575 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/suggestions/3 - null null
2025-05-22 21:56:35.576 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.576 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.576 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetFriendSuggestions (Message_app)'
2025-05-22 21:56:35.576 +07:00 [INF] Route matched with {action = "GetFriendSuggestions", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFriendSuggestions(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.587 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/list/3 - null null
2025-05-22 21:56:35.588 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.588 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.588 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__userId_0
2025-05-22 21:56:35.588 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetFriendsAsync (Message_app)'
2025-05-22 21:56:35.589 +07:00 [INF] Route matched with {action = "GetFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFriendsAsync(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.595 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.601 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.601 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END, [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username], [u0].[id], [u0].[avatar_url], [u0].[bio], [u0].[birthday], [u0].[created_at], [u0].[email], [u0].[fcmToken], [u0].[gender], [u0].[interests], [u0].[location], [u0].[password], [u0].[passwordSalt], [u0].[username]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.605 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.606 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.608 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friendId_0='?' (DbType = Int32), @__8__locals1_userId_1='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friendId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE ([f].[UserId1] = @__friendId_0 OR [f].[UserId2] = @__friendId_0) AND [f].[UserId1] <> @__8__locals1_userId_1 AND [f].[UserId2] <> @__8__locals1_userId_1
2025-05-22 21:56:35.609 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.612 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.617 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.617 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[ReceiverId]
FROM [FriendRequests] AS [f]
WHERE [f].[SenderId] = @__userId_0
2025-05-22 21:56:35.619 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.Models.User, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.621 +07:00 [INF] Executed action server.Controllers.FriendsController.GetFriendsAsync (Message_app) in 32.104ms
2025-05-22 21:56:35.621 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetFriendsAsync (Message_app)'
2025-05-22 21:56:35.622 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/list/3 - 200 null application/json; charset=utf-8 34.1922ms
2025-05-22 21:56:35.623 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [f].[SenderId]
FROM [FriendRequests] AS [f]
WHERE [f].[ReceiverId] = @__userId_0
2025-05-22 21:56:35.627 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__fof_Key_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[id] = @__fof_Key_0
2025-05-22 21:56:35.630 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType12`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[FriendSuggestionDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.631 +07:00 [INF] Executed action server.Controllers.FriendsController.GetFriendSuggestions (Message_app) in 54.7855ms
2025-05-22 21:56:35.631 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetFriendSuggestions (Message_app)'
2025-05-22 21:56:35.632 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/suggestions/3 - 200 null application/json; charset=utf-8 56.6989ms
2025-05-22 21:56:35.641 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/list/3 - null null
2025-05-22 21:56:35.641 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.642 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:35.642 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetFriendsAsync (Message_app)'
2025-05-22 21:56:35.642 +07:00 [INF] Route matched with {action = "GetFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFriendsAsync(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 21:56:35.655 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END, [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username], [u0].[id], [u0].[avatar_url], [u0].[bio], [u0].[birthday], [u0].[created_at], [u0].[email], [u0].[fcmToken], [u0].[gender], [u0].[interests], [u0].[location], [u0].[password], [u0].[passwordSalt], [u0].[username]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.661 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 21:56:35.666 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.673 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.675 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__friend_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__friend_id_0 THEN [f].[UserId2]
    ELSE [f].[UserId1]
END
FROM [Friends] AS [f]
WHERE [f].[UserId1] = @__friend_id_0 OR [f].[UserId2] = @__friend_id_0
2025-05-22 21:56:35.675 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.Models.User, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:35.676 +07:00 [INF] Executed action server.Controllers.FriendsController.GetFriendsAsync (Message_app) in 33.056ms
2025-05-22 21:56:35.676 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetFriendsAsync (Message_app)'
2025-05-22 21:56:35.676 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/list/3 - 200 null application/json; charset=utf-8 34.8952ms
2025-05-22 21:56:40.402 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:56:40.403 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.403 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Message/getMessages/19/3 - 204 null null 0.5541ms
2025-05-22 21:56:40.404 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - null null
2025-05-22 21:56:40.404 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.405 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.405 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:56:40.410 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:56:40.511 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:56:40.512 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:56:40.513 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:56:40.514 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:56:40.514 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:56:40.514 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:56:40.515 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:56:40.515 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:56:40.515 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:56:40.516 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:56:40.516 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:56:40.516 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:56:40.517 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:56:40.519 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:56:40.520 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:56:40.521 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:56:40.522 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:56:40.524 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:56:40.524 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:56:40.525 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:56:40.526 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:56:40.527 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:56:40.528 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:56:40.528 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:56:40.529 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:56:40.529 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:56:40.530 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:56:40.531 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:56:40.532 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:56:40.532 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:56:40.532 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:56:40.533 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:56:40.533 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:56:40.534 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:56:40.534 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:56:40.535 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:56:40.535 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:56:40.535 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:56:40.536 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:56:40.537 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:56:40.537 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:56:40.538 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:56:40.538 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:56:40.538 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:56:40.539 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:56:40.539 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:56:40.540 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:56:40.540 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:56:40.541 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:56:40.542 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:56:40.542 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:56:40.543 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:56:40.543 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:56:40.544 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:56:40.544 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:56:40.545 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:56:40.545 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:56:40.546 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:56:40.547 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:56:40.548 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:56:40.548 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:56:40.549 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:56:40.550 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:56:40.551 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:56:40.551 +07:00 [INF] Retrieved 18 messages from Redis for conversation 19
2025-05-22 21:56:40.554 +07:00 [INF] Retrieved 18 messages from Redis for conversation 19 and user 3
2025-05-22 21:56:40.554 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:56:40.560 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 149.312ms
2025-05-22 21:56:40.560 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:56:40.560 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Message/getMessages/19/3 - 200 null application/json; charset=utf-8 155.7681ms
2025-05-22 21:56:40.572 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:56:40.572 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.572 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_first_conversation/19 - 204 null null 0.2416ms
2025-05-22 21:56:40.573 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:56:40.575 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.575 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.575 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:56:40.587 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:56:40.669 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:56:40.750 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:56:40.756 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 166.7426ms
2025-05-22 21:56:40.756 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:56:40.756 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 182.65ms
2025-05-22 21:56:40.767 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:56:40.767 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.767 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Participant/get_participants/19 - 204 null null 0.5066ms
2025-05-22 21:56:40.771 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:56:40.771 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.772 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:40.773 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:56:40.781 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:56:40.817 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:56:40.820 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:40.824 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 43.2791ms
2025-05-22 21:56:40.824 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:56:40.825 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 53.8625ms
2025-05-22 21:56:43.772 +07:00 [INF] Handling message from user 3: sss
2025-05-22 21:56:43.792 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:56:43.863 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - null null
2025-05-22 21:56:43.863 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:43.863 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Notification/send - 204 null null 0.3832ms
2025-05-22 21:56:43.866 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Notification/send - application/json 66
2025-05-22 21:56:43.866 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:43.867 +07:00 [INF] CORS policy execution successful.
2025-05-22 21:56:43.868 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:56:43.881 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:56:43.904 +07:00 [INF] Sending notification to userId: 2, title: Tin nhắn mới trong nhóm, body: sss
2025-05-22 21:56:43.934 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:56:43.977 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:56:44.010 +07:00 [INF] Executed DbCommand (30ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:56:44.031 +07:00 [INF] Message saved to DB with ID: 398
2025-05-22 21:56:44.033 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:56:44.039 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:56:44.053 +07:00 [INF] Transaction committed for message: 398
2025-05-22 21:56:44.061 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:56:44.073 +07:00 [INF] Saved message 398 to Redis
2025-05-22 21:56:44.077 +07:00 [INF] Added message 398 to conversation 19
2025-05-22 21:56:44.090 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:56:45.790 +07:00 [ERR] Error sending notification to userId: 2 : SenderId mismatch
2025-05-22 21:56:45.790 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:56:45.791 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 1909.9885ms
2025-05-22 21:56:45.791 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:56:45.791 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Notification/send - 500 null text/plain; charset=utf-8 1925.7702ms
2025-05-22 21:56:51.082 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/2 - null null
2025-05-22 21:56:51.089 +07:00 [INF] Executing endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:56:51.090 +07:00 [INF] Route matched with {action = "GetMessages", controller = "Message"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetMessages(Int32, Int32) on controller server.Controllers.MessageController (Message_app).
2025-05-22 21:56:51.141 +07:00 [WRN] Message 271 not found in Redis
2025-05-22 21:56:51.143 +07:00 [WRN] Message 266 not found in Redis
2025-05-22 21:56:51.144 +07:00 [WRN] Message 263 not found in Redis
2025-05-22 21:56:51.145 +07:00 [WRN] Message 262 not found in Redis
2025-05-22 21:56:51.146 +07:00 [WRN] Message 261 not found in Redis
2025-05-22 21:56:51.146 +07:00 [WRN] Message 260 not found in Redis
2025-05-22 21:56:51.147 +07:00 [WRN] Message 257 not found in Redis
2025-05-22 21:56:51.148 +07:00 [WRN] Message 253 not found in Redis
2025-05-22 21:56:51.150 +07:00 [WRN] Message 252 not found in Redis
2025-05-22 21:56:51.151 +07:00 [WRN] Message 251 not found in Redis
2025-05-22 21:56:51.152 +07:00 [WRN] Message 250 not found in Redis
2025-05-22 21:56:51.153 +07:00 [WRN] Message 249 not found in Redis
2025-05-22 21:56:51.154 +07:00 [WRN] Message 248 not found in Redis
2025-05-22 21:56:51.155 +07:00 [WRN] Message 247 not found in Redis
2025-05-22 21:56:51.155 +07:00 [WRN] Message 246 not found in Redis
2025-05-22 21:56:51.155 +07:00 [WRN] Message 245 not found in Redis
2025-05-22 21:56:51.156 +07:00 [WRN] Message 244 not found in Redis
2025-05-22 21:56:51.156 +07:00 [WRN] Message 243 not found in Redis
2025-05-22 21:56:51.157 +07:00 [WRN] Message 242 not found in Redis
2025-05-22 21:56:51.157 +07:00 [WRN] Message 241 not found in Redis
2025-05-22 21:56:51.158 +07:00 [WRN] Message 240 not found in Redis
2025-05-22 21:56:51.158 +07:00 [WRN] Message 239 not found in Redis
2025-05-22 21:56:51.160 +07:00 [WRN] Message 238 not found in Redis
2025-05-22 21:56:51.160 +07:00 [WRN] Message 237 not found in Redis
2025-05-22 21:56:51.161 +07:00 [WRN] Message 231 not found in Redis
2025-05-22 21:56:51.161 +07:00 [WRN] Message 230 not found in Redis
2025-05-22 21:56:51.162 +07:00 [WRN] Message 229 not found in Redis
2025-05-22 21:56:51.163 +07:00 [WRN] Message 228 not found in Redis
2025-05-22 21:56:51.164 +07:00 [WRN] Message 227 not found in Redis
2025-05-22 21:56:51.165 +07:00 [WRN] Message 226 not found in Redis
2025-05-22 21:56:51.167 +07:00 [WRN] Message 225 not found in Redis
2025-05-22 21:56:51.168 +07:00 [WRN] Message 224 not found in Redis
2025-05-22 21:56:51.169 +07:00 [WRN] Message 223 not found in Redis
2025-05-22 21:56:51.171 +07:00 [WRN] Message 222 not found in Redis
2025-05-22 21:56:51.172 +07:00 [WRN] Message 221 not found in Redis
2025-05-22 21:56:51.173 +07:00 [WRN] Message 220 not found in Redis
2025-05-22 21:56:51.174 +07:00 [WRN] Message 219 not found in Redis
2025-05-22 21:56:51.177 +07:00 [WRN] Message 218 not found in Redis
2025-05-22 21:56:51.178 +07:00 [WRN] Message 217 not found in Redis
2025-05-22 21:56:51.179 +07:00 [WRN] Message 216 not found in Redis
2025-05-22 21:56:51.179 +07:00 [WRN] Message 215 not found in Redis
2025-05-22 21:56:51.180 +07:00 [WRN] Message 214 not found in Redis
2025-05-22 21:56:51.185 +07:00 [WRN] Message 213 not found in Redis
2025-05-22 21:56:51.187 +07:00 [WRN] Message 212 not found in Redis
2025-05-22 21:56:51.188 +07:00 [WRN] Message 211 not found in Redis
2025-05-22 21:56:51.189 +07:00 [WRN] Message 210 not found in Redis
2025-05-22 21:56:51.190 +07:00 [WRN] Message 209 not found in Redis
2025-05-22 21:56:51.190 +07:00 [WRN] Message 208 not found in Redis
2025-05-22 21:56:51.191 +07:00 [WRN] Message 207 not found in Redis
2025-05-22 21:56:51.192 +07:00 [WRN] Message 206 not found in Redis
2025-05-22 21:56:51.193 +07:00 [WRN] Message 205 not found in Redis
2025-05-22 21:56:51.193 +07:00 [WRN] Message 204 not found in Redis
2025-05-22 21:56:51.194 +07:00 [WRN] Message 203 not found in Redis
2025-05-22 21:56:51.195 +07:00 [WRN] Message 202 not found in Redis
2025-05-22 21:56:51.195 +07:00 [WRN] Message 201 not found in Redis
2025-05-22 21:56:51.195 +07:00 [WRN] Message 196 not found in Redis
2025-05-22 21:56:51.196 +07:00 [WRN] Message 194 not found in Redis
2025-05-22 21:56:51.196 +07:00 [WRN] Message 193 not found in Redis
2025-05-22 21:56:51.197 +07:00 [WRN] Message 192 not found in Redis
2025-05-22 21:56:51.197 +07:00 [WRN] Message 190 not found in Redis
2025-05-22 21:56:51.198 +07:00 [WRN] Message 189 not found in Redis
2025-05-22 21:56:51.202 +07:00 [WRN] Message 183 not found in Redis
2025-05-22 21:56:51.204 +07:00 [WRN] Message 182 not found in Redis
2025-05-22 21:56:51.205 +07:00 [WRN] Message 181 not found in Redis
2025-05-22 21:56:51.205 +07:00 [INF] Retrieved 19 messages from Redis for conversation 19
2025-05-22 21:56:51.205 +07:00 [INF] Retrieved 19 messages from Redis for conversation 19 and user 2
2025-05-22 21:56:51.205 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.MessageWithAttachment, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 21:56:51.205 +07:00 [INF] Executed action server.Controllers.MessageController.GetMessages (Message_app) in 115.3568ms
2025-05-22 21:56:51.205 +07:00 [INF] Executed endpoint 'server.Controllers.MessageController.GetMessages (Message_app)'
2025-05-22 21:56:51.206 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Message/getMessages/19/2 - 200 null application/json; charset=utf-8 123.9639ms
2025-05-22 21:56:51.268 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - null null
2025-05-22 21:56:51.269 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:56:51.269 +07:00 [INF] Route matched with {action = "GetFirstConversation", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetFirstConversation(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 21:56:51.279 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[id], [t].[created_at], [t].[img_url], [t].[is_group], [t].[lastMessage], [t].[lastMessageSender], [t].[lastMessageTime], [t].[name], [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM (
    SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
    FROM [Conversations] AS [c]
    WHERE [c].[id] = @__conversation_id_0
) AS [t]
LEFT JOIN [Participants] AS [p] ON [t].[id] = [p].[conversation_id]
ORDER BY [t].[id]
2025-05-22 21:56:51.280 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.Models.Conversation'.
2025-05-22 21:56:51.280 +07:00 [INF] Executed action server.Controllers.ConversationController.GetFirstConversation (Message_app) in 11.3355ms
2025-05-22 21:56:51.280 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetFirstConversation (Message_app)'
2025-05-22 21:56:51.281 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Conversation/get_first_conversation/19 - 200 null application/json; charset=utf-8 12.2178ms
2025-05-22 21:56:51.353 +07:00 [INF] Request starting HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - null null
2025-05-22 21:56:51.355 +07:00 [INF] Executing endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:56:51.355 +07:00 [INF] Route matched with {action = "GetParticipants", controller = "Participant"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetParticipants(Int32) on controller server.Controllers.ParticipantController (Message_app).
2025-05-22 21:56:51.366 +07:00 [INF] Executed DbCommand (5ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[id], [p].[adder], [p].[conversation_id], [p].[img_url], [p].[is_deleted], [p].[joined_at], [p].[name], [p].[role], [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0
2025-05-22 21:56:51.367 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType20`1[[System.Collections.Generic.List`1[[server.Models.Participants, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 21:56:51.370 +07:00 [INF] Executed action server.Controllers.ParticipantController.GetParticipants (Message_app) in 14.9195ms
2025-05-22 21:56:51.371 +07:00 [INF] Executed endpoint 'server.Controllers.ParticipantController.GetParticipants (Message_app)'
2025-05-22 21:56:51.371 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/api/Participant/get_participants/19 - 200 null application/json; charset=utf-8 18.2621ms
2025-05-22 21:56:53.848 +07:00 [INF] Handling message from user 2: đf
2025-05-22 21:56:53.851 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[id], [c].[created_at], [c].[img_url], [c].[is_group], [c].[lastMessage], [c].[lastMessageSender], [c].[lastMessageTime], [c].[name]
FROM [Conversations] AS [c]
WHERE [c].[id] = @__p_0
2025-05-22 21:56:53.855 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:56:53.856 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@p0='?' (Size = 500), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (DbType = Boolean), @p4='?' (DbType = Boolean), @p5='?' (DbType = Boolean), @p6='?' (DbType = Int32), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Messages] ([content], [conversation_id], [created_at], [isFile], [isRecalled], [is_read], [sender_id], [type])
OUTPUT INSERTED.[id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-05-22 21:56:53.856 +07:00 [INF] Message saved to DB with ID: 399
2025-05-22 21:56:53.857 +07:00 [WRN] Savepoints are disabled because Multiple Active Result Sets (MARS) is enabled. If 'SaveChanges' fails, then the transaction cannot be automatically rolled back to a known clean state. Instead, the transaction should be rolled back by the application before retrying 'SaveChanges'. See https://go.microsoft.com/fwlink/?linkid=2149338 for more information and examples. To identify the code which triggers this warning, call 'ConfigureWarnings(w => w.Throw(SqlServerEventId.SavepointsDisabledBecauseOfMARS))'.
2025-05-22 21:56:53.858 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@p7='?' (DbType = Int32), @p0='?' (DbType = DateTime2), @p1='?' (Size = 4000), @p2='?' (DbType = Boolean), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (DbType = DateTime2), @p6='?' (Size = 100)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Conversations] SET [created_at] = @p0, [img_url] = @p1, [is_group] = @p2, [lastMessage] = @p3, [lastMessageSender] = @p4, [lastMessageTime] = @p5, [name] = @p6
OUTPUT 1
WHERE [id] = @p7;
2025-05-22 21:56:53.860 +07:00 [INF] Transaction committed for message: 399
2025-05-22 21:56:53.861 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__conversation_id_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[user_id]
FROM [Participants] AS [p]
WHERE [p].[conversation_id] = @__conversation_id_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 21:56:53.863 +07:00 [INF] Saved message 399 to Redis
2025-05-22 21:56:53.863 +07:00 [INF] Added message 399 to conversation 19
2025-05-22 21:56:53.866 +07:00 [INF] Published message to channel conversation:19
2025-05-22 21:56:54.216 +07:00 [INF] Request starting HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - application/json 66
2025-05-22 21:56:54.216 +07:00 [INF] Executing endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:56:54.217 +07:00 [INF] Route matched with {action = "SendNotification", controller = "Notification"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SendNotification(NotificationRequest) on controller FcmBackend.Controllers.NotificationController (Message_app).
2025-05-22 21:56:54.223 +07:00 [INF] Sending notification to userId: 3, title: Tin nhắn mới trong nhóm, body: đf
2025-05-22 21:56:54.225 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[fcmToken]
FROM [Users] AS [u]
WHERE [u].[id] = @__Parse_0
2025-05-22 21:56:54.225 +07:00 [ERR] FCM token not found for userId: 3
2025-05-22 21:56:54.225 +07:00 [INF] Executing ObjectResult, writing value of type 'System.String'.
2025-05-22 21:56:54.226 +07:00 [INF] Executed action FcmBackend.Controllers.NotificationController.SendNotification (Message_app) in 8.8932ms
2025-05-22 21:56:54.226 +07:00 [INF] Executed endpoint 'FcmBackend.Controllers.NotificationController.SendNotification (Message_app)'
2025-05-22 21:56:54.226 +07:00 [INF] Request finished HTTP/1.1 POST http://192.168.1.5:5053/api/Notification/send - 500 null text/plain; charset=utf-8 9.7071ms
2025-05-22 22:03:07.109 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 22:03:07.110 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 22:03:07.156 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 22:03:07.157 +07:00 [ERR] Connection id "0HNCP82SMBQ3T", Request id "0HNCP82SMBQ3T:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 22:03:07.160 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 444080.9981ms
2025-05-22 22:04:12.279 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - null null
2025-05-22 22:04:12.284 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:12.290 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Auth/login - 204 null null 11.3545ms
2025-05-22 22:04:12.303 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5053/api/Auth/login - application/json 60
2025-05-22 22:04:12.306 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:12.309 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:12.323 +07:00 [INF] Executing endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 22:04:12.330 +07:00 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(server.DTO.AuthDTO.LoginDTO) on controller Message_app.Controllers.AuthController (Message_app).
2025-05-22 22:04:12.434 +07:00 [INF] Executed DbCommand (20ms) [Parameters=[@__email_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[id], [u].[avatar_url], [u].[bio], [u].[birthday], [u].[created_at], [u].[email], [u].[fcmToken], [u].[gender], [u].[interests], [u].[location], [u].[password], [u].[passwordSalt], [u].[username]
FROM [Users] AS [u]
WHERE [u].[email] = @__email_0
2025-05-22 22:04:12.450 +07:00 [INF] Executing OkObjectResult, writing value of type 'server.DTO.AuthDTO.LoginRespose'.
2025-05-22 22:04:12.451 +07:00 [INF] Executed action Message_app.Controllers.AuthController.Login (Message_app) in 120.3284ms
2025-05-22 22:04:12.451 +07:00 [INF] Executed endpoint 'Message_app.Controllers.AuthController.Login (Message_app)'
2025-05-22 22:04:12.452 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5053/api/Auth/login - 200 null application/json; charset=utf-8 148.796ms
2025-05-22 22:04:12.494 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - null null
2025-05-22 22:04:12.498 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:12.498 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:12.498 +07:00 [INF] Executing endpoint '/ws/chat'
2025-05-22 22:04:12.528 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__client_UserId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[conversation_id]
FROM [Participants] AS [p]
WHERE [p].[user_id] = @__client_UserId_0 AND [p].[is_deleted] = CAST(0 AS bit)
2025-05-22 22:04:12.536 +07:00 [INF] User 3 subscribed to channel conversation:1
2025-05-22 22:04:12.536 +07:00 [INF] User 3 subscribed to channel conversation:2
2025-05-22 22:04:12.536 +07:00 [INF] User 3 subscribed to channel conversation:9
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:19
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:25
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:26
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:27
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:28
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:29
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:32
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:34
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:35
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:36
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:37
2025-05-22 22:04:12.537 +07:00 [INF] User 3 subscribed to channel conversation:38
2025-05-22 22:04:12.538 +07:00 [INF] User 3 subscribed to channel conversation:39
2025-05-22 22:04:12.538 +07:00 [INF] User 3 subscribed to channel conversation:40
2025-05-22 22:04:12.538 +07:00 [INF] User 3 subscribed to channel conversation:42
2025-05-22 22:04:12.538 +07:00 [INF] User 3 subscribed to channel conversation:43
2025-05-22 22:04:12.539 +07:00 [INF] User 3 subscribed to channel conversation:44
2025-05-22 22:04:12.542 +07:00 [INF] User 3 subscribed to channel conversation:45
2025-05-22 22:04:15.800 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - null null
2025-05-22 22:04:15.800 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:15.801 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:15.801 +07:00 [INF] Executing endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 22:04:15.801 +07:00 [INF] Route matched with {action = "GetAllFriends", controller = "Friends"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllFriends(Int32) on controller server.Controllers.FriendsController (Message_app).
2025-05-22 22:04:15.825 +07:00 [INF] Executed DbCommand (14ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[username]
    ELSE [u0].[username]
END AS [username], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[avatar_url]
    ELSE [u0].[avatar_url]
END AS [avatar], CASE
    WHEN [f].[UserId1] = @__userId_0 THEN [u].[id]
    ELSE [u0].[id]
END AS [friendId], @__userId_0 AS [userId]
FROM [Friends] AS [f]
INNER JOIN [Users] AS [u] ON [f].[UserId2] = [u].[id]
INNER JOIN [Users] AS [u0] ON [f].[UserId1] = [u0].[id]
WHERE [f].[UserId1] = @__userId_0 OR [f].[UserId2] = @__userId_0
2025-05-22 22:04:15.826 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType8`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Collections.Generic.List`1[[server.DTO.FriendDTO, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-22 22:04:15.826 +07:00 [INF] Executed action server.Controllers.FriendsController.GetAllFriends (Message_app) in 25.0424ms
2025-05-22 22:04:15.826 +07:00 [INF] Executed endpoint 'server.Controllers.FriendsController.GetAllFriends (Message_app)'
2025-05-22 22:04:15.826 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/friends/GetAllFriends/3 - 200 null application/json; charset=utf-8 26.3708ms
2025-05-22 22:04:16.027 +07:00 [INF] Request starting HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 22:04:16.027 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:16.027 +07:00 [INF] Request finished HTTP/1.1 OPTIONS http://localhost:5053/api/Conversation/get_conversations/3 - 204 null null 0.3499ms
2025-05-22 22:04:16.030 +07:00 [INF] Request starting HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - null null
2025-05-22 22:04:16.030 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:16.031 +07:00 [INF] CORS policy execution successful.
2025-05-22 22:04:16.031 +07:00 [INF] Executing endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 22:04:16.031 +07:00 [INF] Route matched with {action = "GetConversations", controller = "Conversation"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetConversations(Int32) on controller server.Controllers.ConversationController (Message_app).
2025-05-22 22:04:16.064 +07:00 [INF] Executed DbCommand (28ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[id], [c].[name], [c].[is_group], [c].[created_at], [c].[lastMessage], [c].[lastMessageTime], [c].[img_url], [p0].[id], [p0].[user_id], [p0].[conversation_id], [p0].[name], [p0].[is_deleted], [p0].[img_url]
FROM [Conversations] AS [c]
LEFT JOIN [Participants] AS [p0] ON [c].[id] = [p0].[conversation_id]
WHERE EXISTS (
    SELECT 1
    FROM [Participants] AS [p]
    WHERE [c].[id] = [p].[conversation_id] AND [p].[user_id] = @__userId_0)
ORDER BY [c].[id]
2025-05-22 22:04:16.074 +07:00 [INF] Executing OkObjectResult, writing value of type 'System.Collections.Generic.List`1[[server.DTO.ConversationDto, Message_app, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-22 22:04:16.076 +07:00 [INF] Executed action server.Controllers.ConversationController.GetConversations (Message_app) in 45.2179ms
2025-05-22 22:04:16.076 +07:00 [INF] Executed endpoint 'server.Controllers.ConversationController.GetConversations (Message_app)'
2025-05-22 22:04:16.077 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/api/Conversation/get_conversations/3 - 200 null application/json; charset=utf-8 46.658ms
2025-05-22 22:05:06.244 +07:00 [INF] Application is shutting down...
2025-05-22 22:05:30.718 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 22:05:30.718 +07:00 [ERR] An unhandled exception has occurred while executing the request.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 22:05:30.720 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 22:05:30.721 +07:00 [ERR] Connection id "0HNCP82SMBQ49", Request id "0HNCP82SMBQ49:00000001": An unhandled exception was thrown by the application.
StackExchange.Redis.RedisServerException: WRONGTYPE Operation against a key holding the wrong kind of value
   at server.Services.WebSocketService.webSocket.CleanupClient(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 547
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 205
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 22:05:30.723 +07:00 [INF] Request finished HTTP/1.1 GET http://localhost:5053/ws/chat?userId=3 - 101 null null 78228.4695ms
2025-05-22 22:05:35.219 +07:00 [INF] Executed endpoint '/ws/chat'
2025-05-22 22:05:35.219 +07:00 [ERR] An unhandled exception has occurred while executing the request.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-05-22 22:05:35.223 +07:00 [WRN] The response has already started, the error page middleware will not be executed.
2025-05-22 22:05:35.223 +07:00 [ERR] Connection id "0HNCP82SMBQ3V", Request id "0HNCP82SMBQ3V:00000001": An unhandled exception was thrown by the application.
System.Net.WebSockets.WebSocketException (0x80004005): The remote party closed the WebSocket connection without completing the close handshake.
   at System.Net.WebSockets.ManagedWebSocket.ThrowEOFUnexpected()
   at System.Net.WebSockets.ManagedWebSocket.EnsureBufferContainsAsync(Int32 minimumRequiredBytes, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource.GetResult(Int16 token)
   at System.Net.WebSockets.ManagedWebSocket.ReceiveAsyncPrivate[TResult](Memory`1 payloadBuffer, CancellationToken cancellationToken)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at System.Threading.Tasks.ValueTask`1.ValueTaskSourceAsTask.<>c.<.cctor>b__4_0(Object state)
--- End of stack trace from previous location ---
   at server.Services.WebSocketService.webSocket.Receiver(Client client) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 220
   at server.Services.WebSocketService.webSocket.HandleWebSocket(HttpContext context) in C:\Users\Thao\source\Flutter\Message_app\server\Services\WebSocketService\websocket.cs:line 203
   at Program.<>c.<<<Main>$>b__0_4>d.MoveNext() in C:\Users\Thao\source\Flutter\Message_app\server\Program.cs:line 107
--- End of stack trace from previous location ---
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Watch.BrowserRefresh.BrowserRefreshMiddleware.InvokeAsync(HttpContext context)
   at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.ProcessRequests[TContext](IHttpApplication`1 application)
2025-05-22 22:05:35.224 +07:00 [INF] Request finished HTTP/1.1 GET http://192.168.1.5:5053/ws/chat?userId=2 - 101 null null 551095.538ms
